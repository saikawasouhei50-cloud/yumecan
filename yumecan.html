<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> <title>YUMECAN!_</title>
    <!-- Tailwind CSSë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹ ë¥´ê³  ë©‹ì§„ ë””ìì¸ì„ ì ìš©í•©ë‹ˆë‹¤ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>

		/* gacha.htmlì˜ .iso-floor ìŠ¤íƒ€ì¼ ìˆ˜ì • */

		/* ì‹œê°„ëŒ€ë³„ í•„í„° íš¨ê³¼ */

/* ê¸°ë³¸(ë°¤) - ì›ë³¸ ì´ë¯¸ì§€ ê·¸ëŒ€ë¡œ */
.time-night {
    filter: none;
}

/* ì•„ì¹¨ - ì•½ê°„ í‘¸ë¥´ìŠ¤ë¦„í•˜ê³  ë°ìœ¼ë©° ì±„ë„ê°€ ë‚®ìŒ */
.time-morning {
    filter: brightness(1.1) sepia(0.2) hue-rotate(180deg) saturate(0.8);
}

/* ë‚® - ê°€ì¥ ë°ê³  ì„ ëª…í•¨ */
.time-day {
    filter: brightness(1.2) contrast(1.1) saturate(1.1);
}

/* ì €ë…(ë…¸ì„) - ë¶‰ì€ í†¤(Sepia)ê³¼ ë”°ëœ»í•œ ìƒ‰ê° */
.time-evening {
    filter: brightness(0.9) sepia(0.5) hue-rotate(-20deg) saturate(1.3) contrast(1.1);
}

/* ë°°ê²½ ì´ë¯¸ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ½ê²Œ ë°”ë€Œë„ë¡) */
#room-background {
    transition: filter 2s ease-in-out;
}

.room-wrapper {
    width: 100%;
    max-width: 800px; /* PC ìµœëŒ€ ë„ˆë¹„ */
    margin: 0 auto;   /* ì¤‘ì•™ ì •ë ¬ */
    position: relative;
    
    /* âœ¨ í•µì‹¬: ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ì„ 1.6 (16:10)ìœ¼ë¡œ ê³ ì • */
    /* ë°°ê²½ ì´ë¯¸ì§€ ë¹„ìœ¨ì— ë”°ë¼ 1.6, 1.5, 1.33 ë“±ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥ */
    aspect-ratio: 1.6 / 1; 
    
    /* êµ¬í˜• ë¸Œë¼ìš°ì € í˜¸í™˜ìš© (aspect-ratioê°€ ì•ˆ ë¨¹í ë•Œ ëŒ€ë¹„) */
    @supports not (aspect-ratio: 1.6 / 1) {
        padding-bottom: 62.5%; /* 100 / 1.6 = 62.5% */
        height: 0;
    }
}

/* --- âœ¨ ë“±ê¸‰ë³„ ì´ë¯¸ì§€ ê¸€ë¡œìš° íš¨ê³¼ (filter: drop-shadow) âœ¨ --- */
/* N ë“±ê¸‰: í°ìƒ‰/íšŒìƒ‰ ì€ì€í•œ ë¹› */
.rarity-glow-N { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.4)); }
/* R ë“±ê¸‰: í•˜ëŠ˜ìƒ‰ ë¹› */
.rarity-glow-R { filter: drop-shadow(0 0 7px rgba(0, 180, 255, 0.8)); }
/* SR ë“±ê¸‰: ë³´ë¼ìƒ‰/ìì£¼ìƒ‰ ë¹› */
.rarity-glow-SR { filter: drop-shadow(0 0 9px rgba(200, 0, 255, 0.9)); }
/* SSR ë“±ê¸‰: ê¸ˆìƒ‰/ë…¸ë€ìƒ‰ ê°•í•œ ë¹› */
.rarity-glow-SSR { filter: drop-shadow(0 0 14px rgba(255, 220, 0, 1.0)); }
/* ------------------------------------- */

#room-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #111827; /* bg-gray-900 ìƒ‰ìƒ */
    border-radius: 0.75rem;    /* rounded-xl */
    overflow: hidden;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-xl */
    border: 4px solid #374151; /* border-gray-700 */
}

/* ë°°ê²½ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ê°•ì œ ì§€ì • */
#room-container > div.absolute.inset-0 {
    background-size: contain !important; /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šê³  ê½‰ ì°¨ê²Œ */
    background-position: center bottom !important; /* ë°”ë‹¥ ê¸°ì¤€ ì •ë ¬ */
    background-repeat: no-repeat !important;
}
		
.iso-floor {
    position: absolute;
    
    /* 1. ìœ„ì¹˜ë¥¼ ë” ì•„ë˜ë¡œ ë‚´ë¦½ë‹ˆë‹¤ (ì²œì¥ì´ ì•„ë‹ˆë¼ ë°”ë‹¥ ì¤‘ì‹¬ì— ì˜¤ë„ë¡) */
    top: 63%;       
    
    /* 2. ì¢Œìš° ì¤‘ì•™ ì •ë ¬ */
    left: 50%;      
    
    /* 3. í¬ê¸°ë¥¼ ì¤„ì—¬ì„œ ë²½ ìª½ìœ¼ë¡œ ë„£ìŠµë‹ˆë‹¤ */
    width: 46%;     
    height: 90%;    
    
    /* ë³€í˜• ì†ì„± ìœ ì§€ */
    transform: translate(-50%, -50%) rotateX(60deg) rotateZ(45deg);
    
    /* í™•ì¸ìš© í…Œë‘ë¦¬ (ìœ„ì¹˜ ë§ì¶˜ í›„ì—ëŠ” ì§€ìš°ê±°ë‚˜ transparentë¡œ ë³€ê²½) */
   /* border: 2px dashed red; */
    background-color: transparent; 
    
    pointer-events: none;
    z-index: 0;
}

body.pointer-events-none {
    pointer-events: none;
}

		
		
        /* ì‚¬ìš©ì ì •ì˜ ì• ë‹ˆë©”ì´ì…˜ ë° ìŠ¤íƒ€ì¼ */
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        body {
            font-family: 'Jua', sans-serif;
            background-image: linear-gradient(to top, #30cfd0 0%, #330867 100%);
        }
		
		body.loading {
            pointer-events: none; /* 'loading' í´ë˜ìŠ¤ê°€ ìˆì„ ë•Œ ëª¨ë“  í´ë¦­ì„ ë§‰ìŠµë‹ˆë‹¤. */
        }

        /* ì¹´ë“œê°€ ë‚˜íƒ€ë‚  ë•Œì˜ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .card-animation { animation: fadeIn 0.5s ease-out forwards; }

        /* ë“±ê¸‰ë³„ ì¹´ë“œ ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ */
        .rarity-N { background-image: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); }
        .rarity-R { background-image: linear-gradient(to top, #a1c4fd 0%, #c2ebf0 100%); }
        .rarity-SR { background-image: linear-gradient(to right, #f83292, #7122fa); }
        .rarity-SSR { background-image: linear-gradient(to right, #f78ca0 0%, #f9748f 19%, #fd868c 60%, #fe9a8b 100%); }

        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        .gacha-button { transition: all 0.3s ease; }
        .gacha-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        
        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-button { transition: all 0.2s ease-in-out; }
        /* íƒ­ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ê°œì„  */
.tab-button.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* ë³´ë¼ë¹› ê·¸ë¼ë°ì´ì…˜ */
    color: white !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    font-weight: bold;
    transform: scale(1.05); /* ì‚´ì§ ì»¤ì§€ëŠ” íš¨ê³¼ */
}
        
        /* ì¹´ë“œ ê°œìˆ˜ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #e53e3e;
            color: white;
            font-size: 14px;
            font-weight: bold;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
		
		.level-badge {
    position: absolute;
    bottom: -8px;
    left: -8px;
    background-color: #4299e1; /* blue-500 */
    color: white;
    font-size: 12px;
    font-weight: bold;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
    box-shadow: 0px 2px 4px rgba(0,0,0,0.3);
}

/* .level-badge ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€ */
        .revision-stars {
            position: absolute;
            bottom: -2px;
            right: 4px;
            display: flex;
            gap: 1px;
        }
        .revision-star {
            color: #FFD700; /* Gold color */
            font-size: 14px;
            text-shadow: 0px 1px 2px rgba(0,0,0,0.7);
        }
        /* ë± ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ */
        .deck-slot {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
        }
        /* í™ˆ í™”ë©´ ìºë¦­í„° ì´ë¯¸ì§€ */
        #home-character-image {
            max-height: 60vh;
            object-fit: contain;
            filter: drop-shadow(0px 5px 15px rgba(0,0,0,0.5));
            transition: transform 0.3s ease-in-out;
        }
        #home-character-image:hover {
            transform: scale(1.03);
        }
        /* ì´ë²¤íŠ¸ ë°°ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 100, 0.4); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 100, 0.8); }
        }
        #event-banner {
            animation: pulse-glow 2.5s infinite ease-in-out;
        }

		.sort-button.active {
    background-color: #4299e1; /* íŒŒë€ìƒ‰ */
    color: white;
}

.filter-button.active {
    background-color: #4299e1; /* íŒŒë€ìƒ‰ */
    color: white;
}
        /* ë½‘ê¸° íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .sub-tab-button { transition: all 0.2s ease-in-out; }
        .sub-tab-button.active { background-color: rgba(246, 224, 94, 0.8); color: #330867; }
        
        /* ì „íˆ¬ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #combat-log { scroll-behavior: smooth; }
        .hp-bar-background { background-color: #4a5568; }
        .hp-bar-foreground { background-color: #48bb78; transition: width 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake-animation { animation: shake 0.3s 1; }
        .speed-button.active {
            background-color: #4299e1; /* blue-500 */
            box-shadow: 0 0 10px rgba(66, 153, 225, 0.7);
        }
        .story-content {
            white-space: pre-wrap;
            word-break: keep-all;
        }

/* ë§ˆì´ë£¸ ìºë¦­í„° ì• ë‹ˆë©”ì´ì…˜ */
.chibi-character {
    position: absolute;
    width: 60px;
    height: 60px;
    transition: all 2s linear; /* ë¶€ë“œëŸ¬ìš´ ì´ë™ */
    z-index: 10;
    cursor: pointer;
}
.chibi-character:hover {
    transform: scale(1.1);
}
/* ë§í’ì„  ìŠ¤íƒ€ì¼ */
.chibi-bubble {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    color: black;
    padding: 4px 8px;
    border-radius: 10px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 20;
}
.chibi-character:hover .chibi-bubble {
    opacity: 1;
}
/* ë°°ì¹˜ëœ ê°€êµ¬ */
.placed-furniture {
    position: absolute;
    transition: all 0.2s;
}
		
		/* [ì¶”ê°€] êµ¬ë²„ì „ UIë¥¼ ê°•ì œë¡œ ìˆ¨ê¹ë‹ˆë‹¤. */
        #event-point-display { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <button id="global-home-button" onclick="switchTab('home')" 
        class="hidden fixed top-4 left-4 z-[9999] bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2 px-4 rounded-full shadow-lg border-2 border-white flex items-center gap-2 transition-transform hover:scale-105">
        <span>ğŸ </span>
        <span class="hidden md:inline">ë¡œë¹„ë¡œ ë³µê·€</span> 
    </button>

    <div id="loading-overlay" class="fixed inset-0 bg-black/80 flex flex-col justify-center items-center z-50">
        <div class="text-yellow-300 text-2xl font-bold animate-pulse">YUMECAN!_</div>
        <p class="text-white mt-2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="w-full max-w-5xl bg-white/10 backdrop-blur-md rounded-2xl shadow-xl text-white p-6 md:p-8">
        
        <header id="global-header" class="text-center mb-2 md:mb-4">
            <h1 class="text-3xl md:text-5xl font-bold tracking-wider text-yellow-300" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">YUMECAN!_</h1>
        </header>

        <div id="global-info-bar" class="bg-black/20 p-2 md:p-3 rounded-lg mb-2 md:mb-4 flex flex-wrap justify-between items-center gap-2">
            <div id="login-view" class="flex flex-wrap items-center gap-2 justify-center w-full md:w-auto">
                <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„" class="bg-gray-700 text-white px-2 py-1 rounded-md text-xs md:text-sm w-20 md:w-24">
                <input type="email" id="email-input" placeholder="ì´ë©”ì¼" class="bg-gray-700 text-white px-2 py-1 rounded-md text-xs md:text-sm w-20 md:w-24">
                <input type="password" id="password-input" placeholder="ë¹„ë²ˆ" class="bg-gray-700 text-white px-2 py-1 rounded-md text-xs md:text-sm w-16 md:w-20">
                
                <button id="login-button" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded-full text-xs md:text-sm">ë¡œê·¸ì¸</button>
                <button id="register-button" class="gacha-button bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-full text-xs md:text-sm">ê°€ì…</button>
            </div>
            
            <div id="logged-in-view" class="hidden flex items-center gap-2 justify-center w-full md:w-auto">
                <p class="font-bold text-xs md:text-base">í™˜ì˜í•©ë‹ˆë‹¤, <span id="nickname-display" class="text-yellow-300"></span>ë‹˜!</p>
                <button id="logout-button" class="gacha-button bg-red-600 hover:bg-red-700 text-white font-bold py-0.5 px-2 md:py-1 md:px-3 rounded-full text-xs md:text-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        
        <div id="global-currency-bar" class="flex flex-wrap items-center justify-center md:justify-end gap-1.5 md:gap-3 mb-4 md:mb-6">
            <button onclick="openMailbox()" class="relative gacha-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 md:py-2 md:px-4 rounded-full text-xs md:text-sm flex items-center gap-1">
                <span>ğŸ“©</span>
                <span class="hidden md:inline">ìš°í¸í•¨</span>
                <span id="mail-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center border border-white animate-bounce">N</span>
            </button>

            <div class="text-xs md:text-xl font-bold text-cyan-300 bg-black/20 py-1 px-2 md:py-2 md:px-4 rounded-full inline-flex items-center">
                ğŸ”– <span id="bookmark-display" class="ml-1">10</span>/<span id="max-bookmark-display">10</span><span id="bookmark-timer-container" class="ml-1"></span>
            </div>
            
            <div class="text-xs md:text-2xl font-bold text-yellow-300 bg-black/20 py-1 px-2 md:py-2 md:px-6 rounded-full inline-flex items-center">
                ğŸ’ <span id="currency-display" class="ml-1">100</span>
            </div>
            
            <div class="text-xs md:text-xl font-bold text-gray-300 bg-black/20 py-1 px-2 md:py-2 md:px-4 rounded-full inline-flex items-center">
                ğŸ–‹ï¸ <span id="fountainpen-display" class="ml-1">500</span>
            </div>
            
            <div class="text-xs md:text-xl font-bold text-fuchsia-400 bg-black/20 py-1 px-2 md:py-2 md:px-4 rounded-full inline-flex items-center">
                ğŸ’§ <span id="inkwell-display" class="ml-1">0</span>
            </div>
            
            
        </div> <main>
			<div id="message-area" class="text-center text-lg h-8 mb-4 transition-opacity duration-300"></div>

             <div id="storage-warning" class="hidden text-center bg-red-500 p-2 rounded-lg mb-4">
                <strong>ê²½ê³ :</strong> ê²Œì„ ì§„í–‰ ìƒí™©ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ê°€ ì‹œí¬ë¦¿ ëª¨ë“œì´ê±°ë‚˜ ì €ì¥ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
            </div>

            <div id="home-view" class="relative w-full h-[85vh] overflow-hidden">
    <div class="absolute inset-0 flex items-center justify-start pr-6 md:justify-start md:items-center z-0 pb-44 md:pb-0 md:pl-10 md:-translate-y-12 pointer-events-none">
    
    <div id="home-character-container" class="relative h-full flex items-center md:items-center justify-center pointer-events-auto cursor-pointer group transition-transform duration-300 hover:scale-[1.02]">
        
        <img id="home-character-image" src="" alt="ëŒ€í‘œ ìºë¦­í„°" class="max-h-[60%] md:max-h-[85%] object-contain drop-shadow-2xl transition-all">
        
        <div id="home-dialogue-container" class="absolute top-[15%] right-[-10%] md:top-[10%] md:-right-40 bg-white/95 text-black p-3 md:p-6 rounded-xl rounded-bl-none shadow-xl max-w-[160px] md:max-w-xs hidden group-hover:block transition-opacity duration-300 animate-fadeIn z-20 border-2 border-blue-100">
            <p id="home-character-name" class="font-bold text-blue-600 mb-1 text-sm md:text-xl"></p>
            <p id="home-character-dialogue" class="text-xs md:text-base font-medium leading-relaxed"></p>
        </div>
    </div>
    
    <div id="home-default-message" class="text-xl md:text-3xl text-gray-300 hidden font-bold drop-shadow-md absolute">
        ë‹¹ì‹ ì˜ ì„œê³ ì—ì„œ ëŒ€í‘œ ë“±ì¥ì¸ë¬¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!
    </div>
</div>

    <div class="absolute z-20 pointer-events-none 
            bottom-[6.5rem] left-0 w-full flex flex-row items-end justify-center gap-1 px-1
            md:top-4 md:bottom-28 md:left-auto md:right-0 md:w-1/3 md:min-w-[280px] md:flex-col md:items-end md:gap-1 md:pr-8">
    
    
    <button id="btn-lobby-deck" onclick="switchTab('deck')" class="pointer-events-auto 
        w-24 flex-1 h-14 text-sm 
        md:flex-none md:w-[90%] md:max-w-[280px] md:h-20 md:text-3xl 
        bg-gradient-to-r from-gray-700 to-gray-800 text-white font-bold transform -skew-x-12 
        hover:scale-105 hover:bg-gray-600 transition-all shadow-lg 
        flex flex-col md:flex-row items-center justify-center 
        border border-white/20 
        border-b-2 md:border-b-0 md:border-l-4 border-blue-400 
        mb-1 md:mb-1 mr-0.5 md:mr-0 gap-0.5 md:gap-2"> <span class="transform skew-x-12 text-lg md:text-3xl mb-0.5 md:mb-0">ğŸ“</span>
    <span class="transform skew-x-12 text-sm md:text-2xl leading-none">í¸ì°¬</span>
</button>

<button id="btn-lobby-inventory" onclick="switchTab('inventory')" class="pointer-events-auto 
        w-24 flex-1 h-14 text-sm 
        md:flex-none md:w-[90%] md:max-w-[280px] md:h-20 md:text-3xl 
        bg-gradient-to-r from-gray-700 to-gray-800 text-white font-bold transform -skew-x-12 
        hover:scale-105 hover:bg-gray-600 transition-all shadow-lg 
        flex flex-col md:flex-row items-center justify-center 
        border border-white/20 
        border-b-2 md:border-b-0 md:border-l-4 border-green-400 
        mb-1 md:mb-1 mr-0.5 md:mr-0 gap-0.5 md:gap-2"> <span class="transform skew-x-12 text-lg md:text-3xl mb-0.5 md:mb-0">ğŸ“š</span>
    <span class="transform skew-x-12 text-sm md:text-2xl leading-none">ì„œê³ </span>
</button>

<button id="btn-lobby-gacha" onclick="switchTab('gacha')" class="pointer-events-auto 
        w-24 flex-1 h-14 text-sm 
        md:flex-none md:w-[90%] md:max-w-[280px] md:h-20 md:text-3xl 
        bg-gradient-to-r from-gray-700 to-gray-800 text-white font-bold transform -skew-x-12 
        hover:scale-105 hover:bg-gray-600 transition-all shadow-lg 
        flex flex-col md:flex-row items-center justify-center 
        border border-white/20 
        border-b-2 md:border-b-0 md:border-l-4 border-purple-400 
        mb-1 md:mb-1 gap-0.5 md:gap-2"> <span class="transform skew-x-12 text-lg md:text-3xl mb-0.5 md:mb-0">âœ¨</span>
    <span class="transform skew-x-12 text-sm md:text-2xl leading-none">ì†Œí™˜</span>
</button>

<button onclick="switchTab('story')" class="pointer-events-auto 
        w-8 h-10 text-[8px] 
        md:w-[90%] md:max-w-[135px] md:h-14 md:text-lg 
        bg-indigo-900/80 hover:bg-indigo-800 text-white font-bold transform -skew-x-12 shadow-lg 
        flex flex-col md:flex-row items-center justify-center border border-white/20 
        mb-1 md:mb-1"> <span class="transform skew-x-12 text-xs md:text-xl mb-0.5 md:mb-0">ğŸ“–</span>
    <span class="transform skew-x-12 text-[8px] md:text-lg leading-none">ìŠ¤í† ë¦¬</span>
</button>

<button onclick="switchTab('trade')" class="pointer-events-auto 
        w-8 h-10 text-[8px] 
        md:w-[90%] md:max-w-[135px] md:h-14 md:text-lg 
        bg-blue-900/80 hover:bg-blue-800 text-white font-bold transform -skew-x-12 shadow-lg 
        flex flex-col md:flex-row items-center justify-center border border-white/20 
        mb-1 md:mb-1"> 
		<span id="trade-badge" class="hidden absolute -top-1 -right-1 md:top-0 md:right-0 bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-black animate-bounce z-10 transform skew-x-12">N</span>
		<span class="transform skew-x-12 text-xs md:text-xl mb-0.5 md:mb-0">âš–ï¸</span>
    <span class="transform skew-x-12 text-[8px] md:text-lg leading-none">êµí™˜</span>
</button>

<button onclick="switchTab('myroom')" class="pointer-events-auto 
        w-8 h-10 text-[8px] 
        md:w-[90%] md:max-w-[135px] md:h-14 md:text-lg 
        bg-pink-900/80 hover:bg-pink-800 text-white font-bold transform -skew-x-12 shadow-lg 
        flex flex-col md:flex-row items-center justify-center border border-white/20 
        mb-1 md:mb-1"> <span class="transform skew-x-12 text-xs md:text-xl mb-0.5 md:mb-0">â˜•</span>
    <span class="transform skew-x-12 text-[8px] md:text-lg leading-none">ì‚¬ë¬´ì†Œ</span>
</button>

    <button id="btn-lobby-combat" onclick="switchTab('combat')" class="pointer-events-auto group 
            order-last md:order-none
            w-20 h-16 text-sm
            md:w-full md:max-w-[320px] md:h-24 md:text-4xl 
            bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-black italic transform -skew-x-12 
            hover:scale-105 hover:brightness-110 transition-all 
            shadow-[2px_2px_0px_rgba(0,0,0,0.5)] md:shadow-[6px_6px_0px_rgba(0,0,0,0.5)] border-2 border-yellow-300 
            flex flex-col md:flex-row items-center justify-center gap-0.5 md:gap-2">
        <span class="transform skew-x-12 inline-block text-xl md:text-5xl">âš”ï¸</span>
        <span class="transform skew-x-12 inline-block text-xs md:text-4xl">ë…ì„œ</span>
        <span class="absolute -bottom-2 -right-2 text-6xl opacity-20 transform skew-x-12 text-black hidden md:block">COMBAT</span>
    </button>

    <div class="hidden md:flex gap-2 w-[90%] max-w-[280px] justify-end absolute bottom-0 right-8 pointer-events-none opacity-0"></div>

</div>

    <div class="absolute bottom-10 md:bottom-4 left-0 w-full px-1 md:px-4 flex justify-between items-end z-10 pointer-events-none">
    
    <div class="pointer-events-auto">
        <button id="event-banner" onclick="switchTab('event-home')" class="bg-gradient-to-r from-pink-600 to-rose-700 text-white px-3 py-2 md:px-10 md:py-4 rounded-tr-2xl rounded-bl-xl shadow-lg hover:brightness-110 flex items-center gap-2 md:gap-4 border-2 border-pink-400 transition-transform hover:scale-105">
            <span class="text-2xl md:text-5xl animate-bounce">ğŸ‰</span>
            <div class="text-left">
                <p class="text-[10px] md:text-base text-pink-200 font-bold tracking-widest">EVENT</p>
                <p id="event-banner-text" class="font-bold text-sm md:text-2xl text-shadow">ì´ë²¤íŠ¸ í™•ì¸</p> 
            </div>
        </button>
    </div>

    <div class="flex gap-0.5 md:gap-1 pointer-events-auto bg-black/60 backdrop-blur-md p-1 md:p-2 rounded-xl border border-white/10">
        
        <button onclick="switchTab('friends')" class="relative hover:bg-white/20 p-1 md:p-2 rounded-lg transition-colors text-white" title="ì¹œêµ¬">
            <span id="main-friend-badge" class="hidden absolute top-0 right-0 bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-black animate-bounce">0</span>
            <div class="text-base md:text-xl">ğŸ¤</div>
            <div class="text-[9px] md:text-[10px] text-center text-gray-300 leading-none mt-0.5">ì¹œêµ¬</div>
        </button>
        
        <button onclick="switchTab('collection')" class="hover:bg-white/20 p-1 md:p-2 rounded-lg transition-colors text-white" title="ë„ê°">
            <div class="text-base md:text-xl">ğŸ“’</div>
            <div class="text-[9px] md:text-[10px] text-center text-gray-300 leading-none mt-0.5">ë„ê°</div>
        </button>
        
        <button onclick="switchTab('achievements')" class="relative hover:bg-white/20 p-1 md:p-2 rounded-lg transition-colors text-white" title="ì—…ì ">
            <span id="achievement-badge" class="hidden absolute top-0 right-0 bg-red-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-black animate-bounce">0</span>
            <div class="text-base md:text-xl">ğŸ†</div>
            <div class="text-[9px] md:text-[10px] text-center text-gray-300 leading-none mt-0.5">ì—…ì </div>
        </button>

        <button onclick="switchTab('profile')" class="hover:bg-white/20 p-1 md:p-2 rounded-lg transition-colors text-white" title="í”„ë¡œí•„">
            <div class="text-base md:text-xl">ğŸ‘¤</div>
            <div class="text-[9px] md:text-[10px] text-center text-gray-300 leading-none mt-0.5">í”„ë¡œí•„</div>
        </button>

    </div>
</div>
</div>
            
			<div id="event-home-view" class="hidden">
    <div class="flex flex-col md:flex-row gap-6">

        <div class="md:w-1/2 flex flex-col gap-4">
            
            <div class="flex flex-col items-center">
                <img id="event-home-banner-image" src="https://placehold.co/600x200/ff6347/ffffff?text=Event+Banner" alt="Event Banner" class="w-full rounded-lg shadow-lg mb-3">
                <p id="event-home-duration" class="text-sm text-gray-400"></p>
            </div>
            
            <div class="grid grid-cols-2 gap-4 w-full">
                <button id="goto-event-story" class="gacha-button bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg text-base">
                    ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬
                </button>
                <button id="goto-event-gacha" class="gacha-button bg-gradient-to-r from-red-500 to-yellow-500 hover:from-red-600 hover:to-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg text-base">
                    ì´ë²¤íŠ¸ ì„œê°€
                </button>
            </div>

            <div class="bg-black/20 p-4 rounded-lg shadow-lg flex-col">
                <p id="event-home-description" class="text-gray-200 mb-4 text-center"></p>
                
                <button id="goto-event-shop" class="gacha-button bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg text-lg w-full mb-3">
                    ì´ë²¤íŠ¸ ìƒì 
                </button>
                
                <div class="flex gap-2">
                    <button id="goto-event-battle" class="flex-1 gacha-button bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-black font-bold py-5 px-6 rounded-lg shadow-lg text-xl">
                        ì´ë²¤íŠ¸ ì „íˆ¬
                    </button>
                    <button id="goto-event-raid" class="flex-1 gacha-button bg-gradient-to-r from-red-600 to-rose-900 hover:from-red-700 hover:to-rose-950 text-white font-bold py-5 px-6 rounded-lg shadow-lg text-xl animate-pulse">
                        ì›”ë“œ ë ˆì´ë“œ
                    </button>
                </div>
            </div>
        </div> 

        <div class="md:w-1/2 flex flex-col gap-4">

            <div class="bg-black/20 p-4 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold text-yellow-300 mb-3">ì´ë²¤íŠ¸ Pt í˜„í™©</h3>
                
                <div class="flex justify-between items-center mb-2 px-2">
                    <span class="text-gray-300 font-bold">ğŸ’ í˜„ì¬ ë³´ìœ </span>
                    <span class="text-2xl font-bold text-white">
                        <span id="display-holding-points">0</span> P
                    </span>
                </div>

                <div class="flex justify-between items-center bg-black/30 p-3 rounded-lg border border-white/10">
                    <span class="text-sm text-gray-400">ğŸ† ëˆ„ì  íšë“</span>
                    <span class="text-lg font-bold text-yellow-300">
                        <span id="display-cumulative-points">0</span> P
                    </span>
                </div>
            </div> 
            <button onclick="openRankingModal()" class="w-full gacha-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg flex items-center justify-center gap-2">
                ğŸ† ì‹¤ì‹œê°„ ë­í‚¹ í™•ì¸
            </button>

            <div class="bg-black/20 p-4 rounded-lg shadow-lg">
                <h3 class="text-lg font-bold text-gray-200 mb-3 ml-1">ğŸ–ï¸ ëª…ì˜ˆì˜ ì „ë‹¹ (Top 3)</h3>
                <div id="ranking-preview-container" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm py-2">ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

        </div> 
    </div> 
</div>

<div id="event-view" class="hidden">
    
    <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-lg mx-auto">
        <button id="event-sub-tab-battle" class="sub-tab-button active w-1/4 font-bold py-2 px-2 md:px-4 rounded-full text-sm md:text-base">ì „íˆ¬</button>
        <button id="event-sub-tab-raid" class="sub-tab-button w-1/4 font-bold py-2 px-2 md:px-4 rounded-full text-sm md:text-base text-red-400">ë ˆì´ë“œ</button>
        <button id="event-sub-tab-story" class="sub-tab-button w-1/4 font-bold py-2 px-2 md:px-4 rounded-full text-sm md:text-base">ìŠ¤í† ë¦¬</button>
        <button id="event-sub-tab-shop" class="sub-tab-button w-1/4 font-bold py-2 px-2 md:px-4 rounded-full text-sm md:text-base">ìƒì </button>
    </div>

    <div class="flex justify-center mb-4">
        <div id="event-point-display" class="hidden text-xl font-bold text-pink-300 bg-black/20 py-2 px-4 rounded-full">EVENT P: <span id="event-points">0</span></div>
    </div>
    
    <div id="event-battle-view">
        <p class="text-center text-gray-200 mb-4">ì´ë²¤íŠ¸ ìŠ¤í…Œì´ì§€ì— ë„ì „í•˜ì—¬ ì´ë²¤íŠ¸ í¬ì¸íŠ¸ë¥¼ íšë“í•˜ì„¸ìš”!</p>
        <div id="event-dungeon-list-container" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
    </div>

    <div id="event-raid-view" class="hidden">
        <div class="text-center mb-6">
            <h2 class="text-3xl font-bold text-red-500 animate-pulse">âš  ê¸´ê¸‰ í† ë²Œ ì‘ì „ âš </h2>
            <p class="text-gray-300 text-sm">ëª¨ë“  íƒì •ê³¼ í˜‘ë ¥í•˜ì—¬ ë³´ìŠ¤ë¥¼ ì²˜ì¹˜í•˜ì„¸ìš”!</p>
        </div>

        <div class="bg-black/40 p-6 rounded-xl border-2 border-red-600 relative overflow-hidden max-w-2xl mx-auto">
            <div class="absolute inset-0 bg-red-900/20 animate-pulse pointer-events-none"></div>
            <div class="flex flex-col items-center z-10 relative">
                <h3 id="raid-boss-name" class="text-2xl md:text-3xl font-bold text-white mb-2">LOADING...</h3>
                <img id="raid-boss-image" src="" class="w-48 h-48 md:w-64 md:h-64 object-contain drop-shadow-[0_0_15px_rgba(255,0,0,0.6)] mb-4 transition-transform duration-500 hover:scale-105">
                <div class="w-full bg-gray-800 h-6 md:h-8 rounded-full border border-gray-600 relative overflow-hidden mb-2 shadow-inner">
                    <div id="raid-boss-hp-bar" class="h-full bg-gradient-to-r from-red-600 to-red-400 transition-all duration-500" style="width: 100%"></div>
                    <p id="raid-boss-hp-text" class="absolute inset-0 flex items-center justify-center text-xs md:text-sm font-bold text-white drop-shadow-md">Loading...</p>
                </div>
                <p class="text-xs text-gray-400 mb-2">ì²´ë ¥ì€ ëª¨ë“  ìœ ì €ì—ê²Œ ì‹¤ì‹œê°„ ê³µìœ ë©ë‹ˆë‹¤.</p>
                <div id="raid-count-display" class="text-sm font-bold text-yellow-300 mb-6">ì˜¤ëŠ˜ì˜ ë ˆì´ë“œ: 0 / 5íšŒ</div>
                <button id="raid-start-btn" onclick="startRaidBattle()" class="gacha-button bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-10 rounded-full text-lg md:text-xl shadow-[0_0_15px_rgba(220,38,38,0.5)]">âš”ï¸ ì „íˆ¬ ê°œì‹œ</button>
            </div>
        </div>

        <div class="mt-8 bg-black/40 p-4 rounded-xl border-2 border-gray-600 max-w-2xl mx-auto shadow-2xl">
            <h3 class="text-xl font-bold text-yellow-300 mb-4 text-center">âš”ï¸ ê¸°ì—¬ë„ ìˆœìœ„ (Top 5)</h3>
            <div id="raid-ranking-preview-container" class="space-y-3"></div>
        </div>
    </div> 

    <div id="event-story-view" class="hidden">
        <p class="text-center text-gray-200 mb-4">ì´ë²¤íŠ¸ ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ê³  ìŠ¤í† ë¦¬ë¥¼ í•´ê¸ˆí•˜ì„¸ìš”.</p>
        <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
            <button id="event-story-sub-tab-part1" class="sub-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">ì „ë°˜ë¶€</button>
            <button id="event-story-sub-tab-part2" class="sub-tab-button w-1/2 font-bold py-2 px-6 rounded-full">í›„ë°˜ë¶€</button>
        </div>
        <div id="event-story-part1-container" class="space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
        <div id="event-story-part2-container" class="hidden space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl">
            <p class="text-center text-gray-400 mt-10">í›„ë°˜ë¶€ ìŠ¤í† ë¦¬ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>
    </div>

    <div id="event-shop-view" class="hidden">
        <p class="text-center text-gray-200 mb-4">íšë“í•œ ì´ë²¤íŠ¸ í¬ì¸íŠ¸ë¡œ íŠ¹ë³„í•œ ë³´ìƒì„ êµí™˜í•˜ì„¸ìš”!</p>
        <div id="event-shop-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

</div>

            <div id="gacha-view" class="hidden">
                <p class="text-center text-gray-200 mt-2 mb-4">ìš´ëª…ì„ ì‹œí—˜í•˜ì—¬ ë‹¹ì‹ ì˜ ë“±ì¥ì¸ë¬¼ì„ ë§Œë‚˜ë³´ì„¸ìš”.</p>
                <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
                    <button id="gacha-tab-normal" class="sub-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">ì¼ë°˜ ì„œê°€</button>
                    <button id="gacha-tab-event" class="sub-tab-button w-1/2 font-bold py-2 px-6 rounded-full hidden">ì´ë²¤íŠ¸ ì„œê°€</button>
                </div>
                <div id="normal-gacha-view">
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <button id="pull-one" class="gacha-button w-full sm:w-auto bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ’ 1íšŒ ë½‘ê¸° (10)</button>
                        <button id="pull-ten" class="gacha-button w-full sm:w-auto bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ’ğŸ’ 10íšŒ ë½‘ê¸° (100)</button>
						<button onclick="openGachaPoolModal('normal')" class="gacha-button w-full sm:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-lg text-sm mt-2">
    ë“±ì¥ì¸ë¬¼ ëª©ë¡ (íšë“ ê°€ëŠ¥)
</button>
                    </div>
                </div>
                <div id="event-gacha-view" class="hidden">
                    <div id="event-gacha-info" class="text-center p-2 mb-2 rounded-lg bg-yellow-500/20">
                        <p class="font-bold text-yellow-300"></p>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                        <button id="pull-one-event" class="gacha-button w-full sm:w-auto bg-gradient-to-r from-red-500 to-yellow-500 hover:from-red-600 hover:to-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ”¥ 1íšŒ ë½‘ê¸° (10)</button>
                        <button id="pull-ten-event" class="gacha-button w-full sm:w-auto bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-full shadow-lg">ğŸ”¥ğŸ”¥ 10íšŒ ë½‘ê¸° (100)</button>
						<button onclick="openGachaPoolModal('event')" class="gacha-button w-full sm:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-lg text-sm mt-2">
    ë“±ì¥ì¸ë¬¼ ëª©ë¡ (íšë“ ê°€ëŠ¥)
</button>
                    </div>
                </div>
                <div id="results-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[200px] bg-black/20 p-4 rounded-xl"></div>
            </div>

            <div id="inventory-view" class="hidden">
     <div class="text-center mb-4 relative">
    <p class="text-gray-200">ì§€ê¸ˆê¹Œì§€ ìˆ˜ì§‘í•œ ë“±ì¥ì¸ë¬¼ì…ë‹ˆë‹¤.</p>
    
    <button onclick="switchTab('deck')" class="absolute right-0 top-0 gacha-button bg-gray-700 hover:bg-gray-600 text-white text-xs px-3 py-1 rounded-full border border-gray-500 flex items-center gap-1">
        <span>ğŸ“</span> í¸ì°¬ìœ¼ë¡œ ì´ë™
    </button>

    <div class="mt-2 flex justify-center items-center gap-4">
        <p id="inventory-status" class="text-lg font-bold bg-black/20 py-2 px-4 rounded-full"></p>
        <button id="expand-inventory" class="gacha-button bg-yellow-500 hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold py-2 px-4 rounded-full shadow-lg text-sm">ì¹¸ í™•ì¥ (ğŸ’50)</button>
    </div>


		<div id="dismantle-multi-ui" class="hidden mt-4 bg-black/30 p-3 rounded-lg space-y-2">
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            <p class="text-sm text-gray-300">ì„ íƒëœ ì¹´ë“œ: <span id="selected-card-count" class="font-bold text-white">0ì¥</span></p>
            <button id="select-all-filtered-button" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-full text-sm">í•„í„°ëœ ì›ê³  ì „ì²´ ì„ íƒ</button>
        </div>
        <div class="flex items-center gap-2">
            <button id="exit-multi-mode" class="gacha-button bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-lg text-sm">ë‚˜ê°€ê¸°</button>
            <button id="dismantle-selected-button" class="gacha-button bg-red-600 hover:bg-red-700 disabled:opacity-50 text-white font-bold py-2 px-4 rounded-full shadow-lg text-sm" disabled>ì„ íƒëœ ì›ê³  íŒŒì‡„</button>
        </div>
    </div>
</div>
<div class="flex justify-center mt-4 mb-4">
    <button id="enter-multi-mode" class="gacha-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-lg">ì¼ê´„ íŒŒì‡„</button>
</div>

<div id="inventory-sort-buttons" class="mt-4 flex justify-center gap-2">
    <button data-sort="rarity" class="gacha-button sort-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">ë“±ê¸‰<span class="sort-indicator"></span></button>
    <button data-sort="level" class="gacha-button sort-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">í‡´ê³ <span class="sort-indicator"></span></button>
    <button data-sort="revision" class="gacha-button sort-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">ê°œì •<span class="sort-indicator"></span></button>
    <button data-sort="name" class="gacha-button sort-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">ì´ë¦„<span class="sort-indicator"></span></button>
</div>
		 
        <div id="inventory-filter-buttons" class="mt-2 flex justify-center gap-2">
    <button data-filter="All" class="gacha-button filter-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">ì „ì²´</button>
    <button data-filter="N" class="gacha-button filter-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">N</button>
    <button data-filter="R" class="gacha-button filter-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">R</button>
    <button data-filter="SR" class="gacha-button filter-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">SR</button>
    <button data-filter="SSR" class="gacha-button filter-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-4 rounded-full text-sm">SSR</button>
</div>
    </div>
    <div id="inventory-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[400px] max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
</div>

            <div id="deck-view" class="hidden">
                <div class="text-center mb-4 relative">
    <p class="text-gray-200">ë“±ì¥ì¸ë¬¼ë“¤ê³¼ í•¨ê»˜ ë…ì„œë¥¼ ì¤€ë¹„í•˜ì„¸ìš”. (5ì¥ í•„ìˆ˜)</p>
    
    <button onclick="switchTab('inventory')" class="absolute right-0 top-0 gacha-button bg-gray-700 hover:bg-gray-600 text-white text-xs px-3 py-1 rounded-full border border-gray-500 flex items-center gap-1">
        <span>ğŸ“š</span> ì„œê³ ë¡œ ì´ë™
    </button>

    <div class="mt-2 flex justify-center items-center gap-4">
        <div id="deck-status" class="text-lg font-bold text-yellow-300"></div>
        <button id="auto-fill-deck" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg text-sm">ìë™ í¸ì„±</button>
    </div>
</div>
                <div id="deck-slots-container" class="grid grid-cols-5 gap-4 mb-6 bg-black/20 p-4 rounded-xl"></div>
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-yellow-300">í™œì„± ì¸ì—° íš¨ê³¼</h3>
                    <div id="synergy-list" class="mt-2 text-gray-200 text-sm min-h-[24px]">
                        </div>
                </div>
				<div id="deck-inventory-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[250px] max-h-[40vh] overflow-y-auto bg-black/20 p-4 rounded-xl"></div>
            </div>
            
            <div id="combat-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">í¸ì°¬í•œ ì±…ìœ¼ë¡œ ë…ì„œì— ë„ì „í•˜ì—¬ ë³´ìƒì„ íšë“í•˜ì„¸ìš”!</p>
                    <p class="text-xl font-bold">í˜„ì¬ ì±… ì „íˆ¬ë ¥: <span id="deck-power-display" class="text-yellow-300">0</span></p>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <div id="chapter-list-container" class="md:w-1/3 space-y-2">
                        </div>
                    <div id="stage-list-container" class="md:w-2/3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 bg-black/20 p-2 rounded-xl">
                        </div>
                </div>
            </div>

            <div id="combat-in-progress-view" class="hidden">
                <div class="grid grid-cols-3 gap-4 items-center">
                    <div id="combat-player-deck" class="col-span-1 space-y-2"></div>
                    <div id="combat-monster-area" class="col-span-2 flex flex-col items-center"></div>
                </div>

                <div class="flex justify-end items-center gap-2 mt-4">
                    <button id="speed-1x" class="speed-button active bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-sm">1x</button>
                    <button id="speed-2x" class="speed-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-sm">2x</button>
                    <button id="speed-4x" class="speed-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-sm">4x</button>
                </div>
				<div class="flex justify-end items-center gap-2 mt-4">
    <button id="combat-run-button" class="gacha-button bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-1 px-3 rounded-full text-sm">í•­ë³µ</button>
    </div>
                <div id="combat-log-container" class="mt-2 bg-black/30 p-4 rounded-lg h-40 overflow-y-auto">
                    <div id="combat-log"></div>
                </div>
                 
            </div>

             <div id="collection-view" class="hidden">
    <div class="flex flex-col md:flex-row gap-4 min-h-[70vh]">
        <div class="md:w-1/4 bg-black/20 p-3 rounded-lg max-h-[70vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-yellow-300 mb-2 text-center">ë“±ì¥ì¸ë¬¼</h3>
            <div id="collection-character-list" class="space-y-1">
                </div>
        </div>
        
        <div id="collection-character-detail-view" class="md:w-3/4 bg-black/20 p-4 rounded-lg hidden">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <img id="collection-profile-image" src="" class="w-full md:w-1/3 rounded-lg shadow-lg">
                <div class="md:w-2/3">
                    <h2 id="collection-profile-name" class="text-3xl font-bold text-yellow-300"></h2>
                    <p class="text-lg mt-1"><span class="font-bold text-gray-400">ë‚˜ì´:</span> <span id="collection-profile-age"></span></p>
                    <p class="text-lg mt-1"><span class="font-bold text-gray-400">ì§ì—…:</span> <span id="collection-profile-job"></span></p>
                    <p class="text-sm mt-3 text-gray-300 leading-relaxed" id="collection-profile-description"></p>
                </div>
            </div>
            
            <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
                <button id="collection-sub-tab-cards" class="sub-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">ì¹´ë“œ ëª¨ìŒ</button>
                <button id="collection-sub-tab-dialogues" class="sub-tab-button w-1/2 font-bold py-2 px-6 rounded-full">ëŒ€ì‚¬ ëª¨ìŒ</button>
            </div>
            
            <div id="collection-cards-view">
                <div id="collection-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[40vh] overflow-y-auto bg-black/10 p-2 rounded-xl">
                    </div>
            </div>
            
            <div id="collection-dialogues-view" class="hidden">
                <div id="collection-dialogues-list" class="space-y-3 max-h-[40vh] overflow-y-auto bg-black/10 p-4 rounded-xl">
                    </div>
            </div>
        </div>
        
        <div id="collection-default-message" class="md:w-3/4 flex items-center justify-center bg-black/20 p-4 rounded-lg">
            <p class="text-2xl text-gray-400">ì™¼ìª½ì—ì„œ ë“±ì¥ì¸ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>
    </div>
</div>

			<div id="achievements-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">ë‹¤ì–‘í•œ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê³  íŠ¹ë³„í•œ ë³´ìƒì„ íšë“í•˜ì„¸ìš”.</p>
                </div>
                <div id="achievements-container" class="space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl">
                    </div>
            </div>
            
            <div id="story-view" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-gray-200">ë…ì„œë¥¼ í†µí•´ í•´ê¸ˆí•œ ìŠ¤í† ë¦¬ë¥¼ ì—´ëŒí•©ë‹ˆë‹¤.</p>
                </div>
			
                
                 <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
                    <button id="story-sub-tab-main" class="sub-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">ë©”ì¸ ìŠ¤í† ë¦¬</button>
                    <button id="story-sub-tab-stage" class="sub-tab-button w-1/2 font-bold py-2 px-6 rounded-full">ìŠ¤í…Œì´ì§€ ìŠ¤í† ë¦¬</button>
                </div>

                <div id="main-story-container" class="space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl">
                    </div>
                
                 <div id="stage-story-container" class="hidden space-y-3 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl">
                     </div>
            </div>
			
			<div id="trade-view" class="hidden">
    <div class="text-center mb-4">
        <p class="text-gray-200">ë‹¤ë¥¸ íƒì •ë“¤ê³¼ ë“±ì¥ì¸ë¬¼ì„ êµí™˜í•˜ì„¸ìš”.</p>
    </div>

    <div class="bg-black/20 rounded-full p-1 flex justify-center items-center mb-4 max-w-sm mx-auto">
        <button id="trade-sub-tab-market" class="sub-tab-button active w-1/2 font-bold py-2 px-6 rounded-full">ê±°ë˜ì†Œ ëª©ë¡</button>
        <button id="trade-sub-tab-register" class="sub-tab-button w-1/2 font-bold py-2 px-6 rounded-full">ê±°ë˜ ë“±ë¡</button>
    </div>

    <div id="trade-market-view">
        <div class="flex justify-end mb-2">
            <button onclick="loadTradeList()" class="text-sm text-blue-300 hover:text-white">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="trade-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto bg-black/20 p-4 rounded-xl">
            </div>
    </div>

    <div id="trade-register-view" class="hidden">
        <div class="bg-black/30 p-4 rounded-lg mb-4">
            <h3 class="text-yellow-300 font-bold mb-2">1ë‹¨ê³„: ë³´ë‚¼ ì¹´ë“œ ì„ íƒ</h3>

<div id="trade-filter-buttons" class="flex flex-wrap gap-2 mb-2">
    <button data-filter="All" class="trade-filter-button bg-blue-500 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-blue-600 transition-colors">ì „ì²´</button>
    <button data-filter="N" class="trade-filter-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-gray-700 transition-colors">N</button>
    <button data-filter="R" class="trade-filter-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-gray-700 transition-colors">R</button>
    <button data-filter="SR" class="trade-filter-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-gray-700 transition-colors">SR</button>
    <button data-filter="SSR" class="trade-filter-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-gray-700 transition-colors">SSR</button>
</div>

<div id="trade-inventory-container" class="grid grid-cols-4 sm:grid-cols-5 gap-2 max-h-60 overflow-y-auto bg-black/20 p-2 rounded mb-4">
</div>
            
            <div id="trade-selected-card-preview" class="hidden text-center mb-4 border border-blue-500 p-2 rounded">
                <p class="text-gray-300 text-sm">ì„ íƒëœ ì¹´ë“œ</p>
                <p id="trade-selected-name" class="font-bold text-xl text-white"></p>
            </div>

            <h3 class="text-green-300 font-bold mb-2">2ë‹¨ê³„: ì›í•˜ëŠ” ì¹´ë“œ ì„ íƒ</h3>

<div class="flex flex-col gap-3 mb-4">
    <div>
        <label class="text-xs text-gray-400 ml-1">ë“±ì¥ì¸ë¬¼</label>
        <select id="trade-target-basename" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600 focus:border-blue-500 outline-none">
            <option value="">ë“±ì¥ì¸ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
    </div>

    <div class="flex gap-2">
        <div class="w-1/3">
            <label class="text-xs text-gray-400 ml-1">ë“±ê¸‰</label>
            <select id="trade-target-rarity-select" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600 focus:border-blue-500 outline-none" disabled>
                <option value="">-</option>
            </select>
        </div>

        <div class="w-2/3">
            <label class="text-xs text-gray-400 ml-1">ì¹´ë“œ (ì¹­í˜¸ í¬í•¨)</label>
            <select id="trade-target-specific-card" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600 focus:border-blue-500 outline-none" disabled>
                <option value="">-</option>
            </select>
        </div>
    </div>
</div>

<p class="text-xs text-gray-400 mb-4">* ì„ íƒí•œ ì¹´ë“œë¥¼ ì •í™•íˆ êµ¬í•˜ëŠ” ê±°ë˜ê°€ ë“±ë¡ë©ë‹ˆë‹¤.</p>

<button id="btn-register-trade" class="gacha-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 w-full rounded-full shadow-lg">
    ê±°ë˜ ë“±ë¡í•˜ê¸° (ìˆ˜ìˆ˜ë£Œ: ğŸ’10)
</button>
        </div>
        
        <div class="mt-8">
            <h3 class="text-white font-bold mb-2">ë‚´ê°€ ë“±ë¡í•œ ê±°ë˜</h3>
            <div id="my-trade-list" class="space-y-2"></div>
        </div>
    </div>
</div>

<div id="profile-view" class="hidden">
    <div class="text-center mb-6">
        <p class="text-gray-200">ë‹¤ë¥¸ íƒì •ë“¤ì—ê²Œ ë³´ì—¬ì§ˆ ë‹¹ì‹ ì˜ í”„ë¡œí•„ì„ ì„¤ì •í•˜ì„¸ìš”.</p>
    </div>

    <div class="flex flex-col md:flex-row gap-6 items-start justify-center max-w-4xl mx-auto">
        
        <div class="w-full md:w-1/3 flex flex-col items-center">
            <div class="relative w-full aspect-[2/3] bg-black/30 rounded-lg overflow-hidden border-2 border-gray-600 shadow-xl mb-4 group cursor-pointer" onclick="openProfileCardSelector()">
                <img id="profile-rep-image" src="https://placehold.co/400x600/000000/ffffff?text=No+Card" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="text-white font-bold border border-white px-4 py-2 rounded-full">ì¹´ë“œ ë³€ê²½</span>
                </div>
            </div>
            <p class="text-yellow-300 font-bold text-lg" id="profile-rep-name">ì„ íƒëœ ì¹´ë“œ ì—†ìŒ</p>
        </div>

        <div class="w-full md:w-2/3 bg-black/20 p-6 rounded-xl space-y-6">
            
            <div>
                <label class="block text-gray-400 text-sm font-bold mb-2">ë‹‰ë„¤ì„</label>
                <input type="text" id="profile-nickname-edit" class="w-full bg-gray-700 text-white border border-gray-600 rounded p-3 focus:outline-none focus:border-blue-500 font-bold text-lg" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div>
                <label class="block text-gray-400 text-sm font-bold mb-2">í•œë§ˆë”” (ìµœëŒ€ 50ì)</label>
                <textarea id="profile-message-edit" maxlength="50" rows="3" class="w-full bg-gray-700 text-white border border-gray-600 rounded p-3 focus:outline-none focus:border-blue-500 resize-none" placeholder="ìì‹ ì„ ì†Œê°œí•˜ëŠ” í•œë§ˆë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                <p class="text-right text-xs text-gray-500 mt-1"><span id="profile-msg-count">0</span>/50</p>
            </div>

            <button onclick="saveProfileData()" class="gacha-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                í”„ë¡œí•„ ì €ì¥
            </button>

            <div class="mt-12 pt-6 border-t border-gray-600">
                <h4 class="text-red-400 font-bold mb-2 text-sm flex items-center gap-2">
                    <span>âš  ìœ„í—˜ êµ¬ì—­</span>
                </h4>
                <p class="text-xs text-gray-500 mb-3">
                    ê³„ì •ì„ ì´ˆê¸°í™”í•˜ë©´ ëª¨ë“  ë°ì´í„°(ì¹´ë“œ, ì¬í™”, ì¹œêµ¬ ë“±)ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.
                </p>
                <button id="reset-game" class="gacha-button w-full bg-red-900/50 hover:bg-red-700 border border-red-600 text-red-100 font-bold py-3 rounded-lg shadow-lg text-sm transition-all" data-confirming="false">
                    ê³„ì • ì´ˆê¸°í™”
                </button>
            </div>

        </div>
    </div>
</div>

<div id="profile-card-selector-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-3xl w-full max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">í”„ë¡œí•„ ëŒ€í‘œ ì¹´ë“œ ì„ íƒ</h3>
            <button onclick="document.getElementById('profile-card-selector-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        
        <div id="profile-card-list" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 overflow-y-auto p-2 bg-black/20 rounded-lg">
            </div>
    </div>
</div>
<div id="friends-view" class="hidden">
    <div class="text-center mb-6">
        <p class="text-gray-200">ë™ë£Œ íƒì •ì„ ì°¾ì•„ ì„œê³ ë¥¼ êµ¬ê²½í•´ë³´ì„¸ìš”.</p>
    </div>

    <div class="flex flex-col md:flex-row gap-6 h-[70vh]">
        
        <div class="md:w-1/3 bg-black/20 p-4 rounded-xl flex flex-col h-full">
            
            <div id="friend-request-section" class="hidden mb-4 border-b border-gray-600 pb-2">
                <h3 class="text-sm font-bold text-pink-400 mb-2 flex items-center gap-2">
                    ğŸ“© ë„ì°©í•œ ìš”ì²­ <span id="request-count" class="bg-red-500 text-white text-[10px] px-1.5 rounded-full">0</span>
                </h3>
                <div id="friend-request-list" class="space-y-2 max-h-40 overflow-y-auto">
                    </div>
            </div>
            <h3 class="text-xl font-bold text-yellow-300 mb-4">ë‚´ ì¹œêµ¬ ëª©ë¡</h3>
            <div id="friend-list-container" class="flex-1 overflow-y-auto space-y-2 pr-2">
                <p class="text-center text-gray-500 mt-10">ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div class="md:w-2/3 bg-black/20 p-4 rounded-xl">
            <h3 class="text-xl font-bold text-blue-300 mb-4">íƒì • ê²€ìƒ‰</h3>
            <div class="flex gap-2 mb-6">
                <input type="text" id="friend-search-input" placeholder="ë‹‰ë„¤ì„ ì •í™•íˆ ì…ë ¥" class="flex-1 bg-gray-700 text-white px-4 py-3 rounded-lg border border-gray-600 focus:border-blue-500 outline-none">
                <button onclick="searchUserByName()" class="gacha-button bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-lg font-bold">ê²€ìƒ‰</button>
            </div>
            
            <div id="friend-search-result" class="hidden bg-gray-800 p-4 rounded-lg border border-gray-600 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img id="search-result-img" src="" class="w-12 h-12 rounded bg-black object-cover">
                    <div>
                        <p id="search-result-name" class="font-bold text-white text-lg"></p>
                        <p id="search-result-msg" class="text-xs text-gray-400 italic"></p>
                    </div>
                </div>
                <div id="search-result-action"></div>
            </div>
            <p id="friend-search-msg" class="text-center text-gray-400 mt-4"></p>
        </div>

    </div>
</div>

<div id="visit-mode-overlay" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-40 flex flex-col items-center animate-bounce">
    
    <button onclick="exitVisitMode()" class="gacha-button bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-full font-bold shadow-lg border-2 border-white">
        ë‚´ ì‚¬ë¬´ì†Œë¡œ ëŒì•„ê°€ê¸°
    </button>
</div>
            
            <div id="myroom-view" class="hidden">
				<div id="furniture-shop-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full relative">
        <button id="close-furniture-shop" class="absolute top-3 right-4 text-white text-3xl font-bold hover:text-gray-400">&times;</button>
        
        <h3 class="text-2xl font-bold text-yellow-300 mb-4">ê°€êµ¬ ìƒì </h3>
        <p class="text-gray-400 mb-4 text-sm">ë³´ì„ì„ ì‚¬ìš©í•˜ì—¬ íƒì • ì‚¬ë¬´ì†Œë¥¼ ê¾¸ë°€ ê°€êµ¬ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”.</p>
        
        <div id="furniture-list" class="grid grid-cols-3 sm:grid-cols-4 gap-4 max-h-96 overflow-y-auto mb-4 bg-black/20 p-4 rounded-lg min-h-[100px]">
        </div>
    </div>
</div>
                <div class="text-center mb-4">
                    <p class="text-gray-200">íƒì • ì‚¬ë¬´ì†Œë¥¼ ê¾¸ë¯¸ê³  ë“±ì¥ì¸ë¬¼ë“¤ì˜ íœ´ì‹ì„ ì§€ì¼œë³´ì„¸ìš”.</p>
                </div>

                <div class="room-wrapper">
    <div id="room-container">
        
        <div class="absolute inset-0 bg-contain bg-center bg-no-repeat" style="background-image: url('https://i.imgur.com/CklaT1l.png');"></div>
        
        <div class="iso-floor"></div>
        
        <div id="room-layer" class="relative w-full h-full z-10 pointer-events-none">
            <style> #room-layer > * { pointer-events: auto; } </style>
        </div>

    </div>
</div>

                <div class="flex justify-center gap-4 mt-6">
    <button onclick="openMyRoomCharacterSelector()" class="gacha-button bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-6 rounded-full">ğŸ‘¥ ì…ì£¼ ê´€ë¦¬</button>
    
    <button id="open-furniture-shop" onclick="openFurnitureShop()" class="gacha-button bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-6 rounded-full">ğŸª‘ ê°€êµ¬ ìƒì </button>
    <button id="open-furniture-storage" class="hidden gacha-button bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-full">ğŸ“¦ ë³´ê´€í•¨</button>
    <button id="myroom-edit-mode" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">ğŸ”¨ ë°°ì¹˜ ëª¨ë“œ</button>
</div>

<div id="furniture-storage-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full">
        <h3 class="text-2xl font-bold text-purple-300 mb-4">ê°€êµ¬ ë³´ê´€í•¨</h3>
        <p class="text-gray-400 mb-4 text-sm">ë°°ì¹˜í•˜ì§€ ì•Šì€ ê°€êµ¬ë“¤ì´ ì—¬ê¸°ì— ë³´ê´€ë©ë‹ˆë‹¤.</p>
        
        <div id="storage-list" class="grid grid-cols-3 gap-4 max-h-96 overflow-y-auto mb-4 bg-black/20 p-4 rounded-lg min-h-[100px]">
            </div>
        
        <button id="close-furniture-storage" class="gacha-button bg-red-500 text-white py-2 px-4 rounded-full w-full">ë‹«ê¸°</button>
    </div>
</div>
            </div>

            <div id="toast-notification" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-yellow-400 text-black font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 z-50">
                ğŸ‰ ì—…ì  ë‹¬ì„±!
            </div>


            <div id="card-detail-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-30">
    <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full relative mx-4 max-h-[90vh] overflow-y-auto">
        <button id="close-card-detail" class="absolute top-3 right-4 text-white text-3xl font-bold hover:text-gray-400">&times;</button>
        
        <div class="flex flex-col gap-4">
            <div class="w-full md:w-3/5 mx-auto">
                <img id="detail-card-image" src="" alt="Card Image" class="w-full rounded-lg shadow-lg">
            </div>

            <div class="w-full">
                <h2 id="detail-card-name" class="text-3xl font-bold text-center"></h2>
                <div class="flex items-center justify-center gap-4 my-4">
                    <p id="detail-card-rarity" class="font-bold text-2xl"></p>
                    <p id="detail-card-faction" class="font-bold text-lg px-3 py-1 rounded-full"></p>
                </div>

                <div id="enhancement-container" class="bg-black/20 p-4 rounded-lg">
                    <h3 class="font-bold text-lg mb-2 text-yellow-300">ë“±ì¥ì¸ë¬¼ í‡´ê³ </h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <p>í˜„ì¬ í‡´ê³ : <span id="detail-card-level" class="font-bold text-xl"></span></p>
                            <p id="enhancement-preview" class="text-sm text-green-400"></p>
                        </div>
                        <button id="enhance-card-button" class="gacha-button bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-full shadow-lg">
                            í‡´ê³ í•˜ê¸°
                            <span id="enhancement-cost" class="block text-xs"></span>
                        </button>
                    </div>
                </div>
                
                <div id="revision-container" class="mt-4 bg-black/20 p-4 rounded-lg">
    <h3 class="font-bold text-lg mb-2 text-yellow-300">ê°œì •íŒ ì œì‘</h3>
    
    <div class="flex justify-between items-center mb-2">
        <p>í˜„ì¬ ë‹¨ê³„: <span id="detail-card-revision" class="font-bold text-xl text-white"></span></p>
        <p id="revision-preview" class="text-sm text-green-400"></p>
    </div>

    <div class="mb-3 border-b border-gray-600 pb-3">
        <p class="text-xs text-gray-400 mb-1">ë°©ë²• 1: ë™ì¼í•œ ì›ê³ (ì¹´ë“œ) ì‚¬ìš©</p>
        <div class="flex gap-2">
            <select id="revision-material-select" class="flex-1 bg-gray-700 text-white p-2 rounded border border-gray-600 text-sm">
                <option value="">ì›ë³¸ ì¹´ë“œ ì„ íƒ</option>
            </select>
            <button id="revise-card-button" class="gacha-button bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-1 px-4 rounded shadow-lg text-sm whitespace-nowrap">
                í•©ì¹˜ê¸°
            </button>
        </div>
    </div>

    <div>
        <p class="text-xs text-gray-400 mb-1">ë°©ë²• 2: íŠ¹ìˆ˜ ì‰í¬ ì‚¬ìš©</p>
        <div class="flex justify-between items-center bg-fuchsia-900/30 p-2 rounded border border-fuchsia-500/30">
            <div class="text-sm">
                <span class="text-fuchsia-300 font-bold">ğŸ’§ ì‰í¬ë³‘</span>
                <span id="inkwell-cost-display" class="text-white ml-1">0 / 0</span>
            </div>
            <button id="revise-with-inkwell-button" class="gacha-button bg-fuchsia-600 hover:bg-fuchsia-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-1 px-4 rounded shadow-lg text-sm whitespace-nowrap">
                ì‚¬ìš©í•˜ê¸°
            </button>
        </div>
    </div>
</div>

				<div id="publication-container" class="hidden mt-4 bg-gradient-to-r from-indigo-900 to-purple-900 p-4 rounded-lg border border-yellow-400/30">
    <div class="flex justify-between items-center">
        <div>
            <h3 class="font-bold text-xl text-yellow-300 mb-1">âœ¨ ì •ì‹ ì¶œíŒ</h3>
            <p class="text-sm text-gray-300">ì™„ë²½í•´ì§„ ì›ê³ ë¥¼ ìƒìœ„ ë“±ê¸‰ìœ¼ë¡œ ì¶œíŒí•©ë‹ˆë‹¤.</p>
            <p id="publication-target-name" class="text-sm font-bold text-white mt-1">Target: ???</p>
        </div>
        <button id="publish-card-button" class="gacha-button bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 px-6 rounded-full shadow-[0_0_15px_rgba(234,179,8,0.5)] transition-all transform hover:scale-105">
            ì¶œíŒí•˜ê¸°
        </button>
    </div>
</div>

                <div class="mt-4 bg-black/20 p-3 rounded-lg">
                    <h3 class="font-bold text-lg mb-2 text-yellow-300">ëŠ¥ë ¥ì¹˜</h3>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div><p class="text-sm text-gray-400">HP</p><p id="detail-stat-hp" class="font-bold text-lg"></p></div>
                        <div><p class="text-sm text-gray-400">ATK</p><p id="detail-stat-atk" class="font-bold text-lg"></p></div>
                        <div><p class="text-sm text-gray-400">DEF</p><p id="detail-stat-def" class="font-bold text-lg"></p></div>
                    </div>
                </div>
                <div class="mt-4 bg-black/20 p-3 rounded-lg">
                    <h3 class="font-bold text-lg mb-2 text-yellow-300">ìŠ¤í‚¬</h3>
                    <div id="detail-skills-container" class="space-y-3"></div>
                </div>
            </div>
        </div>
        
        <div id="detail-card-story-container" class="mt-4 bg-black/20 p-4 rounded-lg">
            <h3 class="font-bold text-lg mb-2 text-yellow-300">ë“±ì¥ì¸ë¬¼ ìŠ¤í† ë¦¬</h3>
            <div id="detail-card-story" class="text-gray-300 text-sm story-content h-24 overflow-y-auto"></div>
            <div id="detail-story-pagination" class="flex justify-center items-center mt-2">
                <button id="detail-story-prev" class="gacha-button text-white font-bold py-1 px-4 rounded-full text-sm">&lt; ì´ì „</button>
                <span id="detail-story-page-indicator" class="mx-4 text-sm"></span>
                <button id="detail-story-next" class="gacha-button text-white font-bold py-1 px-4 rounded-full text-sm">ë‹¤ìŒ &gt;</button>
            </div>
        </div>

        <div id="dismantle-container" class="mt-4 bg-red-800/20 p-4 rounded-lg flex justify-between items-center">
            <p class="font-bold text-md text-red-300">íŒŒì‡„ (ì¬ë£Œ íšŒìˆ˜)</p>
            <button id="dismantle-card-button" class="gacha-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg text-sm">
                íŒŒì‡„í•˜ê¸°
            </button>
        </div>
    </div>
</div>

<div id="gacha-pool-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
    <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full relative h-[80vh] flex flex-col border border-yellow-500/50">
        <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
            <h3 id="pool-modal-title" class="text-2xl font-bold text-yellow-300">íšë“ ê°€ëŠ¥ ëª©ë¡</h3>
            <button onclick="document.getElementById('gacha-pool-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-3xl">&times;</button>
        </div>
        <div id="pool-list-container" class="flex-1 overflow-y-auto space-y-4 bg-black/20 p-4 rounded-lg">
            </div>
    </div>
</div>

<div id="mailbox-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full relative border border-indigo-400 h-[80vh] flex flex-col">
        
        <button onclick="document.getElementById('mailbox-modal').classList.add('hidden')" class="absolute top-3 right-4 text-gray-400 hover:text-white text-3xl font-bold z-10">&times;</button>
        
        <div class="flex justify-between items-center mb-2 border-b border-gray-600 pb-2 mr-8">
            <h3 class="text-2xl font-bold text-indigo-300 flex items-center gap-2">
                <span>ğŸ“©</span> ìš°í¸í•¨
            </h3>
        </div>

        <p class="text-gray-400 text-xs mb-2 text-center">* ìš°í¸ì€ ìµœëŒ€ 30ì¼ê°„ ë³´ê´€ë©ë‹ˆë‹¤.</p>
        
        <div id="mailbox-list" class="flex-1 overflow-y-auto space-y-2 bg-black/20 p-2 rounded-lg pr-2 mb-4">
            </div>

        <div class="mt-auto border-t border-gray-600 pt-4 flex justify-center">
            <button onclick="claimAllMails()" class="gacha-button bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-10 rounded-full text-lg shadow-lg w-full md:w-auto transform transition-transform hover:scale-105">
                ğŸ ëª¨ë‘ ë°›ê¸°
            </button>
        </div>

    </div>
</div>
            
            <div id="dismantle-result-modal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-40">
                <div class="bg-gray-800 p-8 rounded-lg text-center max-w-sm w-full">
                    <h2 class="text-3xl font-bold mb-4 text-yellow-300">ì›ê³  íŒŒì‡„ ê²°ê³¼</h2>
                    <p class="text-lg mb-6 text-gray-300">íŒŒì‡„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    
                    <div id="dismantle-rewards-list" class="space-y-3 mb-6 bg-black/30 p-4 rounded-lg">
                        </div>

                    <button id="close-dismantle-result" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">í™•ì¸</button>
                </div>
            </div>
            
            <div id="interactive-story-modal" class="hidden fixed inset-0 bg-black/50 flex flex-col justify-end z-40">
                <div id="story-character-display" class="absolute inset-0 flex justify-center md:justify-between items-end md:px-10 overflow-hidden">
                    <img id="story-char-left" src="" class="h-2/3 md:h-5/6 object-contain transition-opacity duration-300 opacity-0">
                    <img id="story-char-right" src="" class="h-2/3 md:h-5/6 object-contain transition-opacity duration-300 opacity-0">
                </div>
                
                <div id="dialogue-box" class="relative bg-black/70 backdrop-blur-sm m-4 p-5 rounded-xl border border-white/20 text-white z-10">
                    <h3 id="speaker-name" class="font-bold text-2xl text-yellow-300 mb-2"></h3>
                    <p id="dialogue-text" class="text-lg leading-relaxed h-24"></p>
                    <div id="choice-buttons-container" class="mt-4 flex flex-col items-center gap-2"></div>
                    <button id="story-next-button" class="absolute bottom-4 right-5 text-xl animate-pulse">â–¼ ë‹¤ìŒ</button>
                </div>
                <button id="story-skip-button" class="absolute top-5 right-5 bg-black/50 text-white py-2 px-4 rounded-full z-20">ìŠ¤í‚µ</button>
            </div>

            <div id="choice-stats-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
                <div class="bg-gray-800 p-8 rounded-lg max-w-md w-full text-center">
                    <h2 class="text-2xl font-bold text-yellow-300 mb-6">ë‹¤ë¥¸ íƒì •ë“¤ì˜ ì„ íƒ</h2>
                    <div id="stats-container" class="space-y-4">
                        </div>
                    <button id="close-stats-modal" class="gacha-button mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">í™•ì¸</button>
                </div>
            </div>

			<div id="trade-select-card-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full relative border border-gray-600">
        <h3 class="text-2xl font-bold text-yellow-300 mb-2">ë³´ë‚¼ ì¹´ë“œ ì„ íƒ</h3>
        <p class="text-gray-400 mb-4 text-sm">ì¡°ê±´ì— ë§ëŠ” ì¹´ë“œê°€ ì—¬ëŸ¬ ì¥ ìˆìŠµë‹ˆë‹¤.<br>ìƒëŒ€ë°©ì—ê²Œ ë³´ë‚¼ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        
        <div id="trade-select-list" class="grid grid-cols-3 sm:grid-cols-4 gap-4 max-h-96 overflow-y-auto mb-4 bg-black/20 p-4 rounded-lg">
        </div>
        
        <button onclick="document.getElementById('trade-select-card-modal').classList.add('hidden')" class="gacha-button bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-full w-full font-bold">ì·¨ì†Œ</button>
    </div>
</div>

<div id="myroom-char-selector-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full h-[80vh] flex flex-col border border-pink-400">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-bold text-pink-300">ë§ˆì´ë£¸ ì…ì£¼ë¯¼ ì„¤ì •</h3>
            <span id="myroom-selected-count" class="text-white font-bold bg-pink-600 px-3 py-1 rounded-full text-sm">0 / 5</span>
        </div>
        <p class="text-gray-400 text-sm mb-2 text-center">ì‚¬ë¬´ì†Œì— ë¨¸ë¬¼ê²Œ í•  ë“±ì¥ì¸ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”. (ìµœëŒ€ 5ëª…)</p>
        
        <div id="myroom-filter-container" class="flex justify-center gap-2 mb-4">
            <button data-filter="All" class="myroom-filter-btn gacha-button bg-blue-500 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-blue-600">ì „ì²´</button>
            <button data-filter="SSR" class="myroom-filter-btn gacha-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-gray-700">SSR</button>
            <button data-filter="SR" class="myroom-filter-btn gacha-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-gray-700">SR</button>
            <button data-filter="R" class="myroom-filter-btn gacha-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-gray-700">R</button>
            <button data-filter="N" class="myroom-filter-btn gacha-button bg-gray-600 text-white font-bold py-1 px-3 rounded-full text-xs hover:bg-gray-700">N</button>
        </div>

        <div id="myroom-char-list" class="grid grid-cols-4 sm:grid-cols-5 gap-3 overflow-y-auto p-2 bg-black/20 rounded-lg flex-grow">
            </div>

        <div class="flex gap-2 mt-4">
            <button onclick="saveMyRoomCharacters()" class="flex-1 gacha-button bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg shadow-lg">ì €ì¥í•˜ê¸°</button>
            <button onclick="document.getElementById('myroom-char-selector-modal').classList.add('hidden')" class="w-1/4 gacha-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">ì·¨ì†Œ</button>
        </div> </div> 
		<div id="combat-result-modal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-[9999]">
                    <div class="bg-gray-800 p-8 rounded-lg text-center">
                        <h2 id="combat-result-title" class="text-4xl font-bold mb-4"></h2>
                        <p id="combat-result-message" class="text-lg mb-6"></p>
                        <button id="close-combat-result" class="gacha-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">í™•ì¸</button>
                    </div>
                </div>
		</main> </div> <script src="yumecan_data.js"></script>
	
    <script>
	
	const firebaseConfig = {
        apiKey: "AIzaSyDNradWwvrFqZHbmlfavgiN8a7ll_Jb2Sg",
        authDomain: "kside-5db33.firebaseapp.com",
        projectId: "kside-5db33",
        storageBucket: "kside-5db33.appspot.com",
        messagingSenderId: "381837651487",
        appId: "1:381837651487:web:447bff3a3f83abbde66f2a",
    };

    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth(); // ì¸ì¦ ì„œë¹„ìŠ¤ ë³€ìˆ˜ ì¶”ê°€

    let currentCombatIndices = null; 
let currentCombatType = null;
raidBossDataSheet = null;
let currentCollectionGroup = 'íˆì–´ë¡œ ëŒ€ ë¹ŒëŸ°: ê°ì¶•ì „';
	// â–¼â–¼â–¼ [ìˆ˜ì •] ë„ê° ê·¸ë£¹ ê´€ë¦¬ ë³€ìˆ˜ â–¼â–¼â–¼
let currentCollectionSelection = null;
// íƒ­ìœ¼ë¡œ ë§Œë“¤ ê·¸ë£¹ ëª©ë¡ (ìˆœì„œëŒ€ë¡œ ë‚˜ì˜µë‹ˆë‹¤)
const COLLECTION_GROUPS = ['íˆì–´ë¡œ ëŒ€ ë¹ŒëŸ°: ê°ì¶•ì „', 'ì‚¬ì œì™€ ì•…ë§ˆ: ê³ í•´ì†Œ', 'NPC'];

    // DOMì´ ëª¨ë‘ ë¡œë“œëœ í›„ ê²Œì„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', async () => {
	document.body.classList.add('loading');
	const eventSubTabBattle = document.getElementById('event-sub-tab-battle');
        const eventSubTabRaid = document.getElementById('event-sub-tab-raid');
        const eventSubTabStory = document.getElementById('event-sub-tab-story');
        const eventSubTabShop = document.getElementById('event-sub-tab-shop'); // âœ¨ ì´ì œ shop ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
		// âœ¨ [ì‹ ê·œ] ì „íˆ¬ í•­ë³µ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
document.getElementById('combat-run-button').addEventListener('click', () => {
    if (confirm("ì •ë§ë¡œ í•­ë³µí•˜ê³  ë…ì„œë¥¼ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒ¨ë°° ì²˜ë¦¬ë©ë‹ˆë‹¤)")) {
        fleeCombat();
    }
});
	await loadGameData();
	checkEndedEvents();
	const exitMultiModeButton = document.getElementById('exit-multi-mode');
    const enterMultiModeButton = document.getElementById('enter-multi-mode');

        // --- ì¸ì¦ ìƒíƒœ ê°ì§€ ë¦¬ìŠ¤ë„ˆ ---
        auth.onAuthStateChanged(user => {
            const loginView = document.getElementById('login-view');
            const loggedInView = document.getElementById('logged-in-view');
            
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                loggedInView.classList.remove('hidden');
                document.getElementById('nickname-display').textContent = user.displayName || user.email;

                loadGameFromFirebase(user.uid);
                
                // âœ¨ [ì¶”ê°€] ì¹œêµ¬ ìš”ì²­ ì‹¤ì‹œê°„ ê°ì‹œ ì‹œì‘
                startFriendListener(user.uid);
				startMailListener(user.uid);
				startPeriodicMailCheck(user.uid);
				startTradeListener(user.uid);

            } else {
                // --- ìœ ì €ê°€ ë¡œê·¸ì•„ì›ƒí–ˆì„ ë•Œ ---
                currentUser = null;
                loginView.classList.remove('hidden');
                loggedInView.classList.add('hidden');
				startBookmarkRegenTimer();
                
                // ================== ğŸ‘‡ 4. ë¡œë”© ìƒíƒœ ë¹„í™œì„±í™” ğŸ‘‡ ==================
                // ë¡œë”© í™”ë©´ì„ ìˆ¨ê²¨ì„œ ë¡œê·¸ì¸/íšŒì›ê°€ì…ì„ í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
                document.getElementById('loading-overlay').classList.add('hidden');
                document.body.classList.remove('loading');
                // ===============================================================
				
				if (window.mailCheckInterval) clearInterval(window.mailCheckInterval);
            }
        });
		
		


	// gacha3.html - downloadSaveData í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ì „ì²´ êµì²´)

function downloadSaveData() {
    const saveDataString = localStorage.getItem(SAVE_DATA_KEY);
    if (!saveDataString) {
        showMessage('ì €ì¥ëœ ê²Œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!', 'text-red-400', messageArea);
        return;
    }

    try {
        // 1. ì €ì¥ëœ JSON ë¬¸ìì—´ì„ UTF-8 ì•ˆì „ Base64ë¡œ ì¸ì½”ë”©
        const encodedData = utf8_to_b64(saveDataString); // âœ¨ ìˆ˜ì •ëœ í•¨ìˆ˜ ì‚¬ìš© âœ¨

        // 2. íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        const blob = new Blob([encodedData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // íŒŒì¼ëª…: Kside_Save_20251019.txt (í˜„ì¬ ë‚ ì§œ ì‚¬ìš©)
        const now = new Date();
        const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        a.download = `Kside_Save_${dateString}.txt`;
        
        // 3. ìš”ì†Œ ì¶”ê°€, í´ë¦­, ì œê±° ë° URL í•´ì œ
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('ê²Œì„ ë°ì´í„°ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.'); // âœ… ì´ ì½”ë“œê°€ ì‚¬ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    } catch (e) {
        console.error("ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
        alert("ë°ì´í„° ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì˜¤ë¥˜: ì½˜ì†” í™•ì¸)");
    }
}

			function utf8_to_b64(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
        function toSolidBytes(match, p1) {
            return String.fromCharCode('0x' + p1);
    }));
}

// Base64ë¥¼ UTF-8 ë¬¸ìì—´ë¡œ ì•ˆì „í•˜ê²Œ ë””ì½”ë”©í•˜ëŠ” í•¨ìˆ˜ (í•œê¸€ ì²˜ë¦¬)
function b64_to_utf8(str) {
    return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
}
			
			function uploadSaveData(file) {
    const reader = new FileReader();
    
    reader.onload = function(event) {
        try {
            let encodedData = event.target.result;
            
            // âœ¨ í•µì‹¬ ìˆ˜ì •: ì–‘ìª½ ëì˜ ê³µë°±, ì¤„ë°”ê¿ˆ ë“±ì„ ì œê±°í•˜ì—¬ ë°ì´í„° í´ë¦¬ë‹ âœ¨
            encodedData = encodedData.trim();
            
            // 1. Base64 ì•ˆì „ ë””ì½”ë”©
            const jsonString = b64_to_utf8(encodedData); 
            
            // 2. JSON íŒŒì‹± í…ŒìŠ¤íŠ¸ (ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬)
            const parsedData = JSON.parse(jsonString); 
            
            // 3. ìœ íš¨ì„± ì¶”ê°€ í™•ì¸ (ì˜ˆ: ì¸ë²¤í† ë¦¬ í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸)
            if (!parsedData || !Array.isArray(parsedData.inventory)) {
                throw new Error("íŒŒì‹±ëœ ë°ì´í„° êµ¬ì¡°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
            
            // 4. ìœ íš¨í•œ ë°ì´í„°ì´ë¯€ë¡œ localStorageì— ì €ì¥í•˜ê³  ë¡œë“œ
            localStorage.setItem(SAVE_DATA_KEY, jsonString);
            
            alert("ë°ì´í„° ë¡œë“œ ì„±ê³µ! ê²Œì„ì´ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.");
            location.reload();

        } catch (e) {
            console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
            alert(`âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ì €ì¥ íŒŒì¼ì…ë‹ˆë‹¤. ì˜¤ë¥˜: ${e.message}`);
            // showMessageëŠ” ì´ ì‹œì ì—ì„œ DOMì´ ìƒˆë¡œ ë¡œë“œë˜ê¸° ë•Œë¬¸ì— ì˜ë¯¸ ì—†ìŠµë‹ˆë‹¤.
            // alertë§Œ í‘œì‹œí•˜ê³  ëëƒ…ë‹ˆë‹¤.
        }
    };
    
    reader.onerror = function() {
        alert("íŒŒì¼ì„ ì½ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    };

    // FileReaderëŠ” ì´ ì‹œì ì—ë§Œ í˜¸ì¶œë©ë‹ˆë‹¤.
    reader.readAsText(file);
}
		const SAVE_DATA_KEY = 'gachaGameSaveData_v9';
const GRID_SIZE = 100; 
    const TILE_WIDTH_PERCENT = 9;  
    const TILE_HEIGHT_PERCENT = 5;
            

            // --- ê²Œì„ ìƒíƒœ ---
	// âœ¨ [ì‹ ê·œ] ë“±ê¸‰ë³„ ì‰í¬ë³‘ ê°œì • ë¹„ìš© (ì‰í¬ë³‘ ëª‡ ê°œë¡œ ê°œì •í•  ìˆ˜ ìˆëŠ”ì§€)
const INKWELL_REVISION_COSTS = {
    'N': 1,    // N ë“±ê¸‰ì€ 1ê°œ
    'R': 3,    // R ë“±ê¸‰ì€ 3ê°œ
    'SR': 5,   // SR ë“±ê¸‰ì€ 5ê°œ
    'SSR': 10  // SSR ë“±ê¸‰ì€ 10ê°œ (ê°€ì¥ ë¹„ìŒˆ)
};

// âœ¨ [ì‹ ê·œ] ë ˆì´ë“œ í† ë²Œ ë³´ìƒ ì„¤ì •
const RAID_RANK_REWARDS = {
    1: { currency: 1000, fountainPens: 500, title: "ë ˆì´ë“œ ê¸°ì—¬ë„ 1ìœ„ ë³´ìƒ" },
    2: { currency: 700, fountainPens: 300, title: "ë ˆì´ë“œ ê¸°ì—¬ë„ 2ìœ„ ë³´ìƒ" },
    3: { currency: 500, fountainPens: 200, title: "ë ˆì´ë“œ ê¸°ì—¬ë„ 3ìœ„ ë³´ìƒ" },
    top5: { currency: 300, fountainPens: 100, title: "ë ˆì´ë“œ ê¸°ì—¬ë„ Top 5 ë³´ìƒ" }, // 4~5ìœ„
    participation: { currency: 100, fountainPens: 50, title: "ë ˆì´ë“œ í† ë²Œ ì°¸ê°€ ë³´ìƒ" } // ê·¸ ì™¸
};

// âœ¨ [ì‹ ê·œ] ì´ë²¤íŠ¸ ë­í‚¹ ë³´ìƒ ì„¤ì •
const EVENT_RANK_REWARDS = {
    1: { currency: 3000, fountainPens: 1000, title: "ì´ë²¤íŠ¸ 1ìœ„" },
    2: { currency: 2000, fountainPens: 800, title: "ì´ë²¤íŠ¸ 2ìœ„" },
    3: { currency: 1500, fountainPens: 600, title: "ì´ë²¤íŠ¸ 3ìœ„" },
    top10: { currency: 1000, fountainPens: 500, title: "ì´ë²¤íŠ¸ Top 10" },
    top50: { currency: 500, fountainPens: 300, title: "ì´ë²¤íŠ¸ Top 50" },
    participation: { currency: 200, fountainPens: 100, title: "ì´ë²¤íŠ¸ ì°¸ê°€ìƒ" }
};
	
			const DISMANTLE_REWARDS = {
    'N': { fountainPens: 10, inkwells: 0 },
    'R': { fountainPens: 30, inkwells: 0 },
    'SR': { fountainPens: 50, inkwells: 1 },
    'SSR': { fountainPens: 100, inkwells: 3 }, // SSR íŒŒì‡„ ì‹œ ì‰í¬ë³‘ 3ê°œ ì§€ê¸‰
};
			const MAX_REVISION_LEVEL = 5; // âœ¨ ìµœëŒ€ ê°œì • ë ˆë²¨
const STAT_INCREASE_PER_REVISION = 0.10; // âœ¨ ê°œì • 1ë‹¨ê³„ë‹¹ ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ 10% ì¦ê°€
			const MAX_ENHANCEMENT_LEVEL = 9;
const ENHANCEMENT_COSTS = [5, 10, 15, 25, 40, 60, 85, 115, 150]; // ë ˆë²¨ 0->1, 1->2, ..., 8->9 ë¹„ìš©
			const ENHANCEMENT_BASE_COSTS = [5, 10, 15, 25, 40, 60, 85, 115, 150]; // ğŸ‘ˆ ì´ ì½”ë“œë¥¼ ì¶”ê°€
		// âœ¨ [ì¶”ê°€] í‡´ê³  ì„±ê³µ í™•ë¥  ì •ì˜ (0->1, 1->2, ..., 8->9)
// 1.0ì€ 100%, 0.5ëŠ” 50%ì…ë‹ˆë‹¤.
const ENHANCEMENT_PROBABILITIES = [1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2];
const RARITY_COST_MULTIPLIER = { // ğŸ‘ˆ ì´ ì½”ë“œë¥¼ ì¶”ê°€
    'N': 0.7,
    'R': 1.0,
    'SR': 1.3,
    'SSR': 1.6,
};
const STAT_INCREASE_PER_LEVEL = 0.05; // ë ˆë²¨ë‹¹ ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ì˜ 5% ì¦ê°€
let currentUser = null; 
            let currentPlayerNickname = "ìµëª…ì˜ íƒì •";
			// ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ë¶€ (ìŠ¤í¬ë¦½íŠ¸ ë§¨ ìœ„ìª½)
let playerProfile = { repCardId: null, statusMessage: "" }; // ë°˜ë“œì‹œ ì´ˆê¸°ê°’ì„ ì¤˜ì•¼ í•©ë‹ˆë‹¤!
			let currentTradeRarityFilter = 'All';
            let playerCurrency = 100;
			let playerChoices = {};
			let playerFountainPens = 500; // ğŸ–‹ï¸
			let playerInkwells = 0;
			let currentEventChoice = null;
			let isMultiSelectMode = false; // âœ¨ ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œ ìƒíƒœ ì¶”ê°€
            let selectedCardsToDismantle = new Set(); // âœ¨ ì„ íƒëœ ì¹´ë“œ ID Set ì¶”ê°€
            let playerInventory = [];
			let collectedCardNames = new Set(); // ğŸ‘ˆ ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”.
		let playerRoom = { furniture: [], characters: [] }; // ë§ˆì´ë£¸ ë°ì´í„° (ê°€êµ¬ ë°°ì¹˜, ìºë¦­í„°)
let ownedFurniture = []; // ë³´ìœ í•œ ê°€êµ¬ ëª©ë¡
			let isSortAscending = false; // âœ¨ ì •ë ¬ ë°©í–¥ ë³€ìˆ˜ ì¶”ê°€ (false: ë‚´ë¦¼ì°¨ìˆœ, true: ì˜¤ë¦„ì°¨ìˆœ)
            let playerDeck = [];
            let inventoryCapacity = 100;
            let representativeCharacter = null;
            let isCombatRunning = false;
            let combatSpeedMultiplier = 1;
            let lastCombatType = 'main'; // ë§ˆì§€ë§‰ ì „íˆ¬ ìœ í˜•ì„ ì €ì¥í•©ë‹ˆë‹¤.
            let clearedStages = [];
            let clearedEventDungeons = [];
			let isDismantling = false;
            let playerEventPoints = 0;
            let purchasedEventItems = {};
            let currentStoryPages = [];
            let currentStoryPageIndex = 0;
            let playerBookmarks = 10;
            const MAX_BOOKMARKS = 10;
			const HARD_MAX_BOOKMARKS = 30; // âœ¨ ìµœëŒ€ ì¶•ì  í•œë„ (ì´ë²¤íŠ¸/ì—…ì ìš©)
            let lastBookmarkUpdateTime = Date.now();
            const BOOKMARK_REGEN_TIME = 5 * 60 * 1000; // 5 minutes
            let playerAchievements = {}; // { ach_001: 'unlocked' | 'claimed' }
            let playerStats = { totalPulls: 0 };
			let currentInteractiveStory = null; // ì´ ì¤„ ì¶”ê°€
			let currentSceneIndex = 0; // ì´ ì¤„ ì¶”ê°€
			let currentSortOrder = 'rarity';
			let currentRarityFilter = 'All'; // ğŸ‘ˆ ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”.
			let clearedStageStories = []; 
			// [ê¸°ì¡´ ë³€ìˆ˜ë“¤ ì•„ë˜ì— ì¶”ê°€]
let playerCumulativeEventPoints = 0; // ğŸ† ë­í‚¹ìš© ëˆ„ì  í¬ì¸íŠ¸
let playerSystemMailHistory = []; // âœ¨ ì´ ì¤„ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
let playerRaidDailyCount = 0;
let playerRaidLastResetDate = null;
			let playerRaidDamage = 0;

            const DECK_CAPACITY = 5;
            const PULL_ONE_COST = 10;
            const PULL_TEN_COST = 100;
            const EXPAND_COST = 50;
            const EXPAND_AMOUNT = 10;
            

            // --- HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
			const dismantleMultiUI = document.getElementById('dismantle-multi-ui');

const selectedCardCountSpan = document.getElementById('selected-card-count');
const dismantleSelectedButton = document.getElementById('dismantle-selected-button');
			const fountainPenDisplay = document.getElementById('fountainpen-display');
            const currencyDisplay = document.getElementById('currency-display');
            const messageArea = document.getElementById('message-area');
            // 1. ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ìë™ìœ¼ë¡œ ëª¨ë“  íƒ­ê³¼ ë·°ë¥¼ ì¡ë„ë¡ ì„¤ì •)
            const allTabs = document.querySelectorAll('.tab-button');
            // ëª¨ë‹¬ì°½ì„ ì œì™¸í•œ ë©”ì¸ ë·°ë“¤ì„ ìë™ìœ¼ë¡œ ëª¨ë‘ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const allViews = document.querySelectorAll(
              'main > div:not(#combat-result-modal):not(#card-detail-modal):not(#interactive-story-modal)'
            );
            const pullOneButton = document.getElementById('pull-one');
            const pullTenButton = document.getElementById('pull-ten');
            const pullOneEventButton = document.getElementById('pull-one-event');
            const pullTenEventButton = document.getElementById('pull-ten-event');
            const resultsContainer = document.getElementById('results-container');
            const inventoryContainer = document.getElementById('inventory-container');
            const inventoryStatus = document.getElementById('inventory-status');
            const expandInventoryButton = document.getElementById('expand-inventory');
            const deckStatus = document.getElementById('deck-status');
            const deckSlotsContainer = document.getElementById('deck-slots-container');
            const deckInventoryContainer = document.getElementById('deck-inventory-container');
            const autoFillDeckButton = document.getElementById('auto-fill-deck');
            const deckPowerDisplay = document.getElementById('deck-power-display');
            const combatMessageArea = document.getElementById('combat-message-area');
            const dungeonListContainer = document.getElementById('dungeon-list-container');
            const homeCharacterContainer = document.getElementById('home-character-container');
            const homeCharacterImage = document.getElementById('home-character-image');
            const homeDialogueContainer = document.getElementById('home-dialogue-container');
            const homeDefaultMessage = document.getElementById('home-default-message');
            const homeCharacterName = document.getElementById('home-character-name');
            const homeCharacterDialogue = document.getElementById('home-character-dialogue');
            const eventBanner = document.getElementById('event-banner');
            const eventBannerText = document.getElementById('event-banner-text');
            const gachaTabNormal = document.getElementById('gacha-tab-normal');
            const gachaTabEvent = document.getElementById('gacha-tab-event');
            const normalGachaView = document.getElementById('normal-gacha-view');
            const eventGachaView = document.getElementById('event-gacha-view');
            const eventGachaInfo = document.getElementById('event-gacha-info');
            const resetButton = document.getElementById('reset-game');
            const storageWarning = document.getElementById('storage-warning');
            const combatInProgressView = document.getElementById('combat-in-progress-view');
            const combatPlayerDeck = document.getElementById('combat-player-deck');
            const combatMonsterArea = document.getElementById('combat-monster-area');
            const combatLogContainer = document.getElementById('combat-log-container');
            const combatLog = document.getElementById('combat-log');
            const combatResultModal = document.getElementById('combat-result-modal');
            const combatResultTitle = document.getElementById('combat-result-title');
            const combatResultMessage = document.getElementById('combat-result-message');
            const closeCombatResultButton = document.getElementById('close-combat-result');
            const cardDetailModal = document.getElementById('card-detail-modal');
            const closeCardDetailButton = document.getElementById('close-card-detail');
            const speed1xButton = document.getElementById('speed-1x');
            const speed2xButton = document.getElementById('speed-2x');
            const speed4xButton = document.getElementById('speed-4x');
            const collectionContainer = document.getElementById('collection-container');
            const mainStoryContainer = document.getElementById('main-story-container');
            const eventTab = document.getElementById('tab-event');
            const eventPointDisplay = document.getElementById('event-point-display');
            const eventPointsSpan = document.getElementById('event-points');
            // âœ¨ ì´ë²¤íŠ¸ ë·°ì˜ ì„œë¸Œ íƒ­ ë¦¬ìŠ¤ë„ˆ (ì¤‘ë³µ ì˜¤ë¥˜ ë°©ì§€ìš© ìˆ˜ì •)
        {
            const btnBattle = document.getElementById('event-sub-tab-battle');
            if (btnBattle) {
                btnBattle.onclick = function() {
                    displayEventView(); 
                    switchEventSubTab('battle'); 
                };
            }

            const btnRaid = document.getElementById('event-sub-tab-raid');
            if (btnRaid) {
                btnRaid.onclick = function() {
                    displayEventView(); 
                    switchEventSubTab('raid'); 
                    // ë ˆì´ë“œ ë°ì´í„° ë¦¬ìŠ¤ë„ˆê°€ í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì„œ í˜¸ì¶œ
                    if (typeof initRaidListener === 'function') initRaidListener();
                };
            }

            const btnStory = document.getElementById('event-sub-tab-story');
            if (btnStory) {
                btnStory.onclick = function() {
                    displayEventView(); 
                    switchEventSubTab('story'); 
                };
            }

            const btnShop = document.getElementById('event-sub-tab-shop');
            if (btnShop) {
                btnShop.onclick = function() {
                    displayEventView(); 
                    switchEventSubTab('shop'); 
                };
            }
        }
            const eventBattleView = document.getElementById('event-battle-view');
            const eventStoryView = document.getElementById('event-story-view');
            const eventShopView = document.getElementById('event-shop-view');
            const eventDungeonListContainer = document.getElementById('event-dungeon-list-container');
            const eventStoryContainer = document.getElementById('event-story-container');
            const eventShopContainer = document.getElementById('event-shop-container');
            const bookmarkDisplay = document.getElementById('bookmark-display');
            const maxBookmarkDisplay = document.getElementById('max-bookmark-display');
            const bookmarkTimerContainer = document.getElementById('bookmark-timer-container'); 
            const achievementsContainer = document.getElementById('achievements-container'); // âœ… ì—¬ê¸°ì„œ ëª…í™•í•˜ê²Œ ì„ ì–¸
            const toastNotification = document.getElementById('toast-notification');
			const synergyList = document.getElementById('synergy-list');
			const dismantleCardButton = document.getElementById('dismantle-card-button');
			const dismantleResultModal = document.getElementById('dismantle-result-modal');
const dismantleRewardsList = document.getElementById('dismantle-rewards-list');
const closeDismantleResultButton = document.getElementById('close-dismantle-result');

			// âœ¨ íŒŒì¼ ì—…ë¡œë“œ ìš”ì†Œ ì¶”ê°€ âœ¨
			const uploadFile = document.getElementById('upload-file'); // âœ… ì´ ë¼ì¸ì„ ì¶”ê°€í•˜ì„¸ìš”.
			
			// âœ¨ ìŠ¤í† ë¦¬ íƒ­ ê´€ë ¨ ë³€ìˆ˜ë“¤ âœ¨
			const stageStoryContainer = document.getElementById('stage-story-container');
            const storySubTabMain = document.getElementById('story-sub-tab-main');
            const storySubTabStage = document.getElementById('story-sub-tab-stage');
			const interactiveStoryModal = document.getElementById('interactive-story-modal');
			const storyCharLeft = document.getElementById('story-char-left');
			const storyCharRight = document.getElementById('story-char-right');
			const speakerName = document.getElementById('speaker-name');
			const dialogueText = document.getElementById('dialogue-text');
			const storyNextButton = document.getElementById('story-next-button');
			const storySkipButton = document.getElementById('story-skip-button');
			const detailStoryPrevButton = document.getElementById('detail-story-prev');
            const detailStoryNextButton = document.getElementById('detail-story-next');
			const storyView = document.getElementById('story-view');
            
            // --- ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ---
            function isStorageAvailable() {
                try {
                    const key = "__test_localstorage__";
                    localStorage.setItem(key, key);
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // [ì¶”ê°€] undefined ê°’ì„ ì°¾ì•„ì„œ nullë¡œ ë°”ê¿”ì£¼ëŠ” ì•ˆì „ì¥ì¹˜ í•¨ìˆ˜
function removeUndefined(obj) {
    // ë°°ì—´ì¼ ê²½ìš° ë‚´ë¶€ ìš”ì†Œ ì¬ê·€ ì²˜ë¦¬
    if (Array.isArray(obj)) {
        return obj.map(v => removeUndefined(v));
    }
    // ê°ì²´ì¼ ê²½ìš° ë‚´ë¶€ ì†ì„± ì¬ê·€ ì²˜ë¦¬
    else if (obj !== null && typeof obj === 'object') {
        return Object.keys(obj).reduce((acc, key) => {
            const value = obj[key];
            // ê°’ì´ undefinedë©´ nullë¡œ ë³€ê²½, ì•„ë‹ˆë©´ ì¬ê·€ í˜¸ì¶œ
            acc[key] = (value === undefined) ? null : removeUndefined(value);
            return acc;
        }, {});
    }
    // ê¸°ë³¸ ìë£Œí˜•ì¼ ê²½ìš° undefined ì²´í¬
    return (obj === undefined) ? null : obj;
}

// [ìˆ˜ì •] ê¸°ì¡´ saveGameToFirebase í•¨ìˆ˜ ìˆ˜ì •
async function saveGameToFirebase() {
    if (!currentUser) return;

    const currentProfile = playerProfile || {};

    const safeProfile = {
        repCardId: currentProfile.repCardId || null,
        statusMessage: currentProfile.statusMessage || ""
    };

    // ì €ì¥í•  ë°ì´í„° ê°ì²´ ìƒì„±
    const rawSaveData = {
        nickname: currentPlayerNickname || "ìµëª…ì˜ íƒì •",
        currency: playerCurrency || 0,
        fountainPens: playerFountainPens || 0,
        inkwells: playerInkwells || 0,
        inventory: playerInventory || [],
        deck: playerDeck.map(card => card.id),
        capacity: inventoryCapacity || 100,
        representative: representativeCharacter ? representativeCharacter.name : null,
        clearedStages: clearedStages || [],
        currentEventId: (typeof CURRENT_EVENT_ID !== 'undefined') ? CURRENT_EVENT_ID : null,
        eventPoints: playerEventPoints || 0,
		cumulativeEventPoints: playerCumulativeEventPoints || 0,
		raidCumulativeDamage: playerRaidDamage || 0,
		raidDailyCount: playerRaidDailyCount || 0,
        clearedEventDungeons: clearedEventDungeons || [],
        purchasedEventItems: purchasedEventItems || {},
        bookmarks: playerBookmarks || 0,
        lastBookmarkUpdate: lastBookmarkUpdateTime || Date.now(),
        achievements: playerAchievements || {},
        stats: playerStats || { totalPulls: 0 },
        clearedStageStories: clearedStageStories || [],
        playerChoices: playerChoices || {},
        collectedCardNames: Array.from(collectedCardNames || []),
        myRoom: playerRoom || { furniture: [], characters: [] },
        ownedFurniture: ownedFurniture || [],
		systemMailHistory: playerSystemMailHistory || [],
        
        // í”„ë¡œí•„ ë°ì´í„°
        profile: safeProfile
    };
	if (playerRaidLastResetDate instanceof Date && !isNaN(playerRaidLastResetDate)) {
    rawSaveData.raidLastResetDate = playerRaidLastResetDate;
}

    // âœ¨ [í•µì‹¬ ìˆ˜ì •] ì—¬ê¸°ì„œ undefinedë¥¼ nullë¡œ ì‹¹ ë³€í™˜í•©ë‹ˆë‹¤.
    const finalSaveData = removeUndefined(rawSaveData);

    try {
        await db.collection('users').doc(currentUser.uid).set(finalSaveData);
        console.log("ê²Œì„ ë°ì´í„°ê°€ Firebaseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (error) {
        console.error("Firebase ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
    }
}

            // âœ… ì´ ì½”ë“œë¡œ ê¸°ì¡´ loadGame í•¨ìˆ˜ë¥¼ í†µì§¸ë¡œ êµì²´í•´ì£¼ì„¸ìš”.
           async function loadGameFromFirebase(uid) {
    const docRef = db.collection('users').doc(uid);
    const doc = await docRef.get();

    if (doc.exists) {
        console.log("Firebaseì—ì„œ ê²Œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.");
        const savedData = doc.data();
        
        // ë‹‰ë„¤ì„ ë¡œë“œ
        currentPlayerNickname = savedData.nickname || currentUser.displayName || "ìµëª…ì˜ íƒì •";
        document.getElementById('nickname-display').textContent = currentPlayerNickname;

        playerCurrency = savedData.currency ?? 100;
        playerFountainPens = savedData.fountainPens ?? 500;
        playerInkwells = savedData.inkwells ?? 0;
        const loadedInventory = savedData.inventory || [];
        
        // ì¸ë²¤í† ë¦¬ ë¡œë“œ (ì•ˆì „ì¥ì¹˜ í¬í•¨)
        playerInventory = loadedInventory.map(card => ({
            ...card,
            revision: (card.revision !== undefined && card.revision !== null) ? card.revision : 0,
            level: (card.level !== undefined && card.level !== null) ? card.level : 0
        }));

        // âœ¨ [í•µì‹¬ ìˆ˜ì •] ìˆ˜ì§‘ ë„ê° ë°ì´í„° ë¡œë“œ + ë™ê¸°í™”
        collectedCardNames = new Set(savedData.collectedCardNames || []);
        
        // ğŸ’¡ ê¸°ì¡´ì— ì¹´ë“œë¥¼ ê°€ì§€ê³  ìˆë˜ ìœ ì €ë¥¼ ìœ„í•´, í˜„ì¬ ì¸ë²¤í† ë¦¬ì˜ ì¹´ë“œë¥¼ ìˆ˜ì§‘ ëª©ë¡ì— ê°•ì œ ë“±ë¡
        playerInventory.forEach(card => collectedCardNames.add(card.name));

        const savedDeckIds = savedData.deck || [];
        playerDeck = savedDeckIds.map(id => playerInventory.find(card => card.id === id)).filter(Boolean);
        playerRoom = savedData.myRoom || { furniture: [], characters: [] };
        
        if (!Array.isArray(playerRoom.furniture)) playerRoom.furniture = [];
        if (!Array.isArray(playerRoom.characters)) playerRoom.characters = [];
        
        ownedFurniture = savedData.ownedFurniture || [];
        inventoryCapacity = savedData.capacity ?? 100;
        if (savedData.representative) {
            representativeCharacter = findCharacter(savedData.representative) || null;
        }
        clearedStages = savedData.clearedStages || [];
        playerBookmarks = savedData.bookmarks ?? MAX_BOOKMARKS;
        lastBookmarkUpdateTime = savedData.lastBookmarkUpdate ?? Date.now();
        playerAchievements = savedData.achievements || {};
        playerStats = savedData.stats || { totalPulls: 0 };
        clearedStageStories = savedData.clearedStageStories || [];
        
        // ì´ë²¤íŠ¸ ë°ì´í„° ë¡œë“œ (ìˆ˜ì •ëœ ë¡œê·¸)
        if (savedData.currentEventId === CURRENT_EVENT_ID) {
            console.log("ì´ì „ ì´ë²¤íŠ¸ë¥¼ ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤:", CURRENT_EVENT_ID);
            
            playerEventPoints = savedData.eventPoints !== undefined ? savedData.eventPoints : 0;
            
            playerCumulativeEventPoints = savedData.cumulativeEventPoints !== undefined 
                ? savedData.cumulativeEventPoints 
                : playerEventPoints;
            
            // âœ¨ [í•µì‹¬ ìˆ˜ì • 1] playerRaidDamage ë¡œë“œ
            playerRaidDamage = savedData.raidCumulativeDamage !== undefined 
                ? savedData.raidCumulativeDamage 
                : 0;

            // âœ¨ [í•µì‹¬ ìˆ˜ì • 2] ë ˆì´ë“œ ì°¸ì—¬ íšŸìˆ˜ ë¡œë“œ ë° ì´ˆê¸°í™” ì²´í¬
            const lastResetTimestamp = savedData.raidLastResetDate;
            const today = new Date().toDateString(); 
            
            // âš ï¸ [ìˆ˜ì •ëœ ì•ˆì „ ì¥ì¹˜] Timestamp ê°ì²´ì¸ì§€ í™•ì¸
            const savedLastRaidDate = (lastResetTimestamp && typeof lastResetTimestamp.toDate === 'function')
                ? lastResetTimestamp.toDate().toDateString() 
                : null; // âœ¨ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ nullë¡œ ì²˜ë¦¬

            // ë‚ ì§œê°€ ë°”ë€Œì—ˆê±°ë‚˜ (savedLastRaidDateê°€ nullì´ ì•„ë‹ ë•Œ) 
            // ë˜ëŠ” ì•„ì˜ˆ ì €ì¥ëœ ë‚ ì§œê°€ ì—†ì„ ë•Œ (savedLastRaidDate === null)
            if (savedLastRaidDate !== today) { 
                playerRaidDailyCount = 0; 
                // DBì— ì €ì¥í•  ë•Œ Timestampê°€ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì—, 
                // ë¡œì»¬ ë³€ìˆ˜ëŠ” ì¼ë‹¨ nullë¡œ ë‘ì–´ë„ ë‹¤ìŒ íŠ¸ëœì­ì…˜ì—ì„œ ì„œë²„ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
                playerRaidLastResetDate = null; 
            } else {
                // ë‚ ì§œê°€ ê°™ìœ¼ë©´ DB ì¹´ìš´íŠ¸ ë¡œë“œ
                playerRaidDailyCount = savedData.raidDailyCount ?? 0;
                playerRaidLastResetDate = savedData.raidLastResetDate;
            }
            clearedEventDungeons = savedData.clearedEventDungeons || [];
            purchasedEventItems = savedData.purchasedEventItems || {};
            playerChoices = savedData.playerChoices || {};
			playerSystemMailHistory = savedData.systemMailHistory || [];
        } else {
            // âœ¨ IDê°€ ë‹¤ë¥¸ ê²½ìš°: ìƒˆ ì´ë²¤íŠ¸ ì‹œì‘ OR ì´ë²¤íŠ¸ ì¢…ë£Œ (ëª¨ë“  ì´ë²¤íŠ¸ ê´€ë ¨ ë°ì´í„° ì´ˆê¸°í™”)
            if (CURRENT_EVENT_ID) {
                console.log(`ìƒˆë¡œìš´ ì´ë²¤íŠ¸[${CURRENT_EVENT_ID}]ê°€ ê°ì§€ë˜ì–´, ì´ì „ ê¸°ë¡ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.`);
            } else {
                console.log("í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸ê°€ ì—†ì–´ ê¸°ë¡ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.");
            }
            
            playerEventPoints = 0;
            playerCumulativeEventPoints = 0;
            playerRaidDamage = 0; 
            playerRaidDailyCount = 0; // âœ¨ ë ˆì´ë“œ íšŸìˆ˜ ì´ˆê¸°í™”
            clearedEventDungeons = [];
            purchasedEventItems = {};
            playerChoices = {};
        }
		// âœ¨ [ì¶”ê°€] í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
        playerProfile = savedData.profile || { repCardId: null, statusMessage: "" };
        
        // ë‹‰ë„¤ì„ ì¸í’‹ì°½ì—ë„ í˜„ì¬ ë‹‰ë„¤ì„ ë¯¸ë¦¬ ì±„ìš°ê¸°
        const nickInput = document.getElementById('profile-nickname-edit');
        if(nickInput) nickInput.value = currentPlayerNickname;

    } else {
        console.log("ìƒˆë¡œìš´ ìœ ì €ì…ë‹ˆë‹¤. ì´ˆê¸° ë°ì´í„°ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
        initializeNewGameData();
        await saveGameToFirebase(); 
    }

    calculateOfflineRegen();
    playerInventory.forEach(card => {
        if (!card.id) {
            card.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
            console.log("ID ì—†ëŠ” ì¹´ë“œ ë³µêµ¬ë¨:", card.name, card.id);
        }
    });
	await checkAndProcessSystemMails(uid);
    
    updateUI();
	updateRaidDailyCountUI();
    checkEventStatus();
    switchTab('home');
    checkAchievements();
	checkAndSpawnRaidBoss();

	updateAchievementBadge(); // âœ¨ ì¶”ê°€: ë¡œë“œ ì‹œ ë°°ì§€ ê°±
    document.getElementById('loading-overlay').classList.add('hidden');
    document.body.classList.remove('loading');
}	



function saveGame() {
    saveGameToFirebase(); // <--- ì´ í•¨ìˆ˜ê°€ ë¹„ë™ê¸° í˜¸ì¶œì„ ë³´ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
}

			
            function initializeNewGameData() {
    // âœ¨ ê²Œì„ ì²« ì‹œì‘ ì‹œ ê¸°ë³¸ ì§€ê¸‰ ì¹´ë“œì— ê³ ìœ  IDì™€ ë ˆë²¨ ë¶€ì—¬
    addCardToInventory('[ê´€ë¦¬ì¸] Ki');
    addCardToInventory('[ê´€ë¦¬ì¸] Ai');
	collectedCardNames.add('[ê´€ë¦¬ì¸] Ki');
                collectedCardNames.add('[ê´€ë¦¬ì¸] Ai');
	playerCurrency = 100; // ğŸ’ ì´ˆê¸° ë³´ì„ 100ê°œ ì§€ê¸‰
    playerFountainPens = 500; // ğŸ–‹ï¸ ì´ˆê¸° íœ ìˆ˜ëŸ‰ë„ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
    playerBookmarks = MAX_BOOKMARKS;
    lastBookmarkUpdateTime = Date.now();
}


		

            // [ìˆ˜ì •] ê²Œì„ ë°ì´í„° ì´ˆê¸°í™” (ë¦¬ì„¸ë§ˆë¼ + ê±°ë˜ì†Œ ì‚­ì œ + ì¹œêµ¬ ê´€ê³„ ì™„ì „ ì‚­ì œ)
async function resetGame() {
    // 1. í™•ì¸ ë²„íŠ¼ ë¡œì§ (í•œ ë²ˆ ëˆ„ë¥´ë©´ 'í™•ì¸?'ìœ¼ë¡œ ë°”ë€œ)
    if (resetButton.dataset.confirming === 'true') {
        try {
            if (currentUser) {
                console.log("ğŸ”¥ ê³„ì • ì´ˆê¸°í™” ì‹œì‘...");

                // =========================================================
                // 1ë‹¨ê³„: ê±°ë˜ì†Œì— ì˜¬ë ¤ë‘” ë‚´ ë§¤ë¬¼ ì‚­ì œ
                // =========================================================
                const myTradesSnapshot = await db.collection('trades')
                    .where('senderUid', '==', currentUser.uid)
                    .get();

                const tradeBatch = db.batch();
                myTradesSnapshot.forEach(doc => {
                    tradeBatch.delete(doc.ref);
                });
                await tradeBatch.commit();
                console.log(`âœ… ê±°ë˜ì†Œ ë§¤ë¬¼ ${myTradesSnapshot.size}ê±´ ì‚­ì œ ì™„ë£Œ.`);

                // =========================================================
                // 2ë‹¨ê³„: ì¹œêµ¬ ê´€ê³„ ëŠê¸° (ë‚˜ <-> ì¹œêµ¬ ì–‘ìª½ ëª¨ë‘ ì‚­ì œ)
                // =========================================================
                const myFriendsSnapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('friends')
                    .get();

                if (!myFriendsSnapshot.empty) {
                    const friendBatch = db.batch();
                    
                    myFriendsSnapshot.forEach(doc => {
                        const friendUid = doc.id;
                        
                        // 1. ìƒëŒ€ë°©ì˜ ì¹œêµ¬ ëª©ë¡ì—ì„œ 'ë‚˜'ë¥¼ ì‚­ì œ
                        const theirRef = db.collection('users').doc(friendUid)
                                           .collection('friends').doc(currentUser.uid);
                        friendBatch.delete(theirRef);

                        // 2. ë‚´ ì¹œêµ¬ ëª©ë¡ì—ì„œ 'ìƒëŒ€ë°©'ì„ ì‚­ì œ (ì‚¬ì‹¤ ë³¸ì²´ ì‚­ì œí•˜ë©´ ê°™ì´ ì‚¬ë¼ì§€ì§€ë§Œ í™•ì‹¤í•˜ê²Œ ì²˜ë¦¬)
                        friendBatch.delete(doc.ref);
                    });

                    await friendBatch.commit();
                    console.log(`âœ… ì¹œêµ¬ ${myFriendsSnapshot.size}ëª…ê³¼ì˜ ê´€ê³„ ì‚­ì œ ì™„ë£Œ.`);
                }

                // =========================================================
                // 3ë‹¨ê³„: ë‚´ ìœ ì € ë°ì´í„°(ë³¸ì²´) ì‚­ì œ
                // =========================================================
                await db.collection('users').doc(currentUser.uid).delete();
                console.log("âœ… ìœ ì € ë°ì´í„° ì‚­ì œ ì™„ë£Œ.");
            }

            // 4. ë¡œì»¬ ë°ì´í„° ì‚­ì œ ë° ìƒˆë¡œê³ ì¹¨
            localStorage.removeItem(SAVE_DATA_KEY);

            alert("ê³„ì •ì´ ì™„ë²½í•˜ê²Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì¹œêµ¬ ëª©ë¡, ê±°ë˜ì†Œ ë§¤ë¬¼, ê²Œì„ ë°ì´í„° ì‚­ì œ ì™„ë£Œ)");
            location.reload(); 

        } catch (e) {
            console.error("ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
            alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
        }
    } else {
        // ë²„íŠ¼ UI ë³€ê²½ ë¡œì§
        resetButton.textContent = 'í™•ì¸?';
        resetButton.dataset.confirming = 'true';
        resetButton.classList.remove('bg-red-600', 'hover:bg-red-700');
        resetButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
        
        setTimeout(() => {
            resetButton.textContent = 'ì´ˆê¸°í™”';
            resetButton.dataset.confirming = 'false';
            resetButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            resetButton.classList.add('bg-red-600', 'hover:bg-red-700');
        }, 3000);
    }
}

            // --- ì—…ì  ê´€ë ¨ í•¨ìˆ˜ ---
            function showToast() {
                toastNotification.classList.remove('hidden');
                setTimeout(() => {
                    toastNotification.classList.add('hidden');
                }, 2000); // 2ì´ˆ í›„ ì‚¬ë¼ì§
            }

            function checkAchievements() {
    // ì—…ì  ì¡°ê±´ í•¨ìˆ˜ê°€ rarity, level ë“± ëª¨ë“  ì •ë³´ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡
    // ì¸ë²¤í† ë¦¬ ë°ì´í„°ë¥¼ 'í’ë¶€í•˜ê²Œ(rich)' ë§Œë“­ë‹ˆë‹¤.
    const richInventory = playerInventory.map(c => {
        const base = findCharacter(c.name); // (name, rarity, stats...)
        return { ...base, ...c }; // (name, rarity, stats, id, level, revision)
    });
    
    const currentState = {
        inventory: richInventory, // ğŸ‘ˆ 'playerInventory' ëŒ€ì‹  'richInventory'ë¥¼ ì „ë‹¬
        stats: playerStats,
        clearedStages: clearedStages,
        capacity: inventoryCapacity,
        fountainPens: playerFountainPens,
    };
    let newAchievementUnlocked = false;
    achievements.forEach(ach => {
        // ì•„ì§ ë‹¬ì„±í•˜ì§€ ì•Šì€ ì—…ì ë§Œ ì²´í¬
        if (!playerAchievements[ach.id]) {
            // ì—…ì  ì¡°ê±´ì´ playerFountainPensë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.
            if (ach.condition(currentState)) { 
                playerAchievements[ach.id] = 'unlocked';
                newAchievementUnlocked = true;
            }
        }
    });
    if (newAchievementUnlocked) {
        showToast();
        // í˜„ì¬ ì—…ì  íƒ­ì„ ë³´ê³  ìˆë‹¤ë©´ UIë¥¼ ì¦‰ì‹œ ê°±ì‹ 
        if (document.getElementById('achievements-view').classList.contains('hidden') === false) {
            displayAchievements();
        }
		
    }
	updateAchievementBadge();
}
            
            function displayAchievements() {
                achievementsContainer.innerHTML = '';
                achievements.forEach(ach => {
                    const status = playerAchievements[ach.id]; // 'unlocked' or 'claimed' or undefined
                    const achEl = document.createElement('div');
                    achEl.className = `p-4 rounded-lg flex justify-between items-center transition-all ${status ? 'bg-white/20' : 'bg-black/30 opacity-60'}`;
                    
                    let rewardText = '';
                    if (ach.reward.currency) rewardText += `ğŸ’ ${ach.reward.currency} `;
                    if (ach.reward.fountainPens) rewardText += `ğŸ–‹ï¸ ${ach.reward.fountainPens} `; // âœ¨ ì´ ì¤„ì˜ ë¡œì§ì´ ë§Œë…„í•„ ë³´ìƒì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                    if (ach.reward.bookmarks) rewardText += `ğŸ”– ${ach.reward.bookmarks} `;

                    let buttonHTML = '';
                    if (status === 'claimed') {
                        buttonHTML = `<button class="gacha-button bg-gray-600 text-white font-bold py-2 px-4 rounded-full text-sm" disabled>ë‹¬ì„± ì™„ë£Œ</button>`;
                    } else if (status === 'unlocked') {
                        buttonHTML = `<button data-ach-id="${ach.id}" class="gacha-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full text-sm">ë³´ìƒ ë°›ê¸°</button>`;
                    } else {
                        buttonHTML = `<button class="gacha-button bg-gray-800 text-gray-400 font-bold py-2 px-4 rounded-full text-sm" disabled>ì§„í–‰ ì¤‘</button>`;
                    }

                    achEl.innerHTML = `
                        <div>
                            <h3 class="text-lg font-bold ${status ? 'text-yellow-300' : 'text-gray-400'}">${ach.title}</h3>
                            <p class="text-sm text-gray-300">${ach.description} (ë³´ìƒ: ${rewardText})</p>
                        </div>
                        ${buttonHTML}
                    `;
                    achievementsContainer.appendChild(achEl);
                });
            }
            
            function claimAchievement(achievementId) {
    const ach = achievements.find(a => a.id === achievementId);
    if (!ach || playerAchievements[ach.id] !== 'unlocked') return;

    // ë³´ìƒ ì§€ê¸‰
    if (ach.reward.currency) playerCurrency += ach.reward.currency;
    if (ach.reward.fountainPens) playerFountainPens += ach.reward.fountainPens;
    // âœ¨ ì—…ì  ë³´ìƒì€ ìµœëŒ€ 30ê°œê¹Œì§€ ì¶•ì  ê°€ëŠ¥
    if (ach.reward.bookmarks) playerBookmarks = Math.min(HARD_MAX_BOOKMARKS, playerBookmarks + ach.reward.bookmarks);
    
    playerAchievements[ach.id] = 'claimed'; // ìƒíƒœ ë³€ê²½
    
    updateUI();
    displayAchievements(); // UI ê°±ì‹ 
    saveGame();
	updateAchievementBadge();
}
			
			// --- ì¸ì—°(Synergy) ê´€ë ¨ í•¨ìˆ˜ ---
            function calculateActiveSynergies(deck) {
    // 1. ë±ì˜ ê° ì¹´ë“œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í•´ë‹¹í•˜ëŠ” ìºë¦­í„° ë°ì´í„°ë¡œ ë³€í™˜
    const deckWithData = deck.map(cardInstance => {
        // findCharacter í•¨ìˆ˜ëŠ” game_data.jsì— ì •ì˜ëœ ì „ì²´ character ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        const charData = findCharacter(cardInstance.name); 
        if (!charData) return null;
        
        // ì¸ì—° ì¡°ê±´ í™•ì¸ì„ ìœ„í•´ í•„ìš”í•œ 'faction'ê³¼ 'baseName'ì„ ê°€ì§„ ê°ì²´ ë°˜í™˜
        return {
            ...charData, // faction, baseName, rarity ë“±ì„ ëª¨ë‘ í¬í•¨
        };
    }).filter(Boolean); // ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ ì œê±°

    // 2. ë³€í™˜ëœ ë±(characterData ë°°ì—´)ì„ ì¸ì—° ì¡°ê±´ í•¨ìˆ˜ì— ì „ë‹¬
    return synergies.filter(synergy => synergy.condition(deckWithData));
}

            function displaySynergies() {
                const activeSynergies = calculateActiveSynergies(playerDeck);
                if (activeSynergies.length > 0) {
                    synergyList.innerHTML = activeSynergies.map(s => `<span class="bg-black/30 px-3 py-1 rounded-full">${s.name}: ${s.description}</span>`).join(' ');
                } else {
                    synergyList.innerHTML = 'í™œì„±í™”ëœ ì¸ì—°ì´ ì—†ìŠµë‹ˆë‹¤.';
                }
            }
            
            function applySynergyBonusesToDeck(deck) {
                const activeSynergies = calculateActiveSynergies(deck);
                if (activeSynergies.length === 0) return JSON.parse(JSON.stringify(deck));

                const bonusDeck = JSON.parse(JSON.stringify(deck)); // ì›ë³¸ ë± ìˆ˜ì •ì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ê¹Šì€ ë³µì‚¬
                bonusDeck.forEach(card => {
                    activeSynergies.forEach(synergy => {
                        synergy.applyBonus(card);
                    });
                });
                return bonusDeck;
            }

            // yumecan.html - switchTab í•¨ìˆ˜ (2137í–‰ ê·¼ì²˜)

// yumecan.html - switchTab í•¨ìˆ˜ (2137í–‰ ê·¼ì²˜)

// ========================================================
// âœ… [ìˆ˜ì •ë¨] íƒ­ ì „í™˜ í•¨ìˆ˜ (ì¤‘ë³µ ì„ ì–¸ ì œê±° & ìƒë‹¨ë°” ì œì–´ ê°•í™”)
// ========================================================

let currentTab = 'home'; // âœ¨ ì´ ë³€ìˆ˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ì—ì„œ ë”± í•œ ë²ˆë§Œ ì„ ì–¸ë˜ì–´ì•¼ í•©ë‹ˆë‹¤!

// 2. ì•ˆì •í™”ëœ íƒ­ ì „í™˜ í•¨ìˆ˜ (ê±°ë˜ì†Œì´ì „.html ê¸°ë°˜ + ìµœì‹  ê¸°ëŠ¥ í†µí•©)
            function switchTab(tabName) {
                if (typeof isCombatRunning !== 'undefined' && isCombatRunning) return;
                
                // [ì´ˆê¸°í™”] ëª¨ë“  ë·° ìˆ¨ê¸°ê¸° ë° íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
                if (allViews) {
                    allViews.forEach(view => {
                        if (view) view.classList.add('hidden'); 
                    });
                }
                
                if (allTabs) {
                    allTabs.forEach(tab => tab.classList.remove('active'));
                }
				const globalHomeBtn = document.getElementById('global-home-button');
                if (globalHomeBtn) {
                    if (tabName === 'home') {
                        globalHomeBtn.classList.add('hidden'); // í™ˆì—ì„œëŠ” ìˆ¨ê¹€
                    } else {
                        globalHomeBtn.classList.remove('hidden'); // ë‹¤ë¥¸ ê³³ì—ì„œëŠ” ë³´ì„
                    }
                }
                
                // [ë·° ì„ íƒ] íƒ­ ì´ë¦„ì— ë§ëŠ” ë·° ì°¾ê¸°
                let targetView;

                if (tabName === 'event') {
                    // âœ¨ í•µì‹¬: ì´ë²¤íŠ¸ íƒ­ í´ë¦­ ì‹œ 'ì „íˆ¬'ê°€ ì•„ë‹Œ 'ì´ë²¤íŠ¸ í™ˆ(ì•ˆë‚´)'ì„ ë³´ì—¬ì¤Œ
                    targetView = document.getElementById('event-home-view'); 
                } 
                else if (tabName === 'myroom') {
                    targetView = document.getElementById('myroom-view');
                }
                else {
                    // ê·¸ ì™¸: trade -> trade-view, home -> home-view ë“± ê·œì¹™ëŒ€ë¡œ ì—°ê²°
                    targetView = document.getElementById(`${tabName}-view`);
                }
                
                // [íƒ­ ë²„íŠ¼ ì„ íƒ]
                const targetTab = document.getElementById(`tab-${tabName}`);

                // ë°©ì–´ ì½”ë“œ: ë·°ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì¤‘ë‹¨ (ë©ˆì¶¤ ë°©ì§€)
                if (!targetView) {
                    console.warn(`Warning: View for ${tabName} not found.`);
                    // ë·°ê°€ ì—†ì–´ë„ ì½”ë“œëŠ” ê³„ì† ì‹¤í–‰ë˜ê²Œ í•˜ì—¬ ë©ˆì¶¤ í˜„ìƒ ë°©ì§€
                } else {
                    targetView.classList.remove('hidden');
                }

                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ì„ ì–¸ ë°©ì§€ë¥¼ ìœ„í•´ window ê°ì²´ ì‚¬ìš© ê¶Œì¥)
                window.currentTab = tabName;

                // [ë°ì´í„° ë¡œë“œ] ê° íƒ­ì— ë§ëŠ” ìµœì‹  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                if (tabName === 'home') displayHomeView();
                else if (tabName === 'inventory') displayInventory(); 
                else if (tabName === 'deck') displayDeckManagement();
                else if (tabName === 'combat') displayCombatView();
                else if (tabName === 'collection') displayCollectionView();
                else if (tabName === 'story') displayStoryView();
                else if (tabName === 'event') displayEventHomeView();
                else if (tabName === 'achievements') displayAchievements();
                else if (tabName === 'myroom') displayMyRoom();
                // âœ¨ ëˆ„ë½ë˜ì—ˆë˜ ìµœì‹  ê¸°ëŠ¥ ì—°ê²° (ì¹œêµ¬, êµí™˜ì†Œ, í”„ë¡œí•„)
                else if (tabName === 'friends' && typeof loadFriendList === 'function') loadFriendList();
                else if (tabName === 'trade' && typeof loadTradeList === 'function') loadTradeList();
                else if (tabName === 'profile' && typeof displayProfileView === 'function') displayProfileView();
            }
            
            // ì „ì—­ ìŠ¤ì½”í”„ì— ë“±ë¡
            window.switchTab = switchTab;

// âœ… [ì‹ ê·œ] ì´ë²¤íŠ¸ íƒ­ ì „ìš© ì „í™˜ í•¨ìˆ˜ (í™•ì‹¤í•˜ê²Œ í•˜ë‚˜ë§Œ ë³´ì—¬ì¤Œ)
function switchEventSubTab(tabName) {
    // 1. ëª¨ë“  ì´ë²¤íŠ¸ ì„œë¸Œ ë·° ID ëª©ë¡
    const allViewIds = [
        'event-battle-view', 
        'event-raid-view', 
        'event-story-view', 
        'event-shop-view'
    ];
    
    // 2. ëª¨ë“  ë·° ìˆ¨ê¸°ê¸° & ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
    allViewIds.forEach(id => {
        const view = document.getElementById(id);
        if (view) view.classList.add('hidden');
        
        // ë²„íŠ¼ IDëŠ” ë·° IDì—ì„œ '-view'ë¥¼ ëº€ ë’¤ 'sub-tab-'ì„ ì¤‘ê°„ì— ë„£ì€ í˜•íƒœ
        // ì˜ˆ: event-battle-view -> event-sub-tab-battle
        const btnId = id.replace('event-', 'event-sub-tab-').replace('-view', '');
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.remove('active');
    });

    // 3. ì„ íƒëœ ë·°ë§Œ ë³´ì´ê¸°
    const targetView = document.getElementById(`event-${tabName}-view`);
    if (targetView) targetView.classList.remove('hidden');

    // 4. ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
    const targetBtn = document.getElementById(`event-sub-tab-${tabName}`);
    if (targetBtn) targetBtn.classList.add('active');
}
            function switchSubTab(viewContainer, button) {
                Array.from(viewContainer.children).forEach(view => {
                    if(view.id.endsWith('-view')) view.classList.add('hidden');
                });
                Array.from(button.parentElement.children).forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const viewId = button.id.replace('sub-tab-', '') + '-view';
                const viewElement = document.getElementById(viewId);
                if (viewElement) {
                    viewElement.classList.remove('hidden');
                }
            }

            function switchGachaTab(tabName) {
                if (tabName === 'normal') {
                    normalGachaView.classList.remove('hidden');
                    eventGachaView.classList.add('hidden');
                    gachaTabNormal.classList.add('active');
                    gachaTabEvent.classList.remove('active');
                } else {
                    normalGachaView.classList.add('hidden');
                    eventGachaView.classList.remove('hidden');
                    gachaTabNormal.classList.remove('active');
                    gachaTabEvent.classList.add('active');
                }
            }

            // [ìˆ˜ì •] ì´ë²¤íŠ¸ ìƒíƒœ ì²´í¬ (ì˜¤ë¥˜ ìˆ˜ì •íŒ)
function checkEventStatus() {
    // ì „ì—­ ë³€ìˆ˜ ëŒ€ì‹  í•¨ìˆ˜ ì‹¤í–‰ ì‹œì ì— ìš”ì†Œë¥¼ ë‹¤ì‹œ ì°¾ìŠµë‹ˆë‹¤.
    const banner = document.getElementById('event-banner'); 
    const evtTab = document.getElementById('tab-event');
    const gachaTab = document.getElementById('gacha-tab-event');
    const bannerText = document.getElementById('event-banner-text');
    const gachaInfo = document.getElementById('event-gacha-info');

    if (CURRENT_EVENT_ID && currentEventInfo) {
        // âœ… ì´ë²¤íŠ¸ ì§„í–‰ ì¤‘
        if (banner) banner.classList.remove('hidden');
        
        if (bannerText) {
            bannerText.textContent = `${currentEventInfo.title} ì§„í–‰ ì¤‘!`;
        }
        
        if (gachaInfo && currentEventInfo.gachaCharacterName) {
            const pTag = gachaInfo.querySelector('p');
            if (pTag) pTag.textContent = `[${currentEventInfo.gachaCharacterName}] ë“±ì¥ í™•ë¥  UP!`;
        }

        if (gachaTab) gachaTab.classList.remove('hidden');
        if (evtTab) evtTab.classList.remove('hidden');

    } else {
        // âŒ ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸ ì—†ìŒ
        if (banner) banner.classList.add('hidden');
        if (gachaTab) gachaTab.classList.add('hidden');
        if (evtTab) evtTab.classList.add('hidden');
        
        // ê°•ì œ ì´ë™ ë¡œì§
        if (document.getElementById('event-home-view') && !document.getElementById('event-home-view').classList.contains('hidden')) {
            switchTab('home');
        }
        if (gachaTab && gachaTab.classList.contains('active')) {
            switchGachaTab('normal');
        }
    }
}

            function displayHomeView(cycleDialogue = false) {
                if (representativeCharacter) {
                    homeCharacterContainer.classList.remove('hidden');
                    homeDialogueContainer.classList.remove('hidden');
                    homeDefaultMessage.classList.add('hidden');
                    homeCharacterImage.src = representativeCharacter.imageUrl;
                    homeCharacterName.textContent = representativeCharacter.name;
                    if (cycleDialogue) {
                        const currentDialogue = homeCharacterDialogue.textContent;
                        let newDialogue;
                        do {
                            newDialogue = representativeCharacter.dialogues[Math.floor(Math.random() * representativeCharacter.dialogues.length)];
                        } while (representativeCharacter.dialogues.length > 1 && newDialogue === currentDialogue);
                        homeCharacterDialogue.textContent = newDialogue;
                    } else {
                         homeCharacterDialogue.textContent = representativeCharacter.dialogues[0];
                    }
                } else {
                    homeCharacterContainer.classList.add('hidden');
                    homeDialogueContainer.classList.add('hidden');
                    homeDefaultMessage.classList.remove('hidden');
                }
            }


// âœ… 'ë„ê°' íƒ­ì˜ ë©”ì¸ í•¨ìˆ˜ (ìºë¦­í„° ëª©ë¡ ìƒì„±) - ìˆ˜ì •ë¨
function displayCollectionView() {
    const charListContainer = document.getElementById('collection-character-list');
    charListContainer.innerHTML = '';

    // 1. [íƒ­ ë²„íŠ¼ ì˜ì—­]
    const tabContainer = document.createElement('div');
    tabContainer.className = 'flex flex-wrap gap-2 mb-4 justify-center';

    COLLECTION_GROUPS.forEach(groupName => {
        const tabBtn = document.createElement('button');
        const isActive = (groupName === currentCollectionGroup);
        tabBtn.className = `px-3 py-1 rounded-full text-xs font-bold transition-all ${
            isActive ? 'bg-yellow-400 text-black shadow-lg scale-105' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
        }`;
        tabBtn.textContent = groupName;
        tabBtn.onclick = (e) => {
            e.stopPropagation();
            currentCollectionGroup = groupName;
            displayCollectionView();
        };
        tabContainer.appendChild(tabBtn);
    });
    charListContainer.appendChild(tabContainer);

    // 2. [ìºë¦­í„° ëª©ë¡] ìƒì„±
    const collectedBaseNames = new Set();
    if (typeof collectedCardNames !== 'undefined') {
        collectedCardNames.forEach(cardName => {
            const charData = findCharacter(cardName);
            if (charData) collectedBaseNames.add(charData.baseName);
        });
    }

    const allBaseNames = Object.keys(characterProfiles);
    const filteredNames = allBaseNames.filter(baseName => {
        const profile = characterProfiles[baseName];
        return profile.group === currentCollectionGroup;
    });

    if (filteredNames.length === 0) {
        charListContainer.innerHTML += `<p class="text-center text-gray-500 py-4">í•´ë‹¹ ê¸°ìˆ˜ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    } else {
        filteredNames.forEach(baseName => {
            const profile = characterProfiles[baseName];
            const isCollected = collectedBaseNames.has(baseName);
            
            // í˜„ì¬ ì„ íƒëœ ìºë¦­í„°ì¸ì§€ í™•ì¸
            const isActiveChar = (baseName === currentCollectionSelection);
            
            const button = document.createElement('button');
            
            let bgClass = '';
            if (isActiveChar) {
                bgClass = 'bg-blue-600 text-white shadow-md ring-2 ring-blue-400'; 
            } else if (isCollected) {
                bgClass = 'bg-white/10 hover:bg-white/20 text-white'; 
            } else {
                bgClass = 'bg-black/30 text-gray-500'; 
            }

            // âœ¨ [í•µì‹¬ ìˆ˜ì •] isActiveCharê°€ trueë©´ 'active' í´ë˜ìŠ¤ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤!
            button.className = `w-full text-left font-bold py-3 px-4 rounded-lg transition-all duration-200 mb-2 focus:outline-none ${bgClass} ${isActiveChar ? 'active' : ''}`;
            
            button.textContent = isCollected ? profile.name : '?????';
            button.dataset.baseName = baseName;
            
            button.onclick = () => displayCharacterDetail(baseName);
            
            charListContainer.appendChild(button);
        });
    }
}

// âœ… (ì‹ ê·œ) ìºë¦­í„° ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
function displayCharacterDetail(baseName) {
    const profile = characterProfiles[baseName];
    if (!profile) return;
    
    // âœ¨ [í•µì‹¬ ìˆ˜ì •] í˜„ì¬ ì„ íƒëœ ìºë¦­í„° ì´ë¦„ì„ ë³€ìˆ˜ì— ì €ì¥
    currentCollectionSelection = baseName;

    // 1. ìƒì„¸ ë·° ë³´ì´ê¸°
    document.getElementById('collection-character-detail-view').classList.remove('hidden');
    document.getElementById('collection-default-message').classList.add('hidden');
    
    // 2. í”„ë¡œí•„ ì •ë³´ ì±„ìš°ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    let isCollected = false;
    if (typeof collectedCardNames !== 'undefined') {
        isCollected = Array.from(collectedCardNames).some(cardName => {
            const charData = findCharacter(cardName);
            return charData && charData.baseName === baseName;
        });
    }

    if (isCollected) {
        document.getElementById('collection-profile-image').src = profile.imageUrl;
        document.getElementById('collection-profile-name').textContent = profile.name;
        document.getElementById('collection-profile-age').textContent = profile.age;
        document.getElementById('collection-profile-job').textContent = profile.job;
        document.getElementById('collection-profile-description').textContent = profile.description;
    } else {
        document.getElementById('collection-profile-image').src = 'https://placehold.co/300x500/000000/ffffff?text=???';
        document.getElementById('collection-profile-name').textContent = '?????';
        document.getElementById('collection-profile-age').textContent = '??';
        document.getElementById('collection-profile-job').textContent = '?????';
        document.getElementById('collection-profile-description').textContent = 'ì•„ì§ ì´ ë“±ì¥ì¸ë¬¼ì— ëŒ€í•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
    }
    
    // âœ¨ [í•µì‹¬ ìˆ˜ì •] ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ì¼ì¼ì´ ì¡°ì‘í•˜ëŠ” ëŒ€ì‹ , ëª©ë¡ ì „ì²´ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ê¹”ë”í•˜ê²Œ ì ìš©
    displayCollectionView();

    // 4. ì„œë¸Œ íƒ­ ì´ˆê¸°í™” (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    document.getElementById('collection-sub-tab-cards').classList.add('active');
    document.getElementById('collection-sub-tab-dialogues').classList.remove('active');
    document.getElementById('collection-cards-view').classList.remove('hidden');
    document.getElementById('collection-dialogues-view').classList.add('hidden');
    
    // 5. ì¹´ë“œ ëª¨ìŒ í‘œì‹œ
    displayCharacterCards(baseName, isCollected);
}

// âœ… (ì‹ ê·œ) íŠ¹ì • ìºë¦­í„°ì˜ 'ì¹´ë“œ ëª¨ìŒ' í‘œì‹œ í•¨ìˆ˜
function displayCharacterCards(baseName, isCollected) { 
    const cardContainer = document.getElementById('collection-container');
    cardContainer.innerHTML = '';
    
    // âœ¨ [ìˆ˜ì •ë¨] ì´ë¦„ì— '+' ê¸°í˜¸ê°€ í¬í•¨ëœ ì¹´ë“œëŠ” ëª©ë¡ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤.
    const characterVersions = characters.filter(c => 
        c.baseName === baseName && !c.name.includes('+')
    );

    characterVersions.forEach((character, index) => {
                    // ğŸ‘‡ isCardCollectedë¥¼ collectedCardNamesë¡œ ì§ì ‘ í™•ì¸
                    const isCardCollected = collectedCardNames.has(character.name); 
                    
                    const cardElement = createCard(character, { 
                        animationIndex: index, 
                        mode: 'collection', 
                        isCollected: isCardCollected,
                        // instance ì •ë³´ëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì „ë‹¬ (íŒŒì‡„ëœ ì¹´ë“œ ëŒ€ì‘)
                        instance: { id: character.name, level: 0, revision: 0 } 
                    });

                    // ğŸ‘‡ data-unique-id í• ë‹¹ ë¡œì§ ì‚­ì œ (íŒŒì‡„ëœ ì¹´ë“œëŠ” í´ë¦­í•´ë„ ìƒì„¸ ëª¨ë‹¬ X)
                    // if (isCardCollected) { ... } else { ... } ë¶€ë¶„ ì‚­ì œ

                    cardContainer.appendChild(cardElement);
                });
            }


// âœ… (ìˆ˜ì •ë¨) íŠ¹ì • ìºë¦­í„°ì˜ 'ëŒ€ì‚¬ ëª¨ìŒ' í‘œì‹œ í•¨ìˆ˜ (ì¹´ë“œ ë²„ì „ë³„ ì ê¸ˆ)
function displayCharacterDialogues(baseName) {
    const dialogueList = document.getElementById('collection-dialogues-list');
    dialogueList.innerHTML = '';
    
    // 1. ì´ ìºë¦­í„°ì˜ 'ëª¨ë“ ' ë²„ì „ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const allVersions = characters.filter(c => c.baseName === baseName);
    
    // 2. ì´ ìºë¦­í„°ì˜ ì¹´ë“œë¥¼ 'í•˜ë‚˜ë¼ë„' ìˆ˜ì§‘í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    const isAnyCardCollected = allVersions.some(character => collectedCardNames.has(character.name));

    // ì´ íƒ­ ìì²´ê°€ ì ê²¨ì•¼ í•˜ëŠ”ì§€ í™•ì¸
    if (!isAnyCardCollected) {
        dialogueList.innerHTML = `<p class="text-gray-400 text-center py-4">ë“±ì¥ì¸ë¬¼ì„ ìˆ˜ì§‘í•˜ì—¬ ëŒ€ì‚¬ íƒ­ì„ ì ê¸ˆ í•´ì œí•˜ì„¸ìš”.</p>`;
        return; 
    }

    // 3. í™”ë©´ì— í‘œì‹œí•  ë•ŒëŠ” 'ê°œì •íŒ(+)'ì´ ì•„ë‹Œ ì¹´ë“œë§Œ ì¶”ë ¤ëƒ…ë‹ˆë‹¤.
    const displayVersions = allVersions.filter(c => !c.name.includes('+'));

    // 4. ëŒ€ì‚¬ ì¶œë ¥ (ìˆ˜ì§‘ ì—¬ë¶€ì— ë”°ë¼ ì ê¸ˆ/í•´ê¸ˆ)
    displayVersions.forEach(character => {
        const isCardCollected = collectedCardNames.has(character.name); // âœ¨ ì´ ë²„ì „ì˜ ì¹´ë“œë¥¼ ìˆ˜ì§‘í–ˆëŠ”ì§€ í™•ì¸

        // --- í—¤ë” ì¶œë ¥ (ìˆ˜ì§‘ ì•ˆ í–ˆìœ¼ë©´ ğŸ”’ í‘œì‹œ) ---
        let headerHTML;
        if (isCardCollected) {
            headerHTML = `<h4 class="text-lg font-bold text-yellow-300 mt-2">${character.name}</h4>`;
        } else {
            headerHTML = `<h4 class="text-lg font-bold text-gray-500 mt-2">ğŸ”’ ${character.name} (ìˆ˜ì§‘ í•„ìš”)</h4>`;
        }
        dialogueList.innerHTML += headerHTML;
        
        if (isCardCollected) {
            // --- í•´ê¸ˆëœ ê²½ìš°: ëŒ€ì‚¬ ë‚´ìš© ì¶œë ¥ ---
            
            // ì¼ë°˜ ëŒ€ì‚¬
            if (character.dialogues) {
                character.dialogues.forEach(diag => { 
                    dialogueList.innerHTML += `<p class="pl-4 text-gray-300 mb-1">"${diag}"</p>`; 
                });
            }

            // ìŠ¤í‚¬ ëŒ€ì‚¬
            if (character.skills) {
                character.skills.forEach(skill => { 
                    dialogueList.innerHTML += `<p class="pl-4 text-cyan-300 mb-1"><span class="text-xs border border-cyan-500 px-1 rounded mr-1">ìŠ¤í‚¬</span> "${skill.dialogue}"</p>`; 
                });
            }

            // ì‚¬ë§ ëŒ€ì‚¬
            if (character.deathDialogue) {
                dialogueList.innerHTML += `<p class="pl-4 text-red-400 mb-1"><span class="text-xs border border-red-500 px-1 rounded mr-1">ì‚¬ë§</span> "${character.deathDialogue}"</p>`;
            }
            
        } else {
            // --- ì ê¸´ ê²½ìš°: ì ê¸ˆ ë©”ì‹œì§€ ì¶œë ¥ ---
            dialogueList.innerHTML += `<p class="pl-4 text-gray-600 mb-1">í•´ë‹¹ ì›ê³ ë¥¼ ìˆ˜ì§‘í•´ì•¼ë§Œ ëŒ€ì‚¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
        }
        
        dialogueList.innerHTML += `<hr class="border-gray-600 my-4">`;
    });
}

// âœ… displayEventView í•¨ìˆ˜ ë°”ë¡œ ìœ„ì— ì´ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.

// [ìˆ˜ì •] ì´ë²¤íŠ¸ í™ˆ í™”ë©´ í‘œì‹œ (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
function displayEventHomeView() {
    // âœ¨ ì•ˆì „ì¥ì¹˜: ì´ë²¤íŠ¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê³  ì¤‘ë‹¨ (ì—ëŸ¬ ë°©ì§€)
    if (!currentEventInfo || !currentEventInfo.startDate) {
        console.warn("í‘œì‹œí•  ì´ë²¤íŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    };
    
    // ë‚ ì§œ í¬ë§·íŒ…
    const startDateStr = currentEventInfo.startDate.toLocaleDateString('ko-KR', options);
    const endDateStr = currentEventInfo.endDate.toLocaleDateString('ko-KR', options);
    
    // í…ìŠ¤íŠ¸ ë° ì´ë¯¸ì§€ ì„¤ì •
    document.getElementById('event-home-duration').textContent = `${startDateStr} ~ ${endDateStr}`;
    document.getElementById('event-home-banner-image').src = currentEventInfo.bannerImageUrl;
    document.getElementById('event-home-description').textContent = currentEventInfo.description;
    
    // í¬ì¸íŠ¸ í‘œì‹œ
    const holdingEl = document.getElementById('display-holding-points');
    if (holdingEl) holdingEl.textContent = (playerEventPoints || 0).toLocaleString();

    const cumulativeEl = document.getElementById('display-cumulative-points');
    if (cumulativeEl) cumulativeEl.textContent = (playerCumulativeEventPoints || 0).toLocaleString();
    
    // ë­í‚¹ ë¡œë“œ
    loadRankingPreview();
}
			
            function displayEventView() {
                displayEventBattleView();
                displayEventStories(); // ğŸ‘ˆ 'displayEventStoryView'ë¥¼ 'displayEventStories'ë¡œ ë³€ê²½!
                displayEventShopView();
               
            }

            function displayEventBattleView() {
                eventDungeonListContainer.innerHTML = '';
                eventDungeons.forEach((dungeon, index) => {
                    const isUnlocked = index === 0 || clearedEventDungeons.includes(eventDungeons[index - 1].name);
                    const isCleared = clearedEventDungeons.includes(dungeon.name);
                    const dungeonEl = document.createElement('button');
                    dungeonEl.className = `p-4 rounded-lg transition-colors duration-300 text-center ${isUnlocked ? 'bg-white/20 hover:bg-white/30 cursor-pointer' : 'bg-black/30 text-gray-500 cursor-not-allowed'}`;
                    dungeonEl.disabled = !isUnlocked;
                    
                    dungeonEl.innerHTML = `
                        <h3 class="text-xl font-bold ${isUnlocked ? 'text-yellow-300' : ''}">${dungeon.name}</h3>
                        <p class="text-sm">ë³´ìƒ: ${dungeon.eventPointReward} P ${isCleared ? '<span class="text-green-400">(í´ë¦¬ì–´)</span>' : ''}</p>
                    `;
                    if(isUnlocked){
                        dungeonEl.onclick = () => challengeDungeon(index, 'event');
                    }
                    eventDungeonListContainer.appendChild(dungeonEl);
                });
            }

            function displayEventStoryView() {
                eventStoryContainer.innerHTML = '';
                eventStories.forEach((story, index) => {
                    const isUnlocked = index === 0 || clearedEventDungeons.includes(eventDungeons[index - 1].name);
                    const storyEl = document.createElement('div');
                    storyEl.className = `p-4 rounded-lg transition-colors duration-300 ${isUnlocked ? 'bg-white/20 hover:bg-white/30 cursor-pointer' : 'bg-black/30 text-gray-500'}`;
                    if (isUnlocked) {
                        storyEl.dataset.storyIndex = index;
                        storyEl.dataset.storyType = 'event';
                    }

                    storyEl.innerHTML = `
                        <h3 class="text-xl font-bold ${isUnlocked ? 'text-yellow-300' : ''}">${story.title}</h3>
                        <p class="text-sm">${isUnlocked ? 'í´ë¦­í•˜ì—¬ ìŠ¤í† ë¦¬ ì½ê¸°' : `${eventDungeons[index-1].name} í´ë¦¬ì–´ ì‹œ í•´ê¸ˆ`}</p>
                    `;
                    eventStoryContainer.appendChild(storyEl);
                });
            }
            
            function displayEventShopView() {
                eventPointsSpan.textContent = playerEventPoints;
                eventShopContainer.innerHTML = '';
                eventShopItems.forEach(item => {
                    const purchasedCount = purchasedEventItems[item.id] || 0;
                    const isSoldOut = purchasedCount >= item.limit;
                    const canAfford = playerEventPoints >= item.cost;

                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-black/20 p-4 rounded-lg flex justify-between items-center';
                    itemEl.innerHTML = `
                        <div>
                            <h3 class="text-lg font-bold text-yellow-300">${item.name}</h3>
                            <p class="text-sm text-gray-300">ê°€ê²©: ${item.cost} P</p>
                            <p class="text-xs text-gray-400">ë‚¨ì€ íšŸìˆ˜: ${item.limit - purchasedCount} / ${item.limit}</p>
                        </div>
                        <button data-item-id="${item.id}" class="gacha-button bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-full" ${isSoldOut || !canAfford ? 'disabled' : ''}>
                            ${isSoldOut ? 'í’ˆì ˆ' : 'êµ¬ë§¤'}
                        </button>
                    `;
                    eventShopContainer.appendChild(itemEl);
                });
            }
            
            function purchaseEventItem(itemId) {
                const item = eventShopItems.find(i => i.id === itemId);
                if (!item) return;

                const purchasedCount = purchasedEventItems[item.id] || 0;
                if (purchasedCount >= item.limit) {
                    showMessage('ì´ë¯¸ ìµœëŒ€ ìˆ˜ëŸ‰ì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.', 'text-red-400', messageArea);
                    return;
                }
                if (playerEventPoints < item.cost) {
                    showMessage('ì´ë²¤íŠ¸ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'text-red-400', messageArea);
                    return;
                }

                playerEventPoints -= item.cost;
                purchasedEventItems[item.id] = purchasedCount + 1;

                if (item.type === 'card') {
                    playerInventory.push(item.itemData);
                    showMessage(`[${item.name}] íšë“!`, 'text-green-300', messageArea);
                } else if (item.type === 'currency') {
                    playerCurrency += item.itemData;
                    showMessage(`ë³´ì„ ${item.itemData}ê°œ íšë“!`, 'text-green-300', messageArea);
                }
				// âœ¨ [ì¶”ê°€] ë§Œë…„í•„ êµ¬ë§¤ ë¡œì§
                else if (item.type === 'fountainPen') {
                    playerFountainPens += item.itemData;
                    showMessage(`ë§Œë…„í•„ ${item.itemData}ê°œ íšë“!`, 'text-gray-300', messageArea);
                }
                // âœ¨ [ì¶”ê°€] ì‰í¬ë³‘ë„ ë‚˜ì¤‘ì— íŒ”ê³  ì‹¶ë‹¤ë©´ ë¯¸ë¦¬ ì¶”ê°€í•´ë‘ì„¸ìš”
                else if (item.type === 'inkwell') {
                    playerInkwells += item.itemData;
                    showMessage(`ì‰í¬ë³‘ ${item.itemData}ê°œ íšë“!`, 'text-fuchsia-300', messageArea);
                }
				// âœ¨ [ì¶”ê°€] ì±…ê°ˆí”¼ êµ¬ë§¤ ë¡œì§ (30ê°œ í•œë„ ì ìš©)
                else if (item.type === 'bookmark') {
                    if (playerBookmarks >= HARD_MAX_BOOKMARKS) {
                        showMessage(`ì±…ê°ˆí”¼ëŠ” ìµœëŒ€ ${HARD_MAX_BOOKMARKS}ê°œê¹Œì§€ë§Œ ì†Œì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'text-red-400', messageArea);
                        return; // êµ¬ë§¤ ì·¨ì†Œ (í¬ì¸íŠ¸ ì°¨ê° ì•ˆ ë¨)
                    }
                    
                    // êµ¬ë§¤ ì‹œ 30ê°œë¥¼ ì´ˆê³¼í•˜ë©´ 30ê°œê¹Œì§€ë§Œ ì±„ì›€
                    playerBookmarks = Math.min(HARD_MAX_BOOKMARKS, playerBookmarks + item.itemData);
                    showMessage(`ì±…ê°ˆí”¼ íšë“! (í˜„ì¬: ${playerBookmarks})`, 'text-cyan-300', messageArea);
                }

                updateUI();
                displayEventShopView();
                saveGame();
            }

            function calculateOfflineRegen() {
                if (playerBookmarks >= MAX_BOOKMARKS) {
                    lastBookmarkUpdateTime = Date.now();
                    return;
                }
                const now = Date.now();
                const timeDiff = now - lastBookmarkUpdateTime;
                const bookmarksToRegen = Math.floor(timeDiff / BOOKMARK_REGEN_TIME);

                if (bookmarksToRegen > 0) {
                    playerBookmarks = Math.min(MAX_BOOKMARKS, playerBookmarks + bookmarksToRegen);
                    lastBookmarkUpdateTime = lastBookmarkUpdateTime + bookmarksToRegen * BOOKMARK_REGEN_TIME;
                    saveGame();
                }
            }

            function startBookmarkRegenTimer() {
                setInterval(() => {
                    // ì´ ë¸”ë¡ì€ ì±…ê°ˆí”¼ê°€ ì‹¤ì œë¡œ ì¶©ì „ë˜ëŠ” ë¡œì§ì…ë‹ˆë‹¤.
                    if (playerBookmarks < MAX_BOOKMARKS) {
                        const now = Date.now();
                        if (now - lastBookmarkUpdateTime >= BOOKMARK_REGEN_TIME) {
                            playerBookmarks++;
                            lastBookmarkUpdateTime = now; // íƒ€ì´ë¨¸ë¥¼ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                            updateUI();
                            saveGame();
                        }
                    }

                    // ì´ ë¸”ë¡ì€ ë‚¨ì€ ì‹œê°„ì„ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ë¡œì§ì…ë‹ˆë‹¤.
                    if (playerBookmarks < MAX_BOOKMARKS) {
                        const timeRemaining = BOOKMARK_REGEN_TIME - (Date.now() - lastBookmarkUpdateTime);
                        const minutes = Math.floor(timeRemaining / 60000);
                        const seconds = Math.floor((timeRemaining % 60000) / 1000);
                        
                        // MM:SS í˜•ì‹ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. (ì˜ˆ: 04:32)
                        bookmarkTimerContainer.textContent = `(${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')})`;
                        bookmarkTimerContainer.classList.remove('hidden');
                    } else {
                        // ì±…ê°ˆí”¼ê°€ ê°€ë“ ì°¨ë©´ íƒ€ì´ë¨¸ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                        bookmarkTimerContainer.classList.add('hidden');
                    }
                }, 1000); // 1ì´ˆë§ˆë‹¤ ë°˜ë³µ
            }


            function setRepresentative(cardName) {
                const cardData = findCharacter(cardName);
                if (cardData) {
                    representativeCharacter = cardData;
                    showMessage(`${cardData.name}(ì„)ë¥¼ ëŒ€í‘œë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤!`, 'text-blue-300', messageArea);
                    displayInventory();
                    saveGame();
                }
            }
            
            function handlePull(count, cost, gachaType = 'normal') {
                if (playerInventory.length + count > inventoryCapacity) {
                    showMessage('ì„œê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-yellow-400', messageArea); return;
                }
                if (playerCurrency >= cost) {
                    playerCurrency -= cost;
                    showMessage(`-ğŸ’${cost}`, 'text-red-400', messageArea);
                    performPulls(count, gachaType);
                } else {
                    showMessage('ì¬í™”ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-red-400', messageArea);
                }
            }
            
            function expandInventory() {
                if (playerCurrency >= EXPAND_COST) {
                    playerCurrency -= EXPAND_COST; inventoryCapacity += EXPAND_AMOUNT;
                    showMessage(`ì„œê³ ê°€ ${inventoryCapacity}ì¹¸ìœ¼ë¡œ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'text-green-300', messageArea);
                    updateUI(); displayInventory(); saveGame();
                    checkAchievements();
                } else {
                    showMessage('ë³´ì„ì´ ë¶€ì¡±í•˜ì—¬ í™•ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text-red-400', messageArea);
                }
            }

            function updateUI() {
                currencyDisplay.textContent = playerCurrency;
                fountainPenDisplay.textContent = playerFountainPens; // ë§Œë…„í•„ UI ì—…ë°ì´íŠ¸
				document.getElementById('inkwell-display').textContent = playerInkwells;
                eventPointsSpan.textContent = playerEventPoints;
                bookmarkDisplay.textContent = playerBookmarks;
                maxBookmarkDisplay.textContent = MAX_BOOKMARKS;

                const buttons = [pullOneButton, pullTenButton, pullOneEventButton, pullTenEventButton];
                buttons.forEach(btn => {
                    if (btn.id.includes('ten')) btn.disabled = playerCurrency < PULL_TEN_COST;
                    else btn.disabled = playerCurrency < PULL_ONE_COST;
                });
                expandInventoryButton.disabled = playerCurrency < EXPAND_COST;
            }
			
            

            function showMessage(message, colorClass, element) {
    element.textContent = message;
    element.className = `text-center text-lg h-8 mb-4 transition-opacity duration-300 ${colorClass}`;
    setTimeout(() => { element.textContent = ''; }, 2000); // 2ì´ˆ í›„ ë©”ì‹œì§€ë¥¼ ì§€ì›ë‹ˆë‹¤.
}
			
			function generateUniqueId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function addCardToInventory(cardName) {
            const newCard = {
                id: generateUniqueId(),
                name: cardName,
                level: 0, 
                revision: 0 
            };
            playerInventory.push(newCard);
            
            // âœ¨ [ì¶”ê°€] ìˆ˜ì§‘ ê¸°ë¡ì— ë“±ë¡ (ì¤‘ë³µì´ì–´ë„ Setì´ë¼ ìƒê´€ì—†ìŒ)
            collectedCardNames.add(cardName); 
        }

            function performPulls(count, gachaType = 'normal') {
    const results = [];
                let guaranteedSR = (count === 10);
                for (let i = 0; i < count; i++) {
                    let pulledChar;
                    if (guaranteedSR && i === count - 1 && !results.some(c => c.rarity === 'SR' || c.rarity === 'SSR')) {
                        pulledChar = pullCharacter(['SR', 'SSR'], gachaType);
                    } else {
                        pulledChar = pullCharacter(null, gachaType);
                    }
                    results.push(pulledChar);
                    addCardToInventory(pulledChar.name);
                    playerStats.totalPulls++; // ì´ ì¤„ ì¶”ê°€
                }
                displayResults(results); updateUI(); saveGame();
                checkAchievements(); // ì´ ì¤„ ì¶”ê°€
            }
			
			function getEnhancedStats(cardInstance) {
    const baseCard = findCharacter(cardInstance.name);
    if (!baseCard) return null;

    // âœ¨ 'ê°œì •'ì— ë”°ë¥¸ ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ ë³´ë„ˆìŠ¤ë¥¼ ë¨¼ì € ê³„ì‚°
    const revisionBonus = 1 + (cardInstance.revision * STAT_INCREASE_PER_REVISION);
    const revisedStats = {
        hp: Math.floor(baseCard.stats.hp * revisionBonus),
        atk: Math.floor(baseCard.stats.atk * revisionBonus),
        def: Math.floor(baseCard.stats.def * revisionBonus),
    };

    // ê·¸ ë‹¤ìŒ 'í‡´ê³ 'ì— ë”°ë¥¸ ë³´ë„ˆìŠ¤ë¥¼ ì ìš©
    const enhancementBonus = 1 + (cardInstance.level * STAT_INCREASE_PER_LEVEL);
    return {
        hp: Math.floor(revisedStats.hp * enhancementBonus),
        atk: Math.floor(revisedStats.atk * enhancementBonus),
        def: Math.floor(revisedStats.def * enhancementBonus),
    };
}

            // gacha1.html

function pullCharacter(allowedRarities = null, gachaType = 'normal') {
    const now = new Date();
    
    // âœ¨ [í•µì‹¬ ìˆ˜ì •] currentEventInfoê°€ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤!
    // (ì´ë²¤íŠ¸ê°€ ì—†ìœ¼ë©´ nullì´ë¯€ë¡œ ë’¤ì˜ ì¡°ê±´ë“¤ì€ ê²€ì‚¬í•˜ì§€ ì•Šê³  falseê°€ ë©ë‹ˆë‹¤)
    const isEventActive = currentEventInfo && currentEventInfo.startDate && 
                          now >= currentEventInfo.startDate && now <= currentEventInfo.endDate;
    
    // gachaTypeì´ 'event'ì—¬ë„ ì´ë²¤íŠ¸ ê¸°ê°„ì´ ì•„ë‹ˆë©´ í™•ë¥ ì€ normalì„ ì”€ (ë‹¨, í’€ì€ gachaTypeì„ ë”°ë¦„)
    const useEventRates = gachaType === 'event' && isEventActive;
    const probabilities = useEventRates ? eventRarityProbabilities : rarityProbabilities;
    
    let selectedRarity = '';

    // 1. ë“±ê¸‰(Rarity) ê²°ì •
    if (allowedRarities) {
        // 10íšŒ ë½‘ê¸° í™•ì • ë“±ê¸‰ (SR ì´ìƒ)
        const highTierProb = { 'SSR': probabilities['SSR'], 'SR': probabilities['SR'] };
        const totalProb = highTierProb.SSR + highTierProb.SR;
        // SSR/SR ë¹„ìœ¨ì— ë§ì¶° ì¬ì¶”ì²¨
        selectedRarity = (Math.random() * totalProb < highTierProb.SSR) ? 'SSR' : 'SR';
    } else {
        // ì¼ë°˜ í™•ë¥  ë½‘ê¸°
        const rand = Math.random() * 100; 
        let cumulativeProb = 0;
        for (const rarity in probabilities) {
            cumulativeProb += probabilities[rarity];
            if (rand < cumulativeProb) { selectedRarity = rarity; break; }
        }
    }

    // 2. ê²°ì •ëœ ë“±ê¸‰ì— ë§ëŠ” ìºë¦­í„°ë“¤ ì¤‘ "í˜„ì¬ ê°€ì±  íƒ€ì…ì— ë“±ì¥í•˜ëŠ” ì• ë“¤"ë§Œ í•„í„°ë§
    let possibleCharacters = characters.filter(char => {
        // (1) ë“±ê¸‰ì´ ë§ì•„ì•¼ í•¨
        if (char.rarity !== selectedRarity) return false;

        // (2) ê°€ì±  í’€ ë°ì´í„° í™•ì¸
        const poolInfo = gachaPool[char.name];
        if (!poolInfo) return false; // ì‹œíŠ¸ì— ì´ë¦„ ì—†ìœ¼ë©´ ì ˆëŒ€ ì•ˆ ë‚˜ì˜´

        // (3) íƒ€ì…(ì¼ë°˜/ì´ë²¤íŠ¸)ì— ë”°ë¼ ë“±ì¥ ì—¬ë¶€ í™•ì¸
        if (gachaType === 'normal') return poolInfo.normal;
        if (gachaType === 'event') return poolInfo.event;
        
        return false;
    });

    // ë§Œì•½ ì„¤ì • ì‹¤ìˆ˜ë¡œ í•´ë‹¹ ë“±ê¸‰ì— ë½‘ì„ ìºë¦­í„°ê°€ í•˜ë‚˜ë„ ì—†ë‹¤ë©´? (ì•ˆì „ì¥ì¹˜)
    if (possibleCharacters.length === 0) {
        console.warn(`ê²½ê³ : ${gachaType} ë½‘ê¸°ì˜ ${selectedRarity} ë“±ê¸‰ì— í•´ë‹¹í•˜ëŠ” ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤! Në“±ê¸‰ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.`);
        
        // Në“±ê¸‰ ìºë¦­í„°ë“¤ì„ ëª¨ë‘ ì°¾ì•„ì„œ ê·¸ ì¤‘ ëœë¤ìœ¼ë¡œ í•˜ë‚˜ë¥¼ ì¤ë‹ˆë‹¤
        const nRankChars = characters.filter(c => c.rarity === 'N');
        
        if (nRankChars.length > 0) {
            return nRankChars[Math.floor(Math.random() * nRankChars.length)];
        }
        
        // (ë§Œì•½ Në“±ê¸‰ì¡°ì°¨ í•˜ë‚˜ë„ ì—†ë‹¤ë©´ ì–´ì©” ìˆ˜ ì—†ì´ ì „ì²´ ëª©ë¡ì˜ ì²« ë²ˆì§¸ë¥¼ ì¤ë‹ˆë‹¤)
        return characters[0];
    }

    // 3. í”½ì—… ìºë¦­í„° í™•ë¥  ì ìš© (ì´ë²¤íŠ¸ ë½‘ê¸°ì¸ ê²½ìš°)
    if (useEventRates && (selectedRarity === 'SSR' || selectedRarity === 'SR')) {
        // í”½ì—… ëŒ€ìƒ ìºë¦­í„°ê°€ í˜„ì¬ ë½‘ê¸° ê°€ëŠ¥ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
        const pickupChar = possibleCharacters.find(c => c.name === EVENT_CHARACTER_NAME);
        
        if (pickupChar) {
            // 50% í™•ë¥ ë¡œ í”½ì—… ìºë¦­í„° ë“±ì¥
            if (Math.random() < 0.5) {
                return pickupChar;
            } else {
                // ë‚˜ë¨¸ì§€ 50%ëŠ” í”½ì—… ìºë¦­í„°ë¥¼ ì œì™¸í•œ ë‹¤ë¥¸ ì• ë“¤ ì¤‘ì—ì„œ ëœë¤
                const otherChars = possibleCharacters.filter(c => c.name !== EVENT_CHARACTER_NAME);
                if (otherChars.length > 0) {
                    return otherChars[Math.floor(Math.random() * otherChars.length)];
                }
                return pickupChar; // ë‹¤ë¥¸ ì• ê°€ ì—†ìœ¼ë©´ í”½ì—…ìº ì¤Œ
            }
        }
    }

    // 4. ìµœì¢… ëœë¤ ì„ íƒ
    return possibleCharacters[Math.floor(Math.random() * possibleCharacters.length)];
}

            function displayResults(pulledCharacters) {
                resultsContainer.innerHTML = '';
                pulledCharacters.forEach((character, index) => {
                    resultsContainer.appendChild(createCard(character, { animationIndex: index, mode: 'gachaResult' }));
                });
            }
            
            function getUniqueInventory() {
                const cardCounts = playerInventory.reduce((acc, card) => {
                    if (card && card.name) {
                        if (!acc[card.name]) { acc[card.name] = { ...card, count: 0 }; }
                        acc[card.name].count++;
                    }
                    return acc;
                }, {});
                const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
                return Object.values(cardCounts).sort((a, b) => (rarityOrder[b.rarity] - rarityOrder[a.rarity]) || a.name.localeCompare(b.name));
            }

            // âœ… ì´ ì½”ë“œë¡œ ê¸°ì¡´ displayInventory í•¨ìˆ˜ë¥¼ í†µì§¸ë¡œ êµì²´í•´ì£¼ì„¸ìš”.
            // âœ… ì´ ì½”ë“œë¡œ ê¸°ì¡´ displayInventory í•¨ìˆ˜ë¥¼ í†µì§¸ë¡œ êµì²´í•´ì£¼ì„¸ìš”.
            function displayInventory() {
    inventoryStatus.textContent = `${playerInventory.length} / ${inventoryCapacity}`;
    inventoryContainer.innerHTML = '';

    // --- 1. í•„í„°ë§ ë¡œì§ ---
    const filteredInventory = playerInventory.filter(cardInstance => {
        if (currentRarityFilter === 'All') return true;
        const character = findCharacter(cardInstance.name);
        return character && character.rarity === currentRarityFilter;
    });

    if (filteredInventory.length === 0) {
        const emptyMessage = currentRarityFilter === 'All' 
            ? 'ì•„ì§ ìˆ˜ì§‘í•œ ë“±ì¥ì¸ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.' 
            : `í•´ë‹¹ ë“±ê¸‰ì˜ ë“±ì¥ì¸ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.`;
        inventoryContainer.innerHTML = `<p class="col-span-full text-center text-gray-400 mt-10">${emptyMessage}</p>`;
        if (isMultiSelectMode) {
            updateMultiSelectUI();
        }
        return;
    }

    // --- 2. ğŸ”½ ì •ë ¬ ë¡œì§ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„) ğŸ”½ ---
    const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
    const sortedInventory = [...filteredInventory].sort((a, b) => {
        const charA = findCharacter(a.name);
        const charB = findCharacter(b.name);

        // ğŸ›¡ï¸ [ì•ˆì „ì¥ì¹˜] ìºë¦­í„° ë°ì´í„°ê°€ ì—†ëŠ” ìœ ë ¹ ì¹´ë“œëŠ” ë§¨ ë’¤ë¡œ ë³´ëƒ„ (ì—ëŸ¬ ë°©ì§€)
        if (!charA && !charB) return 0;
        if (!charA) return 1;
        if (!charB) return -1;

        let comparison = 0;
        
        // ì•ˆì „ì¥ì¹˜ 2: í˜¹ì‹œ ë°ì´í„°ëŠ” ìˆëŠ”ë° ë“±ê¸‰(rarity)ì´ ë¹„ì–´ìˆì„ ê²½ìš° ëŒ€ë¹„
        const rarityA = (charA.rarity && rarityOrder[charA.rarity]) ? rarityOrder[charA.rarity] : 0;
        const rarityB = (charB.rarity && rarityOrder[charB.rarity]) ? rarityOrder[charB.rarity] : 0;

        switch (currentSortOrder) {
            case 'level':
                // í‡´ê³  ìˆœ: ë ˆë²¨ ë†’ì€ ìˆœ > ë“±ê¸‰ ë†’ì€ ìˆœ > ì´ë¦„ ê°€ë‚˜ë‹¤ ìˆœ
                comparison = (b.level - a.level) || (rarityB - rarityA) || charA.baseName.localeCompare(charB.baseName);
                break;
            case 'revision':
                // ê°œì • ìˆœ: ê°œì • ë†’ì€ ìˆœ > ë“±ê¸‰ ë†’ì€ ìˆœ > ì´ë¦„ ê°€ë‚˜ë‹¤ ìˆœ
                comparison = (b.revision - a.revision) || (rarityB - rarityA) || charA.baseName.localeCompare(charB.baseName);
                break;
            case 'name':
                // ì´ë¦„ ìˆœ: ì´ë¦„ ê°€ë‚˜ë‹¤ ìˆœ > ë“±ê¸‰ ë†’ì€ ìˆœ > ë ˆë²¨ ë†’ì€ ìˆœ
                comparison = charA.baseName.localeCompare(charB.baseName) || (rarityB - rarityA) || (b.level - a.level);
                break;
            case 'rarity':
            default:
                // âœ¨ ë“±ê¸‰ ìˆœ: ë“±ê¸‰ ë†’ì€ ìˆœ > ì´ë¦„ ê°€ë‚˜ë‹¤ ìˆœ > ë ˆë²¨ ë†’ì€ ìˆœ
                comparison = (rarityB - rarityA) || charA.baseName.localeCompare(charB.baseName) || (b.level - a.level);
                break;
        }
        return isSortAscending ? comparison * -1 : comparison;
    });
    // --- ğŸ”¼ ì •ë ¬ ë¡œì§ ë ğŸ”¼ ---

    // --- 3. í™”ë©´ í‘œì‹œ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    sortedInventory.forEach((cardInstance, index) => {
        const character = findCharacter(cardInstance.name);
        if (character) {
            const cardElement = createCard(character, { animationIndex: index, mode: 'inventory', instance: cardInstance });
            if (isMultiSelectMode) {
                cardElement.classList.add('multi-select-card');
                const isInDeck = playerDeck.some(deckCard => deckCard.id === cardInstance.id);
                if (isInDeck) {
                    cardElement.classList.add('opacity-40', 'cursor-not-allowed', 'bg-red-900/30');
                    cardElement.title = "ë±ì— í¬í•¨ë˜ì–´ íŒŒì‡„ ë¶ˆê°€";
                } else {
                    cardElement.classList.add('cursor-pointer');
                }
                if (selectedCardsToDismantle.has(cardInstance.id)) {
                    cardElement.classList.remove('bg-black/20');
                    cardElement.classList.add('border-4', 'border-yellow-400', 'bg-blue-900/50');
                } else if (!isInDeck) {
                    cardElement.classList.add('border', 'border-gray-500', 'bg-black/20');
                }
                cardElement.querySelector('[data-action="set-representative"]').classList.add('hidden');
            }
            inventoryContainer.appendChild(cardElement);
        }
    });

    // --- 4. ë²„íŠ¼ UI ì—…ë°ì´íŠ¸ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    document.querySelectorAll('.sort-button').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-500');
        btn.querySelector('.sort-indicator').textContent = '';
    });
    const activeSortButton = document.querySelector(`.sort-button[data-sort="${currentSortOrder}"]`);
    if (activeSortButton) {
        activeSortButton.classList.add('active', 'bg-blue-500');
        activeSortButton.querySelector('.sort-indicator').textContent = isSortAscending ? ' â–²' : ' â–¼';
    }

    document.querySelectorAll('.filter-button').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-500');
        if (btn.dataset.filter === currentRarityFilter) {
            btn.classList.add('active', 'bg-blue-500');
        }
    });
    
    if (isMultiSelectMode) {
        updateMultiSelectUI();
    }
}

		// ================== âœ¨ ë§ˆì´ë£¸ & ê°€êµ¬ ìƒì  ë¡œì§ ì‹œì‘ âœ¨ ==================

// 1. ë§ˆì´ë£¸ í™”ë©´ í‘œì‹œ (ìºë¦­í„° & ê°€êµ¬ ë Œë”ë§)
		// ================== âœ¨ ì•„ì´ì†Œë©”íŠ¸ë¦­(ë§ˆë¦„ëª¨) ë³€í™˜ ë¡œì§ âœ¨ ==================

// 1. ê·¸ë¦¬ë“œ ì¢Œí‘œ ë³€í™˜ í•¨ìˆ˜ (ë²½ ì•ˆìª½ìœ¼ë¡œ ë²”ìœ„ ì¶•ì†Œ)
function getIsoPos(gridX, gridY) {
    const centerX = 50; 
    
    // âœ¨ [ìˆ˜ì • 1] ë°”ë‹¥ ì¤‘ì‹¬ì  ë†’ì´ (30 -> 35)
    // ì „ì²´ì ìœ¼ë¡œ ì‚´ì§ ë‚´ë ¤ì„œ ìœ„ìª½ ë²½ì— ë‹¿ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
    const centerY = 45; 
    
    // âœ¨ [ìˆ˜ì • 2] ë„ˆë¹„ ê³„ìˆ˜ ì¶•ì†Œ (0.46 -> 0.38)
    // ì¢Œìš° ë²½ ë‘ê»˜ë§Œí¼ ì•ˆìª½ìœ¼ë¡œ ë“¤ì—¬ì˜µë‹ˆë‹¤.
    const widthFactor = 0.38;  
    
    // âœ¨ [ìˆ˜ì • 3] ë†’ì´ ê³„ìˆ˜ ì¶•ì†Œ (0.30 -> 0.24)
    // ì•„ë˜ìª½ ë²½ì— ë‹¿ì§€ ì•Šê²Œ ìƒí•˜ í­ì„ ì¤„ì…ë‹ˆë‹¤.
    const heightFactor = 0.24; 
    
    const screenX = centerX + (gridX - gridY) * widthFactor;
    const screenY = centerY + (gridX + gridY) * heightFactor;
    
    const zIndex = Math.floor(gridX + gridY);
    
    return { left: screenX, top: screenY, zIndex: zIndex };
}

// 2. ì—­ë³€í™˜ í•¨ìˆ˜ (ìœ„ì™€ ë³€ìˆ˜ê°’ ì¼ì¹˜ í•„ìˆ˜)
function getGridPosFromScreen(screenX, screenY) {
    const centerX = 50;
    const centerY = 45; // âœ¨ ì¼ì¹˜ì‹œí‚´
    
    const widthFactor = 0.38; // âœ¨ ì¼ì¹˜ì‹œí‚´
    const heightFactor = 0.24; // âœ¨ ì¼ì¹˜ì‹œí‚´
    
    const dx = (screenX - centerX) / widthFactor;
    const dy = (screenY - centerY) / heightFactor;
    
    let gridX = (dx + dy) / 2;
    let gridY = (dy - dx) / 2;
    
    gridX = Math.max(0, Math.min(100, gridX));
    gridY = Math.max(0, Math.min(100, gridY));
    
    return { x: gridX, y: gridY };
}

// ================== âœ¨ ìˆ˜ì •ëœ displayMyRoom (ì „ì²´ ì½”ë“œ) âœ¨ ==================
function displayMyRoom() {
    const roomLayer = document.getElementById('room-layer');
    if (!roomLayer) return;
    roomLayer.innerHTML = '';

    // âœ¨ [ì¶”ê°€] ê°€êµ¬ ë°ì´í„°ê°€ ë¹„ì–´ìˆë‹¤ë©´ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™” (ì—ëŸ¬ ë°©ì§€)
    if (!playerRoom.furniture) playerRoom.furniture = [];

    // (1) ê°€êµ¬ ë Œë”ë§
    playerRoom.furniture.forEach((item, index) => {
        const furnitureData = furnitureItems.find(f => f.id === item.id);
        if (furnitureData) {
            const el = document.createElement('img');
            el.src = furnitureData.imageUrl;
            
            // âœ¨ [ìˆ˜ì •] pointer-events-auto ì¶”ê°€ (ê°€êµ¬ í´ë¦­/ë“œë˜ê·¸ í—ˆìš©)
            el.className = 'placed-furniture absolute transition-transform duration-200 pointer-events-auto';
            
            el.dataset.id = item.id;
            el.dataset.key = index;

            const iso = getIsoPos(item.x, item.y);
            el.style.left = `${iso.left}%`;
            el.style.top = `${iso.top}%`;
            
            const flipTransform = item.isFlipped ? 'scaleX(-1)' : 'scaleX(1)';
            let zOffset = 0;

            if (furnitureData.type === 'rug') {
                el.style.transform = `translate(-50%, -50%) rotate(45deg) scaleY(0.58) ${flipTransform}`;
                el.style.width = `${furnitureData.size.w * 7}%`; 
                el.style.opacity = '0.95';
                zOffset = -100; 
            } else if (furnitureData.type === 'wall') {
                el.style.transform = `translate(-50%, -200%) ${flipTransform}`;
                el.style.width = `${furnitureData.size.w * 10}%`; 
                zOffset = -50; 
            } else {
                el.style.transform = `translate(-50%, -95%) ${flipTransform}`;
               let baseWidth = 12; 
                if (furnitureData.scale) {
                    baseWidth = baseWidth * furnitureData.scale;
                }
                el.style.width = `${baseWidth}%`; 
                
                el.style.filter = 'drop-shadow(0px 5px 5px rgba(0,0,0,0.5))'; 
                zOffset = 0; 
            }
            el.style.zIndex = iso.zIndex + zOffset; 
            roomLayer.appendChild(el);
        }
    });

    // (2) SD ìºë¦­í„° ë Œë”ë§ (ìˆ˜ì •ë¨: ë§ˆì´ë£¸ ì„¤ì • ìš°ì„  -> ì—†ìœ¼ë©´ ë± -> ì—†ìœ¼ë©´ ì¸ë²¤í† ë¦¬)
    let activeCharacters = [];

    // 1ìˆœìœ„: ë§ˆì´ë£¸ì— ì €ì¥ëœ ì…ì£¼ë¯¼ í™•ì¸
    if (playerRoom.characters && playerRoom.characters.length > 0) {
        // (A) ë‚´ ë°©ì¼ ë•Œ: ë°ì´í„°ê°€ ID(ë¬¸ìì—´)ë¡œ ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¸ë²¤í† ë¦¬ì—ì„œ ì°¾ìŒ
        if (typeof playerRoom.characters[0] === 'string') {
            activeCharacters = playerRoom.characters
                .map(id => playerInventory.find(c => c.id === id))
                .filter(Boolean);
        } 
        // (B) ì¹œêµ¬ ë°©ì¼ ë•Œ: visitFriendRoomì—ì„œ ì´ë¯¸ ê°ì²´ë¡œ ë³€í™˜í•´ë‘ì—ˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        else {
            activeCharacters = playerRoom.characters;
        }
    }

    // 2ìˆœìœ„: ì„¤ì •ëœ ì…ì£¼ë¯¼ì´ ì—†ê±°ë‚˜ ìœ íš¨í•œ ì¹´ë“œê°€ 0ì¥ì´ë©´ -> í˜„ì¬ 'í¸ì°¬(Deck)' ì‚¬ìš©
    if (activeCharacters.length === 0) {
        activeCharacters = playerDeck.length > 0 ? playerDeck : playerInventory.slice(0, 5);
    }

    activeCharacters.forEach((card, index) => {
        const charData = findCharacter(card.name);
        if (!charData) return;

        const el = document.createElement('div');
        
        // âœ¨ [ìˆ˜ì •] pointer-events-auto ì¶”ê°€ (ìºë¦­í„° í´ë¦­ í—ˆìš©)
        el.className = 'chibi-character absolute cursor-pointer transition-all duration-[2000ms] ease-linear pointer-events-auto';
        
        el.id = `chibi-${index}`;
		el.dataset.charName = charData.name;
        
        const gridX = Math.random() * 90;
        const gridY = Math.random() * 90;
        const iso = getIsoPos(gridX, gridY);

        el.style.left = `${iso.left}%`;
        el.style.top = `${iso.top}%`;
        el.style.transform = 'translate(-50%, -90%)'; 
        
        // âŒ ê¸°ì¡´: 45px ê³ ì • í¬ê¸° (ë„ˆë¬´ ì‘ìŒ)
        // el.style.width = '45px';
        // el.style.height = '45px';

        // âœ… ìˆ˜ì •: íƒ€ì¼ í¬ê¸°(TILE_WIDTH_PERCENT)ì— ë¹„ë¡€í•˜ê²Œ ì„¤ì • (1.5ë°° ~ 1.8ë°° ì¶”ì²œ)
        el.style.width = `${TILE_WIDTH_PERCENT * 1.3}%`; 
        el.style.height = 'auto'; // ë†’ì´ëŠ” ë¹„ìœ¨ì— ë§ì¶° ìë™ ì¡°ì ˆ

        el.style.zIndex = iso.zIndex + 50;

        const img = document.createElement('img');
// â–¼ baseNameì„ nameìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš” (ë‘ êµ°ë° ëª¨ë‘)
img.src = (typeof chibiImages !== 'undefined' && chibiImages[charData.name]) ? chibiImages[charData.name] : charData.cardImageUrl;
        img.className = 'w-full h-full object-contain drop-shadow-lg';
        el.appendChild(img);

        const bubble = document.createElement('div');
        bubble.className = 'chibi-bubble absolute -top-10 left-1/2 -translate-x-1/2 bg-white text-black px-2 py-1 rounded-lg text-xs whitespace-nowrap opacity-0 transition-opacity duration-300 pointer-events-none z-20 border border-gray-300 shadow-sm';
        bubble.innerText = charData.dialogues[0];
        el.appendChild(bubble);

        // í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ì œ ì •ìƒ ì‘ë™í•  ê²ƒì…ë‹ˆë‹¤)
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            const randomDialogue = charData.dialogues[Math.floor(Math.random() * charData.dialogues.length)];
            bubble.innerText = randomDialogue;
            bubble.style.opacity = 1;
            setTimeout(() => bubble.style.opacity = 0, 3000);
        });

        roomLayer.appendChild(el);
        
        // ìºë¦­í„° ì´ˆê¸° ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ëœë¤ ìœ„ì¹˜ í• ë‹¹
        if (!el.dataset.gridX) {
             el.dataset.gridX = gridX;
             el.dataset.gridY = gridY;
        }
        
        startChibiMovement(el);
    });
	initInteractionSystem();
}

		// ================== âœ¨ ìºë¦­í„° ìƒí˜¸ì‘ìš© ì‹œìŠ¤í…œ âœ¨ ==================

let interactionCheckInterval = null;

// 1. ìƒí˜¸ì‘ìš© ì²´í¬ ì‹œìŠ¤í…œ (ê¸°ì¡´ í•¨ìˆ˜)
function initInteractionSystem() {
    if (interactionCheckInterval) clearInterval(interactionCheckInterval);

    // 1ì´ˆë§ˆë‹¤ ìºë¦­í„°ë“¤ì˜ ê±°ë¦¬ë¥¼ í™•ì¸
    interactionCheckInterval = setInterval(() => {
        const myRoomView = document.getElementById('myroom-view');
        if (!myRoomView || myRoomView.classList.contains('hidden')) return;

        const characters = document.querySelectorAll('.chibi-character');
        if (characters.length < 2) return;

        // ì´ì¤‘ ë£¨í”„ë¡œ ë‘ ìºë¦­í„° ê°„ì˜ ê±°ë¦¬ ë¹„êµ
        for (let i = 0; i < characters.length; i++) {
            for (let j = i + 1; j < characters.length; j++) {
                const charA = characters[i];
                const charB = characters[j];

                // ì´ë¯¸ ëŒ€í™” ì¤‘ì´ë©´ íŒ¨ìŠ¤
                if (charA.dataset.isInteracting === 'true' || charB.dataset.isInteracting === 'true') continue;

                // ì¿¨íƒ€ì„ ì²´í¬
                const now = Date.now();
                if (charA.dataset.lastInteraction && now - charA.dataset.lastInteraction < 10000) continue;
                if (charB.dataset.lastInteraction && now - charB.dataset.lastInteraction < 10000) continue;

                // ê±°ë¦¬ ê³„ì‚°
                const x1 = parseFloat(charA.dataset.gridX);
                const y1 = parseFloat(charA.dataset.gridY);
                const x2 = parseFloat(charB.dataset.gridX);
                const y2 = parseFloat(charB.dataset.gridY);

                const dist = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));

                // ê±°ë¦¬ê°€ 15 ì´ë‚´ì´ë©´ ìƒí˜¸ì‘ìš© ì‹œì‘
                if (dist < 15) {
                    triggerInteraction(charA, charB);
                    return; 
                }
            }
        }
    }, 1000);
}

// 2. ëŒ€í™” ë°œìƒ ë° ì•ˆì „ì¥ì¹˜ (ìˆ˜ì •ëœ í•¨ìˆ˜)
// yumecan.html - triggerInteraction í•¨ìˆ˜ êµì²´

// [ìˆ˜ì •ë¨] ìƒí˜¸ì‘ìš© ë°œìƒ í•¨ìˆ˜ (ì•ˆì „ì¥ì¹˜ ê°•í™”)
function triggerInteraction(charA, charB) {
    charA.dataset.isInteracting = 'true';
    charB.dataset.isInteracting = 'true';

    try {
        const ax = parseFloat(charA.style.left);
        const bx = parseFloat(charB.style.left);
        const imgA = charA.querySelector('img');
        const imgB = charB.querySelector('img');
        
        // ì„œë¡œ ë§ˆì£¼ë³´ê²Œ í•˜ê¸°
        if (ax < bx) { imgA.style.transform = 'scaleX(-1)'; imgB.style.transform = 'scaleX(1)'; } 
        else { imgA.style.transform = 'scaleX(1)'; imgB.style.transform = 'scaleX(-1)'; }

        // âœ¨ [í•µì‹¬ ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ì¸ë±ìŠ¤ ëŒ€ì‹ , 1ë‹¨ê³„ì—ì„œ ë¶™ì—¬ë‘” ì´ë¦„í‘œ(dataset)ë¥¼ ì§ì ‘ ì½ìŠµë‹ˆë‹¤.
        // ì´ëŸ¬ë©´ ë±/ì¸ë²¤í† ë¦¬ ìˆœì„œê°€ ë°”ë€Œì–´ë„ ì˜¤ë¥˜ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        const charDataA = findCharacter(charA.dataset.charName);
        const charDataB = findCharacter(charB.dataset.charName);

        if (!charDataA || !charDataB) {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì¢…ë£Œ (ì—ëŸ¬ ë°©ì§€)
            console.warn("ìƒí˜¸ì‘ìš© ìºë¦­í„° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return; 
        }

        const nameA = charDataA.baseName.trim();
        const nameB = charDataB.baseName.trim();
        const searchKey = [nameA, nameB].sort().join('_');

        console.log(`[ìƒí˜¸ì‘ìš©] ${nameA} & ${nameB} (${searchKey})`);

        let speaker1, speaker2;
        let dialogue1, dialogue2;

        // ê³ ìœ  ëŒ€ì‚¬ í™•ì¸
        if (interactionDialogues && interactionDialogues[searchKey]) {
            const match = interactionDialogues[searchKey];
            const randomPick = match.dialogues[Math.floor(Math.random() * match.dialogues.length)];
            
            // í™”ì ìˆœì„œ ë§ì¶”ê¸°
            if (match.pair[0] === nameA) {
                speaker1 = charA; speaker2 = charB;
            } else {
                speaker1 = charB; speaker2 = charA;
            }
            dialogue1 = randomPick[0];
            dialogue2 = randomPick[1];

        } else {
            // ë²”ìš© ëŒ€ì‚¬
            const randomPick = genericInteractions[Math.floor(Math.random() * genericInteractions.length)];
            speaker1 = charA;
            speaker2 = charB;
            dialogue1 = randomPick[0];
            dialogue2 = randomPick[1];
        }

        // ëŒ€ì‚¬ ì¶œë ¥
        showBubble(speaker1, dialogue1);
        setTimeout(() => showBubble(speaker2, dialogue2), 1000);

    } catch (error) {
        console.warn("ìƒí˜¸ì‘ìš© ì—ëŸ¬ ì²˜ë¦¬ë¨:", error);
    } finally {
        // 4ì´ˆ í›„ ëŒ€í™” ìƒíƒœ í•´ì œ
        setTimeout(() => {
            if(charA) {
                charA.dataset.isInteracting = 'false';
                charA.dataset.lastInteraction = Date.now();
            }
            if(charB) {
                charB.dataset.isInteracting = 'false';
                charB.dataset.lastInteraction = Date.now();
            }
        }, 4000);
    }
}

function showBubble(charEl, text) {
    const bubble = charEl.querySelector('.chibi-bubble');
    if (bubble) {
        bubble.innerText = text;
        bubble.style.opacity = 1;
        bubble.style.zIndex = 100; // ë§í’ì„  ë§¨ ìœ„ë¡œ
        setTimeout(() => {
            bubble.style.opacity = 0;
            bubble.style.zIndex = 20;
        }, 3000);
    }
}


// ìºë¦­í„° ì´ë™ í•¨ìˆ˜ (í•œ ì¹¸ì”© ì´ë™ + ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
function startChibiMovement(element) {
    if (element.dataset.moveInterval) clearInterval(element.dataset.moveInterval);

    const move = () => {
        const myRoomView = document.getElementById('myroom-view');
        if (!myRoomView || myRoomView.classList.contains('hidden')) return;
        if (element.dataset.isInteracting === 'true') return;

        let targetGridX, targetGridY;
        let attempts = 0;
        let finalTarget = null; // ìµœì¢… ëª©ì ì§€

        // âœ¨ [í•µì‹¬ ë¡œì§] ë¹ˆ ìë¦¬ë¥¼ ì°¾ê¸° ìœ„í•´ 10ë²ˆ ì‹œë„í•©ë‹ˆë‹¤.
        while (attempts < 10) {
            // 0~9 ì‚¬ì´ ëœë¤ ì¢Œí‘œ ìƒì„±
            // 1. ê°€ì¥ìë¦¬(0ê³¼ 100 ê·¼ì²˜)ì— ë„ˆë¬´ ë¶™ì§€ ì•Šë„ë¡ 10 ~ 90 ì‚¬ì´ì˜ ì¢Œí‘œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
const margin = 10;
const effectiveSize = GRID_SIZE - (margin * 2); // 100 - 20 = 80
const testX = Math.floor(Math.random() * effectiveSize) + margin;
const testY = Math.floor(Math.random() * effectiveSize) + margin;

// 2. ê°€êµ¬ ì¶©ëŒ ì²´í¬ ë²”ìœ„ ìˆ˜ì • (ì¢Œí‘œê°€ 0~100ì´ ë˜ì—ˆìœ¼ë¯€ë¡œ ë²”ìœ„ë„ ë„“í˜€ì•¼ í•¨)
const isBlocked = playerRoom.furniture.some(f => {
    const itemData = furnitureItems.find(i => i.id === f.id);
    if (!itemData || itemData.type === 'wall' || itemData.type === 'rug') return false;
    
    // ê°€êµ¬ ì¤‘ì‹¬ì (f.x, f.y)ê³¼ ëª©í‘œ ì§€ì (testX, testY)ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°
    // ê±°ë¦¬ê°€ 6 ì´ë‚´ë©´ ë¶€ë”ªíŒ ê²ƒìœ¼ë¡œ ê°„ì£¼ (ê°€êµ¬ í¬ê¸°ì— ë”°ë¼ ì¡°ì ˆ ê°€ëŠ¥)
    const dist = Math.sqrt(Math.pow(f.x - testX, 2) + Math.pow(f.y - testY, 2));
    return dist < 6; 
});
           

            // ë¹ˆ ìë¦¬ë¼ë©´? -> ì—¬ê¸°ë¡œ ê²°ì •í•˜ê³  ë°˜ë³µ ì¢…ë£Œ!
            if (!isBlocked) {
                finalTarget = { x: testX, y: testY };
                break;
            }
            
            // ë§‰íŒ ìë¦¬ë¼ë©´? -> ì¼ë‹¨ í›„ë³´ì§€ë¡œ ì €ì¥í•´ë‘ê³  ë‹¤ì‹œ ì‹œë„ (ì • ê°ˆ ë° ì—†ìœ¼ë©´ ì—¬ê¸°ë¼ë„ ê°€ì•¼ í•˜ë‹ˆê¹Œ)
            if (!finalTarget) {
                finalTarget = { x: testX, y: testY };
            }

            attempts++;
        }

        // (ì•ˆì „ì¥ì¹˜) í˜¹ì‹œë¼ë„ íƒ€ê²Ÿì´ ì—†ìœ¼ë©´ í˜„ì¬ ìœ„ì¹˜ ìœ ì§€
        if (!finalTarget) return;

        // --- ì´ë™ ì‹¤í–‰ ---
        const iso = getIsoPos(finalTarget.x, finalTarget.y);
        
        const currentLeft = parseFloat(element.style.left) || iso.left;
        const img = element.querySelector('img');
        
        if (iso.left < currentLeft) {
            img.style.transform = 'scaleX(1)'; 
            element.dataset.facing = 'left';
        } else {
            img.style.transform = 'scaleX(-1)'; 
            element.dataset.facing = 'right';
        }

        element.style.left = `${iso.left}%`;
        element.style.top = `${iso.top}%`;
        
        // ê°€êµ¬ë³´ë‹¤ ì‚´ì§ ì•ì— ì„œê¸°
        element.style.zIndex = iso.zIndex + 5;
        
        element.dataset.gridX = finalTarget.x;
        element.dataset.gridY = finalTarget.y;
    };

    // 2.5ì´ˆ ~ 4.5ì´ˆ ê°„ê²©ìœ¼ë¡œ ì´ë™ (ë„ˆë¬´ ì •ì‹ ì—†ì§€ ì•Šê²Œ)
    const interval = setInterval(move, Math.random() * 2000 + 2500);
    element.dataset.moveInterval = interval;
}

// âœ¨ [ì‹ ê·œ] êµí™˜ì†Œ ì¸ë²¤í† ë¦¬ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì—¬ê¸°ì— ì¶”ê°€í•˜ì„¸ìš”!)
// 4. ì¸ë²¤í† ë¦¬ í´ë¦­ ì´ë²¤íŠ¸ (ìœ„ì„) - [ë³€ìˆ˜ëª… ì¤‘ë³µ í•´ê²° ë²„ì „]
        const tradeInvWrapper = document.getElementById('trade-inventory-container'); // ë³€ìˆ˜ëª… ë³€ê²½ë¨
        if (tradeInvWrapper) {
            tradeInvWrapper.addEventListener('click', (e) => {
                const cardEl = e.target.closest('[data-card-id]');
                if (cardEl) {
                    const clickedId = cardEl.dataset.cardId;
                    selectedTradeCardId = clickedId;
                    
                    const cardInstance = playerInventory.find(c => c.id === clickedId);
                    if (cardInstance) {
                        const charData = findCharacter(cardInstance.name);
                        document.getElementById('trade-selected-name').innerHTML = 
                            `<span class="text-yellow-300">${charData.name}</span> <span class="text-xs text-gray-400">(Lv.${cardInstance.level})</span>`;
                        document.getElementById('trade-selected-card-preview').classList.remove('hidden');
                        loadTradeInventory();
                    }
                }
            });
        }

// ================== âœ¨ ìˆ˜ì •ëœ initDragEvents (ë°°ì¹˜ ëª¨ë“œ) âœ¨ ==================
function initDragEvents() {
    const container = document.getElementById('room-container');

    const handleStart = (e) => {
        if (!isEditMode) return;
        let target = e.target;
        
        if (e.type === 'touchstart') {
            const touch = e.touches[0];
            target = document.elementFromPoint(touch.clientX, touch.clientY);
            if (!target || !target.classList.contains('placed-furniture')) return;
        }

        if (target && target.classList.contains('placed-furniture')) {
            if (e.cancelable) e.preventDefault();
            draggedFurniture = target;
            draggedFurniture.style.cursor = 'grabbing';
            draggedFurniture.style.zIndex = 9999; // ë“œë˜ê·¸ ì¤‘ì—” ë§¨ ìœ„ë¡œ
            draggedFurniture.style.transition = 'none'; // ë“œë˜ê·¸ ì¤‘ì—” ì• ë‹ˆë©”ì´ì…˜ ë”

            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            const rect = draggedFurniture.getBoundingClientRect();
            
            // ì¤‘ì‹¬ì  ê¸°ì¤€ ë“œë˜ê·¸ë¥¼ ìœ„í•´ ì˜¤í”„ì…‹ ì¡°ì •
            dragOffsetX = clientX - rect.left - (rect.width / 2);
            dragOffsetY = clientY - rect.top - (rect.height / 2);
        }
    };

    const handleMove = (e) => {
        if (!isEditMode || !draggedFurniture) return;
        if (e.cancelable) e.preventDefault();

        const containerRect = container.getBoundingClientRect();
        const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

        // í™”ë©´ìƒ ì¢Œí‘œ (%, í”½ì…€ -> í¼ì„¼íŠ¸ ë³€í™˜)
        let screenX = ((clientX - containerRect.left) / containerRect.width) * 100;
        let screenY = ((clientY - containerRect.top) / containerRect.height) * 100;

        // ì‹œê°ì  ì—…ë°ì´íŠ¸
        draggedFurniture.style.left = `${screenX}%`;
        draggedFurniture.style.top = `${screenY}%`;
    };

    const handleEnd = (e) => {
        if (!isEditMode || !draggedFurniture) return;

        // ë“œë˜ê·¸ê°€ ëë‚œ ì‹œì ì˜ í™”ë©´ ì¢Œí‘œ(%)
        const currentLeft = parseFloat(draggedFurniture.style.left);
        const currentTop = parseFloat(draggedFurniture.style.top);
        
        // âœ¨ í™”ë©´ ì¢Œí‘œë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ë“œ ì¢Œí‘œ(x, y)ë¡œ ì—­ë³€í™˜í•˜ì—¬ ì €ì¥
        const gridPos = getGridPosFromScreen(currentLeft, currentTop);
        
        const uniqueKey = draggedFurniture.dataset.key;
        if (uniqueKey !== undefined && playerRoom.furniture[uniqueKey]) {
            playerRoom.furniture[uniqueKey].x = gridPos.x;
            playerRoom.furniture[uniqueKey].y = gridPos.y;
        }

        // z-index ì¬ê³„ì‚° ë° ìŠ¤íƒ€ì¼ ë³µêµ¬
        const newIso = getIsoPos(gridPos.x, gridPos.y);
        draggedFurniture.style.zIndex = newIso.zIndex;
        draggedFurniture.style.cursor = 'grab';
        draggedFurniture.style.transition = ''; // ì• ë‹ˆë©”ì´ì…˜ ë³µêµ¬
        
        // ìµœì¢… ìœ„ì¹˜ ë³´ì • (ì •í™•í•œ ê·¸ë¦¬ë“œ ìœ„ì¹˜ë¡œ ìŠ¤ëƒ…)
        draggedFurniture.style.left = `${newIso.left}%`;
        draggedFurniture.style.top = `${newIso.top}%`;

        draggedFurniture = null;
    };

    container.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);

    container.addEventListener('touchstart', handleStart, { passive: false });
    window.addEventListener('touchmove', handleMove, { passive: false });
    window.addEventListener('touchend', handleEnd);

    container.addEventListener('contextmenu', (e) => {
        if (!isEditMode) return;
        if (e.target.classList.contains('placed-furniture')) {
            e.preventDefault();
            if(confirm('ì´ ê°€êµ¬ë¥¼ íšŒìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const uniqueKey = e.target.dataset.key;
                if (uniqueKey !== undefined) {
                    playerRoom.furniture.splice(uniqueKey, 1);
                    displayMyRoom();
                    saveGame();
                    toggleEditMode(); 
                    toggleEditMode(); 
                }
            }
        }
    });
	// 4. ë”ë¸” í´ë¦­ ì‹œ ê°€êµ¬ ì¢Œìš° ë°˜ì „ (ìµœì í™” ë²„ì „)
    container.addEventListener('dblclick', (e) => {
        if (!isEditMode) return;
        
        let target = e.target;
        if (!target.classList.contains('placed-furniture')) return;

        e.preventDefault();
        e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨ (ì¤‘ìš”)
        
        const uniqueKey = target.dataset.key;
        const item = playerRoom.furniture[uniqueKey]; // ë°ì´í„° ì›ë³¸ ê°€ì ¸ì˜¤ê¸°

        if (uniqueKey !== undefined && item) {
            // 1. ë°ì´í„° ê°’ ë³€ê²½
            item.isFlipped = !item.isFlipped;
            
            // 2. í™”ë©´ ê°±ì‹  (ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šê³ , í•´ë‹¹ ìš”ì†Œ ìŠ¤íƒ€ì¼ë§Œ ë³€ê²½)
            const furnitureData = furnitureItems.find(f => f.id === item.id);
            const flipTransform = item.isFlipped ? 'scaleX(-1)' : 'scaleX(1)';

            // ê°€êµ¬ íƒ€ì…ì— ë”°ë¥¸ transform ì¬ê³„ì‚°
            if (furnitureData.type === 'rug') {
                target.style.transform = `translate(-50%, -50%) rotate(45deg) scaleY(0.58) ${flipTransform}`;
            } else if (furnitureData.type === 'wall') {
                target.style.transform = `translate(-50%, -200%) ${flipTransform}`;
            } else {
                target.style.transform = `translate(-50%, -95%) ${flipTransform}`;
            }
            
            // âŒ displayMyRoom(); <-- ì´ê±° ë•Œë¬¸ì— íŠ•ê¸°ëŠ” ê±°ë¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
            // âŒ saveGame();      <-- ì €ì¥ë„ ë‚˜ì¤‘ì— í•œêº¼ë²ˆì— í•©ë‹ˆë‹¤.
        }
    });

} // initDragEvents ë


// ================== âœ¨ [ì‹ ê·œ] ê°€êµ¬ ë³´ê´€í•¨ ê¸°ëŠ¥ ì‹œì‘ âœ¨ ==================

// 1. ê°€êµ¬ ë³´ê´€í•¨ ì—´ê¸° (ë³´ìœ  ì¤‘ì´ì§€ë§Œ ë°©ì— ì—†ëŠ” ê°€êµ¬ë§Œ í‘œì‹œ)
// 1. ê°€êµ¬ ë³´ê´€í•¨ ì—´ê¸° (ìˆ˜ëŸ‰ ê³„ì‚° ë¡œì§ ì ìš©)
function openFurnitureStorage() {
    const list = document.getElementById('storage-list');
    const modal = document.getElementById('furniture-storage-modal');
    if (!list || !modal) return;

    list.innerHTML = '';

    // 1. í˜„ì¬ ë°©ì— ë°°ì¹˜ëœ ê°€êµ¬ë“¤ì˜ IDë³„ ê°œìˆ˜ë¥¼ ì…‰ë‹ˆë‹¤.
    const placedCounts = {};
    playerRoom.furniture.forEach(f => {
        placedCounts[f.id] = (placedCounts[f.id] || 0) + 1;
    });

    // 2. ì „ì²´ ë³´ìœ  ê°€êµ¬ì˜ IDë³„ ê°œìˆ˜ë¥¼ ì…‰ë‹ˆë‹¤.
    const ownedCounts = {};
    ownedFurniture.forEach(id => {
        ownedCounts[id] = (ownedCounts[id] || 0) + 1;
    });

    // 3. (ë³´ìœ  ê°œìˆ˜ - ë°°ì¹˜ ê°œìˆ˜)ê°€ 1ê°œ ì´ìƒì¸ ê°€êµ¬ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
    const uniqueOwnedIds = [...new Set(ownedFurniture)]; // ì¤‘ë³µ ì œê±°ëœ ID ëª©ë¡
    
    let hasItem = false;

    uniqueOwnedIds.forEach(id => {
        const totalOwned = ownedCounts[id] || 0;
        const totalPlaced = placedCounts[id] || 0;
        const availableCount = totalOwned - totalPlaced; // ë³´ê´€í•¨ì— ë‚¨ì•„ìˆëŠ” ê°œìˆ˜

        if (availableCount > 0) {
            hasItem = true;
            const item = furnitureItems.find(f => f.id === id);
            if (!item) return;

            const div = document.createElement('div');
            div.className = 'bg-black/40 p-3 rounded flex flex-col items-center text-center border border-purple-500/30 hover:bg-purple-900/20 transition-colors cursor-pointer';
            
            // í´ë¦­ ì‹œ ë°°ì¹˜
            div.onclick = () => placeFurnitureFromStorage(id);

            div.innerHTML = `
                <div class="h-16 w-full flex items-center justify-center mb-2 bg-black/20 rounded pointer-events-none relative">
                    <img src="${item.imageUrl}" class="max-h-full max-w-full">
                    <span class="absolute top-0 right-0 bg-blue-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-bl">x${availableCount}</span>
                </div>
                <p class="font-bold text-white text-sm mb-1 pointer-events-none">${item.name}</p>
                <p class="text-green-400 text-xs pointer-events-none">í´ë¦­í•˜ì—¬ ë°°ì¹˜</p>
            `;
            list.appendChild(div);
        }
    });

    if (!hasItem) {
        list.innerHTML = `<p class="col-span-3 text-center text-gray-500 py-4">ë³´ê´€ ì¤‘ì¸ ê°€êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ëª¨ë“  ê°€êµ¬ë¥¼ ë°°ì¹˜í–ˆìŠµë‹ˆë‹¤.</p>`;
    }
    modal.classList.remove('hidden');
}

// (ì°¸ê³ ) placeFurnitureFromStorage í•¨ìˆ˜ëŠ” ê¸°ì¡´ ìœ ì§€í•˜ë˜, isFlipped ì´ˆê¸°ê°’ë§Œ ì¶”ê°€í•´ì£¼ì„¸ìš”.
// ê¸°ì¡´: playerRoom.furniture.push({ id: item.id, x: 45, y: 45 });
// ìˆ˜ì •: playerRoom.furniture.push({ id: item.id, x: 45, y: 45, isFlipped: false });

// 2. ë³´ê´€í•¨ì—ì„œ ê°€êµ¬ êº¼ë‚´ê¸° (ë°°ì¹˜)
function placeFurnitureFromStorage(furnitureId) {
    const item = furnitureItems.find(f => f.id === furnitureId);
    if (!item) return;

    // ë°© ì¤‘ì•™ì— ë°°ì¹˜
    playerRoom.furniture.push({ id: item.id, x: 45, y: 45, isFlipped: false });
    
    showMessage(`${item.name} ë°°ì¹˜ ì™„ë£Œ!`, 'text-green-300', messageArea);
    
    // í™”ë©´ ê°±ì‹ 
    displayMyRoom();
    saveGame();
    
    // ë³´ê´€í•¨ ëª©ë¡ ê°±ì‹  (ë°©ê¸ˆ êº¼ë‚¸ ê±´ ì‚¬ë¼ì ¸ì•¼ í•¨)
    openFurnitureStorage();
}

// ================== âœ¨ ê°€êµ¬ ë³´ê´€í•¨ ê¸°ëŠ¥ ë âœ¨ ==================
		
// 2. ê°€êµ¬ ìƒì  ì—´ê¸°
// 2. ê°€êµ¬ ìƒì  ì—´ê¸° (ìˆ˜ì •ë¨)
function openFurnitureShop() {
    const list = document.getElementById('furniture-list');
    const modal = document.getElementById('furniture-shop-modal');
    if (!list || !modal) return;

    list.innerHTML = '';

    furnitureItems.forEach(item => {
        // í˜„ì¬ ë³´ìœ  ì¤‘ì¸ ê°œìˆ˜ ê³„ì‚°
        const ownedCount = ownedFurniture.filter(id => id === item.id).length;
        
        const div = document.createElement('div');
        div.className = 'bg-black/40 p-3 rounded flex flex-col items-center text-center border border-white/10';
        
        // ëˆì´ ì¶©ë¶„í•œì§€ í™•ì¸
        const canAfford = playerCurrency >= item.cost;
        
        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê²°ì • (ë³´ìœ  ì—¬ë¶€ ìƒê´€ì—†ì´ ëˆë§Œ ìˆìœ¼ë©´ í™œì„±í™”)
        const btnClass = canAfford 
            ? 'bg-green-500 hover:bg-green-600 cursor-pointer' 
            : 'bg-red-500 opacity-50 cursor-not-allowed';
            
        const btnDisabled = canAfford ? '' : 'disabled';

        div.innerHTML = `
            <div class="h-16 w-full flex items-center justify-center mb-2 bg-black/20 rounded relative">
                <img src="${item.imageUrl}" class="max-h-full max-w-full">
                ${ownedCount > 0 ? `<span class="absolute top-0 right-0 bg-blue-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-bl">x${ownedCount}</span>` : ''}
            </div>
            <p class="font-bold text-white text-sm mb-1">${item.name}</p>
            <p class="text-yellow-300 text-xs mb-2">ğŸ’ ${item.cost}</p>
            <button class="gacha-button text-xs py-1 px-3 rounded-full text-white font-bold w-full transition-colors ${btnClass}" 
                ${btnDisabled} 
                onclick="buyFurniture('${item.id}')">
                êµ¬ë§¤
            </button>
        `;
        list.appendChild(div);
    });
    modal.classList.remove('hidden');
}

// 3. ê°€êµ¬ êµ¬ë§¤ (ì¤‘ë³µ êµ¬ë§¤ í—ˆìš© ë²„ì „)
window.buyFurniture = function(furnitureId) {
    const item = furnitureItems.find(f => f.id === furnitureId);
    if (!item) return;

    // âŒ ê¸°ì¡´ì˜ ì¤‘ë³µ ì²´í¬ ë¡œì§ ì‚­ì œ
    // if (ownedFurniture.includes(item.id)) { ... } 

    if (playerCurrency >= item.cost) {
        if (!confirm(`${item.name}ì„(ë¥¼) ğŸ’${item.cost}ì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        playerCurrency -= item.cost;
        
        // ë³´ìœ  ëª©ë¡ì— ì¶”ê°€ (ê°™ì€ IDê°€ ì—¬ëŸ¬ ë²ˆ ë“¤ì–´ê°)
        ownedFurniture.push(item.id);
        
        // êµ¬ë§¤ ì¦‰ì‹œ ë°© ì¤‘ì•™ì— ìë™ ë°°ì¹˜ (ì´ˆê¸° ìƒíƒœ: ë°˜ì „ ì—†ìŒ)
        playerRoom.furniture.push({ id: item.id, x: 45, y: 45, isFlipped: false });
        
        showMessage(`${item.name} êµ¬ë§¤ ì™„ë£Œ!`, 'text-green-300', messageArea);
        
        updateUI();
        saveGame();
        openFurnitureShop(); 
        displayMyRoom(); 
    } else {
        alert('ë³´ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
    }
};

		// ================== ğŸ”¨ ë°°ì¹˜ ëª¨ë“œ(Edit Mode) ë¡œì§ ì‹œì‘ ==================

let isEditMode = false; // í˜„ì¬ ë°°ì¹˜ ëª¨ë“œì¸ì§€ ì—¬ë¶€
let draggedFurniture = null; // ë“œë˜ê·¸ ì¤‘ì¸ ê°€êµ¬ ìš”ì†Œ
let dragOffsetX = 0;
let dragOffsetY = 0;

// 1. ë°°ì¹˜ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
function toggleEditMode() {
if (!document.getElementById('visit-mode-overlay').classList.contains('hidden')) {
        return;
    }
    isEditMode = !isEditMode;
    const btn = document.getElementById('myroom-edit-mode');
    const container = document.getElementById('room-container');
    
    // âœ¨ [ì¶”ê°€] ë³´ê´€í•¨ ë²„íŠ¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const storageBtn = document.getElementById('open-furniture-storage');

    if (isEditMode) {
        // [ON] ë°°ì¹˜ ëª¨ë“œ ì¼œì§
        btn.textContent = 'âœ… ì €ì¥ ì™„ë£Œ';
        btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        btn.classList.add('bg-green-600', 'hover:bg-green-700');
        
        container.classList.add('border-yellow-400'); 
        
        // âœ¨ [ì¶”ê°€] ë³´ê´€í•¨ ë²„íŠ¼ ë³´ì´ê¸°
        if(storageBtn) storageBtn.classList.remove('hidden');

        // ìºë¦­í„° ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.chibi-character').forEach(el => el.classList.add('hidden'));
        
        // ê°€êµ¬ ë“œë˜ê·¸ í™œì„±í™”
        document.querySelectorAll('.placed-furniture').forEach(el => {
            el.style.cursor = 'grab';
            el.style.pointerEvents = 'auto';
        });
        
        // ì•ˆë‚´ ë©”ì‹œì§€ ìˆ˜ì • (íšŒìˆ˜í•˜ë©´ ë³´ê´€í•¨ìœ¼ë¡œ ê°„ë‹¤ëŠ” ë‚´ìš© ì¶”ê°€)
        showMessage('ê°€êµ¬ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì´ë™í•˜ê±°ë‚˜, ìš°í´ë¦­í•˜ì—¬ ë³´ê´€í•¨ì— ë„£ìœ¼ì„¸ìš”.', 'text-yellow-300', messageArea);

    } else {
        // [OFF] ë°°ì¹˜ ëª¨ë“œ êº¼ì§
        btn.textContent = 'ğŸ”¨ ë°°ì¹˜ ëª¨ë“œ';
        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
        btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
        
        container.classList.remove('border-yellow-400');
        
        // âœ¨ [ì¶”ê°€] ë³´ê´€í•¨ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        if(storageBtn) storageBtn.classList.add('hidden');

        // ìºë¦­í„° ë³´ì´ê¸°
        document.querySelectorAll('.chibi-character').forEach(el => el.classList.remove('hidden'));
        
        document.querySelectorAll('.placed-furniture').forEach(el => {
            el.style.cursor = 'default';
        });

        saveGame();
        showMessage('ë°°ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'text-green-300', messageArea);
    }
}

		


    

// ================== ğŸ”¨ ë°°ì¹˜ ëª¨ë“œ ë¡œì§ ë ==================
// ================== âœ¨ ë§ˆì´ë£¸ ë¡œì§ ë âœ¨ ==================

           // âœ… [ìµœì¢… ìˆ˜ì •] í¸ì°¬(ë± ê´€ë¦¬) í™”ë©´ í‘œì‹œ í•¨ìˆ˜ (ì•ˆì „ì¥ì¹˜ ê°•í™”íŒ)
            function displayDeckManagement() {
                // 1. ë± ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                deckStatus.textContent = `í˜„ì¬ í¸ì°¬: ${playerDeck.length} / ${DECK_CAPACITY}`;
                if (playerDeck.length === DECK_CAPACITY) {
                    deckStatus.classList.remove('text-yellow-300');
                    deckStatus.classList.add('text-green-400');
                } else {
                    deckStatus.classList.add('text-yellow-300');
                    deckStatus.classList.remove('text-green-400');
                }
                
                // 2. [ìœ„ìª½] ë± ìŠ¬ë¡¯ í‘œì‹œ (ì—¬ê¸°ê°€ ì˜¤ë¥˜ì˜ ì›ì¸ì´ì—ˆìŠµë‹ˆë‹¤)
                deckSlotsContainer.innerHTML = '';
                
                // ë± ë°ì´í„° ì²­ì†Œ (ë°ì´í„° ì—†ëŠ” ì¹´ë“œëŠ” ë±ì—ì„œ ìë™ ì œì™¸í•˜ê¸° ìœ„í•¨)
                const validDeck = [];

                for (let i = 0; i < DECK_CAPACITY; i++) {
                    if (playerDeck[i]) {
                        const baseCharacter = findCharacter(playerDeck[i].name);
                        
                        // âœ¨ [ì•ˆì „ì¥ì¹˜ 1] ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ” ì¹´ë“œë§Œ ê·¸ë¦¼
                        if (baseCharacter) {
                            deckSlotsContainer.appendChild(createCard(baseCharacter, { mode: 'deckSlot', instance: playerDeck[i] }));
                            validDeck.push(playerDeck[i]); // ìœ íš¨í•œ ì¹´ë“œë§Œ ì„ì‹œ ë°°ì—´ì— ì €ì¥
                        } else {
                            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 'ì˜¤ë¥˜ ì¹´ë“œ'ë¡œ í‘œì‹œí•˜ê³  ë±ì—ì„œëŠ” ì œì™¸ë¨
                            console.warn(`ë±ì— ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œê°€ ìˆìŠµë‹ˆë‹¤: ${playerDeck[i].name}`);
                            const errorSlot = document.createElement('div');
                            errorSlot.className = 'deck-slot rounded-lg border-red-500 text-red-400 flex flex-col items-center justify-center text-xs'; 
                            errorSlot.innerHTML = `<p>ë°ì´í„° ì—†ìŒ</p><button onclick="location.reload()" class="mt-1 underline">ìƒˆë¡œê³ ì¹¨</button>`;
                            deckSlotsContainer.appendChild(errorSlot);
                        }
                    } else {
                        // ë¹ˆ ìŠ¬ë¡¯
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'deck-slot rounded-lg'; 
                        emptySlot.textContent = 'ë¹„ì–´ìˆìŒ';
                        deckSlotsContainer.appendChild(emptySlot);
                    }
                }

                // ë± ë°ì´í„° ë™ê¸°í™” (ì˜¤ë¥˜ ì¹´ë“œê°€ ìˆì—ˆë‹¤ë©´ ì œê±°ëœ ìƒíƒœë¡œ ì €ì¥)
                if (validDeck.length !== playerDeck.length) {
                    playerDeck = validDeck;
                    saveGame(); // ìë™ ìˆ˜ì •ëœ ë± ì €ì¥
                }

                // 3. [ì•„ë˜ìª½] ì¸ë²¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
                deckInventoryContainer.innerHTML = '';
                if (playerInventory.length === 0) {
                    deckInventoryContainer.innerHTML = `<p class="col-span-full text-center text-gray-400 mt-10">í¸ì°¬í•  ë“±ì¥ì¸ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                } else {
                    // ì •ë ¬: ë± í¬í•¨ > ë“±ê¸‰ > ë ˆë²¨ > ì´ë¦„
                    const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
                    const sortedInventory = [...playerInventory].sort((a, b) => {
                        const charA = findCharacter(a.name);
                        const charB = findCharacter(b.name);
                        
                        if (!charA) return 1; 
                        if (!charB) return -1;

                        const inDeckA = playerDeck.some(d => d.id === a.id) ? 1 : 0;
                        const inDeckB = playerDeck.some(d => d.id === b.id) ? 1 : 0;
                        
                        return (inDeckB - inDeckA) || 
                               (rarityOrder[charB.rarity] - rarityOrder[charA.rarity]) || 
                               (b.level - a.level) || 
                               charA.baseName.localeCompare(charB.baseName);
                    });

                    sortedInventory.forEach((cardInstance, index) => {
                        const baseCharacter = findCharacter(cardInstance.name);
                        
                        // âœ¨ [ì•ˆì „ì¥ì¹˜ 2] ì¸ë²¤í† ë¦¬ì—ë„ ë°ì´í„° ì—†ëŠ” ì¹´ë“œëŠ” ê±´ë„ˆëœ€
                        if (!baseCharacter) return; 

                        const isCardInDeck = playerDeck.some(deckCard => deckCard.id === cardInstance.id);
                        const isDeckFull = playerDeck.length >= DECK_CAPACITY;
                        
                        deckInventoryContainer.appendChild(createCard(baseCharacter, {
                            animationIndex: index,
                            mode: 'deckBuilder',
                            instance: cardInstance,
                            isCardInDeck: isCardInDeck,
                            isDeckFull: isDeckFull
                        }));
                    });
                }
                displaySynergies();
            }

            
           // âœ… [ìˆ˜ì •ë¨] ìë™ í¸ì„± í•¨ìˆ˜ (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
            function autoFillDeck() {
                // 1. ì¸ë²¤í† ë¦¬ì˜ ëª¨ë“  ì¹´ë“œì— ëŒ€í•´ ì „íˆ¬ë ¥ ê³„ì‚°
                const inventoryWithPower = playerInventory.map(cardInstance => {
                    // ì¹´ë“œì˜ í˜„ì¬ ìŠ¤íƒ¯(í‡´ê³ /ê°œì • ì ìš©)ì„ ê°€ì ¸ì˜´
                    const enhancedStats = getEnhancedStats(cardInstance);

                    // âœ¨ [í•µì‹¬ ìˆ˜ì •] ë°ì´í„°ê°€ ìœ ì‹¤ëœ ì¹´ë“œëŠ” statsê°€ nullë¡œ ë°˜í™˜ë¨
                    // ì´ë•Œ atkë¥¼ ì½ìœ¼ë ¤ í•˜ë©´ ì—ëŸ¬ê°€ ë‚˜ë¯€ë¡œ, ì•ˆì „í•˜ê²Œ ì „íˆ¬ë ¥ì„ 0(ë˜ëŠ” -1)ìœ¼ë¡œ ì²˜ë¦¬
                    if (!enhancedStats) {
                        return { instance: cardInstance, power: -1 }; 
                    }

                    // ì •ìƒì ì¸ ì¹´ë“œë¼ë©´ ì „íˆ¬ë ¥ ê³„ì‚° (ê³µ + ë°© + ì²´ë ¥/10)
                    const power = enhancedStats.atk + enhancedStats.def + Math.floor(enhancedStats.hp / 10);
                    return { instance: cardInstance, power: power };
                });

                // 2. ì „íˆ¬ë ¥ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë¥˜ ì¹´ë“œëŠ” powerê°€ -1ì´ë¯€ë¡œ ë§¨ ë’¤ë¡œ ê°)
                inventoryWithPower.sort((a, b) => b.power - a.power);
                
                // 3. ìƒìœ„ 5ì¥ ì„ íƒ (ë‹¨, ì „íˆ¬ë ¥ì´ 0ë³´ë‹¤ í° 'ì •ìƒ ì¹´ë“œ'ë§Œ ì„ íƒ)
                const validCards = inventoryWithPower.filter(item => item.power > 0);
                
                playerDeck = validCards.slice(0, DECK_CAPACITY).map(item => item.instance);

                // 4. í™”ë©´ ê°±ì‹  ë° ì €ì¥
                displayDeckManagement();
                showMessage('ê°€ì¥ ê°•ë ¥í•œ ë“±ì¥ì¸ë¬¼ë¡œ ë±ì„ ìë™ í¸ì„±í–ˆìŠµë‹ˆë‹¤!', 'text-blue-300', messageArea);
                saveGame();
            }

            function addToDeck(cardId) {
                if (playerDeck.length >= DECK_CAPACITY) return;
                
                const cardInstanceToAdd = playerInventory.find(c => c.id === cardId);
                if (!cardInstanceToAdd) return;

                // ì´ì œ ë™ì¼ ì¸ë¬¼ì´ ì•„ë‹Œ, 'ì´ë¯¸ ë±ì— ë“¤ì–´ê°„ ì¹´ë“œì¸ì§€'ë§Œ í™•ì¸í•©ë‹ˆë‹¤.
                if (playerDeck.some(deckCard => deckCard.id === cardInstanceToAdd.id)) {
                     showMessage('ì´ë¯¸ í¸ì°¬ëœ ì¹´ë“œì…ë‹ˆë‹¤.', 'text-yellow-400', messageArea);
                    return;
                }

                playerDeck.push(cardInstanceToAdd);
                displayDeckManagement();
                saveGame();
            }
            
            function removeFromDeck(cardId) {
                const indexToRemove = playerDeck.findIndex(card => card.id === cardId);
                if(indexToRemove > -1) {
                    playerDeck.splice(indexToRemove, 1);
                }
                displayDeckManagement();
                saveGame();
            }
            
				// ìœ„ì¹˜: gacha1.html, ì•½ 1129ë²ˆì§¸ ì¤„
			function calculateDeckPower() {
    if (playerDeck.length === 0) return 0;
    
    // ë±ì— ìˆëŠ” ê° ì¹´ë“œì˜ í‡´ê³ ëœ ìŠ¤íƒ¯ì„ ê¸°ì¤€ìœ¼ë¡œ ì „íˆ¬ë ¥ì„ í•©ì‚°í•©ë‹ˆë‹¤.
    // (í‘œì‹œë˜ëŠ” ì „íˆ¬ë ¥ì—ëŠ” ì¸ì—° ë³´ë„ˆìŠ¤ê°€ í¬í•¨ë˜ì§€ ì•Šì§€ë§Œ, ì‹¤ì œ ì „íˆ¬ì—ì„œëŠ” ì •ìƒ ì ìš©ë©ë‹ˆë‹¤.)
    return playerDeck.reduce((total, cardInstance) => {
        const enhancedStats = getEnhancedStats(cardInstance);
        if (enhancedStats) {
            return total + (enhancedStats.atk + enhancedStats.def + Math.floor(enhancedStats.hp / 10));
        }
        return total;
    }, 0);
}

            // âœ… ì´ ì½”ë“œë¡œ ê¸°ì¡´ displayCombatView í•¨ìˆ˜ë¥¼ í†µì§¸ë¡œ êµì²´í•´ì£¼ì„¸ìš”.
            function displayCombatView() {
                deckPowerDisplay.textContent = calculateDeckPower();
                const chapterContainer = document.getElementById('chapter-list-container');
                chapterContainer.innerHTML = '';

                mainChapters.forEach((chapter, index) => {
                    // âœ¨ ì±•í„° ì ê¸ˆ í•´ì œ ì¡°ê±´ ë¡œì§ ì‹œì‘ âœ¨
                    let isChapterUnlocked = false;
                    if (index === 0) {
                        isChapterUnlocked = true; // 1ì¥ì€ í•­ìƒ ì—´ë ¤ìˆìŒ
                    } else {
                        // ì´ì „ ì±•í„°ì˜ ë§ˆì§€ë§‰ ìŠ¤í…Œì´ì§€ IDë¥¼ ë§Œë“­ë‹ˆë‹¤. (ì˜ˆ: 2ì¥ì˜ ì¡°ê±´ -> 1-10)
                        const prevChapter = mainChapters[index - 1];
                        const lastStageIdOfPrevChapter = `${index}-${prevChapter.stages.length}`;
                        isChapterUnlocked = clearedStages.includes(lastStageIdOfPrevChapter);
                    }
                    // âœ¨ ì±•í„° ì ê¸ˆ í•´ì œ ì¡°ê±´ ë¡œì§ ë âœ¨

                    const chapterEl = document.createElement('button');
                    chapterEl.className = `w-full gacha-button text-white font-bold py-3 px-4 rounded-lg text-left ${isChapterUnlocked ? 'bg-black/20 hover:bg-black/40' : 'bg-black/40 text-gray-500 cursor-not-allowed'}`;
                    chapterEl.disabled = !isChapterUnlocked;
                    
                    if (isChapterUnlocked) {
                        chapterEl.dataset.action = 'select-chapter';
                        chapterEl.dataset.chapterIndex = index;
                        chapterEl.textContent = chapter.chapterName;
                    } else {
                        chapterEl.textContent = `${chapter.chapterName} (ì œ${index}ì¥ í´ë¦¬ì–´ ì‹œ í•´ê¸ˆ)`;
                    }
                    
                    chapterContainer.appendChild(chapterEl);
                });

                // ê¸°ë³¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ ì±•í„°ì˜ ìŠ¤í…Œì´ì§€ë¥¼ í‘œì‹œ
                displayStages(0);
            }
            
			// âœ… displayCombatView í•¨ìˆ˜ ë°”ë¡œ ë‹¤ìŒì— ì´ ìƒˆë¡œìš´ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.
            function displayStages(chapterIndex) {
                const stageContainer = document.getElementById('stage-list-container');
                stageContainer.innerHTML = ''; // ì´ˆê¸°í™”
                
                // ì„ íƒëœ ì±•í„° ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš©
                document.querySelectorAll('#chapter-list-container button').forEach((btn, idx) => {
                    btn.classList.toggle('bg-blue-500', idx === chapterIndex);
                });

                const chapter = mainChapters[chapterIndex];
                if (!chapter) return;

                chapter.stages.forEach((stage, stageIndex) => {
                    const stageId = `${chapterIndex + 1}-${stageIndex + 1}`;
                    const isCleared = clearedStages.includes(stageId);
                    
                    // ìŠ¤í…Œì´ì§€ ì ê¸ˆ í•´ì œ ì¡°ê±´: ì²« ìŠ¤í…Œì´ì§€ì´ê±°ë‚˜, ì´ì „ ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆê±°ë‚˜
                    const isUnlocked = stageIndex === 0 || clearedStages.includes(`${chapterIndex + 1}-${stageIndex}`);

                    const stageEl = document.createElement('button');
                    stageEl.className = `p-3 rounded-lg text-center transition-transform duration-200 ${isUnlocked ? 'bg-white/20 hover:scale-105 cursor-pointer' : 'bg-black/30 text-gray-500 cursor-not-allowed'}`;
                    stageEl.disabled = !isUnlocked;
                    
                    stageEl.innerHTML = `
                        <p class="font-bold">${stage.stageName}</p>
                        <p class="text-xs">${isCleared ? 'âœ”ï¸' : 'âš”ï¸'}</p>
                    `;

                    if(isUnlocked) {
                        stageEl.dataset.action = 'challenge-stage';
                        stageEl.dataset.chapterIndex = chapterIndex;
                        stageEl.dataset.stageIndex = stageIndex;
                    }
                    stageContainer.appendChild(stageEl);
                });
            }
			
            // âœ… ê¸°ì¡´ challengeDungeon í•¨ìˆ˜ë¥¼ ì•„ë˜ ì½”ë“œë¡œ êµì²´í•´ì£¼ì„¸ìš”. (ì´ë²¤íŠ¸ ë˜ì „ ë¡œì§ì€ ìœ ì§€ë©ë‹ˆë‹¤)
            function challengeDungeon(dungeonIndex, type = 'main') {
                if (playerBookmarks < 1) {
                    const msgArea = type === 'event' ? messageArea : (document.getElementById('combat-message-area') || messageArea);
                    showMessage('ì±…ê°ˆí”¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-yellow-400', msgArea);
                    return;
                }
                if (playerDeck.length < DECK_CAPACITY) {
                    const msgArea = type === 'event' ? messageArea : (document.getElementById('combat-message-area') || messageArea);
                    showMessage('ë±ì„ 5ì¥ìœ¼ë¡œ ëª¨ë‘ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤!', 'text-yellow-400', msgArea);
                    return;
                }
                
                playerBookmarks--;
                if (playerBookmarks === MAX_BOOKMARKS - 1) {
                     lastBookmarkUpdateTime = Date.now();
                }
                updateUI();
                
                // ì´ë²¤íŠ¸ ë˜ì „ì€ ê¸°ì¡´ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                if (type === 'event') {
                    startCombat(dungeonIndex, type);
                }
                // 'main' íƒ€ì…ì€ ì´ì œ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. challengeStageë¥¼ í†µí•´ í˜¸ì¶œë©ë‹ˆë‹¤.
            }
            
            // gacha3.html - challengeStage í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ì „ì²´ êµì²´)

function challengeStage(chapterIndex, stageIndex) {
    // **ì°¸ê³ :** ì±…ê°ˆí”¼ ë¶€ì¡± ì²´í¬ëŠ” startStageCombatì—ì„œ í•œ ë²ˆ ë” í•˜ì§€ë§Œ, 
    // ì—¬ê¸°ì„œëŠ” ë± ìš©ëŸ‰ ì²´í¬ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
    
    if (playerDeck.length < DECK_CAPACITY) {
        showMessage('ë±ì„ 5ì¥ìœ¼ë¡œ ëª¨ë‘ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤!', 'text-yellow-400', messageArea);
        return;
    }
    
    // ì±…ê°ˆí”¼ê°€ 1ê°œë¼ë„ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ë¦¬í„´ë©ë‹ˆë‹¤.
    if (playerBookmarks < 1) {
        showMessage('ì±…ê°ˆí”¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-yellow-400', messageArea);
        return;
    }

    const stage = mainChapters[chapterIndex].stages[stageIndex];
    const stageId = `${chapterIndex + 1}-${stageIndex + 1}`;

    // 1. ìŠ¤í…Œì´ì§€ ìŠ¤í† ë¦¬ê°€ ìˆê³ , ì•„ì§ ì—´ëŒí•˜ì§€ ì•Šì€ ê²½ìš°
    if (stage.stageStory && !clearedStageStories.includes(stageId)) {
        const storyToStart = { content: stage.stageStory }; 
        
        // ìŠ¤í† ë¦¬ ì™„ë£Œ ì‹œ ì±…ê°ˆí”¼ ì†Œëª¨ ë° ì „íˆ¬ ì‹œì‘ì„ ìœ„í•œ ì½œë°± ì„¤ì •
        // startStageCombat í•¨ìˆ˜ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì±…ê°ˆí”¼ë¥¼ ì†Œëª¨í•©ë‹ˆë‹¤.
        document.getElementById('interactive-story-modal').dataset.callback = `startStageCombat(${chapterIndex}, ${stageIndex})`;
        
        startInteractiveStory(storyToStart);
        
        // ìŠ¤í† ë¦¬ ì—´ëŒ ìƒíƒœë¥¼ ì €ì¥ (ì±…ê°ˆí”¼ëŠ” ìŠ¤í† ë¦¬ ì™„ë£Œ í›„ ì†Œëª¨)
        clearedStageStories.push(stageId);
        saveGame(); 
        
    } else {
        // 2. ìŠ¤í† ë¦¬ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì—´ëŒí•œ ê²½ìš°, ë°”ë¡œ ì±…ê°ˆí”¼ë¥¼ ì†Œëª¨í•˜ê³  ì „íˆ¬ ì‹œì‘
        startStageCombat(chapterIndex, stageIndex);
    }
}

            function setCombatSpeed(speed) {
                combatSpeedMultiplier = speed;
                const allSpeedButtons = document.querySelectorAll('.speed-button');
                allSpeedButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('bg-gray-600');
                    btn.classList.remove('bg-blue-500');
                });
                document.getElementById(`speed-${speed}x`).classList.add('active', 'bg-blue-500');
                document.getElementById(`speed-${speed}x`).classList.remove('bg-gray-600');
            }

			// ì±…ê°ˆí”¼ë¥¼ ì†Œëª¨í•˜ê³  ì‹¤ì œ ì „íˆ¬ë¥¼ ì‹œì‘í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function startStageCombat(chapterIndex, stageIndex) {
    // 1. ì±…ê°ˆí”¼ ì†Œëª¨ ë¡œì§ (ì†Œëª¨ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ì—ë§Œ ì‹¤í–‰)
    if (playerBookmarks < 1) {
        showMessage('ì±…ê°ˆí”¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', 'text-yellow-400', messageArea);
        return;
    }
    
    playerBookmarks--;
    if (playerBookmarks === MAX_BOOKMARKS - 1) {
        lastBookmarkUpdateTime = Date.now();
    }
    updateUI();

    // 2. ì „íˆ¬ ì‹œì‘
    startCombat({ chapter: chapterIndex, stage: stageIndex }, 'main_stage');
}

				// âœ… ê¸°ì¡´ async function startCombat í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”.
async function startCombat(indices, type) {
    isCombatRunning = true;
    setCombatSpeed(1); 

    let monsterData;

    // â–¼â–¼â–¼ ëª¬ìŠ¤í„° ë°ì´í„° ì„¤ì • (ë ˆì´ë“œ í¬í•¨) â–¼â–¼â–¼
    if (type === 'raid') {
        monsterData = JSON.parse(JSON.stringify({
            name: raidBossData.name,
            stats: { 
                hp: raidBossData.currentHp, 
                atk: raidBossData.atk, 
                def: raidBossData.def 
            },
            imageUrl: raidBossData.imageUrl,
            isAoE: true 
        }));
    } 
    else if (type === 'main_stage') {
        const combatData = mainChapters[indices.chapter].stages[indices.stage];
        monsterData = JSON.parse(JSON.stringify(monsters[combatData.monsterName]));
    } else if (type === 'event') {
        const combatData = eventDungeons[indices];
        monsterData = JSON.parse(JSON.stringify(monsters[combatData.monsterName]));
    }
    // â–²â–²â–² ëª¬ìŠ¤í„° ë°ì´í„° ì„¤ì • ë â–²â–²â–²
	window.currentCombatIndices = indices;
    window.currentCombatType = type;

    // 1. í‡´ê³ /ê°œì • ë ˆë²¨ ì ìš© (ì—¬ê¸°ì„œ combatDeck ì •ì˜)
    let combatDeck = playerDeck.map(cardInstance => {
        const baseCard = findCharacter(cardInstance.name);
        const enhancedStats = getEnhancedStats(cardInstance);
        return {
            ...baseCard,
            stats: enhancedStats,
        };
    });

    // 2. ì¸ì—° ë³´ë„ˆìŠ¤ ì ìš©
    combatDeck = applySynergyBonusesToDeck(combatDeck);

    // 3. ìµœëŒ€ HP ì €ì¥ (ì›ë³¸ ë³´ë„ˆìŠ¤ ë± ì €ì¥)
    const originalBonusDeck = JSON.parse(JSON.stringify(combatDeck)); 

    // --- UI ë Œë”ë§ ---
    const combatMonsterImage = document.getElementById('combat-monster-image');
    if(combatMonsterImage) combatMonsterImage.classList.remove('shake-animation'); // ì• ë‹ˆë©”ì´ì…˜ ì”ìƒ ì œê±°

    // ë·° ì „í™˜
    allViews.forEach(view => view.classList.add('hidden'));
    combatInProgressView.classList.remove('hidden');
    combatLog.innerHTML = '';
    combatPlayerDeck.innerHTML = '';
    
    // í”Œë ˆì´ì–´ ë± UI ê·¸ë¦¬ê¸°
    combatDeck.forEach((card, index) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'bg-gray-700 p-2 rounded';
        cardEl.innerHTML = `
            <p class="font-bold text-sm truncate" title="${card.name}">${card.name}</p>
            <div class="hp-bar-background rounded-full h-2.5 mt-1">
                <div id="player-hp-bar-${index}" class="hp-bar-foreground h-2.5 rounded-full" style="width: 100%"></div>
            </div>
            <p id="player-hp-text-${index}" class="text-xs text-center mt-0.5">${card.stats.hp} / ${originalBonusDeck[index].stats.hp}</p>
        `;
        combatPlayerDeck.appendChild(cardEl);
    });

    // ëª¬ìŠ¤í„° UI ê·¸ë¦¬ê¸°
    combatMonsterArea.innerHTML = `
        <h3 class="text-2xl font-bold">${monsterData.name}</h3>
        <img id="combat-monster-image" src="${monsterData.imageUrl}" alt="${monsterData.name}" class="my-4 h-48 w-48 object-contain">
        <div class="w-full hp-bar-background rounded-full h-4">
            <div id="monster-hp-bar" class="hp-bar-foreground h-4 rounded-full" style="width: 100%"></div>
        </div>
        <p id="monster-hp-text" class="text-sm mt-1">${monsterData.stats.hp} / ${monsterData.stats.hp}</p>
    `;

    // 4. ì „íˆ¬ ë£¨í”„ ì‹¤í–‰
    await runCombatLoop(combatDeck, originalBonusDeck, monsterData, indices, type); 
}

            
            

            const delay = ms => new Promise(res => setTimeout(res, ms / combatSpeedMultiplier));

            // âœ… ê¸°ì¡´ runCombatLoop í•¨ìˆ˜ë¥¼ ì´ ì½”ë“œë¡œ í†µì§¸ë¡œ êµì²´í•˜ì„¸ìš”.
// âœ… [ìˆ˜ì •ë¨] ì „íˆ¬ ë£¨í”„ í•¨ìˆ˜ (í•­ë³µ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨ ê¸°ëŠ¥ ì¶”ê°€)
async function runCombatLoop(combatDeck, originalBonusDeck, monsterData, indices, type) { 
    const originalMonsterDef = monsterData.stats.def;
    let totalDamageDealt = 0; 

    // ëª¬ìŠ¤í„°ë‚˜ í”Œë ˆì´ì–´ ì¤‘ í•œ ìª½ì´ ì „ë©¸í•  ë•Œê¹Œì§€ ë°˜ë³µ
    while (monsterData.stats.hp > 0 && combatDeck.some(c => c.stats.hp > 0)) {
        
        // âœ¨ [í•µì‹¬ 1] ë£¨í”„ ì‹œì‘ ì‹œ ì „íˆ¬ ì¤‘ì¸ì§€ ì²´í¬. ì•„ë‹ˆë¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ.
        if (!isCombatRunning) return;

        // ===============================================
        // 1. í”Œë ˆì´ì–´ í„´
        // ===============================================
        for (let i = 0; i < combatDeck.length; i++) {
            // âœ¨ [í•µì‹¬ 2] í„´ ì¤‘ê°„ì—ë„ ìˆ˜ì‹œë¡œ ì²´í¬
            if (!isCombatRunning) return;

            const card = combatDeck[i];
            if (card.stats.hp > 0) {
                await delay(800);
                if (!isCombatRunning) return; // âœ¨ ë”œë ˆì´ ì§í›„ ì²´í¬ í•„ìˆ˜!

                const monsterImage = document.getElementById('combat-monster-image');
                
                // ìŠ¤í‚¬ ì‚¬ìš© ì—¬ë¶€ ê²°ì •
                const useUltimate = card.rarity === 'SSR' && Math.random() < 0.25;
                const useSkill = Math.random() < 0.4;
                let skillToUse = null;

                if (useUltimate && card.skills.length > 1) skillToUse = card.skills[1];
                else if (useSkill) skillToUse = card.skills[0];

                let damage = 0;

                if (skillToUse) {
                    logCombat(`<strong>${card.name}</strong>ì˜ ìŠ¤í‚¬! <span class="text-yellow-300">"${skillToUse.name}"</span>`);
                    
                    await delay(400);
                    if (!isCombatRunning) return; // âœ¨ ë”œë ˆì´ ì§í›„ ì²´í¬

                    logCombat(`<em>"${skillToUse.dialogue}"</em>`);
                    
                    // --- ìŠ¤í‚¬ íš¨ê³¼ ê³„ì‚° ---
                    if (skillToUse.type === 'true_damage') {
                        damage = Math.floor(card.stats.atk * skillToUse.power);
                        logCombat(`ë°©ì–´ë ¥ì„ ë¬´ì‹œí•œ ê°•ë ¥í•œ ì¼ê²©!`);
                    } else if (skillToUse.type === 'heal') {
                        damage = 0;
                        const healAmount = Math.floor(card.stats.atk * skillToUse.power);
                        const maxHp = originalBonusDeck[i].stats.hp;
                        card.stats.hp = Math.min(maxHp, card.stats.hp + healAmount);
                        logCombat(`<strong>${card.name}</strong>ì´(ê°€) ì²´ë ¥ì„ ${healAmount} íšŒë³µí–ˆìŠµë‹ˆë‹¤!`);
                    } else if (skillToUse.type === 'vampire') {
                        damage = Math.max(1, Math.floor(card.stats.atk * skillToUse.power) - monsterData.stats.def);
                        const healedAmount = Math.floor(damage * 0.5);
                        const maxHp = originalBonusDeck[i].stats.hp;
                        card.stats.hp = Math.min(maxHp, card.stats.hp + healedAmount);
                        logCombat(`<strong>${card.name}</strong>ì´(ê°€) ${healedAmount}ì˜ ì²´ë ¥ì„ í¡ìˆ˜í–ˆìŠµë‹ˆë‹¤!`);
                    } else if (skillToUse.type === 'debuff_def') {
                        monsterData.stats.def = Math.max(0, Math.floor(monsterData.stats.def * 0.8));
                        logCombat(`<strong>${monsterData.name}</strong>ì˜ ë°©ì–´ë ¥ì´ ê°ì†Œí–ˆìŠµë‹ˆë‹¤!`);
                    } else if (skillToUse.type === 'debuff_atk') {
                        monsterData.stats.atk = Math.max(0, Math.floor(monsterData.stats.atk * 0.9));
                        logCombat(`<strong>${monsterData.name}</strong>ì˜ ê³µê²©ë ¥ì´ ê°ì†Œí–ˆìŠµë‹ˆë‹¤!`);
                    } else if (skillToUse.type === 'buff_atk') {
                        card.stats.atk = Math.floor(card.stats.atk * 1.1);
                        logCombat(`<strong>${card.name}</strong>ì˜ ê³µê²©ë ¥ì´ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!`);
                    } else {
                        damage = Math.max(1, Math.floor(card.stats.atk * skillToUse.power) - monsterData.stats.def);
                    }

                } else {
                    logCombat(`<strong>${card.name}</strong>ì˜ ì¼ë°˜ ê³µê²©!`);
                    damage = Math.max(1, card.stats.atk - monsterData.stats.def);
                }
                
                if (damage > 0) {
                    monsterData.stats.hp = Math.max(0, monsterData.stats.hp - damage);
                    totalDamageDealt += damage;
                    logCombat(`<strong>${monsterData.name}</strong>ì—ê²Œ ${damage}ì˜ ë°ë¯¸ì§€!`);
                    
                    if (monsterImage) {
                        monsterImage.classList.add('shake-animation');
                        setTimeout(() => monsterImage.classList.remove('shake-animation'), 300 / combatSpeedMultiplier);
                    }
                    updateCombatUI(combatDeck, originalBonusDeck, monsterData);
                }

                if (monsterData.stats.hp <= 0) break;
            }
        } 

        if (monsterData.stats.hp <= 0) break;

        // ===============================================
        // 2. ëª¬ìŠ¤í„° í„´
        // ===============================================
        await delay(1000);
        if (!isCombatRunning) return; // âœ¨ ë”œë ˆì´ ì§í›„ ì²´í¬

        const alivePlayers = combatDeck.filter(c => c.stats.hp > 0);
        
        if (alivePlayers.length > 0) {
            if (monsterData.isAoE) {
                logCombat(`<strong>${monsterData.name}</strong>ì˜ <span class="text-red-400 font-bold">ê´‘ì—­ ê³µê²©!</span>`);
                for (const targetCard of alivePlayers) {
                    const damage = Math.max(1, monsterData.stats.atk - targetCard.stats.def);
                    const hpBeforeAttack = targetCard.stats.hp;
                    targetCard.stats.hp = Math.max(0, targetCard.stats.hp - damage);
                    logCombat(`- <strong>${targetCard.name}</strong>ì—ê²Œ ${damage}ì˜ ë°ë¯¸ì§€!`);
                    
                    if (targetCard.stats.hp <= 0 && hpBeforeAttack > 0) {
                        await delay(200);
                        if (!isCombatRunning) return; // âœ¨ ì²´í¬
                        if (targetCard.deathDialogue) {
                            logCombat(`<strong>${targetCard.name}</strong>: <em>"${targetCard.deathDialogue}"</em>`);
                        }
                    }
                }
            } else {
                const targetCard = alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
                logCombat(`<strong>${monsterData.name}</strong>ì˜ ê³µê²©!`);
                const damage = Math.max(1, monsterData.stats.atk - targetCard.stats.def);
                const hpBeforeAttack = targetCard.stats.hp;
                targetCard.stats.hp = Math.max(0, targetCard.stats.hp - damage);
                logCombat(`<strong>${targetCard.name}</strong>ì—ê²Œ ${damage}ì˜ ë°ë¯¸ì§€!`);
                
                if (targetCard.stats.hp <= 0 && hpBeforeAttack > 0) {
                    await delay(400);
                    if (!isCombatRunning) return; // âœ¨ ì²´í¬
                    if (targetCard.deathDialogue) {
                        logCombat(`<strong>${targetCard.name}</strong>: <em>"${targetCard.deathDialogue}"</em>`);
                    }
                }
            }
            updateCombatUI(combatDeck, originalBonusDeck, monsterData);
        }
    } // while ë£¨í”„ ì¢…ë£Œ
    
    await delay(1000);
    if (!isCombatRunning) return; // âœ¨ ë§ˆì§€ë§‰ ë”œë ˆì´ í›„ì—ë„ ì²´í¬

    monsterData.stats.def = originalMonsterDef; 
    
    // âœ¨ [í•µì‹¬ 3] ì „íˆ¬ê°€ 'í•­ë³µ'ìœ¼ë¡œ ì¸í•´ ì´ë¯¸ ëë‚¬ëŠ”ì§€(false) í™•ì¸ í›„ ì •ìƒ ì¢…ë£Œ í˜¸ì¶œ
    if (isCombatRunning) {
        endCombat(monsterData.stats.hp <= 0, {indices: indices, type: type}, totalDamageDealt);
    }
}

            function logCombat(message) {
                combatLog.innerHTML += `<p>${message}</p>`;
                combatLogContainer.scrollTop = combatLogContainer.scrollHeight;
            }
			
			// âœ¨ [ìˆ˜ì •ëœ registerUser í•¨ìˆ˜]
        async function registerUser() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            // âœ¨ 1. ë‹‰ë„¤ì„ ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
            const nicknameInput = document.getElementById('nickname-input').value.trim();

            if (!nicknameInput) {
                return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const newUser = userCredential.user;
                
                // âœ¨ 2. Firebase í”„ë¡œí•„ì— ë‹‰ë„¤ì„ ì„¤ì •
                await newUser.updateProfile({ displayName: nicknameInput });
                
                alert('íšŒì›ê°€ì… ì„±ê³µ! ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.');

                const localDataString = localStorage.getItem(SAVE_DATA_KEY);
                if (localDataString) {
                    // (ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§ ìœ ì§€)
                    console.log('ê¸°ì¡´ ë¡œì»¬ ë°ì´í„°ë¥¼ Firebaseë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•©ë‹ˆë‹¤.');
                    const localData = JSON.parse(localDataString);
                    // ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì—ë„ ë‹‰ë„¤ì„ ì €ì¥
                    localData.nickname = nicknameInput; 
                    await db.collection('users').doc(newUser.uid).set(localData);
                    localStorage.removeItem(SAVE_DATA_KEY);
                } else {
                    // (ì‹ ê·œ ìœ ì € ë¡œì§)
                    initializeNewGameData();
                    
                    // âœ¨ 3. ì „ì—­ ë³€ìˆ˜ì— ë‹‰ë„¤ì„ ì €ì¥ í›„ DB ì €ì¥
                    currentPlayerNickname = nicknameInput;
                    await saveGameToFirebase(); 
                }
            } catch (error) {
                alert(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // âœ¨ ë¡œê·¸ì¸ í•¨ìˆ˜ âœ¨
        async function loginUser() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // âœ¨ ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ âœ¨
        async function logoutUser() {
            try {
                await auth.signOut();
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } catch (error) {
                alert(`ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`);
            }
        }


			function renderEventStoryList() {
    const eventStoryContainer = document.getElementById('eventStoryContainer');
    eventStoryContainer.innerHTML = '';
    
    // 1ë²ˆì—ì„œ ì •ì˜í•œ eventStories ë°°ì—´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    eventStories.forEach((story, index) => {
        const storyEl = document.createElement('div');
        storyEl.className = 'p-3 bg-white/10 rounded-lg shadow-md mb-2 cursor-pointer transition-transform hover:scale-[1.01]';
        
        // â­ ì´ ë‘ ê°€ì§€ data- ì†ì„±ì´ ì¤‘ìš”í•©ë‹ˆë‹¤!
        storyEl.dataset.storyIndex = index;
        storyEl.dataset.storyType = 'event'; // âœ… ì´ ì†ì„±ì´ 'event'ì—¬ì•¼ í•©ë‹ˆë‹¤.
        
        storyEl.innerHTML = `
            <div class="text-lg font-bold text-white">${story.title}</div>
            <div class="text-sm text-gray-300">íšë“ ë³´ìƒ: ë¶ë§ˆí¬ 10ê°œ</div>
        `;

        if (story.isLocked) {
             storyEl.classList.add('opacity-50', 'cursor-default');
             storyEl.innerHTML = `<div class="text-lg font-bold text-gray-500">ìŠ¤í† ë¦¬ ì ê¸ˆ</div><div class="text-sm text-gray-500">ì´ë²¤íŠ¸ ì§„í–‰ì„ í†µí•´ í•´ì œ ê°€ëŠ¥</div>`;
             storyEl.dataset.storyType = 'locked'; // ì ê¸´ ìŠ¤í† ë¦¬ëŠ” ë‹¤ë¥¸ íƒ€ì…ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ í´ë¦­ ë°©ì§€
        }
        
        eventStoryContainer.appendChild(storyEl);
    });
}

             // yumecan.html íŒŒì¼ì˜ function updateCombatUI í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”.
function updateCombatUI(deck, originalBonusDeck, monster) {
    // 1. í”Œë ˆì´ì–´ ë± HP ì—…ë°ì´íŠ¸
    deck.forEach((card, index) => {
        const originalCardWithBonus = originalBonusDeck[index];
        
        // âœ¨ [í•µì‹¬ ìˆ˜ì •] ì›ë³¸ ë± ë°ì´í„°ê°€ ì¡´ì¬í•˜ê³  stats ì†ì„±ë„ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        if(!originalCardWithBonus || !originalCardWithBonus.stats) return; 

        const maxHp = originalCardWithBonus.stats.hp; // ì „íˆ¬ ì‹œì‘ ì‹œì ì˜ ìµœëŒ€ HP
        const currentHp = card.stats.hp;

        const hpPercent = maxHp > 0 ? (currentHp / maxHp) * 100 : 0;
        
        // HP ë°” ì—…ë°ì´íŠ¸ (null ì²´í¬ ì¶”ê°€)
        const hpBarEl = document.getElementById(`player-hp-bar-${index}`);
        const hpTextEl = document.getElementById(`player-hp-text-${index}`);

        if (hpBarEl) {
            hpBarEl.style.width = `${hpPercent}%`;
        }
        if (hpTextEl) {
            hpTextEl.textContent = `${currentHp} / ${maxHp}`;
        }
    });

    // 2. ëª¬ìŠ¤í„° HP ì—…ë°ì´íŠ¸ (ì´ ë¶€ë¶„ì„ ì•„ë˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”)
    let monsterMaxHp;

    // A. ë ˆì´ë“œ ë³´ìŠ¤ ë°ì´í„° ì‚¬ìš© (ì „ì—­ ë³€ìˆ˜ raidBossDataSheetì™€ ì´ë¦„ ì¼ì¹˜ í™•ì¸)
    if (typeof raidBossDataSheet !== 'undefined' && monster.name === raidBossDataSheet.name) {
        monsterMaxHp = raidBossDataSheet.maxHp;
    } 
    // B. ì¼ë°˜ ëª¬ìŠ¤í„° ë°ì´í„° ì‚¬ìš©
    else {
        // ì¼ë°˜ ëª¬ìŠ¤í„° ëª©ë¡ì—ì„œ Max HPë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        monsterMaxHp = monsters[monster.name]?.stats.hp;
    }

    if (monsterMaxHp) { // Max HPë¥¼ ì°¾ì•˜ë‹¤ë©´
        const monsterHpPercent = (monster.stats.hp / monsterMaxHp) * 100;
        
        const monsterHpBar = document.getElementById('monster-hp-bar');
        const monsterHpText = document.getElementById('monster-hp-text');

        if (monsterHpBar) {
            monsterHpBar.style.width = `${monsterHpPercent}%`;
        }
        if (monsterHpText) {
            monsterHpText.textContent = `${monster.stats.hp} / ${monsterMaxHp}`;
        }
    } else {
        console.error("ëª¬ìŠ¤í„° ì›ë³¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ HP ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤");
    }
}


			function displayEventStories() {
    const eventStoryContainer = document.getElementById('event-story-part1-container'); // ğŸ‘ˆ ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”.
    eventStoryContainer.innerHTML = '';
    
    // ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° (ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°)
    if (!eventStories || eventStories.length === 0) {
        eventStoryContainer.innerHTML = `<p class="text-center text-gray-400 mt-10">ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬ëŠ” í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>`;
        return;
    }

    // ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬ë¥¼ ìˆœíšŒí•˜ë©° ë²„íŠ¼ ìƒì„±
    eventStories.forEach((story, index) => {
        // ì´ë²¤íŠ¸ ë˜ì „ í´ë¦¬ì–´ ìƒíƒœë¥¼ ìŠ¤í† ë¦¬ í•´ê¸ˆ ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©
        // ì˜ˆ: eventDungeons[index]ê°€ clearedEventDungeonsì— í¬í•¨ë˜ì–´ì•¼ í•´ê¸ˆ
        const dungeonName = eventDungeons[index]?.name;
        const isUnlocked = dungeonName && clearedEventDungeons.includes(dungeonName);
        
        const storyEl = document.createElement('div');
        storyEl.className = `p-4 rounded-lg transition-colors duration-300 ${isUnlocked ? 'bg-white/20 hover:bg-white/30 cursor-pointer' : 'bg-black/30 text-gray-500'}`;
        
        if (isUnlocked) {
            storyEl.dataset.storyIndex = index;
            storyEl.dataset.storyType = 'event';
        }

        let unlockText = 'í´ë¦­í•˜ì—¬ ìŠ¤í† ë¦¬ ì½ê¸°';
        if (!isUnlocked) {
            unlockText = `${dungeonName} í´ë¦¬ì–´ ì‹œ í•´ê¸ˆ`;
        }

        storyEl.innerHTML = `
            <h3 class="text-xl font-bold ${isUnlocked ? 'text-pink-300' : ''}">[ì´ë²¤íŠ¸] ${story.title}</h3>
            <p class="text-sm">${unlockText}</p>
        `;
        eventStoryContainer.appendChild(storyEl);
    });
}
			
			// [ì´ ì½”ë“œë¡œ gacha.htmlì˜ function displayEventStoryPart2() í•¨ìˆ˜ ì „ì²´ë¥¼ êµì²´í•˜ì„¸ìš”]
function displayEventStoryPart2() {
    const container = document.getElementById('event-story-part2-container');
    container.innerHTML = '';

    // í›„ë°˜ë¶€ ìŠ¤í† ë¦¬ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    if (!eventStoryPart2.secondHalf || eventStoryPart2.secondHalf.length === 0) {
        // [ìˆ˜ì •ëœ ë¶€ë¶„] 
        // "ì•„ì§ ê³µê°œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" ëŒ€ì‹  ìš”ì²­í•˜ì‹  ë©”ì‹œì§€ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        container.innerHTML = `<p class="text-center text-gray-400 mt-10">ë¯¸ë‹ˆ ì´ë²¤íŠ¸ì—ëŠ” í›„ë°˜ë¶€ ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>`;
        return;
    }

    // (ê¸°ì¡´ í›„ë°˜ë¶€ ìŠ¤í† ë¦¬ í•´ê¸ˆ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤)
    // ì „ë°˜ë¶€ ë§ˆì§€ë§‰ ìŠ¤í† ë¦¬ë¥¼ í´ë¦¬ì–´í–ˆëŠ”ì§€ í™•ì¸
    const isPart1Finished = playerChoices['event_part2_final_choice'];

    eventStoryPart2.secondHalf.forEach((story, index) => {
        const isUnlocked = (index === 0) ? isPart1Finished : playerChoices[`event_part2_story_${index - 1}`];

        const storyEl = document.createElement('div');
        storyEl.className = `p-4 rounded-lg transition-colors duration-300 ${isUnlocked ? 'bg-white/20 hover:bg-white/30 cursor-pointer' : 'bg-black/30 text-gray-500'}`;
        
        if (isUnlocked) {
            storyEl.dataset.storyIndex = index;
            storyEl.dataset.storyType = 'event_part2'; 
        }

        let unlockText = 'í´ë¦­í•˜ì—¬ ìŠ¤í† ë¦¬ ì½ê¸°';
        if (!isUnlocked) {
            unlockText = (index === 0) ? `ì „ë°˜ë¶€ ë§ˆì§€ë§‰ ì„ íƒì„ ì™„ë£Œí•˜ë©´ í•´ê¸ˆ` : `ì´ì „ ìŠ¤í† ë¦¬ë¥¼ ì™„ë£Œí•˜ë©´ í•´ê¸ˆ`;
        }
        
        storyEl.innerHTML = `
            <h3 class="text-xl font-bold ${isUnlocked ? 'text-pink-300' : ''}">[ì´ë²¤íŠ¸] ${story.title}</h3>
            <p class="text-sm">${unlockText}</p>
        `;
        container.appendChild(storyEl);
    });
}
			
           // âœ… [ìµœì¢… ìˆ˜ì •] endCombat (ë ˆì´ë“œ ì¢…ë£Œ ì‹œ ëª¨ë‹¬ ì”ìƒ í•´ê²°)
function endCombat(isVictory, combatInfo, totalDamageDealt = 0) { 
    console.log("1. ì „íˆ¬ ì¢…ë£Œ ì§„ì…:", combatInfo);

    isCombatRunning = false; 

    // [1] ì „íˆ¬ í™”ë©´ ìˆ¨ê¸°ê¸°
    const combatView = document.getElementById('combat-in-progress-view');
    if (combatView) {
        combatView.classList.add('hidden');
    }

    // [2] ê²°ê³¼ì°½ ëª¨ë‹¬ ì¤€ë¹„
    const resultModal = document.getElementById('combat-result-modal');
    const resultTitle = document.getElementById('combat-result-title');
    const resultMessage = document.getElementById('combat-result-message');

    if (resultModal) {
        // ì¼ë‹¨ ëª¨ë‹¬ì„ ë„ì›€ (ê°•ì œ í‘œì‹œ)
        document.body.appendChild(resultModal); 
        resultModal.classList.remove('hidden');
        resultModal.style.zIndex = '99999'; 
        resultModal.style.display = 'flex'; 
        
        // âœ¨ [ì¤‘ìš”] í…ìŠ¤íŠ¸ ì´ˆê¸°í™” (ì´ì „ ì „íˆ¬ ë©”ì‹œì§€ê°€ ë‚¨ì§€ ì•Šê²Œ í•¨)
        if (resultTitle) resultTitle.textContent = "ì „íˆ¬ ì¢…ë£Œ ì²˜ë¦¬ ì¤‘...";
        if (resultMessage) resultMessage.textContent = "";
    }

    // [3] ë ˆì´ë“œ ì˜ˆì™¸ ì²˜ë¦¬ (ì—¬ê¸°ê°€ ë¬¸ì œì˜€ìŠµë‹ˆë‹¤)
    if (combatInfo && combatInfo.type === 'raid') {
        if (resultModal) {
            // âœ¨ [í•µì‹¬ ìˆ˜ì •] flexë¡œ ê°•ì œëœ ìŠ¤íƒ€ì¼ì„ noneìœ¼ë¡œ í™•ì‹¤í•˜ê²Œ ë®ì–´ì¨ì„œ ë•ë‹ˆë‹¤.
            resultModal.style.display = 'none'; 
            resultModal.classList.add('hidden');
        }

        if (typeof submitRaidDamage === 'function') submitRaidDamage(totalDamageDealt);
        
        document.getElementById('event-view').classList.remove('hidden');
        document.getElementById('event-raid-view').classList.remove('hidden');
        
        const btnRaid = document.getElementById('event-sub-tab-raid');
        if (btnRaid) btnRaid.classList.add('active');
        return; 
    }

    // [4] ì¼ë°˜/ì´ë²¤íŠ¸ ì „íˆ¬ ë³´ìƒ ê³„ì‚°
    try {
        lastCombatType = combatInfo ? combatInfo.type : 'main'; 

        let rewardMsg = "";
        let titleText = isVictory ? "ìŠ¹ë¦¬!" : "íŒ¨ë°°...";
        let titleColor = isVictory ? "text-green-400" : "text-red-400";

        if (isVictory) {
            if (combatInfo.type === 'event') {
                if (typeof eventDungeons !== 'undefined' && eventDungeons[combatInfo.indices]) {
                    const dungeon = eventDungeons[combatInfo.indices];
                    const reward = dungeon.eventPointReward || 0;
                    if (typeof playerEventPoints !== 'undefined') playerEventPoints += reward;
                    if (typeof playerCumulativeEventPoints !== 'undefined') playerCumulativeEventPoints += reward;
                    if (typeof clearedEventDungeons !== 'undefined' && !clearedEventDungeons.includes(dungeon.name)) {
                        clearedEventDungeons.push(dungeon.name);
                    }
                    rewardMsg = `ì´ë²¤íŠ¸ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´! ${reward} Pë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`;
                }
            } else if (combatInfo.type === 'main_stage') {
                if (typeof mainChapters !== 'undefined' && mainChapters[combatInfo.indices.chapter]) {
                    const stage = mainChapters[combatInfo.indices.chapter].stages[combatInfo.indices.stage];
                    const stageId = `${combatInfo.indices.chapter + 1}-${combatInfo.indices.stage + 1}`;
                    if (typeof clearedStages !== 'undefined' && !clearedStages.includes(stageId)) {
                        clearedStages.push(stageId);
                    }
                    let rewardsEarned = [];
                    if (stage.rewards) {
                        if (stage.rewards.fountainPens) {
                            if (typeof playerFountainPens !== 'undefined') playerFountainPens += stage.rewards.fountainPens;
                            rewardsEarned.push(`ğŸ–‹ï¸${stage.rewards.fountainPens}`);
                        }
                        if (stage.rewards.currency) {
                            if (typeof playerCurrency !== 'undefined') playerCurrency += stage.rewards.currency;
                            rewardsEarned.push(`ğŸ’${stage.rewards.currency}`);
                        }
                    }
                    rewardMsg = `ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´! ${rewardsEarned.join(', ')} íšë“!`;
                }
            }
        } else {
            rewardMsg = "ì „íˆ¬ì—ì„œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...";
        }

        // ê²°ê³¼ í…ìŠ¤íŠ¸ ì ìš©
        if(resultTitle) {
            resultTitle.textContent = titleText;
            resultTitle.className = `text-4xl font-bold mb-4 ${titleColor}`;
        }
        if(resultMessage) resultMessage.textContent = rewardMsg;

        try { if(typeof updateUI === 'function') updateUI(); } catch(e) {}
        try { if(typeof checkAchievements === 'function') checkAchievements(); } catch(e) {}
saveGame();
    } catch (error) {
        console.error("ë³´ìƒ ê³„ì‚° ì—ëŸ¬:", error);
        if(resultMessage) resultMessage.textContent = `ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`;
    }
}

            // âœ… [ìˆ˜ì •ë¨] createCard í•¨ìˆ˜ (ë“±ê¸‰ë³„ ê¸€ë¡œìš° ì ìš©)
function createCard(character, options = {}) {
    const { animationIndex, mode = 'default', isCardInDeck, isDeckFull, isCollected } = options;
    
    // 1. ê¸€ë¡œìš° í´ë˜ìŠ¤ ì„¤ì •
    const glowClass = `rarity-glow-${character.rarity}`; // âœ¨ [í•µì‹¬] ê¸€ë¡œìš° í´ë˜ìŠ¤ ì¤€ë¹„
    
    // ì¹´ë“œ ì™¸í˜• ì»¨í…Œì´ë„ˆ
    const card = document.createElement('div');
    card.className = `rarity-${character.rarity} relative text-center rounded-lg shadow-md p-2 transform transition-transform duration-300 hover:scale-105 cursor-pointer`;
    card.title = character.name;
    
    // ... (ë‚˜ë¨¸ì§€ ë³€ìˆ˜ ì„¤ì • ë¡œì§ì€ ìœ ì§€) ...
    const rarityColor = { 'N': 'text-gray-600', 'R': 'text-blue-800', 'SR': 'text-white', 'SSR': 'text-black' }[character.rarity];
    const factionColors = {
        'íƒì •': 'bg-blue-500 text-white',
        'ì¡°ìˆ˜': 'bg-green-500 text-white',
        'ë²”ì¸': 'bg-red-500 text-white',
        // ... (ë‚˜ë¨¸ì§€ ì§„ì˜ ì»¬ëŸ¬ ìœ ì§€) ...
        'íˆì–´ë¡œ': 'bg-indigo-600 text-white',
        'ë¹ŒëŸ°': 'bg-gray-800 text-white',
        'ë§ˆë²•ì‚¬': 'bg-purple-600 text-white',
        'ì´ˆëŒ€ê°': 'bg-orange-400 text-white',
        'ë„ë°•ì‚¬': 'bg-yellow-600 text-white',
        'ì‚¬ì œ': 'bg-teal-500 text-white',
        'ì•…ë§ˆ': 'bg-rose-900 text-white'
    };
    const cardInstance = options.instance;

    // 1. ë ˆë²¨ ë°°ì§€
    let levelBadgeHTML = '';
    if (cardInstance && cardInstance.level > 0) {
        levelBadgeHTML = `<div class="level-badge">+${cardInstance.level}</div>`;
    }
    
    // 2. ê°œì •(ë³„) í‘œì‹œ
    let revisionStarsHTML = '';
    if (cardInstance && cardInstance.revision > 0) {
        revisionStarsHTML = `<div class="revision-stars">${'â­'.repeat(cardInstance.revision)}</div>`;
    }
    
    // 3. í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    let actionButtonsHTML = '';
    
    if (mode === 'deckBuilder' && cardInstance) {
        // ... (ë± ë¹Œë” ë¡œì§ ìœ ì§€) ...
        const disabled = isDeckFull || isCardInDeck;
        const buttonText = isCardInDeck ? 'í¸ì°¬ë¨' : 'ì¶”ê°€';
        const buttonColor = isCardInDeck ? 'bg-gray-500' : 'bg-green-500 hover:bg-green-600';
        actionButtonsHTML = `<button data-action="add-to-deck" data-card-id="${cardInstance.id}" class="w-full mt-2 py-1 rounded-md text-white font-bold text-sm ${buttonColor}" ${disabled ? 'disabled' : ''}>${buttonText}</button>`;
        
    } else if (mode === 'inventory') {
        // ... (ì¸ë²¤í† ë¦¬ ë¡œì§ ìœ ì§€) ...
        const isRepresentative = representativeCharacter && representativeCharacter.name === character.name;
        const repButtonText = isRepresentative ? 'ëŒ€í‘œ' : 'ëŒ€í‘œ ì„¤ì •';
        const repButtonColor = isRepresentative ? 'bg-yellow-500' : 'bg-gray-600 hover:bg-gray-700';
        actionButtonsHTML = `<button data-action="set-representative" data-card-name="${character.name}" class="w-full mt-2 py-1 rounded-md text-white font-bold text-sm ${repButtonColor}" ${isRepresentative ? 'disabled' : ''}>${repButtonText}</button>`;
        
    } else if (mode === 'deckSlot' && cardInstance) {
        // ... (ë± ìŠ¬ë¡¯ ë¡œì§ ìœ ì§€) ...
        actionButtonsHTML = `<button data-action="remove-from-deck" data-card-id="${cardInstance.id}" class="w-full mt-2 py-1 rounded-md text-white font-bold text-sm bg-red-600 hover:bg-red-700 shadow-md">í•´ì œ</button>`;
    }
    
    // ì§„ì˜ ë°°ì§€
    const factionBadge = `<span class="absolute top-2 right-2 text-xs font-bold px-2 py-1 rounded-full ${factionColors[character.faction]} z-10">${character.faction}</span>`;

    // 4. HTML ì¡°ë¦½
    card.innerHTML = `
        ${factionBadge} ${levelBadgeHTML} ${revisionStarsHTML} 
        <div class="relative pointer-events-none">
            <img src="${character.cardImageUrl}" alt="${character.name}" class="w-full h-full object-cover rounded-md mb-2 border-2 border-white/50 ${glowClass}"> 
            <p class="font-bold text-sm ${rarityColor} truncate">${character.name}</p>
            <p class="font-black text-lg ${rarityColor}" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.5);">${character.rarity}</p>
        </div>
        ${actionButtonsHTML}
    `;

    if (cardInstance && mode !== 'collection') { 
        card.dataset.uniqueId = cardInstance.id;
    }

    if (typeof animationIndex === 'number') {
        card.style.opacity = '0';
        card.style.animationDelay = `${animationIndex * 0.05}s`;
        card.classList.add('card-animation');
    }
    
    if(mode === 'deckBuilder' && isCardInDeck) {
        card.classList.add('opacity-50');
    }

    if (mode === 'collection') {
        if (isCollected) {
            card.dataset.isCollected = "true";
        } else {
            card.dataset.isCollected = "false";
            card.classList.add('grayscale', 'opacity-75');
            card.classList.remove('hover:scale-105', 'cursor-pointer');
        }
    }
    return card;
}

            function getSkillDescription(skill) {
    // 1. êµ¬ê¸€ ì‹œíŠ¸ì— ì ì–´ë‘” 'ì»¤ìŠ¤í…€ ì„¤ëª…'ì´ ìˆë‹¤ë©´ ê·¸ê±¸ ìµœìš°ì„ ìœ¼ë¡œ ë³´ì—¬ì¤Œ
    if (skill.desc && skill.desc !== "") {
        return skill.desc;
    }

    // 2. ì»¤ìŠ¤í…€ ì„¤ëª…ì´ ì—†ìœ¼ë©´, ìŠ¤í‚¬ íƒ€ì…ì— ë”°ë¼ ìë™ ìƒì„±
    const powerPercent = Math.round(skill.power * 100); // ì˜ˆ: 1.5 -> 150
    
    switch(skill.type) {
        case 'damage': 
            return `ì ì—ê²Œ ê³µê²©ë ¥ì˜ ${powerPercent}% ë§Œí¼ í”¼í•´ë¥¼ ì¤ë‹ˆë‹¤.`;
        case 'heal': 
            return `ìì‹ ì˜ ì²´ë ¥ì„ ê³µê²©ë ¥ì˜ ${powerPercent}% ë§Œí¼ íšŒë³µí•©ë‹ˆë‹¤.`;
        case 'vampire': 
            return `ì ì„ ê³µê²©í•˜ê³  í”¼í•´ëŸ‰ì˜ 50%ë¥¼ ì²´ë ¥ìœ¼ë¡œ í¡ìˆ˜í•©ë‹ˆë‹¤.`;
        case 'true_damage': 
            return `ì ì˜ ë°©ì–´ë ¥ì„ ë¬´ì‹œí•˜ê³  ê³µê²©ë ¥ì˜ ${powerPercent}% í”¼í•´ë¥¼ ì¤ë‹ˆë‹¤.`;
        case 'buff_atk': 
            return `ìì‹ ì˜ ê³µê²©ë ¥ì´ 10% ì¦ê°€í•©ë‹ˆë‹¤.`;
        case 'debuff_atk': 
            return `ì ì˜ ê³µê²©ë ¥ì„ 10% ê°ì†Œì‹œí‚µë‹ˆë‹¤.`;
        case 'debuff_def': 
            return `ì ì˜ ë°©ì–´ë ¥ì„ 20% ê°ì†Œì‹œí‚µë‹ˆë‹¤.`;
        default: 
            return 'íŠ¹ë³„í•œ íš¨ê³¼ë¥¼ ê°€ì§„ ìŠ¤í‚¬ì…ë‹ˆë‹¤.'; // íƒ€ì…ì„ ëª¨ë¥¼ ë•Œ ë‚˜ì˜¤ëŠ” ê¸°ë³¸ ë¬¸êµ¬
    }
}

            let currentDetailCardId = null;

            // âœ… ì´ ì½”ë“œë¡œ ê¸°ì¡´ showCardDetails í•¨ìˆ˜ë¥¼ í†µì§¸ë¡œ êµì²´í•´ì£¼ì„¸ìš”.
            function showCardDetails(cardId) {
                const cardInstance = playerInventory.find(c => c.id === cardId);
                if (!cardInstance) {
                    console.error("ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", cardId);
                    return;
                }

                currentDetailCardId = cardId;
                const character = findCharacter(cardInstance.name);
                const currentStats = getEnhancedStats(cardInstance);

                // --- 1. ê¸°ë³¸ ì •ë³´ í‘œì‹œ ---
                document.getElementById('detail-card-image').src = character.imageUrl;
                document.getElementById('detail-card-name').textContent = character.name;
                const rarityEl = document.getElementById('detail-card-rarity');
                rarityEl.textContent = character.rarity;
                const rarityColor = { 'N': 'text-gray-400', 'R': 'text-blue-400', 'SR': 'text-purple-400', 'SSR': 'text-yellow-400' }[character.rarity];
                rarityEl.className = `font-bold text-2xl ${rarityColor}`;
                const factionEl = document.getElementById('detail-card-faction');
                factionEl.textContent = character.faction;
                const factionColors = { 'íƒì •': 'bg-blue-500 text-white', 'ì¡°ìˆ˜': 'bg-green-500 text-white', 'ë²”ì¸': 'bg-red-500 text-white' };
                factionEl.className = `font-bold text-lg px-3 py-1 rounded-full ${factionColors[character.faction]}`;

                // --- 2. í‡´ê³ ëœ ëŠ¥ë ¥ì¹˜ í‘œì‹œ ---
                document.getElementById('detail-stat-hp').textContent = currentStats.hp;
                document.getElementById('detail-stat-atk').textContent = currentStats.atk;
                document.getElementById('detail-stat-def').textContent = currentStats.def;

                // --- 3. ìŠ¤í‚¬ ë° ìŠ¤í† ë¦¬ í‘œì‹œ ---
                const skillsContainer = document.getElementById('detail-skills-container');
                skillsContainer.innerHTML = '';
                
                character.skills.forEach((skill, index) => {
                    const isUltimate = character.rarity === 'SSR' && index === 1;
                    const skillEl = document.createElement('div');
                    skillEl.className = 'bg-black/20 p-3 rounded-lg';
                    
                    // [ìˆ˜ì •] êµ¬ê¸€ ì‹œíŠ¸ì— ì ì€ ì„¤ëª…(desc)ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ìë™ ìƒì„± í•¨ìˆ˜(getSkillDescription) ì‚¬ìš©
                    const description = skill.desc ? skill.desc : getSkillDescription(skill);

                    skillEl.innerHTML = `
                        <h4 class="font-bold ${isUltimate ? 'text-yellow-300' : 'text-white'}">
                            ${isUltimate ? 'ê¶ê·¹ê¸°' : 'ì¼ë°˜ ìŠ¤í‚¬'}: ${skill.name}
                        </h4>
                        <p class="text-gray-300 italic">"${skill.dialogue}"</p>
                        <p class="text-sm mt-1 text-green-300">${description}</p>
                    `;
                    skillsContainer.appendChild(skillEl);
                });
                currentStoryPages = character.story.split('[PAGE_BREAK]');
                currentStoryPageIndex = 0;
                displayCardStoryPage();

                // --- 4. í‡´ê³  UI ì—…ë°ì´íŠ¸ ë¡œì§ ---
                const levelDisplay = document.getElementById('detail-card-level');
                const previewDisplay = document.getElementById('enhancement-preview');
                const costDisplay = document.getElementById('enhancement-cost');
                const enhanceButton = document.getElementById('enhance-card-button');
                
                levelDisplay.textContent = `+${cardInstance.level}`;
                
                if (cardInstance.level >= MAX_ENHANCEMENT_LEVEL) {
                    previewDisplay.textContent = 'ìµœëŒ€ ë ˆë²¨ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.';
                    enhanceButton.disabled = true;
                    costDisplay.textContent = 'í‡´ê³  ë¶ˆê°€';
                } else {
                    const nextLevelStats = getEnhancedStats({ ...cardInstance, level: cardInstance.level + 1 });
                    
                    // âœ¨ [ìˆ˜ì •] í™•ë¥  ì •ë³´ ê°€ì ¸ì˜¤ê¸° ë° í‘œì‹œ
                    const prob = ENHANCEMENT_PROBABILITIES[cardInstance.level];
                    const probPercent = Math.floor(prob * 100);
                    
                    // í™•ë¥ ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½ (ë†’ìœ¼ë©´ ì´ˆë¡, ë‚®ìœ¼ë©´ ë¹¨ê°•)
                    const probColor = prob >= 0.8 ? 'text-green-400' : (prob >= 0.5 ? 'text-yellow-400' : 'text-red-400');

                    previewDisplay.innerHTML = `
                        HP ${currentStats.hp} <span class="text-gray-400">&rarr;</span> ${nextLevelStats.hp}<br>
                        ATK ${currentStats.atk} <span class="text-gray-400">&rarr;</span> ${nextLevelStats.atk}<br>
                        <span class="${probColor} font-bold mt-1 block">ì„±ê³µ í™•ë¥ : ${probPercent}%</span>
                    `;
                    
                    const cost = getEnhancementCost(cardInstance);
                    costDisplay.textContent = `ğŸ–‹ï¸ ${cost}`;
                    enhanceButton.disabled = playerFountainPens < cost;
                }

                // --- 5. âœ¨ 'ê°œì •' UI ì—…ë°ì´íŠ¸ ë¡œì§ (ì‰í¬ë³‘ ê¸°ëŠ¥ ì¶”ê°€ë¨) âœ¨ ---
    const revisionLevelDisplay = document.getElementById('detail-card-revision');
    const revisionPreviewDisplay = document.getElementById('revision-preview');
    const revisionMaterialSelect = document.getElementById('revision-material-select');
    const reviseButton = document.getElementById('revise-card-button');
    
    // [ì‹ ê·œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°]
    const inkwellCostDisplay = document.getElementById('inkwell-cost-display');
    const reviseInkButton = document.getElementById('revise-with-inkwell-button');

    // í˜„ì¬ ìƒíƒœ í‘œì‹œ
    revisionLevelDisplay.innerHTML = 'â­'.repeat(cardInstance.revision) + ` ${cardInstance.revision}ì°¨ ê°œì •`;
    revisionMaterialSelect.innerHTML = '<option value="">ê°œì •ì— ì‚¬ìš©í•  ì›ë³¸ì„ ì„ íƒí•˜ì„¸ìš”</option>';

    // ìµœëŒ€ ë ˆë²¨ ì²´í¬
    if (cardInstance.revision >= MAX_REVISION_LEVEL) {
        revisionPreviewDisplay.textContent = 'ìµœì¢… ê°œì •íŒì…ë‹ˆë‹¤.';
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        reviseButton.disabled = true;
        revisionMaterialSelect.disabled = true;
        reviseInkButton.disabled = true;
        reviseInkButton.textContent = "ìµœëŒ€ ë ˆë²¨";
        inkwellCostDisplay.textContent = "-";
    } else {
        // ë‹¤ìŒ ë‹¨ê³„ ë³´ë„ˆìŠ¤ ë¯¸ë¦¬ë³´ê¸°
        const nextRevisionBonus = (cardInstance.revision + 1) * STAT_INCREASE_PER_REVISION * 100;
        revisionPreviewDisplay.textContent = `ë‹¤ìŒ ê°œì • ì‹œ ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ +${nextRevisionBonus}%`;

        // [ì˜µì…˜ 1: ì¹´ë“œ ì‚¬ìš©] ë¡œì§
        const materialCards = playerInventory.filter(c => c.name === cardInstance.name && c.id !== cardInstance.id);
        if (materialCards.length > 0) {
            materialCards.forEach(mat => {
                const option = document.createElement('option');
                option.value = mat.id;
                option.textContent = `Lv.${mat.level} ${mat.name}`;
                revisionMaterialSelect.appendChild(option);
            });
            reviseButton.disabled = false;
            revisionMaterialSelect.disabled = false;
        } else {
            const option = document.createElement('option');
            option.textContent = 'ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì›ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.';
            option.disabled = true;
            revisionMaterialSelect.appendChild(option);
            reviseButton.disabled = true;
            revisionMaterialSelect.disabled = true;
        }

        // [ì˜µì…˜ 2: ì‰í¬ë³‘ ì‚¬ìš©] ë¡œì§ âœ¨
        const inkCost = INKWELL_REVISION_COSTS[character.rarity] || 999;
        const canAffordInk = playerInkwells >= inkCost;
        
        inkwellCostDisplay.innerHTML = `<span class="${canAffordInk ? 'text-green-400' : 'text-red-400'} font-bold">${playerInkwells}</span> / ${inkCost}`;
        
        reviseInkButton.disabled = !canAffordInk;
        reviseInkButton.textContent = canAffordInk ? "ì‚¬ìš©í•˜ê¸°" : "ë¶€ì¡±í•¨";
        
        // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²° (ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ onclick ì†ì„± ë®ì–´ì“°ê¸°)
        reviseInkButton.onclick = reviseCardWithInkwell;
    }
				// yumecan.html - showCardDetails í•¨ìˆ˜ ë‚´ë¶€ì˜ ë§¨ ëë¶€ë¶„

                // ... (ê¸°ì¡´ ê°œì •íŒ ì œì‘ UI ë¡œì§ ë) ...

                // â–¼â–¼â–¼ [ì‹ ê·œ] ì¶œíŒ(ë“±ê¸‰ì—…) ë¡œì§ ì¶”ê°€ â–¼â–¼â–¼
                const pubContainer = document.getElementById('publication-container');
                const pubButton = document.getElementById('publish-card-button');
                const pubTargetText = document.getElementById('publication-target-name');
                
                // 1. ë“±ê¸‰ ìˆœì„œ ì •ì˜
                const rarityOrder = ['N', 'R', 'SR', 'SSR'];
                const currentRarityIndex = rarityOrder.indexOf(character.rarity);

                // 2. ì¶œíŒ ì¡°ê±´ í™•ì¸
                // (MAX_ENHANCEMENT_LEVEL ë“±ì´ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•¨)
                const isMaxLevel = cardInstance.level >= (typeof MAX_ENHANCEMENT_LEVEL !== 'undefined' ? MAX_ENHANCEMENT_LEVEL : 9);
                const isMaxRevision = cardInstance.revision >= (typeof MAX_REVISION_LEVEL !== 'undefined' ? MAX_REVISION_LEVEL : 5);
                const hasNextRarity = currentRarityIndex !== -1 && currentRarityIndex < rarityOrder.length - 1;

                // yumecan.html ì˜ showCardDetails í•¨ìˆ˜ ë‚´ë¶€

// ... (ì´ì „ ì½”ë“œ: isMaxLevel, isMaxRevision ë“± í™•ì¸í•˜ëŠ” ê³³)

let nextRarityChar = null;

if (isMaxLevel && isMaxRevision && hasNextRarity) {
    const nextRarity = rarityOrder[currentRarityIndex + 1];

    // âœ¨ [ìˆ˜ì •] 1ìˆœìœ„: ì—‘ì…€ì— ì •í•´ë‘” 'publish_target'ì´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ê·¸ê±¸ë¡œ ì§„í™”!
    if (character.publishTarget) {
        nextRarityChar = characters.find(c => c.name === character.publishTarget);
    }
    
    // 2ìˆœìœ„: ë§Œì•½ ì •í•´ë‘” ê²Œ ì—†ìœ¼ë©´, ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ (ê°™ì€ ì´ë¦„ + ë‹¤ìŒ ë“±ê¸‰) ì°¾ê¸°
    if (!nextRarityChar) {
        nextRarityChar = characters.find(c => 
            c.baseName === character.baseName && c.rarity === nextRarity
        );
    }
}

// ... (ì´í›„ ì½”ë“œ: UI í‘œì‹œ ë¡œì§ ë“± ê·¸ëŒ€ë¡œ ìœ ì§€)

                // 3. UI í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
                if (nextRarityChar) {
                    // ì¡°ê±´ ë§Œì¡± & ìƒìœ„ ë“±ê¸‰ ìºë¦­í„° ë°ì´í„° ì¡´ì¬í•¨ -> ë²„íŠ¼ ë³´ì´ê¸°
                    if (pubContainer) pubContainer.classList.remove('hidden');
                    
                    // í‡´ê³ /ê°œì • UIëŠ” ìˆ¨ê¹€
                    const enhanceContainer = document.getElementById('enhancement-container');
                    const revContainer = document.getElementById('revision-container');
                    if (enhanceContainer) enhanceContainer.classList.add('hidden');
                    if (revContainer) revContainer.classList.add('hidden');

                    if (pubTargetText) pubTargetText.textContent = `ëŒ€ìƒ: [${nextRarityChar.rarity}] ${nextRarityChar.name}`;
                    
                    // â–¼â–¼â–¼ [í•µì‹¬] ê´„í˜¸ê°€ ë¹ ì§€ê¸° ì‰¬ìš´ ë¶€ë¶„ì…ë‹ˆë‹¤. ì •í™•íˆ ë³µì‚¬í•˜ì„¸ìš”! â–¼â–¼â–¼
                    if (pubButton) {
                        pubButton.onclick = () => publishCard(currentDetailCardId, nextRarityChar);
                    }
                } else {
                    // ì¡°ê±´ ë¶ˆë§Œì¡± -> ìˆ¨ê¸°ê¸°
                    if (pubContainer) pubContainer.classList.add('hidden');
                }

                // ëª¨ë‹¬ ë„ìš°ê¸° (ì—¬ê¸°ë„ ê´„í˜¸ í™•ì¸!)
                cardDetailModal.classList.remove('hidden');
            }

                

			// âœ… showCardDetails í•¨ìˆ˜ ë°”ë¡œ ë‹¤ìŒì— ì´ ìƒˆë¡œìš´ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.

function publishCard(cardId, targetCharacterData) {
    // â–¼â–¼â–¼ [ì£¼ì˜] ì—¬ê¸° ë”°ì˜´í‘œëŠ” ìˆ«ì 1 ì˜†ì— ìˆëŠ” `(ë°±í‹±) ì´ì–´ì•¼ í•©ë‹ˆë‹¤! â–¼â–¼â–¼
    const confirmMsg = `ì¶•í•˜í•©ë‹ˆë‹¤! ì´ ì›ê³ ë¥¼ [${targetCharacterData.name}]ìœ¼ë¡œ ì •ì‹ ì¶œíŒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì£¼ì˜: ë ˆë²¨ê³¼ ê°œì • ìˆ˜ì¹˜ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.)`;
    
    if (!confirm(confirmMsg)) {
        return;
    }

    // 1. ì¸ë²¤í† ë¦¬ì—ì„œ ë‚´ ì¹´ë“œ ì°¾ê¸°
    const myCard = playerInventory.find(c => c.id === cardId);
    if (!myCard) return;

    // 2. ë°ì´í„° ë³€í™˜
    const oldName = myCard.name;
    
    myCard.name = targetCharacterData.name; // ì´ë¦„ ë³€ê²½ (ë“±ê¸‰/ì´ë¯¸ì§€ ë³€ê²½ë¨)
    myCard.level = 0;      // +0 ì´ˆê¸°í™”
    myCard.revision = 0;   // 0ì„± ì´ˆê¸°í™”
    
    // 3. ìˆ˜ì§‘ ë„ê°ì— ë“±ë¡
    collectedCardNames.add(targetCharacterData.name);

    // 4. ì €ì¥ ë° UI ê°±ì‹ 
    saveGame();
    updateUI();
    
    // â–¼â–¼â–¼ [ì£¼ì˜] ì—¬ê¸°ë„ `(ë°±í‹±) ì…ë‹ˆë‹¤! â–¼â–¼â–¼
    alert(`[${oldName}] ì›ê³ ê°€ [${targetCharacterData.name}]ìœ¼ë¡œ í›Œë¥­í•˜ê²Œ ì¶œíŒë˜ì—ˆìŠµë‹ˆë‹¤!`);
    
    showCardDetails(cardId); // ìƒì„¸ì°½ ìƒˆë¡œê³ ì¹¨
    
    // ì¸ë²¤í† ë¦¬ í™”ë©´ì´ë©´ ê°±ì‹ 
    const inventoryView = document.getElementById('inventory-view');
    if (inventoryView && !inventoryView.classList.contains('hidden')) {
        displayInventory();
    }
}
		
function showCollectionCardDetails(cardBaseName) {
    const character = findCharacter(cardBaseName);
    if (!character) {
        console.error("ë„ê° ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", cardBaseName);
        return;
    }

    currentDetailCardId = null; // ë„ê°ì—ì„œëŠ” ì¸ìŠ¤í„´ìŠ¤ IDê°€ ì—†ìŒ

    // --- 1. ê¸°ë³¸ ì •ë³´ í‘œì‹œ (showCardDetailsì™€ ê±°ì˜ ë™ì¼) ---
    document.getElementById('detail-card-image').src = character.imageUrl;
    document.getElementById('detail-card-name').textContent = character.name;
    const rarityEl = document.getElementById('detail-card-rarity');
    rarityEl.textContent = character.rarity;
    const rarityColor = { 'N': 'text-gray-400', 'R': 'text-blue-400', 'SR': 'text-purple-400', 'SSR': 'text-yellow-400' }[character.rarity];
    rarityEl.className = `font-bold text-2xl ${rarityColor}`;
    const factionEl = document.getElementById('detail-card-faction');
    factionEl.textContent = character.faction;
    const factionColors = { 'íƒì •': 'bg-blue-500 text-white', 'ì¡°ìˆ˜': 'bg-green-500 text-white', 'ë²”ì¸': 'bg-red-500 text-white' };
    factionEl.className = `font-bold text-lg px-3 py-1 rounded-full ${factionColors[character.faction]}`;

    // --- 2. âœ¨ ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ í‘œì‹œ (í‡´ê³ /ê°œì • ì—†ëŠ” ê¸°ë³¸ ìŠ¤íƒ¯) âœ¨ ---
    document.getElementById('detail-stat-hp').textContent = character.stats.hp;
    document.getElementById('detail-stat-atk').textContent = character.stats.atk;
    document.getElementById('detail-stat-def').textContent = character.stats.def;

    // --- 3. ìŠ¤í‚¬ ë° ìŠ¤í† ë¦¬ í‘œì‹œ (showCardDetailsì™€ ë™ì¼) ---
    const skillsContainer = document.getElementById('detail-skills-container');
    skillsContainer.innerHTML = '';
    character.skills.forEach((skill, index) => {
        const isUltimate = character.rarity === 'SSR' && index === 1;
        const skillEl = document.createElement('div');
        skillEl.className = 'bg-black/20 p-3 rounded-lg';
        skillEl.innerHTML = `<h4 class="font-bold ${isUltimate ? 'text-yellow-300' : 'text-white'}">${isUltimate ? 'ê¶ê·¹ê¸°' : 'ì¼ë°˜ ìŠ¤í‚¬'}: ${skill.name}</h4><p class="text-gray-300 italic">"${skill.dialogue}"</p><p class="text-sm mt-1">${getSkillDescription(skill)}</p>`;
        skillsContainer.appendChild(skillEl);
    });
    currentStoryPages = character.story.split('[PAGE_BREAK]');
    currentStoryPageIndex = 0;
    displayCardStoryPage();

    // --- 4. âœ¨ í‡´ê³ , ê°œì •, íŒŒì‡„ UI ìˆ¨ê¸°ê¸° âœ¨ ---
    document.getElementById('enhancement-container').classList.add('hidden');
    document.getElementById('revision-container').classList.add('hidden');
    document.getElementById('dismantle-container').classList.add('hidden');

    // ëª¨ë‹¬ í‘œì‹œ
    cardDetailModal.classList.remove('hidden');
}
			

			function enterMultiSelectMode() {
    isMultiSelectMode = true;
    selectedCardsToDismantle.clear();
    dismantleMultiUI.classList.remove('hidden');
    enterMultiModeButton.classList.add('hidden');
    displayInventory();
}

function exitMultiSelectMode() {
    isMultiSelectMode = false;
    selectedCardsToDismantle.clear();
    dismantleMultiUI.classList.add('hidden');
    enterMultiModeButton.classList.remove('hidden');
    displayInventory();
    // ëª¨ë“œ ì¢…ë£Œ ì‹œ ì¸ë²¤í† ë¦¬ ë·°ê°€ ì—´ë ¤ìˆë‹¤ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì¹´ë“œ ìƒì„¸ ëª¨ë‹¬ì´ ëœ¨ë„ë¡ í•©ë‹ˆë‹¤.
    if (!document.getElementById('inventory-view').classList.contains('hidden')) {
        switchTab('inventory');
    }
}

function updateMultiSelectUI() {
    const count = selectedCardsToDismantle.size;
    selectedCardCountSpan.textContent = `${count}ì¥`;
    dismantleSelectedButton.disabled = count === 0;
    dismantleSelectedButton.classList.toggle('bg-red-700', count > 0);
}
			
			function dismantleCard(cardId) {
    if (!confirm('ì´ ì¹´ë“œë¥¼ íŒŒì‡„í•˜ê³  ì¬ë£Œë¥¼ íšŒìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì¹´ë“œëŠ” ì˜êµ¬íˆ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
        return;
    }

    const indexToRemove = playerInventory.findIndex(c => c.id === cardId);
    if (indexToRemove === -1) {
        alert('ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const cardInstance = playerInventory[indexToRemove];
    const character = findCharacter(cardInstance.name);
    const rarity = character.rarity;
    const rewards = DISMANTLE_REWARDS[rarity];

    // ë±ì— í¬í•¨ëœ ì¹´ë“œëŠ” ì‚­ì œ ë¶ˆê°€ëŠ¥
    if (playerDeck.some(deckCard => deckCard.id === cardId)) {
        alert('í¸ì°¬ì— í¬í•¨ëœ ì¹´ë“œëŠ” íŒŒì‡„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë±ì—ì„œ ë¨¼ì € ì œê±°í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì¸ë²¤í† ë¦¬ì—ì„œ ì¹´ë“œ ì œê±°
    playerInventory.splice(indexToRemove, 1);

    // ë³´ìƒ ì§€ê¸‰
    let message = `[${cardInstance.name}] íŒŒì‡„ ì™„ë£Œ.`;
    if (rewards.fountainPens > 0) {
        playerFountainPens += rewards.fountainPens;
        message += ` ğŸ–‹ï¸${rewards.fountainPens} íšë“.`;
    }
    if (rewards.inkwells > 0) {
        playerInkwells += rewards.inkwells;
        message += ` ğŸ’§ì‰í¬ë³‘ ${rewards.inkwells} íšë“.`;
    }

    hideCardDetails();
    updateUI();
    displayInventory();
    saveGame();
    showMessage(message, 'text-yellow-300', messageArea);
}
            
            function displayCardStoryPage() {
                const storyContent = document.getElementById('detail-card-story');
                const pageIndicator = document.getElementById('detail-story-page-indicator');
                
                storyContent.textContent = currentStoryPages[currentStoryPageIndex];
                pageIndicator.textContent = `${currentStoryPageIndex + 1} / ${currentStoryPages.length}`;
                
                detailStoryPrevButton.disabled = currentStoryPageIndex === 0;
                detailStoryNextButton.disabled = currentStoryPageIndex === currentStoryPages.length - 1;
            }

            function hideCardDetails() {
                cardDetailModal.classList.add('hidden');
                // ğŸ‘‡ ìˆ¨ê²¨ì¡Œë˜ UI ìš”ì†Œë“¤ì„ ë‹¤ì‹œ ë³´ì´ë„ë¡ ë³µì›
                document.getElementById('enhancement-container').classList.remove('hidden');
                document.getElementById('revision-container').classList.remove('hidden');
                document.getElementById('dismantle-container').classList.remove('hidden');
            }
            
            function findCharacter(name) {
                return characters.find(c => c.name === name);
            }

            function displayStoryView() {
    // íƒ­ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™” (ë©”ì¸ íƒ­ì´ ê¸°ë³¸)
    const activeTab = document.querySelector('#story-view .sub-tab-button.active');
    
    if (activeTab && activeTab.id === 'story-sub-tab-stage') {
        displayStageStories();
    } else {
        displayMainStories();
    }
}

// ìƒˆë¡œìš´ í•¨ìˆ˜: ë©”ì¸ ìŠ¤í† ë¦¬ ëª©ë¡ì„ í‘œì‹œ
function displayMainStories() {
    mainStoryContainer.classList.remove('hidden');
    stageStoryContainer.classList.add('hidden');
    mainStoryContainer.innerHTML = '';
    
    mainStories.forEach((story, index) => {
        const isUnlocked = story.dungeonToUnlock === null || clearedStages.includes(story.dungeonToUnlock);
        const storyEl = document.createElement('div');
        storyEl.className = `p-4 rounded-lg transition-colors duration-300 ${isUnlocked ? 'bg-white/20 hover:bg-white/30 cursor-pointer' : 'bg-black/30 text-gray-500'}`;
        
        if (isUnlocked) {
            storyEl.dataset.storyIndex = index;
            storyEl.dataset.storyType = 'main';
        }

        let unlockText = 'í´ë¦­í•˜ì—¬ ìŠ¤í† ë¦¬ ì½ê¸°';
        if (!isUnlocked) {
            const [chap, stg] = story.dungeonToUnlock.split('-');
            unlockText = `ì±•í„° ${chap}-${stg} í´ë¦¬ì–´ ì‹œ í•´ê¸ˆ`;
        }

        storyEl.innerHTML = `
            <h3 class="text-xl font-bold ${isUnlocked ? 'text-yellow-300' : ''}">[ë©”ì¸] ${story.title}</h3>
            <p class="text-sm">${unlockText}</p>
        `;
        mainStoryContainer.appendChild(storyEl);
    });
}

// ìƒˆë¡œìš´ í•¨ìˆ˜: ìŠ¤í…Œì´ì§€ ìŠ¤í† ë¦¬ ëª©ë¡ì„ í‘œì‹œ
function displayStageStories() {
    mainStoryContainer.classList.add('hidden');
    stageStoryContainer.classList.remove('hidden');
    stageStoryContainer.innerHTML = '';

    // ìŠ¤í…Œì´ì§€ ìŠ¤í† ë¦¬ë¥¼ ìŠ¤í…Œì´ì§€ ID(1-1, 1-2 ë“±) ìˆœì„œëŒ€ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
    const sortedStageStories = [...clearedStageStories].sort((a, b) => {
        const [chapA, stgA] = a.split('-').map(Number);
        const [chapB, stgB] = b.split('-').map(Number);
        return (chapA - chapB) || (stgA - stgB);
    });

    if (sortedStageStories.length === 0) {
        stageStoryContainer.innerHTML = `<p class="text-center text-gray-400 mt-10">ì—´ëŒí•œ ìŠ¤í…Œì´ì§€ ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë…ì„œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.</p>`;
        return;
    }

    sortedStageStories.forEach(stageId => {
        const [chapIdx, stgIdx] = stageId.split('-').map(s => parseInt(s) - 1);
        const stage = mainChapters[chapIdx]?.stages[stgIdx];

        if (stage && stage.stageStory) {
            const storyEl = document.createElement('div');
            storyEl.className = 'p-4 rounded-lg bg-white/10 hover:bg-white/20 cursor-pointer transition-colors duration-300';
            storyEl.dataset.stageId = stageId;
            storyEl.dataset.storyType = 'stage';

            storyEl.innerHTML = `
                <h3 class="text-lg font-bold text-cyan-300">[ìŠ¤í…Œì´ì§€] ${stage.stageName}</h3>
                <p class="text-sm">í´ë¦­í•˜ì—¬ ë‹¤ì‹œ ì½ê¸°</p>
            `;
            stageStoryContainer.appendChild(storyEl);
        }
    });
}

			function getEnhancementCost(cardInstance) {
    const character = findCharacter(cardInstance.name);
    if (!character || cardInstance.level >= MAX_ENHANCEMENT_LEVEL) return null;

    const baseCost = ENHANCEMENT_BASE_COSTS[cardInstance.level];
    const multiplier = RARITY_COST_MULTIPLIER[character.rarity] || 1.0;
    
    // ìµœì¢… ë¹„ìš©ì€ ì†Œìˆ˜ì  ì˜¬ë¦¼ ë˜ëŠ” ë°˜ì˜¬ë¦¼ ì²˜ë¦¬í•˜ì—¬ ì •ìˆ˜ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
    return Math.ceil(baseCost * multiplier);
}
			
			// --- ëŒ€í™”í˜• ìŠ¤í† ë¦¬ ê´€ë ¨ í•¨ìˆ˜ (ìƒˆ ë²„ì „) ---
            // gacha3.html - startInteractiveStory í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ì „ì²´ êµì²´)

function startInteractiveStory(storyOrIndex, type) {
    let storyData;

    if (typeof storyOrIndex === 'number' && type === 'main') {
        storyData = mainStories[storyOrIndex];
    } else if (typeof storyOrIndex === 'number' && type === 'event') {
        storyData = eventStories[storyOrIndex];
    } else if (typeof storyOrIndex === 'number' && type === 'event_part2') { // ğŸ‘ˆ ì´ ë¸”ë¡ì„ ì¶”ê°€
        storyData = eventStoryPart2.secondHalf[storyOrIndex];
    } else if (typeof storyOrIndex === 'object') {
        // ìŠ¤í…Œì´ì§€ ìŠ¤í† ë¦¬ ê°ì²´ë¥¼ ì§ì ‘ ë°›ìŠµë‹ˆë‹¤.
        storyData = storyOrIndex;
    } else {
        return;
    }

    currentInteractiveStory = storyData;
    // ìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ê±°ë‚˜, ë‚´ìš©(content)ì´ ë°°ì—´ì´ ì•„ë‹ˆë©´ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
    if (!currentInteractiveStory || !Array.isArray(currentInteractiveStory.content)) {
        alert("ìŠ¤í† ë¦¬ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); // ë°ì´í„° ë¬¸ì œ ë°œìƒ ì‹œ ì•Œë¦¼ ì¶”ê°€
        return;
    }

    currentSceneIndex = 0;
    interactiveStoryModal.classList.remove('hidden');
    renderCurrentScene();
}
            function renderCurrentScene() {
    const scene = currentInteractiveStory.content[currentSceneIndex];
    if (!scene) {
        closeInteractiveStory();
        return;
    }

    const choiceContainer = document.getElementById('choice-buttons-container');
    choiceContainer.innerHTML = ''; // ì„ íƒì§€ ì´ˆê¸°í™”

    // ëŒ€í™” ë‚´ìš© ë° í™”ì ì´ë¦„ ì—…ë°ì´íŠ¸
    speakerName.textContent = scene.character || ' ';
    dialogueText.textContent = scene.dialogue;

    // âœ¨ ì„ íƒì§€ ì²˜ë¦¬ ë¡œì§ âœ¨
    if (scene.choices && scene.choices.length > 0) {
        storyNextButton.classList.add('hidden'); // 'ë‹¤ìŒ' ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        scene.choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'gacha-button bg-white/10 hover:bg-white/20 text-white font-bold py-3 px-5 rounded-lg w-full max-w-xs';
            button.textContent = choice.text;
            // ë²„íŠ¼ì— ë°ì´í„° ì†ì„±ìœ¼ë¡œ ì •ë³´ ì €ì¥
            if (choice.nextScene !== undefined) {
                button.dataset.nextScene = choice.nextScene;
            }
            if (choice.isFinalChoice) {
                button.dataset.isFinalChoice = 'true';
                button.dataset.statId = choice.statId;
            }
            choiceContainer.appendChild(button);
        });
    } else {
        storyNextButton.classList.remove('hidden'); // 'ë‹¤ìŒ' ë²„íŠ¼ ë³´ì´ê¸°
    }

    // ìºë¦­í„° ì´ë¯¸ì§€ ì²˜ë¦¬ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    if (scene.character) {
        const portraitUrl = characterPortraits[scene.character]?.[scene.expression] || '';
        if (scene.position === 'left') {
            storyCharLeft.src = portraitUrl;
            storyCharLeft.classList.remove('opacity-0');
            storyCharLeft.classList.add('opacity-100');
            storyCharRight.classList.remove('opacity-100');
            storyCharRight.classList.add('opacity-0');
        } else if (scene.position === 'right') {
            storyCharRight.src = portraitUrl;
            storyCharRight.classList.remove('opacity-0');
            storyCharRight.classList.add('opacity-100');
            storyCharLeft.classList.remove('opacity-100');
            storyCharLeft.classList.add('opacity-0');
        }
    } else {
        storyCharLeft.classList.add('opacity-0');
        storyCharRight.classList.add('opacity-0');
    }
}

function advanceStory() {
    // 1. í˜„ì¬ ì¥ë©´ ë°ì´í„°ë¥¼ ë¨¼ì € ê°€ì ¸ì˜µë‹ˆë‹¤.
    const currentScene = currentInteractiveStory.content[currentSceneIndex]; 

    // 2. 'jumpTo' ì†ì„±ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    if (currentScene && currentScene.jumpTo !== undefined) {
        // 'jumpTo'ê°€ ìˆìœ¼ë©´: ì¸ë±ìŠ¤ë¥¼ ì§€ì •ëœ ë²ˆí˜¸ë¡œ ì í”„
        currentSceneIndex = currentScene.jumpTo;
    } else {
        // 'jumpTo'ê°€ ì—†ìœ¼ë©´: í‰ì†Œì²˜ëŸ¼ ì¸ë±ìŠ¤ë¥¼ 1 ì¦ê°€
        currentSceneIndex++;
    }

    // 3. ì¦ê°€/ì í”„ëœ ì¸ë±ìŠ¤ê°€ ìŠ¤í† ë¦¬ì˜ ëì„ ë„˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    if (currentSceneIndex < currentInteractiveStory.content.length) {
        // 4. ìŠ¤í† ë¦¬ê°€ ëë‚˜ì§€ ì•Šì•˜ìœ¼ë©´: ë‹¤ìŒ ì¥ë©´ì„ ë Œë”ë§
        renderCurrentScene();
    } else {
        // 5. ìŠ¤í† ë¦¬ê°€ ëë‚¬ìœ¼ë©´:
        // (ê°€ì¥ ì¤‘ìš”!) ìŠ¤í† ë¦¬ë¥¼ ë‹«ê¸° *ì „ì—* ì½œë°±(ì „íˆ¬ ì‹œì‘ ëª…ë ¹)ì„ ì½ì–´ì˜µë‹ˆë‹¤.
        const callback = interactiveStoryModal.dataset.callback; 
        
        closeInteractiveStory(); // ìŠ¤í† ë¦¬ë¥¼ ë‹«ìŠµë‹ˆë‹¤. (ì´ë•Œ currentInteractiveStoryê°€ nullì´ ë©ë‹ˆë‹¤)
        
        // ì½ì–´ë‘” ì½œë°±ì´ ìˆìœ¼ë©´ ì‹¤í–‰í•©ë‹ˆë‹¤.
        if (callback) {
            eval(callback);
            interactiveStoryModal.dataset.callback = ''; // ì½œë°± ë¹„ìš°ê¸°
        }
    }
}

// gacha3.html - dismantleMultipleCards í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ì „ì²´ êµì²´)

function dismantleMultipleCards() {
    if (selectedCardsToDismantle.size === 0) {
        showMessage('íŒŒì‡„í•  ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'text-yellow-400', messageArea);
        return;
    }

    if (!confirm(`ì„ íƒëœ ${selectedCardsToDismantle.size}ì¥ì˜ ì¹´ë“œë¥¼ íŒŒì‡„í•˜ê³  ì¬ë£Œë¥¼ íšŒìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)`)) {
        return;
    }

    let totalFountainPens = 0;
    let totalInkwells = 0;
    let cardsToRemove = []; 
    let cardsInDeck = []; 
    
    // 1. íŒŒì‡„í•  ì¹´ë“œì™€ ë³´ìƒ ê³„ì‚° (ë¡œì§ ìœ ì§€)
    selectedCardsToDismantle.forEach(cardId => {
        const cardInstance = playerInventory.find(c => c.id === cardId);
        if (!cardInstance) return;

        if (playerDeck.some(deckCard => deckCard.id === cardId)) {
            cardsInDeck.push(cardInstance.name);
        } else {
            const character = findCharacter(cardInstance.name);
            const rewards = DISMANTLE_REWARDS[character.rarity];
            totalFountainPens += rewards.fountainPens;
            totalInkwells += rewards.inkwells;
            cardsToRemove.push(cardId);
        }
    });

    if (cardsToRemove.length === 0 && cardsInDeck.length > 0) {
        showMessage('ì„ íƒëœ ì¹´ë“œê°€ ëª¨ë‘ ë±ì— í¬í•¨ë˜ì–´ íŒŒì‡„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text-red-400', messageArea);
        return;
    }

    // 2. íŒŒì‡„ ì‹¤í–‰ ë° ë³´ìƒ ì§€ê¸‰
    playerInventory = playerInventory.filter(card => !cardsToRemove.includes(card.id));
    playerFountainPens += totalFountainPens;
    playerInkwells += totalInkwells;

    // 3. âœ¨í•µì‹¬ ìˆ˜ì •âœ¨: íŒŒì‡„ ì„±ê³µ ì‹œ ì„ íƒ ëª©ë¡ì„ ì¦‰ì‹œ ì´ˆê¸°í™”
    selectedCardsToDismantle.clear(); // âœ… ì„ íƒëœ ì¹´ë“œ ëª©ë¡ì„ ë¹„ì›ë‹ˆë‹¤.
    
    hideCardDetails();
    updateUI();
    saveGame();
    
    // 4. ê²°ê³¼ ëª¨ë‹¬ì— ë³´ìƒ í‘œì‹œ (ë°ì´í„° ì±„ìš°ê¸°)
    dismantleRewardsList.innerHTML = '';
    
    if (totalFountainPens > 0) {
        dismantleRewardsList.innerHTML += `<div class="text-xl text-gray-300 font-bold">ğŸ–‹ï¸ ë§Œë…„í•„: +${totalFountainPens}</div>`;
    }
    if (totalInkwells > 0) {
        dismantleRewardsList.innerHTML += `<div class="text-xl text-fuchsia-400 font-bold">ğŸ’§ ì‰í¬ë³‘: +${totalInkwells}</div>`;
    }
    
    if (cardsInDeck.length > 0) {
         dismantleRewardsList.innerHTML += `<div class="text-xs text-red-400 mt-2">(${cardsInDeck.length}ì¥ì€ ë±ì— í¬í•¨ë˜ì–´ íŒŒì‡„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.)</div>`;
    }

    // 5. ëª¨ë‹¬ì— ìµœì¢… ë©”ì‹œì§€ ìƒíƒœ ì €ì¥
    if (cardsToRemove.length > 0) {
        dismantleResultModal.dataset.finalMessage = `ì´ ${cardsToRemove.length}ì¥ì˜ ì›ê³ ë¥¼ íŒŒì‡„í–ˆìŠµë‹ˆë‹¤.`;
        dismantleResultModal.dataset.messageColor = 'text-yellow-300';
    } else {
        dismantleResultModal.dataset.finalMessage = '';
    }
    
    // ëª¨ë‹¬ í‘œì‹œ (ì¦‰ì‹œ ë„ì›ë‹ˆë‹¤.)
    dismantleResultModal.classList.remove('hidden');
}
			

			
			// [ìˆ˜ì •ëœ enhanceCard í•¨ìˆ˜]
function enhanceCard() {
    if (!currentDetailCardId) return;
    const cardInstance = playerInventory.find(c => c.id === currentDetailCardId);
    if (!cardInstance || cardInstance.level >= MAX_ENHANCEMENT_LEVEL) return;

    const cost = getEnhancementCost(cardInstance);
    if (cost === null) return;

    if (playerFountainPens >= cost) {
        // 1. ë¹„ìš© ì†Œëª¨ (ì„±ê³µí•˜ë“  ì‹¤íŒ¨í•˜ë“  ì†Œëª¨ë¨)
        playerFountainPens -= cost;

        // 2. ì„±ê³µ í™•ë¥  ê°€ì ¸ì˜¤ê¸°
        const successRate = ENHANCEMENT_PROBABILITIES[cardInstance.level];
        
        // 3. ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° (0.0 ~ 1.0 ì‚¬ì´ ëœë¤ê°’)
        const isSuccess = Math.random() < successRate;

        if (isSuccess) {
            // âœ¨ ì„±ê³µ!
            cardInstance.level++;
            alert(`í‡´ê³  ì„±ê³µ! (+${cardInstance.level}) ì›ê³ ê°€ ë” ì™„ë²½í•´ì¡ŒìŠµë‹ˆë‹¤.`);
            checkAchievements(); // ì—…ì  ì²´í¬
        } else {
            // ğŸ’¥ ì‹¤íŒ¨... (ë ˆë²¨ ìœ ì§€, ë¹„ìš©ë§Œ ì†Œëª¨)
            alert("í‡´ê³  ì‹¤íŒ¨... ì‰í¬ë§Œ ë‚­ë¹„í–ˆìŠµë‹ˆë‹¤. ë¬¸ì¥ì´ ë§ˆìŒì— ë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        // 4. ì €ì¥ ë° UI ê°±ì‹ 
        updateUI();
        saveGame();
        showCardDetails(currentDetailCardId); // ë°”ë€ ì •ë³´(ë˜ëŠ” ê·¸ëŒ€ë¡œì¸ ì •ë³´) ë‹¤ì‹œ í‘œì‹œ
        
        // ì¸ë²¤í† ë¦¬ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ê°±ì‹ 
        if (!document.getElementById('inventory-view').classList.contains('hidden')) {
            displayInventory();
        }

    } else {
        alert('ë§Œë…„í•„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    }
}
			
            function closeInteractiveStory() {
    interactiveStoryModal.classList.add('hidden');
    storyCharLeft.src = ''; // ì´ë¯¸ì§€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    storyCharRight.src = '';
    currentInteractiveStory = null;
    // ì¼ë°˜ì ì¸ ìŠ¤í† ë¦¬ ë·°ì—ì„œ ë‹«ëŠ” ê²½ìš° ì½œë°±ì€ ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
   
}

// âœ¨ [ì‹ ê·œ] ì‰í¬ë³‘ì„ ì‚¬ìš©í•˜ì—¬ ê°œì •í•˜ëŠ” í•¨ìˆ˜
function reviseCardWithInkwell() {
    if (!currentDetailCardId) return;

    const cardInstance = playerInventory.find(c => c.id === currentDetailCardId);
    if (!cardInstance) return;

    // 1. ë¹„ìš© ê³„ì‚°
    const character = findCharacter(cardInstance.name);
    const cost = INKWELL_REVISION_COSTS[character.rarity] || 999;

    // 2. ìœ íš¨ì„± ê²€ì‚¬
    if (cardInstance.revision >= MAX_REVISION_LEVEL) {
        alert("ì´ë¯¸ ìµœì¢… ê°œì •íŒì…ë‹ˆë‹¤.");
        return;
    }
    if (playerInkwells < cost) {
        alert(`ì‰í¬ë³‘ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${cost}, ë³´ìœ : ${playerInkwells})`);
        return;
    }

    if (!confirm(`ì‰í¬ë³‘ ${cost}ê°œë¥¼ ì‚¬ìš©í•˜ì—¬ [${cardInstance.name}]ì˜ ê°œì •íŒì„ ì œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    // 3. ìì› ì†Œëª¨ ë° ë ˆë²¨ì—…
    playerInkwells -= cost;
    cardInstance.revision++;

    // 4. ì„±ê³µ ë©”ì‹œì§€ ë° ì €ì¥
    const successDialogue = character.enhancementSuccessDialogue || "íŠ¹ìˆ˜ ì‰í¬ì˜ í˜ìœ¼ë¡œ ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!";
    alert(`[ì‰í¬ë³‘ ì‚¬ìš© ì„±ê³µ]\n${successDialogue}`);

    updateUI();
    saveGame();
    showCardDetails(currentDetailCardId); // UI ê°±ì‹ 

    // ì¸ë²¤í† ë¦¬ì°½ ê°±ì‹ 
    if (!document.getElementById('inventory-view').classList.contains('hidden')) {
        displayInventory();
    }
}
            function reviseCard() {
    if (!currentDetailCardId) return;

    // âœ¨ í™•ì¸ì°½ ë¡œì§ ì¶”ê°€ ì‹œì‘ âœ¨
    if (!confirm('ì„ íƒí•œ ì¹´ë“œë¥¼ ì›ë³¸ìœ¼ë¡œ ì‚¬ìš©í•´ ê°œì •íŒì„ ì œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì›ë³¸ ì¹´ë“œëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
        return; // 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥´ë©´ í•¨ìˆ˜ ì¢…ë£Œ
    }
    // âœ¨ í™•ì¸ì°½ ë¡œì§ ì¶”ê°€ ë âœ¨

    const baseCard = playerInventory.find(c => c.id === currentDetailCardId);
                const materialSelect = document.getElementById('revision-material-select');
                const materialId = materialSelect.value;

                if (!baseCard || !materialId || materialId === "") { // "" ê°’ ì²´í¬ ì¶”ê°€
                    alert('ê°œì •ì— ì‚¬ìš©í•  ì›ë³¸ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (baseCard.revision >= MAX_REVISION_LEVEL) return;

                // ì¬ë£Œ ì¹´ë“œë¥¼ ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±°í•©ë‹ˆë‹¤.
                const materialIndex = playerInventory.findIndex(c => c.id === materialId);
                if (materialIndex > -1) {
                    // ë±ì— í¬í•¨ëœ ì¹´ë“œëŠ” ì¬ë£Œë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ë„ë¡ ë§‰ìŠµë‹ˆë‹¤.
                    const isMaterialInDeck = playerDeck.some(deckCard => deckCard.id === materialId);
                    if(isMaterialInDeck) {
                        alert('í¸ì°¬ì— í¬í•¨ëœ ì¹´ë“œëŠ” ì›ë³¸ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    playerInventory.splice(materialIndex, 1);
                } else {
                    alert('ì˜¤ë¥˜: ì¬ë£Œ ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ê¸°ë³¸ ì¹´ë“œì˜ ê°œì • ë ˆë²¨ì„ ì˜¬ë¦½ë‹ˆë‹¤.
                baseCard.revision++;

                // ì„±ê³µ ë©”ì‹œì§€ ë° UI ê°±ì‹ 
                const successDialogue = findCharacter(baseCard.name).enhancementSuccessDialogue || `${baseCard.name}ì˜ ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì´ ë°œê²¬ë˜ì—ˆë‹¤!`;
                alert(successDialogue);

                updateUI();
                saveGame();
                showCardDetails(currentDetailCardId); // ëª¨ë‹¬ ì •ë³´ ìƒˆë¡œê³ ì¹¨
                // ë§Œì•½ ì¸ë²¤í† ë¦¬ê°€ ì—´ë ¤ìˆì—ˆë‹¤ë©´, ì¸ë²¤í† ë¦¬ë„ ìƒˆë¡œê³ ì¹¨
                if (!document.getElementById('inventory-view').classList.contains('hidden')) {
                    displayInventory();
                }
            }
			
			async function recordAndShowStats(statId, userChoiceText) {
    const choiceRef = db.collection('choices').doc(statId);

    await choiceRef.set({
        [userChoiceText]: firebase.firestore.FieldValue.increment(1)
    }, { merge: true });

    const doc = await choiceRef.get();
    const data = doc.exists ? doc.data() : {};

    let totalVotes = 0;
    const stats = [];
    Object.values(data).forEach(votes => {
        totalVotes += votes;
    });

    // í†µê³„ì— í‘œì‹œí•  ì„ íƒì§€ ëª©ë¡ì„ ì‹¤ì œ ì„ íƒì§€ê°€ ìˆì—ˆë˜ ì”¬ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •
    const allChoices = eventStoryPart2.firstHalf[3].choices.map(c => c.text);

    allChoices.forEach(choiceText => {
        const votes = data[choiceText] || 0;
        const percent = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : "0.0";
        stats.push({ text: choiceText, percent: percent });
    });

    const statsContainer = document.getElementById('stats-container');
    statsContainer.innerHTML = stats.map(stat => `
        <div class="text-left">
            <div class="flex justify-between items-center mb-1">
                <span class="font-bold">${stat.text}</span>
                <span class="text-yellow-300">${stat.percent}%</span>
            </div>
            <div class="w-full bg-gray-600 rounded-full h-4">
                <div class="bg-blue-500 h-4 rounded-full" style="width: ${stat.percent}%"></div>
            </div>
        </div>
    `).join('');

    document.getElementById('choice-stats-modal').classList.remove('hidden');
}

// 1. í”„ë¡œí•„ í™”ë©´ í‘œì‹œ
function displayProfileView() {
    // ë‹‰ë„¤ì„ & ë©”ì‹œì§€ ì„¸íŒ…
    document.getElementById('profile-nickname-edit').value = currentPlayerNickname;
    document.getElementById('profile-message-edit').value = playerProfile.statusMessage || "";
    document.getElementById('profile-msg-count').textContent = (playerProfile.statusMessage || "").length;

    // ëŒ€í‘œ ì¹´ë“œ ì´ë¯¸ì§€ ì„¸íŒ…
    const repImg = document.getElementById('profile-rep-image');
    const repName = document.getElementById('profile-rep-name');

    let cardData = null;
    let charData = null;

    // ì €ì¥ëœ ëŒ€í‘œ ì¹´ë“œ IDê°€ ìˆê³ , ì¸ë²¤í† ë¦¬ì— ê·¸ ì¹´ë“œê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if (playerProfile.repCardId) {
        cardData = playerInventory.find(c => c.id === playerProfile.repCardId);
    }

    // ë§Œì•½ ì €ì¥ëœ ì¹´ë“œê°€ ì—†ë‹¤ë©´(íŒŒì‡„ë¨ ë“±), ì¸ë²¤í† ë¦¬ì˜ ì²« ë²ˆì§¸ ì¹´ë“œë¥¼ ë³´ì—¬ì¤Œ (ë˜ëŠ” ë¹ˆ ìƒíƒœ)
    if (!cardData && playerInventory.length > 0) {
        // ê¸°ë³¸ê°’ ì—†ìŒ ìƒíƒœ ìœ ì§€
    }

    if (cardData) {
        charData = findCharacter(cardData.name);
        repImg.src = charData.imageUrl;
        repName.textContent = `[${charData.rarity}] ${charData.name} (Lv.${cardData.level})`;
        repName.className = "text-yellow-300 font-bold text-lg mt-2";
    } else {
        repImg.src = "https://placehold.co/400x600/000000/ffffff?text=Select+Card";
        repName.textContent = "ëŒ€í‘œ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”";
        repName.className = "text-gray-500 font-bold text-lg mt-2";
    }
}

// 2. í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
function saveProfileData() {
    const newNickname = document.getElementById('profile-nickname-edit').value.trim();
    const newMessage = document.getElementById('profile-message-edit').value.trim();

    if (!newNickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    // ë°ì´í„° ê°±ì‹ 
    currentPlayerNickname = newNickname;
    playerProfile.statusMessage = newMessage;

    // UI ê°±ì‹  (ìƒë‹¨ ë‹‰ë„¤ì„ í‘œì‹œ ë“±)
    document.getElementById('nickname-display').textContent = currentPlayerNickname;

    // Firebase ì €ì¥
    saveGame();
    alert("í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

// 3. ì¹´ë“œ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
function openProfileCardSelector() {
    const modal = document.getElementById('profile-card-selector-modal');
    const list = document.getElementById('profile-card-list');
    list.innerHTML = '';

    // ì¸ë²¤í† ë¦¬ ì •ë ¬ (ë“±ê¸‰ ë†’ì€ ìˆœ -> ë ˆë²¨ ë†’ì€ ìˆœ)
    const sortedInv = [...playerInventory].sort((a, b) => {
        const charA = findCharacter(a.name);
        const charB = findCharacter(b.name);
        
        if (!charA) return 1;
        if (!charB) return -1;

        const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
        const rA = rarityOrder[charA.rarity] || 0;
        const rB = rarityOrder[charB.rarity] || 0;

        return (rB - rA) || (b.level - a.level);
    });

    sortedInv.forEach(cardInstance => {
        const charData = findCharacter(cardInstance.name);
        if (!charData) return; 

        // âœ¨ í•µì‹¬ ë³€ê²½: ì§ì ‘ HTMLì„ ì§œì§€ ì•Šê³  'createCard' í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // mode: 'default'ë¡œ ì„¤ì •í•˜ë©´ ë²„íŠ¼ ì—†ì´ ì¹´ë“œ ëª¨ì–‘ë§Œ ì˜ˆì˜ê²Œ ë‚˜ì˜µë‹ˆë‹¤.
        const cardEl = createCard(charData, { 
            instance: cardInstance, 
            mode: 'default' 
        });

        // í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²° (í´ë¦­ ì‹œ í•´ë‹¹ ì¹´ë“œë¡œ ì„ íƒ)
        cardEl.onclick = () => {
            selectProfileCard(cardInstance.id);
        };

        // âœ¨ í˜„ì¬ ì„ íƒëœ ì¹´ë“œë¼ë©´ ë…¸ë€ìƒ‰ í…Œë‘ë¦¬ì™€ ë±ƒì§€ë¡œ í‘œì‹œ
        if (playerProfile.repCardId === cardInstance.id) {
            cardEl.classList.add('ring-4', 'ring-yellow-400', 'z-10'); // ê°•ì¡° í…Œë‘ë¦¬
            
            // 'ì„ íƒë¨' ë±ƒì§€ ì¶”ê°€
            const badge = document.createElement('div');
            badge.className = 'absolute top-0 right-0 bg-yellow-400 text-black font-bold px-2 py-1 rounded-bl-lg shadow-md z-20 text-xs';
            badge.innerText = 'V';
            cardEl.appendChild(badge);
        }

        list.appendChild(cardEl);
    });

    modal.classList.remove('hidden');
}

// 4. ì¹´ë“œ ì„ íƒ ì²˜ë¦¬
function selectProfileCard(cardId) {
    playerProfile.repCardId = cardId;
    document.getElementById('profile-card-selector-modal').classList.add('hidden');
    displayProfileView(); // í™”ë©´ ê°±ì‹  (ì €ì¥ì€ ì•„ì§ ì•ˆ í•¨, ìœ ì €ê°€ ì €ì¥ ë²„íŠ¼ ëˆŒëŸ¬ì•¼ í•¨)
}
window.displayProfileView = displayProfileView;
window.saveProfileData = saveProfileData;
window.openProfileCardSelector = openProfileCardSelector;
window.selectProfileCard = selectProfileCard;
// ... openRankingModal í•¨ìˆ˜ ì •ì˜ê°€ ëë‚˜ëŠ” ê³³ ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€ ...

window.openRankingModal = openRankingModal;

// 5. í•œë§ˆë”” ê¸€ììˆ˜ ì¹´ìš´íŒ… (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° í•„ìš”)
document.getElementById('profile-message-edit').addEventListener('input', function() {
    document.getElementById('profile-msg-count').textContent = this.value.length;
});


		function handleStoryInteraction(e) {
    const choiceButton = e.target.closest('button');

    // --- 1. ì„ íƒì§€ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° (ê¸°ì¡´ ë¡œì§) ---
    if (choiceButton && choiceButton.dataset.nextScene) {
        currentEventChoice = choiceButton.textContent;
        currentSceneIndex = parseInt(choiceButton.dataset.nextScene);
        renderCurrentScene();
    } 
    // --- 2. 'ì „ë°˜ë¶€ ì™„ë£Œ' ê°™ì€ ìµœì¢… ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° (ê¸°ì¡´ ë¡œì§) ---
    else if (choiceButton && choiceButton.dataset.isFinalChoice === 'true') {
        closeInteractiveStory();
        if (currentEventChoice) {
            // âœ… 1. ìœ ì €ì˜ ì„ íƒì„ playerChoices ê°ì²´ì— ê¸°ë¡í•©ë‹ˆë‹¤.
            playerChoices[choiceButton.dataset.statId] = currentEventChoice;
            
            // âœ… 2. ë³€ê²½ëœ playerChoicesë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
            saveGame();

            recordAndShowStats(choiceButton.dataset.statId, currentEventChoice);
        } else {
            console.error("ì˜¤ë¥˜: ìœ ì €ì˜ ì„ íƒì´ ê¸°ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
    }
    // --- 3. "ìŠ¤í‚µ" ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš° (ë¬´ì‹œ) ---
    else if (choiceButton && choiceButton.id === 'story-skip-button') {
        // ìŠ¤í‚µ ë²„íŠ¼ì€ ìì²´ ë¦¬ìŠ¤ë„ˆ(closeInteractiveStory)ê°€ ìˆìœ¼ë¯€ë¡œ,
        // ì—¬ê¸°ì„œ advanceStoryê°€ í˜¸ì¶œë˜ëŠ” ê²ƒì„ ë§‰ìŠµë‹ˆë‹¤.
        return;
    }
    // --- 4. âœ¨ ê·¸ ì™¸ì˜ ì˜ì—­ (ëŒ€í™”ì°½, "ë‹¤ìŒ" ë²„íŠ¼ ë“±)ì„ í´ë¦­í•œ ê²½ìš° ---
    else {
        // í˜„ì¬ ì„ íƒì§€ê°€ í™”ë©´ì— ë–  ìˆëŠ”ì§€ í™•ì¸
        const choiceContainer = document.getElementById('choice-buttons-container');
        
        // ì„ íƒì§€ê°€ ì—†ì„ ë•Œë§Œ (ì¦‰, 'ë‹¤ìŒ' ë²„íŠ¼ì´ ë³´ì¼ ë•Œë§Œ) advanceStoryë¥¼ í˜¸ì¶œ
        if (choiceContainer.children.length === 0) {
            advanceStory();
        }
        // (ì„ íƒì§€ê°€ 1ê°œ ì´ìƒ ë– ìˆë‹¤ë©´, ìœ ì €ê°€ ì„ íƒì§€ë¥¼ ëˆ„ë¥´ê¸¸ ê¸°ë‹¤ë¦¬ë©° ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ)
    }
}
			
            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

// âœ¨ [ì‹ ê·œ] ë§ˆì´ë£¸ ì…ì£¼ë¯¼ í•„í„° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.getElementById('myroom-filter-container').addEventListener('click', (e) => {
    const btn = e.target.closest('.myroom-filter-btn');
    if (!btn) return;

    // 1. í•„í„° ìƒíƒœ ë³€ê²½
    currentMyRoomFilter = btn.dataset.filter;

    // 2. ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ê±´ íŒŒë€ìƒ‰, ë‚˜ë¨¸ì§„ íšŒìƒ‰)
    document.querySelectorAll('.myroom-filter-btn').forEach(b => {
        if (b.dataset.filter === currentMyRoomFilter) {
            b.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            b.classList.add('bg-blue-500', 'hover:bg-blue-600');
        } else {
            b.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            b.classList.add('bg-gray-600', 'hover:bg-gray-700');
        }
    });

    // 3. ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    updateMyRoomSelectorUI();
});

// âœ¨ ê³„ì • ê´€ë ¨ ë²„íŠ¼
document.getElementById('register-button').addEventListener('click', registerUser);
document.getElementById('login-button').addEventListener('click', loginUser);
document.getElementById('logout-button').addEventListener('click', logoutUser);



// âœ¨ ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬ ë·°ì˜ ìƒˆ ì„œë¸Œ íƒ­ ë¦¬ìŠ¤ë„ˆ
document.getElementById('event-story-sub-tab-part1').addEventListener('click', () => {
    document.getElementById('event-story-part1-container').classList.remove('hidden');
    document.getElementById('event-story-part2-container').classList.add('hidden');
    document.getElementById('event-story-sub-tab-part1').classList.add('active');
    document.getElementById('event-story-sub-tab-part2').classList.remove('active');
	
});
document.getElementById('event-story-sub-tab-part2').addEventListener('click', () => {
    document.getElementById('event-story-part1-container').classList.add('hidden');
    document.getElementById('event-story-part2-container').classList.remove('hidden');
    document.getElementById('event-story-sub-tab-part1').classList.remove('active');
    document.getElementById('event-story-sub-tab-part2').classList.add('active');
	displayEventStoryPart2(); // ğŸ‘ˆ ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”.
});

document.getElementById('event-view').addEventListener('click', (e) => {
    const storyEl = e.target.closest('[data-story-type]');
    if (!storyEl || !storyEl.dataset.storyIndex) return; // ìœ íš¨í•œ ìŠ¤í† ë¦¬ ë²„íŠ¼ì´ ì•„ë‹ˆë©´ ì¢…ë£Œ

    const storyType = storyEl.dataset.storyType;
    const storyIndex = parseInt(storyEl.dataset.storyIndex, 10);

    if (storyType === 'event') {
        // --- ì „ë°˜ë¶€ ìŠ¤í† ë¦¬ í´ë¦­ ---
        startInteractiveStory(storyIndex, 'event');

    } else if (storyType === 'event_part2') {
        // --- í›„ë°˜ë¶€ ìŠ¤í† ë¦¬ í´ë¦­ ---
        const storyData = eventStoryPart2.secondHalf[storyIndex];

        // ë¶„ê¸° ìŠ¤í† ë¦¬ ì²˜ë¦¬
        if (storyData.isBranching) {
            const userChoice = playerChoices['event_part2_final_choice'];
            if (userChoice && storyData.branches[userChoice]) {
                startInteractiveStory({ content: storyData.branches[userChoice] });
            } else {
                // í˜¹ì‹œ ëª¨ë¥¼ ì˜¤ë¥˜ ë°©ì§€ìš© ê¸°ë³¸ê°’
                startInteractiveStory({ content: storyData.branches['ê²°ì •ì ì¸ ì§€ë¬¸ì„ ë¯¿ëŠ”ë‹¤.'] });
            }
        } else {
            // ì¼ë°˜ í›„ë°˜ë¶€ ìŠ¤í† ë¦¬
            startInteractiveStory(storyIndex, 'event_part2');
        }

        // í›„ë°˜ë¶€ ìŠ¤í† ë¦¬ë¥¼ "í´ë¦­"í–ˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ë¡ (ì´ê²ƒì´ ë‹¤ìŒ ìŠ¤í† ë¦¬ì˜ í•´ê¸ˆ ì¡°ê±´)
        playerChoices[`event_part2_story_${storyIndex}`] = true;
        saveGame();
        
        // ìŠ¤í† ë¦¬ê°€ ëë‚œ í›„ UIë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ìŒ ìŠ¤í† ë¦¬ê°€ í•´ê¸ˆëœ ê²ƒì„ ë°”ë¡œ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ì„¤ì •
        document.getElementById('interactive-story-modal').dataset.callback = 'displayEventStoryPart2()';
    }
});

// âœ¨ ì¸ë²¤í† ë¦¬ ë‹¤ì¤‘ íŒŒì‡„ ëª¨ë“œ ê´€ë ¨
enterMultiModeButton.addEventListener('click', enterMultiSelectMode);
exitMultiModeButton.addEventListener('click', exitMultiSelectMode);
dismantleSelectedButton.addEventListener('click', dismantleMultipleCards);

// âœ¨ íŒŒì‡„ ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
closeDismantleResultButton.addEventListener('click', () => {
    const finalMessage = dismantleResultModal.dataset.finalMessage;
    const messageColor = dismantleResultModal.dataset.messageColor;
    dismantleResultModal.classList.add('hidden');
    if (finalMessage) {
        showMessage(finalMessage, messageColor, messageArea);
        dismantleResultModal.dataset.finalMessage = '';
    }
    exitMultiSelectMode();
});

// í•„í„° ë²„íŠ¼ í´ë¦­
document.getElementById('inventory-filter-buttons').addEventListener('click', (e) => {
    const button = e.target.closest('.filter-button');
    if (button && button.dataset.filter) {
        currentRarityFilter = button.dataset.filter;
        displayInventory();
    }
});

// í•„í„°ëœ ì›ê³  ì „ì²´ ì„ íƒ ë²„íŠ¼ í´ë¦­
document.getElementById('select-all-filtered-button').addEventListener('click', () => {
    // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ì¹´ë“œë“¤ë§Œ ì„ íƒ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤.
    const currentlyVisibleCards = playerInventory.filter(cardInstance => {
        if (currentRarityFilter === 'All') return true;
        const character = findCharacter(cardInstance.name);
        return character && character.rarity === currentRarityFilter;
    });

    // ë±ì— í¬í•¨ë˜ì§€ ì•Šì€ ì¹´ë“œë§Œ ì„ íƒ ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤.
    currentlyVisibleCards.forEach(cardInstance => {
        const isInDeck = playerDeck.some(deckCard => deckCard.id === cardInstance.id);
        if (!isInDeck) {
            selectedCardsToDismantle.add(cardInstance.id);
        }
    });

    // ì„ íƒ ìƒíƒœë¥¼ í™”ë©´ì— ì¦‰ì‹œ ë°˜ì˜í•©ë‹ˆë‹¤.
    displayInventory();
});

// âœ¨ ì¹´ë“œ ìƒì„¸ ëª¨ë‹¬ì—ì„œ ë‹¨ì¼ íŒŒì‡„
dismantleCardButton.addEventListener('click', () => {
    dismantleCard(currentDetailCardId);
});

// ================ ğŸ‘‡ ì´ë²¤íŠ¸ í™ˆ ê´€ë ¨ ë¦¬ìŠ¤ë„ˆ (ì‹ ê·œ) ğŸ‘‡ ================

// 1. 'í™ˆ' í™”ë©´ì˜ ì´ë²¤íŠ¸ ë°°ë„ˆ í´ë¦­ ì‹œ -> ì´ë²¤íŠ¸ í™ˆ(ì•ˆë‚´ ì°½)ìœ¼ë¡œ ì´ë™
const bannerElement = document.getElementById('event-banner'); 

if (bannerElement) { 
    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ë®ì–´ì“°ê¸°
    bannerElement.onclick = function() {
        switchTab('event-home'); // âœ¨ ì—¬ê¸°ê°€ 'event'ì—ì„œ 'event-home'ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤!
    };
}

// 2. 'ì´ë²¤íŠ¸ í™ˆ'ì˜ 'ì´ë²¤íŠ¸ ì „íˆ¬' ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById('goto-event-battle').addEventListener('click', () => {
    // ê¸°ì¡´ event-viewë¥¼ ë³´ì—¬ì£¼ê³ , 'ì „íˆ¬' ì„œë¸Œ íƒ­ì„ í™œì„±í™”
    document.getElementById('event-home-view').classList.add('hidden');
    document.getElementById('event-view').classList.remove('hidden');
    displayEventView(); // ì „íˆ¬/ìŠ¤í† ë¦¬/ìƒì  ëª©ë¡ì„ ê·¸ë¦¼
    switchSubTab(document.getElementById('event-view'), eventSubTabBattle); // ì „íˆ¬ íƒ­ í™œì„±í™”
});

// 3. 'ì´ë²¤íŠ¸ í™ˆ'ì˜ 'ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬' ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById('goto-event-story').addEventListener('click', () => {
    document.getElementById('event-home-view').classList.add('hidden');
    document.getElementById('event-view').classList.remove('hidden');
    displayEventView(); 
    switchSubTab(document.getElementById('event-view'), eventSubTabStory); // ìŠ¤í† ë¦¬ íƒ­ í™œì„±í™”
});

// 4. 'ì´ë²¤íŠ¸ í™ˆ'ì˜ 'ì´ë²¤íŠ¸ ì„œê°€' ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById('goto-event-gacha').addEventListener('click', () => {
    switchTab('gacha'); // ë½‘ê¸° íƒ­ìœ¼ë¡œ ì´ë™
    switchGachaTab('event'); // ì´ë²¤íŠ¸ ë½‘ê¸° ì„œë¸Œ íƒ­ í™œì„±í™”
});

// 5. 'ì´ë²¤íŠ¸ í™ˆ'ì˜ 'ì´ë²¤íŠ¸ ìƒì ' ë²„íŠ¼ í´ë¦­ ì‹œ (ì‹ ê·œ ì¶”ê°€)
            document.getElementById('goto-event-shop').addEventListener('click', () => {
                // ê¸°ì¡´ event-viewë¥¼ ë³´ì—¬ì£¼ê³ , 'ìƒì ' ì„œë¸Œ íƒ­ì„ í™œì„±í™”
                document.getElementById('event-home-view').classList.add('hidden');
                document.getElementById('event-view').classList.remove('hidden');
                displayEventView(); // ì „íˆ¬/ìŠ¤í† ë¦¬/ìƒì  ëª©ë¡ì„ ê·¸ë¦¼
                
                // 'ìƒì ' íƒ­ì„ í™œì„±í™”í•˜ê¸° ìœ„í•´ eventSubTabShop ë³€ìˆ˜(DOM ìš”ì†Œ)ë¥¼ ì „ë‹¬
                switchSubTab(document.getElementById('event-view'), eventSubTabShop); 
            });

// ======================================================================


// =================== ğŸ‘‡ 'ë„ê°' íƒ­ ì „ìš© ë¦¬ìŠ¤ë„ˆ ğŸ‘‡ ===================

// 'ë„ê°' íƒ­ì˜ ìºë¦­í„° ëª©ë¡(ì‚¬ì´ë“œë°”) í´ë¦­ ì´ë²¤íŠ¸
document.getElementById('collection-character-list').addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (button && button.dataset.baseName) {
        displayCharacterDetail(button.dataset.baseName);
    }
});

// 'ë„ê°' íƒ­ì˜ ì„œë¸Œ íƒ­ (ì¹´ë“œ ëª¨ìŒ) í´ë¦­
document.getElementById('collection-sub-tab-cards').addEventListener('click', (e) => {
    e.target.classList.add('active');
    document.getElementById('collection-sub-tab-dialogues').classList.remove('active');
    document.getElementById('collection-cards-view').classList.remove('hidden');
    document.getElementById('collection-dialogues-view').classList.add('hidden');
    
    // í˜„ì¬ ì„ íƒëœ ìºë¦­í„°ì˜ baseNameì„ ì°¾ì•„ì„œ ì¹´ë“œ ë·°ë¥¼ ë‹¤ì‹œ ê·¸ë¦¼
    const activeCharButton = document.querySelector('#collection-character-list button.active');
    if (activeCharButton) {
        const baseName = activeCharButton.dataset.baseName;
        // const isCollected = new Set(playerInventory.map(card => findCharacter(card.name)?.baseName)).has(baseName); // ğŸ‘ˆ ì´ ì¤„ ì‚­ì œ
        displayCharacterCards(baseName); // ğŸ‘ˆ ë‘ ë²ˆì§¸ ì¸ì ì—†ì´ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •
    }
});

// 'ë„ê°' íƒ­ì˜ ì„œë¸Œ íƒ­ (ëŒ€ì‚¬ ëª¨ìŒ) í´ë¦­
document.getElementById('collection-sub-tab-dialogues').addEventListener('click', (e) => {
    e.target.classList.add('active');
    document.getElementById('collection-sub-tab-cards').classList.remove('active');
    document.getElementById('collection-cards-view').classList.add('hidden');
    document.getElementById('collection-dialogues-view').classList.remove('hidden');
    
    // í˜„ì¬ ì„ íƒëœ ìºë¦­í„°ì˜ baseNameì„ ì°¾ì•„ì„œ ëŒ€ì‚¬ ë·°ë¥¼ ê·¸ë¦¼
    const activeCharButton = document.querySelector('#collection-character-list button.active');
    if (activeCharButton) {
        displayCharacterDialogues(activeCharButton.dataset.baseName);
    }
});
// =================================================================

// âœ¨ ë°ì´í„° ì—…ë¡œë“œ (ì´ì œ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ë§Œì•½ì„ ìœ„í•´ ë‚¨ê²¨ë‘ )
if (uploadFile) {
    uploadFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            uploadSaveData(file); 
        }
        e.target.value = null; 
    });
}

// âœ¨ ìŠ¤í† ë¦¬ ë·°ì˜ ì„œë¸Œ íƒ­
storySubTabMain.addEventListener('click', () => {
    storySubTabMain.classList.add('active');
    storySubTabStage.classList.remove('active');
    displayStoryView();
});
storySubTabStage.addEventListener('click', () => {
    storySubTabStage.classList.add('active');
    storySubTabMain.classList.remove('active');
    displayStoryView();
});

// âœ¨ ì¸ë²¤í† ë¦¬ ì •ë ¬ ë²„íŠ¼
document.getElementById('inventory-sort-buttons').addEventListener('click', (e) => {
    const button = e.target.closest('.sort-button');
    if (button && button.dataset.sort) {
        const newSortOrder = button.dataset.sort;
        if (newSortOrder === currentSortOrder) {
            isSortAscending = !isSortAscending;
        } else {
            currentSortOrder = newSortOrder;
            isSortAscending = false; 
        }
        displayInventory();
    }
});

// âœ¨ ì¹´ë“œ ê°•í™” ë° ê°œì • ë²„íŠ¼
document.getElementById('enhance-card-button').addEventListener('click', enhanceCard);
document.getElementById('revise-card-button').addEventListener('click', reviseCard);

// âœ¨ ë©”ì¸ íƒ­ ë²„íŠ¼
allTabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.id.split('-')[1])));

// âœ¨ ì—…ì  ë³´ìƒ ë°›ê¸°
achievementsContainer.addEventListener('click', (e) => {
    const button = e.target.closest('[data-ach-id]');
    if (button) {
        claimAchievement(button.dataset.achId);
    }
});

// âœ¨ ë½‘ê¸° ë²„íŠ¼
pullOneButton.addEventListener('click', () => handlePull(1, PULL_ONE_COST, 'normal'));
pullTenButton.addEventListener('click', () => handlePull(10, PULL_TEN_COST, 'normal'));
pullOneEventButton.addEventListener('click', () => handlePull(1, PULL_ONE_COST, 'event'));
pullTenEventButton.addEventListener('click', () => handlePull(10, PULL_TEN_COST, 'event'));

// âœ¨ ê¸°íƒ€ ê¸°ëŠ¥ ë²„íŠ¼
expandInventoryButton.addEventListener('click', expandInventory);
autoFillDeckButton.addEventListener('click', autoFillDeck);
resetButton.addEventListener('click', resetGame);


		

// 2. ë§ˆì´ë£¸ ë‚´ë¶€ ë²„íŠ¼ë“¤
const openShopBtn = document.getElementById('open-furniture-shop');
if (openShopBtn) openShopBtn.addEventListener('click', openFurnitureShop);

const closeShopBtn = document.getElementById('close-furniture-shop');
const shopModal = document.getElementById('furniture-shop-modal');
if (closeShopBtn) {
    closeShopBtn.addEventListener('click', () => {
        shopModal.classList.add('hidden');
    });
}

// ìƒì  ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
if (shopModal) {
    shopModal.addEventListener('click', (e) => {
        if (e.target === shopModal) shopModal.classList.add('hidden');
    });
}

		

// âœ¨ ë½‘ê¸° ë·°ì˜ ì„œë¸Œ íƒ­
gachaTabNormal.addEventListener('click', () => switchGachaTab('normal'));
gachaTabEvent.addEventListener('click', () => switchGachaTab('event'));

// âœ¨ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ (ì¸ë²¤í† ë¦¬, ë± í¸ì„±, ë„ê° ë“±) - ìˆ˜ì •ëœ ë²„ì „
const cardClickableContainers = [inventoryContainer, deckInventoryContainer, deckSlotsContainer, collectionContainer];
cardClickableContainers.forEach(container => {
    container.addEventListener('click', (e) => {
        // íŒŒì‡„ ì¤‘ì´ê±°ë‚˜, í´ë¦­ëœ ìš”ì†Œê°€ ì¹´ë“œ ìì²´ê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ
        if (isDismantling) return;
        
        // 1. ì•¡ì…˜ ë²„íŠ¼(`data-action`) í´ë¦­ ì²˜ë¦¬
        const actionButton = e.target.closest('[data-action]');
        if (actionButton) {
            e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€
            const action = actionButton.dataset.action;
            const cardId = actionButton.dataset.cardId;
            const cardName = actionButton.dataset.cardName;

            if (action === 'set-representative') setRepresentative(cardName);
            else if (action === 'add-to-deck') addToDeck(cardId);
            else if (action === 'remove-from-deck') removeFromDeck(cardId);
            
            return; // ì•¡ì…˜ ë²„íŠ¼ ì²˜ë¦¬ í›„ ì¢…ë£Œ
        }
        
        // 2. ì¹´ë“œ ìì²´ í´ë¦­ ì²˜ë¦¬ (ìƒì„¸ ì •ë³´ ë³´ê¸° ë˜ëŠ” ë‹¤ì¤‘ ì„ íƒ)
        const cardElement = e.target.closest('.relative.text-center'); // ì¹´ë“œ ìš”ì†Œ ì°¾ê¸°
        // data-unique-idëŠ” ì¸ë²¤í† ë¦¬/ë± ì¹´ë“œì—ë§Œ ìˆìœ¼ë¯€ë¡œ ì´ê±¸ë¡œ êµ¬ë¶„
        const cardUniqueId = cardElement?.dataset.uniqueId; 

        // ì¸ë²¤í† ë¦¬ì—ì„œ ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œì¼ ë•Œ
        if (container === inventoryContainer && isMultiSelectMode && cardUniqueId) {
             const isInDeck = playerDeck.some(deckCard => deckCard.id === cardUniqueId);
             if (isInDeck) {
                 showMessage('ë±ì— í¬í•¨ëœ ì¹´ë“œëŠ” íŒŒì‡„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text-red-400', messageArea);
                 return;
             }
             if (selectedCardsToDismantle.has(cardUniqueId)) {
                 selectedCardsToDismantle.delete(cardUniqueId);
             } else {
                 selectedCardsToDismantle.add(cardUniqueId);
             }
             displayInventory(); // ì„ íƒ ìƒíƒœ UI ì—…ë°ì´íŠ¸
             return; // ë‹¤ì¤‘ ì„ íƒ í›„ ì¢…ë£Œ
        }
        
        // ë„ê°ì´ ì•„ë‹Œ ê³³ì—ì„œ ìœ íš¨í•œ ì¹´ë“œ IDê°€ ìˆì„ ë•Œë§Œ ìƒì„¸ ì •ë³´ í‘œì‹œ
        if (container !== collectionContainer && cardUniqueId) {
             showCardDetails(cardUniqueId);
        } 
        // ğŸ‘‡ ë„ê°ì—ì„œ í´ë¦­ ì‹œ: ê¸°ë³¸ ì¹´ë“œ ì •ë³´ í‘œì‹œ (ìƒˆ í•¨ìˆ˜ í˜¸ì¶œ)
        else if (container === collectionContainer && cardElement) {
            // ì¹´ë“œ ìš”ì†Œì—ì„œ ê¸°ë³¸ ì´ë¦„(name)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. (title ì†ì„± í™œìš©)
            const cardBaseName = cardElement.title; 
            // ìˆ˜ì§‘ëœ ì¹´ë“œì¸ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸ (íšŒìƒ‰ ì¹´ë“œ í´ë¦­ ë°©ì§€)
            const isCollected = cardElement.dataset.isCollected === "true";
            if (cardBaseName && isCollected) {
                showCollectionCardDetails(cardBaseName); // âœ¨ ìƒˆ í•¨ìˆ˜ í˜¸ì¶œ âœ¨
            }
        }

    }); // addEventListener ì½œë°± ë
}); // forEach ì½œë°± ë

// âœ¨ ì „íˆ¬ ë·° (ì±•í„° ë° ìŠ¤í…Œì´ì§€ ì„ íƒ)
document.getElementById('combat-view').addEventListener('click', (e) => {
    const button = e.target.closest('button[data-action]');
    if (!button) return;
    const action = button.dataset.action;
    if (action === 'select-chapter') displayStages(parseInt(button.dataset.chapterIndex));
    else if (action === 'challenge-stage') challengeStage(parseInt(button.dataset.chapterIndex), parseInt(button.dataset.stageIndex));
});

// âœ¨ í™ˆ í™”ë©´ ë° ì´ë²¤íŠ¸ ë°°ë„ˆ
homeCharacterContainer.addEventListener('click', () => { if (representativeCharacter) displayHomeView(true); });

eventBanner.addEventListener('click', () => {
    // ë©”ì‹œì§€ëŠ” ë„ìš°ì§€ ì•Šê³  ë°”ë¡œ ì´ë²¤íŠ¸ íƒ­ìœ¼ë¡œ ì´ë™
    switchTab('event'); 
});
// âœ¨ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ë“¤ (ê²°ê³¼ í™•ì¸ í›„ í™”ë©´ ì´ë™ ì²˜ë¦¬)
closeCombatResultButton.addEventListener('click', () => {
    const resultModal = document.getElementById('combat-result-modal');
    
    if (resultModal) {
        // [í•µì‹¬ í•´ê²°] ì•„ê¹Œ ê°•ì œë¡œ ì¤€ display: flexë¥¼ display: noneìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤.
        resultModal.style.display = 'none'; 
        resultModal.classList.add('hidden');
        
        // Z-indexë„ ì´ˆê¸°í™” (í˜¹ì‹œ ëª¨ë¥¼ ê°„ì„­ ë°©ì§€)
        resultModal.style.zIndex = '';
    }

    // ì „íˆ¬ í™”ë©´ ìˆ¨ê¸°ê¸°
    const combatView = document.getElementById('combat-in-progress-view');
    if (combatView) {
        combatView.classList.add('hidden');
    }

    // í™”ë©´ ì´ë™ ë¡œì§ (ì›ë˜ëŒ€ë¡œ)
    if (lastCombatType === 'event') {
        switchTab('event');
        displayEventView();
        
        const eventView = document.getElementById('event-view');
        const btnBattle = document.getElementById('event-sub-tab-battle');
        if (eventView && btnBattle) {
            switchSubTab(eventView, btnBattle);
        }
    } else {
        switchTab('combat');
    }
});
closeCardDetailButton.addEventListener('click', hideCardDetails);
cardDetailModal.addEventListener('click', (e) => { if (e.target === cardDetailModal) hideCardDetails(); });

// âœ¨ ìŠ¤í† ë¦¬ ë·° (ë©”ì¸, ìŠ¤í…Œì´ì§€, ì´ë²¤íŠ¸ ìŠ¤í† ë¦¬ ëª©ë¡)
storyView.addEventListener('click', (e) => {
    const storyEl = e.target.closest('[data-story-index], [data-stage-id]');
    if (!storyEl) return;
    if (storyEl.dataset.storyType === 'main') {
        startInteractiveStory(parseInt(storyEl.dataset.storyIndex), 'main');
    } else if (storyEl.dataset.storyType === 'stage') {
        const stageId = storyEl.dataset.stageId;
        const [chapIdx, stgIdx] = stageId.split('-').map(s => parseInt(s) - 1);
        const stage = mainChapters[chapIdx]?.stages[stgIdx];
        if (stage && stage.stageStory) startInteractiveStory({ content: stage.stageStory });
        else alert('ìŠ¤í…Œì´ì§€ ìŠ¤í† ë¦¬ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } else if (storyEl.dataset.storyType === 'event') {
        startInteractiveStory(parseInt(storyEl.dataset.storyIndex), 'event');
    } 
});

// âœ¨ ì´ë²¤íŠ¸ ìƒì 
eventShopContainer.addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (button && button.dataset.itemId) purchaseEventItem(button.dataset.itemId);
});

// âœ¨ ëŒ€í™”í˜• ìŠ¤í† ë¦¬ ëª¨ë‹¬ ìƒí˜¸ì‘ìš©
interactiveStoryModal.addEventListener('click', handleStoryInteraction);
document.getElementById('close-stats-modal').addEventListener('click', () => {
    document.getElementById('choice-stats-modal').classList.add('hidden');
});
storySkipButton.addEventListener('click', closeInteractiveStory);

// âœ¨ ì¹´ë“œ ìƒì„¸ ìŠ¤í† ë¦¬ í˜ì´ì§€ë„¤ì´ì…˜
detailStoryPrevButton.addEventListener('click', () => {
    if (currentStoryPageIndex > 0) {
        currentStoryPageIndex--;
        displayCardStoryPage();
    }
});
detailStoryNextButton.addEventListener('click', () => {
    if (currentStoryPageIndex < currentStoryPages.length - 1) {
        currentStoryPageIndex++;
        displayCardStoryPage();
    }
});

// âœ¨ ì „íˆ¬ ì†ë„ ì¡°ì ˆ
speed1xButton.addEventListener('click', () => setCombatSpeed(1));
speed2xButton.addEventListener('click', () => setCombatSpeed(2));
speed4xButton.addEventListener('click', () => setCombatSpeed(4));

		

// âœ¨ ì´ë²¤íŠ¸ ë·°ì˜ ì„œë¸Œ íƒ­ (ìˆ˜ì •ë¨)
        eventSubTabBattle.addEventListener('click', () => {
            displayEventView(); 
            switchSubTab(document.getElementById('event-view'), eventSubTabBattle); 
        });
        eventSubTabStory.addEventListener('click', () => {
            displayEventView(); 
            switchSubTab(document.getElementById('event-view'), eventSubTabStory); 
        });
        eventSubTabShop.addEventListener('click', () => {
            displayEventView(); 
            switchSubTab(document.getElementById('event-view'), eventSubTabShop); 
        });

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ [ì—¬ê¸°]ì— ì´ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”! ğŸ‘‡ğŸ‘‡ğŸ‘‡
        
        // --- [ìˆ˜ì •] ë§ˆì´ë£¸ ë°°ì¹˜ ëª¨ë“œ í™œì„±í™” ì½”ë“œ ---
        const myRoomEditBtn = document.getElementById('myroom-edit-mode');
        if (myRoomEditBtn) {
            myRoomEditBtn.addEventListener('click', toggleEditMode);
        }

		// âœ¨âœ¨ [ì¶”ê°€] ê°€êµ¬ ë³´ê´€í•¨ ë²„íŠ¼ ì—°ê²° âœ¨âœ¨
        const openStorageBtn = document.getElementById('open-furniture-storage');
        if (openStorageBtn) openStorageBtn.addEventListener('click', openFurnitureStorage);

        const closeStorageBtn = document.getElementById('close-furniture-storage');
        const storageModal = document.getElementById('furniture-storage-modal');
        
        if (closeStorageBtn) {
            closeStorageBtn.addEventListener('click', () => {
                storageModal.classList.add('hidden');
            });
        }
        
        if (storageModal) {
            storageModal.addEventListener('click', (e) => {
                if (e.target === storageModal) storageModal.classList.add('hidden');
            });
        }
        // ë“œë˜ê·¸ ê¸°ëŠ¥ ì´ˆê¸°í™”
        initDragEvents();
        // ==========================================
        // â–¼â–¼â–¼ êµí™˜ì†Œ(Trade) í†µí•© ì½”ë“œ (ì—¬ê¸°ì„œë¶€í„° ë¶™ì—¬ë„£ìœ¼ì„¸ìš”) â–¼â–¼â–¼
        // ==========================================

        // 1. ë³€ìˆ˜ ë° ê¸°ë³¸ ì„¤ì •
        let selectedTradeCardId = null; 

        // 2. íƒ­ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
        const tradeTabBtn = document.getElementById('tab-trade');
        if (tradeTabBtn) {
            tradeTabBtn.addEventListener('click', () => {
                switchTab('trade');
                loadTradeList();
            });
        }

        const tradeSubTabMarket = document.getElementById('trade-sub-tab-market');
        if (tradeSubTabMarket) {
            tradeSubTabMarket.addEventListener('click', () => {
                document.getElementById('trade-market-view').classList.remove('hidden');
                document.getElementById('trade-register-view').classList.add('hidden');
                tradeSubTabMarket.classList.add('active');
                document.getElementById('trade-sub-tab-register').classList.remove('active');
                loadTradeList();
            });
        }

        const tradeSubTabRegister = document.getElementById('trade-sub-tab-register');
        if (tradeSubTabRegister) {
            tradeSubTabRegister.addEventListener('click', () => {
                document.getElementById('trade-market-view').classList.add('hidden');
                document.getElementById('trade-register-view').classList.remove('hidden');
                document.getElementById('trade-sub-tab-market').classList.remove('active');
                tradeSubTabRegister.classList.add('active');
                
                loadTradeInventory();
                loadMyTrades();
                
                // âœ¨ [ì¶”ê°€] íƒ­ì„ ì—´ ë•Œ ì„ íƒ ìƒì ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
                initTradeTargetSelectors(); 
            });
        }

		// âœ¨ [ì‹ ê·œ] 1. ë² ì´ìŠ¤ ì´ë¦„ ëª©ë¡ ì±„ìš°ê¸°
function initTradeTargetSelectors() {
    const baseSelect = document.getElementById('trade-target-basename');
    if (!baseSelect) return;

    // ì¤‘ë³µ ì œê±°ëœ ë² ì´ìŠ¤ ì´ë¦„ ëª©ë¡ ë§Œë“¤ê¸° (ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬)
    // 'characters' ë³€ìˆ˜ëŠ” yumecan_data.jsì— ìˆëŠ” ì „ì²´ ë°ì´í„°ì…ë‹ˆë‹¤.
    const uniqueBaseNames = [...new Set(characters.map(c => c.baseName))].sort();

    baseSelect.innerHTML = '<option value="">ë“±ì¥ì¸ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    uniqueBaseNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        baseSelect.appendChild(option);
    });

    // ë² ì´ìŠ¤ ì´ë¦„ ë³€ê²½ ì‹œ ì´ë²¤íŠ¸ ì—°ê²°
    baseSelect.onchange = updateTradeRarityOptions;
}

// âœ¨ [ì‹ ê·œ] 2. ì„ íƒëœ ìºë¦­í„°ì˜ 'ë“±ê¸‰' ëª©ë¡ ì±„ìš°ê¸°
function updateTradeRarityOptions() {
    const baseName = document.getElementById('trade-target-basename').value;
    const raritySelect = document.getElementById('trade-target-rarity-select');
    const specificSelect = document.getElementById('trade-target-specific-card');
    
    // ì´ˆê¸°í™”
    raritySelect.innerHTML = '<option value="">ë“±ê¸‰ ì„ íƒ</option>';
    specificSelect.innerHTML = '<option value="">-</option>';
    specificSelect.disabled = true;

    if (!baseName) {
        raritySelect.disabled = true;
        return;
    }

    // í•´ë‹¹ ìºë¦­í„°ê°€ ê°€ì§„ ë“±ê¸‰ë“¤ë§Œ ì¶”ì¶œ
    const availableRarities = [...new Set(
        characters.filter(c => c.baseName === baseName).map(c => c.rarity)
    )];
    
    // ë“±ê¸‰ ìˆœì„œ ì •ë ¬ (N -> R -> SR -> SSR)
    const rarityOrder = { 'N': 1, 'R': 2, 'SR': 3, 'SSR': 4 };
    availableRarities.sort((a, b) => rarityOrder[a] - rarityOrder[b]);

    availableRarities.forEach(r => {
        const option = document.createElement('option');
        option.value = r;
        option.textContent = r;
        raritySelect.appendChild(option);
    });

    raritySelect.disabled = false;
    raritySelect.onchange = updateTradeSpecificCardOptions;
}

// âœ¨ [ì‹ ê·œ] 3. ìºë¦­í„°+ë“±ê¸‰ì— ë§ëŠ” 'êµ¬ì²´ì ì¸ ì¹´ë“œ' ëª©ë¡ ì±„ìš°ê¸°
function updateTradeSpecificCardOptions() {
    const baseName = document.getElementById('trade-target-basename').value;
    const rarity = document.getElementById('trade-target-rarity-select').value;
    const specificSelect = document.getElementById('trade-target-specific-card');

    specificSelect.innerHTML = '<option value="">ì¹´ë“œ ì„ íƒ</option>';

    if (!baseName || !rarity) {
        specificSelect.disabled = true;
        return;
    }

    // ì¡°ê±´ì— ë§ëŠ” ì¹´ë“œ ì°¾ê¸°
    const targetCards = characters.filter(c => c.baseName === baseName && c.rarity === rarity);

    targetCards.forEach(c => {
        const option = document.createElement('option');
        option.value = c.name; // ì‹¤ì œ ê°’ì€ í’€ë„¤ì„ (ì˜ˆ: [ë¹ŒëŸ°] ê¹€ê¸°ì² )
        option.textContent = c.name;
        specificSelect.appendChild(option);
    });

    specificSelect.disabled = false;
}

        // [ìˆ˜ì •ëœ loadTradeInventory í•¨ìˆ˜]
function loadTradeInventory() {
    const container = document.getElementById('trade-inventory-container');
    if (!container) return;
    container.innerHTML = '';

    if (!playerInventory) {
            container.innerHTML = '<p class="col-span-full text-center text-gray-400">ë°ì´í„° ë¡œë”© ì¤‘...</p>';
            return;
    }

    // 1. í•„í„°ë§ (ë± ì œì™¸ & ë“±ê¸‰ í•„í„° ì ìš©)
    let tradableCards = playerInventory.filter(card => {
        // ë±ì— ìˆëŠ” ì¹´ë“œëŠ” ì œì™¸
        if (playerDeck.some(d => d.id === card.id)) return false;
        
        // âœ¨ ë“±ê¸‰ í•„í„° ì ìš©
        if (currentTradeRarityFilter !== 'All') {
            const charData = findCharacter(card.name);
            if (!charData || charData.rarity !== currentTradeRarityFilter) return false;
        }
        return true;
    });

    // âœ¨ 2. ì •ë ¬ (ë“±ê¸‰ ë†’ì€ ìˆœ -> ë ˆë²¨ ë†’ì€ ìˆœ -> ì´ë¦„ìˆœ)
    const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
    tradableCards.sort((a, b) => {
        const charA = findCharacter(a.name);
        const charB = findCharacter(b.name);
        const rA = charA ? rarityOrder[charA.rarity] : 0;
        const rB = charB ? rarityOrder[charB.rarity] : 0;

        // ë“±ê¸‰ ë¹„êµ -> ë ˆë²¨ ë¹„êµ -> ì´ë¦„ ë¹„êµ
        return (rB - rA) || (b.level - a.level) || a.name.localeCompare(b.name);
    });

    if (tradableCards.length === 0) {
        const msg = currentTradeRarityFilter === 'All' 
            ? 'ê±°ë˜ ê°€ëŠ¥í•œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.<br>(ë±ì— ìˆëŠ” ì¹´ë“œëŠ” ì œì™¸)' 
            : `[${currentTradeRarityFilter}] ë“±ê¸‰ì˜ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.`;
        container.innerHTML = `<p class="col-span-full text-center text-gray-400 py-4 text-xs">${msg}</p>`;
        return;
    }

    // 3. ì¹´ë“œ ìƒì„± (ê¸°ì¡´ ë¡œì§ + ë“±ê¸‰ ë±ƒì§€ ìœ ì§€)
    tradableCards.forEach(cardInstance => {
        const charData = findCharacter(cardInstance.name);
        const isSelected = (selectedTradeCardId === cardInstance.id);
        
        const cardEl = document.createElement('div');
        cardEl.className = `relative cursor-pointer border-2 rounded-lg p-1 transition-all ${isSelected ? 'border-yellow-400 bg-white/20' : 'border-transparent bg-black/40 hover:bg-white/10'}`;
        cardEl.dataset.cardId = cardInstance.id;

        const imageUrl = charData ? charData.imageUrl : '';
        const displayName = charData ? charData.name : cardInstance.name;
        
        const rarity = charData ? charData.rarity : '?';
        const rarityColors = {
            'N': 'bg-gray-500 text-white',
            'R': 'bg-blue-600 text-white',
            'SR': 'bg-purple-600 text-white',
            'SSR': 'bg-yellow-400 text-black'
        };
        const badgeClass = rarityColors[rarity] || 'bg-gray-600 text-white';

        cardEl.innerHTML = `
            <div class="pointer-events-none">
                <div class="aspect-[2/3] overflow-hidden rounded mb-1 relative">
                        <img src="${imageUrl}" class="w-full h-full object-cover">
                        <span class="absolute top-0 right-0 ${badgeClass} text-[10px] font-bold px-1.5 py-0.5 rounded-bl shadow-md">
                        ${rarity}
                        </span>
                </div>
                <p class="text-xs text-center text-white truncate mt-1">${displayName}</p>
                <p class="text-[10px] text-center text-gray-400">Lv.${cardInstance.level}</p>
            </div>
        `;
        container.appendChild(cardEl);
    });
}

        // 4. ì¸ë²¤í† ë¦¬ í´ë¦­ ì´ë²¤íŠ¸ (ìœ„ì„)
        const tradeInvContainer = document.getElementById('trade-inventory-container');
        if (tradeInvContainer) {
            tradeInvContainer.addEventListener('click', (e) => {
                const cardEl = e.target.closest('[data-card-id]');
                if (cardEl) {
                    const clickedId = cardEl.dataset.cardId;
                    selectedTradeCardId = clickedId;
                    
                    const cardInstance = playerInventory.find(c => c.id === clickedId);
                    if (cardInstance) {
                        const charData = findCharacter(cardInstance.name);
                        document.getElementById('trade-selected-name').innerHTML = 
                            `<span class="text-yellow-300">${charData.name}</span> <span class="text-xs text-gray-400">(Lv.${cardInstance.level})</span>`;
                        document.getElementById('trade-selected-card-preview').classList.remove('hidden');
                        loadTradeInventory();
                    }
                }
            });
        }
		
		const tradeFilterContainer = document.getElementById('trade-filter-buttons');
if (tradeFilterContainer) {
    tradeFilterContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.trade-filter-button');
        if (!btn) return;
        
        // 1. í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
        currentTradeRarityFilter = btn.dataset.filter;
        
        // 2. ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½ (ì„ íƒëœ ê²ƒë§Œ íŒŒë€ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” íšŒìƒ‰)
        document.querySelectorAll('.trade-filter-button').forEach(b => {
            b.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            b.classList.add('bg-gray-600', 'hover:bg-gray-700');
        });
        btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
        
        // 3. ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadTradeInventory();
    });
}

        // 5. ê±°ë˜ ë“±ë¡ ë²„íŠ¼ (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì´ë™ + ë‚´ ê±°ë˜ í‘œì‹œ)
        const btnRegister = document.getElementById('btn-register-trade');
        if (btnRegister) {
            btnRegister.addEventListener('click', async () => {
                if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                if (!selectedTradeCardId) return alert("ë³´ë‚¼ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                
                // âœ¨ [ìˆ˜ì •] í…ìŠ¤íŠ¸ ì…ë ¥ê°’ ëŒ€ì‹  ì„ íƒ ìƒìì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
                // const targetName = document.getElementById('trade-target-name').value.trim(); (ì‚­ì œ)
                const targetName = document.getElementById('trade-target-specific-card').value; // êµ¬ì²´ì ì¸ ì¹´ë“œ ì´ë¦„
                const targetRarity = document.getElementById('trade-target-rarity-select').value; // ë“±ê¸‰

                // ìœ íš¨ì„± ê²€ì‚¬
                if (!targetName || !targetRarity) return alert("ì›í•˜ëŠ” ì¹´ë“œë¥¼ ëê¹Œì§€ ì„ íƒí•´ì£¼ì„¸ìš”.");
                
                if (playerCurrency < 10) return alert("ë³´ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (ìˆ˜ìˆ˜ë£Œ 10)");

                if (!confirm(`[${targetName}] (${targetRarity}ë“±ê¸‰)ì„(ë¥¼) êµ¬í•˜ëŠ” ê±°ë˜ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                const userRef = db.collection('users').doc(currentUser.uid);
                const tradesCollection = db.collection('trades');

                try {
                    await db.runTransaction(async (transaction) => {
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists) throw "User not found";

                        const userData = userDoc.data();
                        const currentInventory = userData.inventory || [];
                        
                        const cardIndex = currentInventory.findIndex(c => c.id === selectedTradeCardId);
                        if (cardIndex === -1) throw "ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

                        const cardToTrade = currentInventory[cardIndex];
                        
                        // DB ì—…ë°ì´íŠ¸ ì¤€ë¹„
                        const newInventory = [...currentInventory];
                        newInventory.splice(cardIndex, 1); // ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±°
                        
                        const newCurrency = (userData.currency || 0) - 10; // ìˆ˜ìˆ˜ë£Œ ì°¨ê°
                        if (newCurrency < 0) throw "ë³´ì„ ë¶€ì¡±";

                        transaction.update(userRef, { 
                            inventory: newInventory,
                            currency: newCurrency
                        });

                        const newTradeRef = tradesCollection.doc();
                        transaction.set(newTradeRef, {
        senderUid: currentUser.uid,
        senderName: currentPlayerNickname,
        offeredCard: cardToTrade,
        targetName: targetName,
        targetRarity: targetRarity, // âœ¨ [ì¶”ê°€] DBì— í¬ë§ ë“±ê¸‰ ì €ì¥
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'active'
    });
                    });

                    // âœ¨ [í•µì‹¬ ë³€ê²½] ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì¦‰ì‹œ ë°˜ì˜ ë¡œì§ âœ¨
                    
                    // 1. ë¡œì»¬ ë°ì´í„°(ë‚´ ì¸ë²¤í† ë¦¬/ëˆ) ìˆ˜ë™ ì—…ë°ì´íŠ¸
                    const localCardIndex = playerInventory.findIndex(c => c.id === selectedTradeCardId);
                    if (localCardIndex > -1) playerInventory.splice(localCardIndex, 1);
                    playerCurrency -= 10;
                    
                    // 2. UI ê°±ì‹ 
                    updateUI(); 
selectedTradeCardId = null; 
document.getElementById('trade-selected-card-preview').classList.add('hidden'); 

// âœ¨ [ìˆ˜ì •] ì˜›ë‚  ì…ë ¥ì°½ ì´ˆê¸°í™” ì½”ë“œë¥¼ ì§€ìš°ê³ , ì„ íƒ ìƒìë“¤ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
const baseSelect = document.getElementById('trade-target-basename');
if(baseSelect) baseSelect.value = ""; // ì²« ë²ˆì§¸ ìƒì ì´ˆê¸°í™”

const raritySelect = document.getElementById('trade-target-rarity-select');
if(raritySelect) {
    raritySelect.innerHTML = '<option value="">-</option>';
    raritySelect.disabled = true;
}

const specificSelect = document.getElementById('trade-target-specific-card');
if(specificSelect) {
    specificSelect.innerHTML = '<option value="">-</option>';
    specificSelect.disabled = true;
}

alert("ê±°ë˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");

// 3. 'ê±°ë˜ì†Œ ëª©ë¡' íƒ­ìœ¼ë¡œ í™”ë©´ ê°•ì œ ì „í™˜
const marketTabBtn = document.getElementById('trade-sub-tab-market');
if(marketTabBtn) marketTabBtn.click();

                } catch (e) {
                    console.error(e);
                    alert("ë“±ë¡ ì‹¤íŒ¨: " + e);
                }
            });
        }

        // 6. ê±°ë˜ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ (ë‚´ ê±°ë˜ë„ í‘œì‹œë¨)
        async function loadTradeList() {
            const container = document.getElementById('trade-list-container');
            if (!container) return;
            container.innerHTML = '<p class="text-white">ë¡œë”© ì¤‘...</p>';

            try {
                const snapshot = await db.collection('trades')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();

                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-500">ë“±ë¡ëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                snapshot.forEach(doc => {
    const trade = doc.data();
    const isMyTrade = currentUser && trade.senderUid === currentUser.uid;
    const charData = findCharacter(trade.offeredCard.name);
    const imgUrl = charData ? charData.imageUrl : '';

    // âœ¨ ë‚´ ê±°ë˜ì¼ ê²½ìš° í…Œë‘ë¦¬ ìƒ‰ìƒê³¼ ë°°ê²½ìƒ‰ì„ ë‹¤ë¥´ê²Œ í‘œì‹œ
    const bgClass = isMyTrade ? 'bg-blue-900/40 border-blue-500' : 'bg-gray-800 border-gray-600';

    // âœ¨ [ì¶”ê°€] í¬ë§ ë“±ê¸‰ ë±ƒì§€ ìƒì„± ë¡œì§
    let rarityBadge = '';
    if (trade.targetRarity && trade.targetRarity !== 'ALL') {
        const rColors = { 'N': 'bg-gray-500', 'R': 'bg-blue-600', 'SR': 'bg-purple-600', 'SSR': 'bg-yellow-500 text-black' };
        rarityBadge = `<span class="${rColors[trade.targetRarity]} text-white text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold">${trade.targetRarity}</span>`;
    } else {
        rarityBadge = `<span class="bg-gray-600 text-white text-[10px] px-1.5 py-0.5 rounded ml-1">ëª¨ë“  ë“±ê¸‰</span>`;
    }

    const el = document.createElement('div');
    el.className = `${bgClass} p-3 rounded-lg border flex gap-3 items-center`;
    el.innerHTML = `
        <div class="w-16 h-16 flex-shrink-0 relative">
            <img src="${imgUrl}" class="w-full h-full object-cover rounded border border-white/20">
            ${isMyTrade ? '<span class="absolute top-0 left-0 bg-blue-600 text-white text-[10px] px-1 font-bold">ME</span>' : ''}
        </div>
        <div class="flex-grow">
            <p class="text-yellow-300 font-bold text-sm">${trade.offeredCard.name} <span class="text-xs text-gray-400">(Lv.${trade.offeredCard.level})</span></p>
            <p class="text-xs text-gray-400">From: ${trade.senderName}</p>
            <div class="mt-1 text-white text-sm bg-black/30 p-1 rounded text-center">
                êµ¬í•¨: <span class="font-bold text-green-400">${trade.targetName}</span> ${rarityBadge}
            </div>
        </div>
        <div class="flex flex-col gap-1">
            ${isMyTrade 
                ? `<button onclick="cancelTrade('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-2 rounded">íšŒìˆ˜</button>`
                // âœ¨ [ìˆ˜ì •] executeTrade í•¨ìˆ˜ì— ë“±ê¸‰ ì •ë³´(targetRarity) ì¶”ê°€ ì „ë‹¬
                : `<button onclick="executeTrade('${doc.id}', '${trade.targetName}', '${trade.targetRarity || 'ALL'}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded font-bold">êµí™˜</button>`
            }
        </div>
    `;
    container.appendChild(el);
});
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="text-red-400">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        // 7. ë‚´ ê±°ë˜ ëª©ë¡ (ì·¨ì†Œìš©)
        // [ìˆ˜ì •ëœ loadMyTrades í•¨ìˆ˜]
        async function loadMyTrades() {
            if (!currentUser) return;
            const list = document.getElementById('my-trade-list');
            if (!list) return;
            list.innerHTML = '<p class="text-gray-400 text-sm">ë¡œë”© ì¤‘...</p>';
            
            try {
                // 'active' ìƒíƒœì™€ 'waiting_claim' ìƒíƒœ ëª¨ë‘ ê°€ì ¸ì˜´
                const snapshot = await db.collection('trades')
                    .where('senderUid', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc') // ìµœì‹ ìˆœ
                    .get();

                list.innerHTML = '';
                
                // ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€(ë³´ìƒ ë¯¸ìˆ˜ë ¹ í¬í•¨) ê±°ë˜ë§Œ í•„í„°ë§
                const activeTrades = snapshot.docs.filter(doc => {
                    const status = doc.data().status;
                    return status === 'active' || status === 'waiting_claim';
                });

                if(activeTrades.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-sm">ì§„í–‰ ì¤‘ì¸ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                activeTrades.forEach(doc => {
                    const trade = doc.data();
                    const div = document.createElement('div');
                    
                    // ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ ë””ìì¸ê³¼ ë²„íŠ¼ í‘œì‹œ
                    if (trade.status === 'active') {
                        // ëŒ€ê¸° ì¤‘ -> íšŒìˆ˜ ë²„íŠ¼
                        div.className = 'flex justify-between items-center bg-gray-700 p-2 rounded mb-2 border border-gray-600';
                        div.innerHTML = `
                            <div>
                                <span class="text-white text-sm font-bold">ë“±ë¡ ì¤‘</span>
                                <div class="text-xs text-gray-300">[${trade.offeredCard.name}] â†” [${trade.targetName}]</div>
                            </div>
                            <button onclick="cancelTrade('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded">íšŒìˆ˜</button>
                        `;
                    } else if (trade.status === 'waiting_claim') {
                        // ê±°ë˜ ì„±ì‚¬ë¨ -> ìˆ˜ë ¹ ë²„íŠ¼ (âœ¨ì¤‘ìš”)
                        div.className = 'flex justify-between items-center bg-green-900/50 p-2 rounded mb-2 border border-green-500';
                        div.innerHTML = `
                            <div>
                                <span class="text-green-400 text-sm font-bold">ê±°ë˜ ì„±ì‚¬!</span>
                                <div class="text-xs text-gray-200">${trade.buyerName || 'ëˆ„êµ°ê°€'}ë‹˜ê³¼ êµí™˜ë¨</div>
                            </div>
                            <button onclick="receiveTradeItem('${doc.id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded animate-pulse font-bold">ë³´ìƒ ìˆ˜ë ¹</button>
                        `;
                    }
                    
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = '<p class="text-red-400 text-sm">ë¡œë“œ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)</p>';
            }
        }

        // 1. ê±°ë˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ (ì¹´ë“œ ê²€ìƒ‰ ë° ë¶„ê¸° ì²˜ë¦¬)
        window.executeTrade = function(tradeId, targetName, targetRarity) {
            // ë‚´ê°€ ê°€ì§„ ì¹´ë“œ ì¤‘ ì¡°ê±´ì— ë§ëŠ” ê²ƒë“¤ì„ ëª¨ë‘ ì°¾ìŠµë‹ˆë‹¤.
            const candidates = playerInventory.filter(c => {
                const charData = findCharacter(c.name);
                if (!charData) return false;
                
                // ì´ë¦„ í™•ì¸ (í’€ë„¤ì„ì´ ê°™ê±°ë‚˜, ë² ì´ìŠ¤ ì´ë¦„ì´ ê°™ê±°ë‚˜)
                const isNameMatch = (c.name === targetName) || (charData.baseName === targetName);
                if (!isNameMatch) return false;

                // ë±ì— ìˆëŠ” ì¹´ë“œëŠ” ì œì™¸
                if (playerDeck.some(d => d.id === c.id)) return false;

                // ë“±ê¸‰ ì¡°ê±´ í™•ì¸
                if (targetRarity && targetRarity !== 'ALL') {
                    if (charData.rarity !== targetRarity) return false;
                }
                
                return true;
            });

            // ê²½ìš°ì˜ ìˆ˜ ì²˜ë¦¬
            if (candidates.length === 0) {
                return alert(`ì¡°ê±´ì— ë§ëŠ” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.\n(ë±ì— ì¥ì°© ì¤‘ì¸ ì¹´ë“œëŠ” ê±°ë˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)`);
            }
            
            if (candidates.length === 1) {
                // 1ì¥ë¿ì´ë©´ ë°”ë¡œ ê±°ë˜ ì§„í–‰
                confirmTradeTransaction(tradeId, candidates[0], targetName, targetRarity);
            } else {
                // âœ¨ ì—¬ëŸ¬ ì¥ì´ë©´ ì„ íƒ ëª¨ë‹¬ ë„ìš°ê¸°
                openTradeSelectModal(tradeId, candidates, targetName, targetRarity);
            }
        };

        // 2. ì¹´ë“œ ì„ íƒ ëª¨ë‹¬ ì—´ê¸° (ê°œì • ë‹¨ê³„ í‘œì‹œ ì¶”ê°€ë¨)
        function openTradeSelectModal(tradeId, candidates, targetName, targetRarity) {
            const modal = document.getElementById('trade-select-card-modal');
            const list = document.getElementById('trade-select-list');
            
            list.innerHTML = ''; 

            candidates.forEach(cardInstance => {
                const charData = findCharacter(cardInstance.name);
                const revision = cardInstance.revision || 0; // ê°œì • ìˆ˜ì¹˜ (ì—†ìœ¼ë©´ 0)
                const stars = 'â­'.repeat(revision); // ë³„ ë¬¸ìì—´ ìƒì„±

                const cardEl = document.createElement('div');
                cardEl.className = 'relative bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600 border border-gray-500 transition-transform hover:scale-105';
                
                // í´ë¦­í•˜ë©´ ì´ ì¹´ë“œë¡œ ê±°ë˜ ì‹¤í–‰
                cardEl.onclick = () => {
                    document.getElementById('trade-select-card-modal').classList.add('hidden');
                    confirmTradeTransaction(tradeId, cardInstance, targetName, targetRarity);
                };

                cardEl.innerHTML = `
                    <div class="aspect-[2/3] overflow-hidden rounded mb-2 relative">
                        <img src="${charData.imageUrl}" class="w-full h-full object-cover">
                        
                        <span class="absolute bottom-0 right-0 bg-blue-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-tl shadow-md z-10">
                            Lv.${cardInstance.level}
                        </span>
                        
                        <div class="absolute bottom-0 left-0 p-1 text-[10px] text-yellow-300 font-bold z-10" style="text-shadow: 1px 1px 2px black;">
                            ${stars}
                        </div>
                    </div>
                    
                    <p class="text-xs font-bold text-center text-white truncate">${cardInstance.name}</p>
                    <p class="text-[10px] text-center text-gray-400">
                        Lv.${cardInstance.level} 
                        <span class="text-yellow-400">${revision > 0 ? `(+${revision}ê°œì •)` : ''}</span>
                    </p>
                `;
                list.appendChild(cardEl);
            });

            modal.classList.remove('hidden');
        }

        // 3. ì‹¤ì œ ê±°ë˜ íŠ¸ëœì­ì…˜ ì‹¤í–‰
        window.confirmTradeTransaction = async function(tradeId, myOfferCard, targetName, targetRarity) {
            const rarityMsg = (targetRarity && targetRarity !== 'ALL') ? `[${targetRarity}]` : '';
            
            // ì–´ë–¤ ì¹´ë“œë¥¼ ë³´ë‚´ëŠ”ì§€ ëª…í™•íˆ ë³´ì—¬ì¤Œ
            const msg = `ë‚˜ì˜ [${myOfferCard.name}] (Lv.${myOfferCard.level}) ì¹´ë“œë¥¼ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if (!confirm(msg)) return;

            const tradeRef = db.collection('trades').doc(tradeId);
            const buyerRef = db.collection('users').doc(currentUser.uid);
            let receivedCard = null;

            try {
                await db.runTransaction(async (transaction) => {
                    const tradeDoc = await transaction.get(tradeRef);
                    if (!tradeDoc.exists || tradeDoc.data().status !== 'active') throw "ì´ë¯¸ ì™„ë£Œë˜ì—ˆê±°ë‚˜ ì·¨ì†Œëœ ê±°ë˜ì…ë‹ˆë‹¤.";
                    
                    receivedCard = tradeDoc.data().offeredCard;
                    const buyerDoc = await transaction.get(buyerRef);
                    const buyerInventory = buyerDoc.data().inventory || [];
                    
                    const cardIndex = buyerInventory.findIndex(c => c.id === myOfferCard.id);
                    if (cardIndex === -1) throw "ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

                    const newBuyerInventory = [...buyerInventory];
                    newBuyerInventory.splice(cardIndex, 1); 
                    newBuyerInventory.push(receivedCard);

                    transaction.update(buyerRef, { inventory: newBuyerInventory });
                    
                    transaction.update(tradeRef, { 
                        status: 'waiting_claim', 
                        receivedCard: myOfferCard, 
                        buyerUid: currentUser.uid,
                        buyerName: currentPlayerNickname,
                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                // ë¡œì»¬ ë°ì´í„° ê°±ì‹ 
                const localIndex = playerInventory.findIndex(c => c.id === myOfferCard.id);
                if(localIndex > -1) playerInventory.splice(localIndex, 1);
                if (receivedCard) playerInventory.push(receivedCard);

                alert(`ê±°ë˜ ì„±ê³µ! [${receivedCard.name}] íšë“!`);
                loadTradeList(); 

            } catch (e) {
                alert("ê±°ë˜ ì‹¤íŒ¨: " + e);
            }
        };

// âœ¨ [ìˆ˜ì •] ê±°ë˜ ì·¨ì†Œ ë° ì¹´ë“œ íšŒìˆ˜ í•¨ìˆ˜ (ìƒˆë¡œê³ ì¹¨ ì—†ìŒ)
        window.cancelTrade = async function(tradeId) {
            if(!confirm("ê±°ë˜ë¥¼ ì·¨ì†Œí•˜ê³  ì¹´ë“œë¥¼ íšŒìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            const tradeRef = db.collection('trades').doc(tradeId);
            const userRef = db.collection('users').doc(currentUser.uid);

            try {
                let returnedCard = null;

                await db.runTransaction(async (transaction) => {
                    const tradeDoc = await transaction.get(tradeRef);
                    if (!tradeDoc.exists) throw "ê±°ë˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    
                    const data = tradeDoc.data();
                    if (data.status !== 'active') throw "ì´ë¯¸ ì„±ì‚¬ë˜ì—ˆê±°ë‚˜ ì·¨ì†Œëœ ê±°ë˜ì…ë‹ˆë‹¤.";
                    if (data.senderUid !== currentUser.uid) throw "ë³¸ì¸ì˜ ê±°ë˜ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";

                    returnedCard = data.offeredCard;

                    // 1. ë‚´ DB ì¸ë²¤í† ë¦¬ì— ì¹´ë“œ ë³µêµ¬
                    const userDoc = await transaction.get(userRef);
                    const currentInventory = userDoc.data().inventory || [];
                    const newInventory = [...currentInventory, returnedCard];
                    
                    transaction.update(userRef, { inventory: newInventory });
                    
                    // 2. ê±°ë˜ ë¬¸ì„œ ì‚­ì œ
                    transaction.delete(tradeRef);
                });

                // 3. ë¡œì»¬ ë°ì´í„°(ë‚´ ê°€ë°©) ì¦‰ì‹œ ê°±ì‹ 
                if (returnedCard) {
                    playerInventory.push(returnedCard);
                }
                
                alert(`[${returnedCard.name}] íšŒìˆ˜ ì™„ë£Œ!`);

                // 4. í™”ë©´ ëª©ë¡ ê°±ì‹  (ë¡œë”© ì—†ì´ ì¦‰ì‹œ ë°˜ì˜)
                if (typeof loadTradeList === 'function') loadTradeList();       // ì „ì²´ ëª©ë¡ ê°±ì‹ 
                if (typeof loadMyTrades === 'function') loadMyTrades();         // ë‚´ ê±°ë˜ ëª©ë¡ ê°±ì‹ 
                if (typeof loadTradeInventory === 'function') loadTradeInventory(); // ë“±ë¡ í™”ë©´ ì¸ë²¤í† ë¦¬ ê°±ì‹ 

            } catch (e) {
                console.error(e);
                alert("íšŒìˆ˜ ì‹¤íŒ¨: " + e);
            }
        };
		
		
		// ================== ğŸ¤ ì¹œêµ¬ ì‹œìŠ¤í…œ (ìƒí˜¸ ìˆ˜ë½ ë²„ì „) ==================

// 1. ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸° (ì¤‘ë³µ ë°©ì§€ ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
async function sendFriendRequest(targetUid, targetNickname) {
    if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    
    try {
        // âœ¨ [í•µì‹¬] ì´ë¯¸ ì¹œêµ¬ì¸ì§€ ë¨¼ì € í™•ì¸!
        const myCheck = await db.collection('users').doc(currentUser.uid).collection('friends').doc(targetUid).get();
        if (myCheck.exists) {
            const status = myCheck.data().status || 'accepted';
            if (status === 'accepted') return alert("ì´ë¯¸ ì¹œêµ¬ ì‚¬ì´ì…ë‹ˆë‹¤.");
            if (status === 'sent') return alert("ì´ë¯¸ ìš”ì²­ì„ ë³´ë‚¸ ìƒíƒœì…ë‹ˆë‹¤.");
            if (status === 'received') return alert("ìƒëŒ€ë°©ì´ ì´ë¯¸ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ë°›ì€ ìš”ì²­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }

        const batch = db.batch();

        // 1. ë‚´ ì¹œêµ¬ ëª©ë¡ì— ì¶”ê°€ (ìƒíƒœ: sent)
        const myRef = db.collection('users').doc(currentUser.uid).collection('friends').doc(targetUid);
        batch.set(myRef, {
            nickname: targetNickname,
            status: 'sent',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. ìƒëŒ€ë°© ì¹œêµ¬ ëª©ë¡ì— ì¶”ê°€ (ìƒíƒœ: received)
        const theirRef = db.collection('users').doc(targetUid).collection('friends').doc(currentUser.uid);
        batch.set(theirRef, {
            nickname: currentPlayerNickname, 
            status: 'received',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await batch.commit();
        
        alert(`[${targetNickname}]ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!`);
        
        // UI ê°±ì‹  (í”„ë¡œí•„ ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê³ , ì¹œêµ¬ ëª©ë¡ì´ ì—´ë ¤ìˆë‹¤ë©´ ê°±ì‹ )
        if (document.getElementById('other-user-profile-modal')) {
            document.getElementById('other-user-profile-modal').remove();
        }
        loadFriendList();

    } catch (error) {
        console.error("ìš”ì²­ ì‹¤íŒ¨:", error);
        alert("ì¹œêµ¬ ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}

// 2. ì¹œêµ¬ ìˆ˜ë½í•˜ê¸° (ì–‘ìª½ ëª¨ë‘ 'accepted' ìƒíƒœë¡œ ë³€ê²½)
async function acceptFriendRequest(targetUid, targetNickname) {
    try {
        const batch = db.batch();

        // ë‚´ ìƒíƒœ ë³€ê²½
        const myRef = db.collection('users').doc(currentUser.uid).collection('friends').doc(targetUid);
        batch.update(myRef, { status: 'accepted' });

        // ìƒëŒ€ë°© ìƒíƒœ ë³€ê²½
        const theirRef = db.collection('users').doc(targetUid).collection('friends').doc(currentUser.uid);
        batch.update(theirRef, { status: 'accepted' });

        await batch.commit();

        alert(`[${targetNickname}]ë‹˜ê³¼ ì¹œêµ¬ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        loadFriendList();

    } catch (error) {
        console.error("ìˆ˜ë½ ì‹¤íŒ¨:", error);
        alert("ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

// 3. ì¹œêµ¬ ì‚­ì œ / ìš”ì²­ ì·¨ì†Œ / ê±°ì ˆ (ì–‘ìª½ ë°ì´í„° ëª¨ë‘ ì‚­ì œ)
async function cancelFriendRequest(targetUid, targetNickname, isReject = false) {
    const msg = isReject ? 'ê±°ì ˆ' : 'ì‚­ì œ/ì·¨ì†Œ';
    if (!confirm(`ì •ë§ë¡œ [${targetNickname}]ë‹˜ê³¼ì˜ ê´€ê³„ë¥¼ ${msg}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        const batch = db.batch();

        const myRef = db.collection('users').doc(currentUser.uid).collection('friends').doc(targetUid);
        batch.delete(myRef);

        const theirRef = db.collection('users').doc(targetUid).collection('friends').doc(currentUser.uid);
        batch.delete(theirRef);

        await batch.commit();

        alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadFriendList();
        
        // ê²€ìƒ‰ì°½ì´ë‚˜ í”„ë¡œí•„ì´ ì—´ë ¤ìˆë‹¤ë©´ ê°±ì‹ ì„ ìœ„í•´ ë‹«ê¸°
        if (document.getElementById('other-user-profile-modal')) {
            document.getElementById('other-user-profile-modal').remove();
        }

    } catch (error) {
        console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

// [ìˆ˜ì •] ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ë‹‰ë„¤ì„ í´ë¦­ ì‹œ í”„ë¡œí•„ ì—°ê²° & UID ì „ë‹¬)
async function loadFriendList() {
    const friendContainer = document.getElementById('friend-list-container');
    const reqSection = document.getElementById('friend-request-section');
    const reqContainer = document.getElementById('friend-request-list');
    const reqCount = document.getElementById('request-count');

    if (!currentUser) return;
    
    friendContainer.innerHTML = '<p class="text-gray-500 text-center">ë¡œë”© ì¤‘...</p>';

    try {
        const snapshot = await db.collection('users').doc(currentUser.uid).collection('friends').get();
        
        friendContainer.innerHTML = '';
        reqContainer.innerHTML = '';
        
        let friendCount = 0;
        let requestCount = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            const uid = doc.id; // âœ¨ ì—¬ê¸°ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤! (ë¬¸ì„œ ID = ì¹œêµ¬ UID)
            const status = data.status || 'accepted';

            // 1. ì¹œêµ¬ ìš”ì²­ ë°›ì€ ê²½ìš°
            if (status === 'received') {
                requestCount++;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-pink-900/40 border border-pink-500/50 p-2 rounded-lg';
                div.innerHTML = `
                    <span class="font-bold text-white text-sm truncate w-24">${data.nickname}</span>
                    <div class="flex gap-1">
                        <button onclick="acceptFriendRequest('${uid}', '${data.nickname}')" class="bg-green-600 text-white text-xs px-2 py-1 rounded hover:bg-green-500">ìˆ˜ë½</button>
                        <button onclick="cancelFriendRequest('${uid}', '${data.nickname}', true)" class="bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-500">ê±°ì ˆ</button>
                    </div>
                `;
                reqContainer.appendChild(div);

            } 
            // 2. ì´ë¯¸ ì¹œêµ¬ì¸ ê²½ìš°
            else if (status === 'accepted') {
                friendCount++;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition-colors';
                
                // âœ¨ ë‹‰ë„¤ì„ ë¶€ë¶„ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ + UID ì „ë‹¬
                // onclickì—ì„œ openOtherUserProfileì„ ë¶€ë¥¼ ë•Œ uid: '${uid}'ë¥¼ ê¼­ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
                div.innerHTML = `
                    <div class="flex items-center gap-3 cursor-pointer group" onclick="openOtherUserProfile({ nickname: '${data.nickname}', uid: '${uid}', representative: '${data.representative || ''}' })">
                        <div class="w-2 h-2 rounded-full bg-green-500 group-hover:bg-yellow-400 transition-colors"></div>
                        <span class="font-bold text-white group-hover:text-yellow-300 transition-colors">${data.nickname}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="visitFriendRoom('${uid}', '${data.nickname}')" class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs px-3 py-2 rounded font-bold shadow">ğŸ </button>
                        <button onclick="deleteFriend('${uid}', '${data.nickname}')" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-2 rounded font-bold shadow">âœ‚ï¸</button>
                    </div>
                `;
                friendContainer.appendChild(div);
            }
        });

        if (requestCount > 0) {
            reqSection.classList.remove('hidden');
            reqCount.textContent = requestCount;
        } else {
            reqSection.classList.add('hidden');
        }

        if (friendCount === 0) {
            friendContainer.innerHTML = '<p class="text-gray-500 text-center mt-4 text-sm">ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

    } catch (e) {
        console.error(e);
        friendContainer.innerHTML = '<p class="text-red-400 text-center">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</p>';
    }
}

// âœ… [ë””ë²„ê¹… ì¶”ê°€] íƒ€ ìœ ì € í”„ë¡œí•„ ëª¨ë‹¬
async function openOtherUserProfile(initialData) {
    const oldModal = document.getElementById('other-user-profile-modal');
    if (oldModal) oldModal.remove();

    let userData = initialData;
    
    try {
        document.body.style.cursor = 'wait';
        console.log(`ğŸ” [DEBUG] UID(${initialData.uid}) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`);
        
        const doc = await db.collection('users').doc(initialData.uid).get();
        if (doc.exists) {
            const dbData = doc.data();
            
            // ğŸ”¥ [ì—¬ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”] F12 ì½˜ì†”ì— ì´ ë¡œê·¸ê°€ ëœ° ê²ë‹ˆë‹¤.
            console.log("ğŸ”¥ [DEBUG] ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:", dbData);
            console.log("ğŸ“¦ [DEBUG] ì¸ë²¤í† ë¦¬ ê°œìˆ˜:", dbData.inventory ? dbData.inventory.length : "ì—†ìŒ");
            console.log("ğŸ‘¤ [DEBUG] í”„ë¡œí•„ ì„¤ì •:", dbData.profile);

            userData = { ...initialData, ...dbData };
        } else {
            console.warn("âš ï¸ [DEBUG] í•´ë‹¹ ìœ ì €ì˜ ë°ì´í„°ê°€ DBì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    } catch (e) {
        console.error("í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", e);
    } finally {
        document.body.style.cursor = 'default';
    }

    // -----------------------------------------------------------
    // âœ¨ [ì•ˆì „ì¥ì¹˜ ì¶”ê°€] í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ ì „ ë°ì´í„° ì •ì œ
    // inventoryê°€ nullì´ê±°ë‚˜ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ë§Œë“¤ì–´ì„œ ì˜¤ë¥˜ ë°©ì§€
    if (!userData.inventory) userData.inventory = [];
    if (!userData.profile) userData.profile = { repCardId: null };
    // -----------------------------------------------------------

    const nickname = userData.nickname || "ìµëª…ì˜ íƒì •";
    const statusMsg = (userData.profile && userData.profile.statusMessage) ? userData.profile.statusMessage : "ë“±ë¡ëœ í•œë§ˆë””ê°€ ì—†ìŠµë‹ˆë‹¤.";
    
    // í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ
    const { imgUrl, cardName } = getUserRepInfo(userData);

    const isMe = (currentUser && userData.uid === currentUser.uid);
    
    const friendBtnHTML = isMe ? '' : `
        <button onclick="sendFriendRequest('${userData.uid}', '${nickname}')" class="flex-1 gacha-button bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-lg shadow-lg transition-all border border-green-500">
            ğŸ¤ ì¹œêµ¬ ì¶”ê°€
        </button>
    `;

    const modal = document.createElement('div');
    modal.id = 'other-user-profile-modal';
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[100]';
    
    modal.innerHTML = `
        <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full relative border border-gray-600 shadow-2xl mx-4 animate-fadeIn">
            <button onclick="document.getElementById('other-user-profile-modal').remove()" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-300 mb-8 text-center">íƒì • í”„ë¡œí•„</h3>
            
            <div class="flex flex-col md:flex-row gap-8 items-start">
                <div class="w-full md:w-1/2 flex flex-col items-center">
                    <div class="relative w-full max-w-[240px] aspect-[2/3] bg-black/30 rounded-lg overflow-hidden border-4 border-gray-700 shadow-xl mb-4 group">
                        <img src="${imgUrl}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent pointer-events-none"></div>
                        <div class="absolute bottom-2 left-0 right-0 text-center">
                            <span class="inline-block bg-black/60 text-yellow-300 text-xs font-bold px-3 py-1 rounded-full border border-yellow-500/30">${cardName || 'ì¹´ë“œ ì •ë³´ ì—†ìŒ'}</span>
                        </div>
                    </div>
                </div>

                <div class="w-full md:w-1/2 flex flex-col justify-center space-y-6 py-2">
                    <div class="bg-black/20 p-4 rounded-lg border-l-4 border-indigo-500">
                        <p class="text-gray-400 text-xs font-bold mb-1 uppercase tracking-wider">Nickname</p>
                        <p class="text-white font-bold text-2xl tracking-tight">${nickname}</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wider ml-1">Status Message</p>
                        <div class="bg-black/30 p-6 rounded-xl text-gray-200 min-h-[120px] flex items-center justify-center relative border border-gray-700 shadow-inner">
                            <span class="text-6xl text-gray-700 absolute top-0 left-2 font-serif select-none leading-none">â€œ</span>
                            <p class="italic px-4 break-words w-full text-center text-lg font-serif leading-relaxed z-10">${statusMsg}</p>
                            <span class="text-6xl text-gray-700 absolute bottom-[-10px] right-2 font-serif select-none leading-none">â€</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                ${friendBtnHTML}
                <button onclick="document.getElementById('other-user-profile-modal').remove()" class="flex-1 gacha-button bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold text-lg shadow-lg transition-all border border-gray-600">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
		

// [ìˆ˜ì •] ë‹‰ë„¤ì„ ê²€ìƒ‰ í•¨ìˆ˜ (ê´€ê³„ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ìë™ ë³€ê²½)
async function searchUserByName() {
    const input = document.getElementById('friend-search-input');
    const resultBox = document.getElementById('friend-search-result');
    const resultAction = document.getElementById('search-result-action');
    const msg = document.getElementById('friend-search-msg');
    
    const nickname = input.value.trim();
    if (!nickname) return;

    msg.textContent = "ê²€ìƒ‰ ì¤‘...";
    resultBox.classList.add('hidden');

    try {
        const snapshot = await db.collection('users')
            .where('nickname', '==', nickname)
            .limit(1)
            .get();

        if (snapshot.empty) {
            msg.textContent = "í•´ë‹¹ ë‹‰ë„¤ì„ì˜ íƒì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        msg.textContent = "";
        const doc = snapshot.docs[0];
        const userData = doc.data();
        const uid = doc.id;
		const { imgUrl } = getUserRepInfo(userData);

        // --- âœ¨ [ì¶”ê°€] ê´€ê³„ ìƒíƒœ í™•ì¸ ë¡œì§ ---
        let relationStatus = 'none';
        if (currentUser && uid !== currentUser.uid) {
            const relDoc = await db.collection('users').doc(currentUser.uid).collection('friends').doc(uid).get();
            if (relDoc.exists) {
                relationStatus = relDoc.data().status || 'accepted';
            }
        }
        // -------------------------------------

    

        resultBox.classList.remove('hidden');
        
        // ë°•ìŠ¤ í´ë¦­ ì‹œ í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸°
        resultBox.onclick = () => openOtherUserProfile({ ...userData, uid: uid });
        resultBox.classList.add('cursor-pointer', 'hover:bg-gray-700', 'transition-colors');

        document.getElementById('search-result-img').src = imgUrl;
        document.getElementById('search-result-name').textContent = userData.nickname;
        document.getElementById('search-result-msg').textContent = userData.profile?.statusMessage || "ìƒíƒœ ë©”ì‹œì§€ ì—†ìŒ";

        // ë²„íŠ¼ ìƒíƒœ ë¶„ê¸° ì²˜ë¦¬
        if (uid === currentUser.uid) {
            resultAction.innerHTML = `<span class="text-yellow-500 text-xs font-bold">ë‚˜ (ë³¸ì¸)</span>`;
            resultBox.onclick = null;
            resultBox.classList.remove('cursor-pointer', 'hover:bg-gray-700');
        } 
        else if (relationStatus === 'accepted') {
            // ì´ë¯¸ ì¹œêµ¬ì¼ ë•Œ -> ë°©ë¬¸ ë²„íŠ¼ í‘œì‹œ
            resultAction.innerHTML = `
                <button onclick="event.stopPropagation(); visitFriendRoom('${uid}', '${userData.nickname}')" class="gacha-button bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md">
                    ğŸ  ë°©ë¬¸
                </button>`;
        }
        else if (relationStatus === 'sent') {
            // ìš”ì²­ ë³´ëƒ„
            resultAction.innerHTML = `<span class="text-gray-400 text-xs font-bold">âœ‰ï¸ ìš”ì²­í•¨</span>`;
        }
        else if (relationStatus === 'received') {
            // ìš”ì²­ ë°›ìŒ -> ìˆ˜ë½ ë²„íŠ¼
            resultAction.innerHTML = `
                <button onclick="event.stopPropagation(); acceptFriendRequest('${uid}', '${userData.nickname}')" class="gacha-button bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md animate-pulse">
                    âœ… ìˆ˜ë½
                </button>`;
        }
        else {
            // ë‚¨ë‚¨ -> ì¹œêµ¬ ì¶”ê°€ ë²„íŠ¼
            resultAction.innerHTML = `
                <button onclick="event.stopPropagation(); sendFriendRequest('${uid}', '${userData.nickname}')" class="gacha-button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md">
                    ì¹œêµ¬ ìš”ì²­
                </button>`;
        }

    } catch (e) {
        console.error(e);
        msg.textContent = "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
}


// âœ… [ìµœì¢… ìˆ˜ì •] ì¹œêµ¬ ë°© ë°©ë¬¸ í•¨ìˆ˜ (ë‚´ìš©ë¬¼ ì§ì ‘ êµì²´ ë°©ì‹)
let originalMyRoomData = null; // ë‚´ ë°© ë°ì´í„°ë¥¼ ì„ì‹œ ì €ì¥í•  ë³€ìˆ˜

async function visitFriendRoom(targetUid, targetNickname) {
    // 1. ë°°ì¹˜ ëª¨ë“œ ì¤‘ì´ë¼ë©´ ê°•ì œë¡œ ë„ê³  ì €ì¥
    if (typeof isEditMode !== 'undefined' && isEditMode) {
        toggleEditMode();
    }

    try {
        console.log(`[ë°©ë¬¸ ì‹œì‘] ${targetNickname} (${targetUid})`);

        // 2. ì¹œêµ¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const doc = await db.collection('users').doc(targetUid).get();
        if (!doc.exists) {
            alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìœ ì €ì…ë‹ˆë‹¤.");
            return;
        }

        const friendData = doc.data();
        const friendInventory = friendData.inventory || []; 
        
        // 3. ì¹œêµ¬ ë°© ë°ì´í„° ì¤€ë¹„ (ì—†ìœ¼ë©´ ë¹ˆ ë°©)
        let friendFurniture = [];
        let friendCharacters = [];

        if (friendData.myRoom) {
            // ê°€êµ¬ ë°ì´í„° ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
            if (Array.isArray(friendData.myRoom.furniture)) {
                friendFurniture = JSON.parse(JSON.stringify(friendData.myRoom.furniture));
            }

            // ìºë¦­í„° ë°ì´í„° ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
            if (Array.isArray(friendData.myRoom.characters)) {
                // ì €ì¥ëœ ID ëª©ë¡ì„ ì‹¤ì œ ìºë¦­í„° ê°ì²´ë¡œ ë³€í™˜
                friendCharacters = friendData.myRoom.characters
                    .map(id => friendInventory.find(c => c.id === id))
                    .filter(Boolean); // ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ ì œê±°
            }
        }
        
        console.log(`[ë°ì´í„° ë¡œë“œ ì™„ë£Œ] ê°€êµ¬: ${friendFurniture.length}ê°œ, ìºë¦­í„°: ${friendCharacters.length}ëª…`);

        // 4. ë‚´ ë°© ë°ì´í„° ë°±ì—… (ì•„ì§ ë°±ì—… ì•ˆ í–ˆë‹¤ë©´)
        if (!originalMyRoomData) {
            // í˜„ì¬ playerRoom ìƒíƒœë¥¼ ê¹Šì€ ë³µì‚¬ë¡œ ë°±ì—…
            originalMyRoomData = JSON.parse(JSON.stringify(playerRoom));
        }

        // âœ¨ [í•µì‹¬ ìˆ˜ì •] ê°ì²´ ìì²´ë¥¼ ë°”ê¾¸ì§€ ì•Šê³ , ì†ì„±ë§Œ ì¹œêµ¬ ë°ì´í„°ë¡œ ë®ì–´ì”ë‹ˆë‹¤.
        // ì´ë ‡ê²Œ í•˜ë©´ ì°¸ì¡° ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê³  í™•ì‹¤í•˜ê²Œ ë‚´ìš©ì´ ë°”ë€ë‹ˆë‹¤.
        playerRoom.furniture = friendFurniture;
        playerRoom.characters = friendCharacters;

        // 5. í™”ë©´ ì „í™˜ ë° ë Œë”ë§
        switchTab('myroom');
        
        // ë°©ë¬¸ ëª¨ë“œ UI í‘œì‹œ
        const overlay = document.getElementById('visit-mode-overlay');
        if (overlay) overlay.classList.remove('hidden');
      
        // ìˆ˜ì •/ìƒì /ë³´ê´€í•¨/ì…ì£¼ê´€ë¦¬ ë²„íŠ¼ ëª¨ë‘ ìˆ¨ê¸°ê¸°
        const editBtn = document.getElementById('myroom-edit-mode');
        const shopBtn = document.getElementById('open-furniture-shop');
        const storageBtn = document.getElementById('open-furniture-storage');
        const charSelectorBtn = document.querySelector('button[onclick="openMyRoomCharacterSelector()"]');

        if (editBtn) editBtn.classList.add('hidden');
        if (shopBtn) shopBtn.classList.add('hidden');
        if (storageBtn) storageBtn.classList.add('hidden');
        if (charSelectorBtn) charSelectorBtn.classList.add('hidden');

        // ë°© ë‹¤ì‹œ ê·¸ë¦¬ê¸° (í™•ì‹¤í•˜ê²Œ ë¹„ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¼)
        const roomLayer = document.getElementById('room-layer');
        if (roomLayer) roomLayer.innerHTML = ''; 
        
        displayMyRoom();
        
        showMessage(`${targetNickname}ë‹˜ì˜ ì‚¬ë¬´ì†Œì— ë°©ë¬¸í–ˆìŠµë‹ˆë‹¤.`, 'text-indigo-300', messageArea);

    } catch (e) {
        console.error("ë°©ë¬¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
        alert(`ë°©ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ${e.message}`);
        
        // ì˜¤ë¥˜ ë‚˜ë©´ ë‚´ ë°©ìœ¼ë¡œ ë³µêµ¬ ì‹œë„
        if (originalMyRoomData) exitVisitMode();
    }
}

// 5. ë°©ë¬¸ ì¢…ë£Œ (ë‚´ ë°©ìœ¼ë¡œ ëŒì•„ì˜¤ê¸°)
function exitVisitMode() {
    if (originalMyRoomData) {
        playerRoom = originalMyRoomData; // ë‚´ ë°ì´í„° ë³µêµ¬
        originalMyRoomData = null;
    }
    
    // UI ë³µêµ¬
    document.getElementById('visit-mode-overlay').classList.add('hidden');
    document.getElementById('myroom-edit-mode').classList.remove('hidden');
    document.getElementById('open-furniture-shop').classList.remove('hidden');
    document.getElementById('open-furniture-storage').classList.add('hidden'); // ì´ê±´ ì›ë˜ êº¼ì ¸ìˆìŒ
	
	// âœ¨ [ì¶”ê°€] ì…ì£¼ ê´€ë¦¬ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
    const charSelectorBtn = document.querySelector('button[onclick="openMyRoomCharacterSelector()"]');
    if(charSelectorBtn) charSelectorBtn.classList.remove('hidden');

    // ë‚´ ë°© ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    displayMyRoom();
    showMessage("ë‚˜ì˜ íƒì • ì‚¬ë¬´ì†Œë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤.", 'text-green-300', messageArea);
}

		
		// ================== ğŸ† ì´ë²¤íŠ¸ ë­í‚¹ ì‹œìŠ¤í…œ ==================
		
		

// 1. ë­í‚¹ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
async function openRankingModal() {
    // ëª¨ë‹¬ HTML ë™ì  ìƒì„± (ì—†ìœ¼ë©´ ë§Œë“¤ê¸°)
    let modal = document.getElementById('ranking-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'ranking-modal';
        modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden';
        modal.innerHTML = `
            <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full relative border border-yellow-500">
                <button onclick="document.getElementById('ranking-modal').classList.add('hidden')" class="absolute top-3 right-4 text-white text-2xl">&times;</button>
                <h3 class="text-2xl font-bold text-yellow-300 mb-2 text-center">ğŸ† ì´ë²¤íŠ¸ ë­í‚¹</h3>
                <p class="text-center text-gray-400 text-xs mb-4">ìˆœìœ„ëŠ” 'ëˆ„ì  íšë“ í¬ì¸íŠ¸' ê¸°ì¤€ì…ë‹ˆë‹¤.</p>
                
                <div class="flex justify-between items-center bg-indigo-900/50 p-3 rounded-lg mb-4 border border-indigo-500">
                    <span class="text-white font-bold">ë‚´ ëˆ„ì  ì ìˆ˜</span>
                    <span class="text-yellow-300 font-bold text-xl" id="my-ranking-score">0 P</span>
                </div>

                <div id="ranking-list" class="space-y-2 max-h-[60vh] overflow-y-auto bg-black/20 p-2 rounded-lg">
                    <p class="text-center text-gray-500 py-4">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    modal.classList.remove('hidden');
    document.getElementById('my-ranking-score').textContent = `${playerCumulativeEventPoints.toLocaleString()} P`;
    
    // ë­í‚¹ ë°ì´í„° ë¡œë“œ ì‹œì‘
    loadEventRankingData();
}



// âœ… [ìˆ˜ì •ë¨] ì´ë²¤íŠ¸ ë­í‚¹ ë¡œë“œ í•¨ìˆ˜ (í”„ë¡œí•„ ì¹´ë“œ ì ìš© ì™„ë£Œ)
async function loadEventRankingData() {
    const listContainer = document.getElementById('ranking-list');
    
    try {
        // Firestore ì¿¼ë¦¬ (ë³€ë™ ì—†ìŒ)
        const snapshot = await db.collection('users')
            .where('currentEventId', '==', CURRENT_EVENT_ID)
            .orderBy('cumulativeEventPoints', 'desc')
            .limit(20)
            .get();

        listContainer.innerHTML = '';
        
        if (snapshot.empty) {
            listContainer.innerHTML = '<p class="text-center text-gray-500">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        let rank = 1;
        snapshot.forEach(doc => {
            const data = doc.data();
            const isMe = (currentUser && doc.id === currentUser.uid);
            
            // ---------------------------------------------------------
            // âœ¨ [í•µì‹¬ ìˆ˜ì •] ê¸°ì¡´ì˜ ë³µì¡í•œ ì´ë¯¸ì§€ í™•ì¸ ë¡œì§ì„ 
            // í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ í•œ ì¤„ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
            // (ì´ í•¨ìˆ˜ê°€ 'í”„ë¡œí•„ ì¹´ë“œ' -> 'ëŒ€í‘œ ìºë¦­í„°' ìˆœìœ¼ë¡œ ì•Œì•„ì„œ ì°¾ì•„ì¤ë‹ˆë‹¤)
            // ---------------------------------------------------------
            const { imgUrl } = getUserRepInfo(data); 

            const div = document.createElement('div');
            
            // ë­í‚¹ ìŠ¤íƒ€ì¼ ì„¤ì • (ë³€ë™ ì—†ìŒ)
            let rankStyle = 'bg-gray-700 border-gray-600';
            let rankBadge = `<span class="font-bold w-6 text-center text-gray-400">${rank}</span>`;
            
            if (rank === 1) {
                rankStyle = 'bg-yellow-900/40 border-yellow-500';
                rankBadge = 'ğŸ¥‡';
            } else if (rank === 2) {
                rankStyle = 'bg-gray-400/20 border-gray-400';
                rankBadge = 'ğŸ¥ˆ';
            } else if (rank === 3) {
                rankStyle = 'bg-orange-900/40 border-orange-500';
                rankBadge = 'ğŸ¥‰';
            }

            if (isMe) rankStyle += ' ring-2 ring-blue-500';

            // í´ë¦­ ì´ë²¤íŠ¸ ë° ìŠ¤íƒ€ì¼
            div.className = `flex items-center gap-3 p-2 rounded border ${rankStyle} cursor-pointer hover:bg-white/10 transition-colors relative group`;
            div.onclick = () => openOtherUserProfile({ ...data, uid: doc.id });
            
            div.innerHTML = `
                <div class="text-xl">${rankBadge}</div>
                
                <img src="${imgUrl}" class="w-10 h-10 rounded object-cover bg-black border border-white/20">
                
                <div class="flex-grow">
                    <p class="text-sm font-bold text-white truncate max-w-[120px]">
                        ${data.nickname || 'ìµëª…ì˜ íƒì •'}
                    </p>
                    ${isMe ? '<span class="text-[10px] bg-blue-600 text-white px-1 rounded">ME</span>' : ''}
                </div>
                <div class="text-right">
                    <p class="text-yellow-300 font-bold text-sm">${(data.cumulativeEventPoints || 0).toLocaleString()} P</p>
                </div>
            `;
            listContainer.appendChild(div);
            rank++;
        });

    } catch (error) {
        console.error("ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:", error);
        
        if (error.message.includes('index')) {
             listContainer.innerHTML = `
                <div class="text-red-400 text-center text-sm p-2">
                    <p class="font-bold">âš ï¸ ì‹œìŠ¤í…œ ì„¤ì • í•„ìš”</p>
                    <p>ê°œë°œì ì½˜ì†”(F12)ì„ ì—´ì–´ Firestore ì¸ë±ìŠ¤ ìƒì„± ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.</p>
                </div>
            `;
        } else {
             listContainer.innerHTML = '<p class="text-center text-red-500">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
}

// [ì¶”ê°€] ì´ë²¤íŠ¸ í™ˆ í™”ë©´ì— TOP 3ë¥¼ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
async function loadRankingPreview() {
    const container = document.getElementById('ranking-preview-container');
    if (!container) return;

    try {
        // Top 3 ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const snapshot = await db.collection('users')
            .where('currentEventId', '==', CURRENT_EVENT_ID)
            .orderBy('cumulativeEventPoints', 'desc')
            .limit(3)
            .get();

        container.innerHTML = '';

        if (snapshot.empty) {
            container.innerHTML = '<p class="text-center text-gray-500 text-sm py-2">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // ë©”ë‹¬ ë° ìŠ¤íƒ€ì¼ ì„¤ì • (ê¸ˆ, ì€, ë™)
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        const borderColors = ['border-yellow-500', 'border-gray-400', 'border-orange-500'];
        const bgColors = ['bg-yellow-900/40', 'bg-gray-700/40', 'bg-orange-900/40'];
        const textColors = ['text-yellow-300', 'text-gray-300', 'text-orange-300'];

        let rank = 0;
        snapshot.forEach(doc => {
            const data = doc.data();
			const { imgUrl } = getUserRepInfo(data);
            const nickname = data.nickname || "ìµëª…ì˜ íƒì •";
            const score = (data.cumulativeEventPoints || 0).toLocaleString();

            const el = document.createElement('div');
            el.className = `flex items-center justify-between p-2 rounded border ${borderColors[rank] || 'border-gray-700'} ${bgColors[rank] || 'bg-gray-800'}`;
            
            el.innerHTML = `
                <div class="flex items-center gap-2 overflow-hidden">
                    <span class="text-xl">${medals[rank]}</span>
                    <span class="font-bold text-white text-sm truncate max-w-[120px]">${nickname}</span>
                </div>
                <span class="font-bold ${textColors[rank] || 'text-white'} text-sm">${score} P</span>
            `;
            container.appendChild(el);
            rank++;
        });

        // 3ëª… ë¯¸ë§Œì¼ ê²½ìš° ë¹ˆ ì¹¸ ì±„ìš°ê¸° (ì„ íƒì‚¬í•­)
        for (let i = rank; i < 3; i++) {
            const el = document.createElement('div');
            el.className = `flex items-center justify-between p-2 rounded border border-dashed border-gray-600 bg-white/5 opacity-50`;
            el.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-xl grayscale">${medals[i]}</span>
                    <span class="text-gray-400 text-sm">-</span>
                </div>
                <span class="text-gray-500 text-sm">0 P</span>
            `;
            container.appendChild(el);
        }

    } catch (e) {
        console.error("Top 3 ë¡œë“œ ì‹¤íŒ¨:", e);
        // ì¸ë±ìŠ¤ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬
        container.innerHTML = '<p class="text-center text-red-400 text-xs py-2">ë¡œë”© ì‹¤íŒ¨</p>';
    }
}
		
		// âœ¨ [ì‹ ê·œ] íŒë§¤ìê°€ ë§¡ê²¨ì§„ ì¹´ë“œë¥¼ ìˆ˜ë ¹í•˜ëŠ” í•¨ìˆ˜
        window.receiveTradeItem = async function(tradeId) {
            const tradeRef = db.collection('trades').doc(tradeId);
            const userRef = db.collection('users').doc(currentUser.uid);

            try {
                let receivedCard = null;

                await db.runTransaction(async (transaction) => {
                    const tradeDoc = await transaction.get(tradeRef);
                    if (!tradeDoc.exists) throw "ê±°ë˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
                    
                    const data = tradeDoc.data();
                    if (data.status !== 'waiting_claim') throw "ìˆ˜ë ¹í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.";
                    if (data.senderUid !== currentUser.uid) throw "ë³¸ì¸ì˜ ê±°ë˜ê°€ ì•„ë‹™ë‹ˆë‹¤.";

                    receivedCard = data.receivedCard;

                    // ë‚´ ì¸ë²¤í† ë¦¬ì— ì¹´ë“œ ì¶”ê°€
                    const userDoc = await transaction.get(userRef);
                    const newInventory = [...(userDoc.data().inventory || []), receivedCard];

                    transaction.update(userRef, { inventory: newInventory });
                    
                    // ê±°ë˜ ì™„ì „ ì¢…ë£Œ ì²˜ë¦¬ (ì‚­ì œí•˜ê±°ë‚˜ completedë¡œ ë³€ê²½)
                    transaction.update(tradeRef, { status: 'completed' });
                });

                alert(`[${receivedCard.name}] ìˆ˜ë ¹ ì™„ë£Œ!`);
                
                // ë¡œì»¬ ê°±ì‹ 
                playerInventory.push(receivedCard);
                loadMyTrades(); // ëª©ë¡ ê°±ì‹ 

            } catch (e) {
                console.error(e);
                alert("ìˆ˜ë ¹ ì‹¤íŒ¨: " + e);
            }
        };
		
		window.searchUserByName = searchUserByName;
    window.loadFriendList = loadFriendList;
    window.visitFriendRoom = visitFriendRoom;
    window.exitVisitMode = exitVisitMode;
    window.openOtherUserProfile = openOtherUserProfile;
    
    // ğŸ‘‡ ìƒˆë¡œ ë§Œë“  ìƒí˜¸ ì‘ìš© í•¨ìˆ˜ë“¤ ë“±ë¡
    window.sendFriendRequest = sendFriendRequest;
    window.acceptFriendRequest = acceptFriendRequest;
    window.cancelFriendRequest = cancelFriendRequest;
	window.deleteFriend = cancelFriendRequest;
	
	// âœ¨ [ì‹ ê·œ] ê±°ë˜ì†Œ ì•Œë¦¼ ë¦¬ìŠ¤ë„ˆ (ìˆ˜ë ¹ ëŒ€ê¸° ì¤‘ì¸ ê±°ë˜ê°€ ìˆìœ¼ë©´ ë°°ì§€ í‘œì‹œ)
function startTradeListener(uid) {
    db.collection('trades')
      .where('senderUid', '==', uid)           // ë‚´ê°€ ë³´ë‚¸ ê±°ë˜ ì¤‘
      .where('status', '==', 'waiting_claim')  // 'ìˆ˜ë ¹ ëŒ€ê¸°' ìƒíƒœì¸ ê²ƒë§Œ ê°ì‹œ
      .onSnapshot(snapshot => {
          const badge = document.getElementById('trade-badge');
          const count = snapshot.size; // ëŒ€ê¸° ì¤‘ì¸ ê±°ë˜ ê°œìˆ˜

          if (badge) {
              if (count > 0) {
                  badge.classList.remove('hidden'); // ë°°ì§€ ë³´ì´ê¸°
                  badge.textContent = count;        // ê°œìˆ˜ í‘œì‹œ (1, 2...)
              } else {
                  badge.classList.add('hidden');    // ë°°ì§€ ìˆ¨ê¸°ê¸°
              }
          }
      });
}
	
	// âœ¨ ì¹œêµ¬ ìš”ì²­ ì‹¤ì‹œê°„ ê°ì‹œ í•¨ìˆ˜
    function startFriendListener(uid) {
        db.collection('users').doc(uid).collection('friends')
          .where('status', '==', 'received') // 'ë°›ìŒ' ìƒíƒœì¸ ìš”ì²­ë§Œ ê°ì‹œ
          .onSnapshot(snapshot => {
              const count = snapshot.size; // ìš”ì²­ ê°œìˆ˜
              const badge = document.getElementById('main-friend-badge');
              
              if (badge) {
                  if (count > 0) {
                      badge.classList.remove('hidden'); // ë°°ì§€ ë³´ì´ê¸°
                      badge.textContent = count;
                  } else {
                      badge.classList.add('hidden'); // ë°°ì§€ ìˆ¨ê¸°ê¸°
                  }
              }

              // ë§Œì•½ í˜„ì¬ 'ì¹œêµ¬ íƒ­'ì„ ë³´ê³  ìˆë‹¤ë©´ ëª©ë¡ë„ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
              const friendsView = document.getElementById('friends-view');
              if (friendsView && !friendsView.classList.contains('hidden')) {
                  loadFriendList();
              }
          });
    }
	
	// âœ¨ ì—…ì  ë°°ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateAchievementBadge() {
        // 'unlocked' ìƒíƒœì¸(ë‹¬ì„±í–ˆì§€ë§Œ ë³´ìƒ ì•ˆ ë°›ì€) ì—…ì  ê°œìˆ˜ ì„¸ê¸°
        let count = 0;
        
        // ì „ì—­ ë³€ìˆ˜ achievements ë°°ì—´ì„ ìˆœíšŒ
        achievements.forEach(ach => {
            // playerAchievements ê°ì²´ì— í•´ë‹¹ IDê°€ ìˆê³ , ìƒíƒœê°€ 'unlocked'ì´ë©´ ì¹´ìš´íŠ¸
            if (playerAchievements[ach.id] === 'unlocked') {
                count++;
            }
        });

        const badge = document.getElementById('achievement-badge');
        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden'); // ë°°ì§€ ë³´ì´ê¸°
            } else {
                badge.classList.add('hidden');    // ë°°ì§€ ìˆ¨ê¸°ê¸°
            }
        }
    }
	
	// ================== âœ¨ ë§ˆì´ë£¸ ì…ì£¼ ê´€ë¦¬ ì‹œìŠ¤í…œ âœ¨ ==================

let tempMyRoomChars = new Set(); // ì„ íƒ ì¤‘ì¸ ìºë¦­í„° ID ì„ì‹œ ì €ì¥

// 1. ì…ì£¼ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
function openMyRoomCharacterSelector() {
    const modal = document.getElementById('myroom-char-selector-modal');
    const list = document.getElementById('myroom-char-list');
    
    // í˜„ì¬ ì„¤ì •ëœ ì…ì£¼ë¯¼ ëª©ë¡ì„ ì„ì‹œ ì €ì¥ì†Œì— ë³µì‚¬
    tempMyRoomChars = new Set(playerRoom.characters || []);
    
    // ìœ íš¨ì„± ê²€ì‚¬: ì¸ë²¤í† ë¦¬ì— ì—†ëŠ” ì¹´ë“œ ID(íŒŒì‡„ë¨)ëŠ” ì œê±°
    tempMyRoomChars.forEach(id => {
        if (!playerInventory.some(c => c.id === id)) tempMyRoomChars.delete(id);
    });

    updateMyRoomSelectorUI(); // í™”ë©´ ê·¸ë¦¬ê¸°
    modal.classList.remove('hidden');
}

let currentMyRoomFilter = 'All';

// [ìˆ˜ì •ë¨] ì…ì£¼ë¯¼ ì„ íƒì°½ UI ê·¸ë¦¬ê¸° (ìºë¦­í„°ë³„ ì •ë ¬ ì ìš©)
function updateMyRoomSelectorUI() {
    const list = document.getElementById('myroom-char-selector-modal').querySelector('#myroom-char-list');
    const countSpan = document.getElementById('myroom-selected-count');
    
    list.innerHTML = '';
    countSpan.textContent = `${tempMyRoomChars.size} / 5`;

    // 1. í•„í„°ë§ (ì„ íƒëœ ë“±ê¸‰ë§Œ ë‚¨ê¸°ê¸°)
    const filteredInv = playerInventory.filter(cardInstance => {
        if (currentMyRoomFilter === 'All') return true;
        const charData = findCharacter(cardInstance.name);
        return charData && charData.rarity === currentMyRoomFilter;
    });

    if (filteredInv.length === 0) {
        list.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">í•´ë‹¹ ë“±ê¸‰ì˜ ì…ì£¼ë¯¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        return;
    }

    // 2. âœ¨ ì •ë ¬ ë¡œì§ ë³€ê²½ (ìºë¦­í„° ì´ë¦„ -> ë“±ê¸‰ -> ë ˆë²¨)
    const sortedInv = [...filteredInv].sort((a, b) => {
        const charA = findCharacter(a.name);
        const charB = findCharacter(b.name);
        
        // ì•ˆì „ì¥ì¹˜
        if (!charA) return 1;
        if (!charB) return -1;

        // [1ìˆœìœ„] ìºë¦­í„° ê¸°ë³¸ ì´ë¦„(BaseName)ìœ¼ë¡œ ë¬¶ê¸° (ê°€ë‚˜ë‹¤ìˆœ)
        const nameComparison = charA.baseName.localeCompare(charB.baseName);
        if (nameComparison !== 0) return nameComparison;

        // [2ìˆœìœ„] ë“±ê¸‰ ë†’ì€ ìˆœ (SSR > SR > R > N)
        const rarityOrder = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1 };
        const rA = rarityOrder[charA.rarity] || 0;
        const rB = rarityOrder[charB.rarity] || 0;
        if (rA !== rB) return rB - rA;

        // [3ìˆœìœ„] ë ˆë²¨ ë†’ì€ ìˆœ
        return b.level - a.level;
    });

    // 3. ì¹´ë“œ ìƒì„±
    sortedInv.forEach(cardInstance => {
        const charData = findCharacter(cardInstance.name);
        if (!charData) return;

        const isSelected = tempMyRoomChars.has(cardInstance.id);
        
        const cardEl = document.createElement('div');
        cardEl.className = `relative cursor-pointer border-2 rounded-lg p-1 transition-all ${isSelected ? 'border-pink-500 bg-pink-900/40' : 'border-transparent bg-black/40 hover:bg-white/10'}`;
        
        // í´ë¦­ ì‹œ í† ê¸€
        cardEl.onclick = () => toggleMyRoomChar(cardInstance.id);

        cardEl.innerHTML = `
            <div class="aspect-[2/3] overflow-hidden rounded mb-1 relative pointer-events-none">
                <img src="${charData.imageUrl}" class="w-full h-full object-cover ${isSelected ? '' : 'opacity-70'}">
                ${isSelected ? '<div class="absolute inset-0 border-4 border-pink-500 rounded"></div><span class="absolute top-0 right-0 bg-pink-500 text-white text-xs font-bold px-1.5 py-0.5">V</span>' : ''}
                <span class="absolute bottom-0 right-0 bg-black/60 text-white text-[10px] px-1 rounded-tl">${charData.rarity}</span>
            </div>
            <p class="text-[10px] text-center text-white truncate">${cardInstance.name}</p>
        `;
        list.appendChild(cardEl);
    });
}

// 3. ìºë¦­í„° ì„ íƒ/í•´ì œ í† ê¸€
function toggleMyRoomChar(cardId) {
    if (tempMyRoomChars.has(cardId)) {
        tempMyRoomChars.delete(cardId);
    } else {
        if (tempMyRoomChars.size >= 5) {
            alert("ìµœëŒ€ 5ëª…ê¹Œì§€ë§Œ ì…ì£¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }
        tempMyRoomChars.add(cardId);
    }
    updateMyRoomSelectorUI(); // í™”ë©´ ê°±ì‹ 
}

// 4. ì €ì¥í•˜ê¸°
function saveMyRoomCharacters() {
    // ì„ì‹œ ì„ íƒ ëª©ë¡ì„ ì‹¤ì œ ë°ì´í„°ì— ë°˜ì˜ (ë°°ì—´ë¡œ ë³€í™˜)
    playerRoom.characters = Array.from(tempMyRoomChars);
    
    saveGame();
    displayMyRoom(); // ë§ˆì´ë£¸ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨ (ìºë¦­í„° ë³€ê²½ ë°˜ì˜)
    
    document.getElementById('myroom-char-selector-modal').classList.add('hidden');
    alert("ì…ì£¼ë¯¼ ëª…ë‹¨ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤!");
}

// âœ¨ HTML ë²„íŠ¼ì—ì„œ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ìˆë„ë¡ windowì— ë“±ë¡
window.openMyRoomCharacterSelector = openMyRoomCharacterSelector;
window.saveMyRoomCharacters = saveMyRoomCharacters;

// ================== ğŸ“© ìš°í¸í•¨(Mailbox) ì‹œìŠ¤í…œ ì‹œì‘ ==================

// 1. ìš°í¸í•¨ ì—´ê¸°
function openMailbox() {
    if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    
    const modal = document.getElementById('mailbox-modal');
    if (modal) {
        modal.classList.remove('hidden');
        loadMailboxList();
    } else {
        console.error("ìš°í¸í•¨ ëª¨ë‹¬(mailbox-modal)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HTMLì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}

// 2. ìš°í¸ ëª©ë¡ ë¡œë“œ
async function loadMailboxList() {
    const listContainer = document.getElementById('mailbox-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '<p class="text-center text-gray-500 mt-10">ìš°í¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

    try {
        const snapshot = await db.collection('users').doc(currentUser.uid)
            .collection('mailbox')
            .orderBy('createdAt', 'desc')
            .get();

        listContainer.innerHTML = '';

        if (snapshot.empty) {
            listContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-500 gap-2 py-10">
                    <span class="text-4xl">ğŸ“­</span>
                    <p>ìš°í¸í•¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                </div>`;
            return;
        }

        snapshot.forEach(doc => {
            const mail = doc.data();
            const mailId = doc.id;
            
            // ë³´ìƒ í…ìŠ¤íŠ¸ ìƒì„±
            let rewardText = [];
            if (mail.rewards) {
                if (mail.rewards.currency) rewardText.push(`ğŸ’ ${mail.rewards.currency}`);
                if (mail.rewards.fountainPens) rewardText.push(`ğŸ–‹ï¸ ${mail.rewards.fountainPens}`);
                if (mail.rewards.inkwells) rewardText.push(`ğŸ’§ ${mail.rewards.inkwells}`);
                if (mail.rewards.cardName) rewardText.push(`ğŸƒ ${mail.rewards.cardName}`);
                if (mail.rewards.customItem) rewardText.push(`ğŸ ${mail.rewards.customItem}`);
            }
            const rewardString = rewardText.length > 0 ? rewardText.join(' / ') : 'ì•ˆë‚´ ë©”ì‹œì§€';

            // ë‚ ì§œ í¬ë§·
            const date = mail.createdAt ? new Date(mail.createdAt.toDate()).toLocaleDateString() : '';

            const div = document.createElement('div');
            div.className = 'bg-gray-700/80 p-4 rounded-lg border border-gray-600 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 shadow-md hover:bg-gray-700 transition-colors mb-2';
            div.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-indigo-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold">SYSTEM</span>
                        <h4 class="font-bold text-white text-lg">${mail.title}</h4>
                    </div>
                    <p class="text-sm text-gray-300 mb-2 leading-relaxed whitespace-pre-wrap">${mail.content}</p>
                    <div class="bg-black/30 px-3 py-1.5 rounded inline-block">
                        <span class="text-yellow-300 font-bold text-sm">ë³´ìƒ: ${rewardString}</span>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">${date}</p>
                </div>
                <button onclick="claimMail('${mailId}')" class="gacha-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg whitespace-nowrap self-end sm:self-center shrink-0">
                    ë°›ê¸°
                </button>
            `;
            listContainer.appendChild(div);
        });

    } catch (e) {
        console.error(e);
        listContainer.innerHTML = '<p class="text-center text-red-400">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</p>';
    }
}

// 3. ìš°í¸ ë°›ê¸° (ë‹¨ì¼)
async function claimMail(mailId) {
    if (!currentUser) return;

    const userRef = db.collection('users').doc(currentUser.uid);
    const mailRef = userRef.collection('mailbox').doc(mailId);

    try {
        await db.runTransaction(async (transaction) => {
            const mailDoc = await transaction.get(mailRef);
            if (!mailDoc.exists) throw "ì´ë¯¸ ë°›ê±°ë‚˜ ì‚­ì œëœ ìš°í¸ì…ë‹ˆë‹¤.";
            
            const userData = (await transaction.get(userRef)).data();
            const mailData = mailDoc.data();
            const rewards = mailData.rewards || {};

            // 1. ì¬í™” ì§€ê¸‰
            let newCurrency = (userData.currency || 0) + (rewards.currency || 0);
            let newPens = (userData.fountainPens || 0) + (rewards.fountainPens || 0);
            let newInk = (userData.inkwells || 0) + (rewards.inkwells || 0);
            
            // 2. ì¹´ë“œ ì§€ê¸‰
            let newInventory = [...(userData.inventory || [])];
            if (rewards.cardName) {
                // ìƒˆ ì¹´ë“œ ê°ì²´ ìƒì„±
                const newCard = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    name: rewards.cardName,
                    level: 0,
                    revision: 0
                };
                newInventory.push(newCard);
            }

            // 3. DB ì—…ë°ì´íŠ¸
            transaction.update(userRef, {
                currency: newCurrency,
                fountainPens: newPens,
                inkwells: newInk,
                inventory: newInventory
            });

            // 4. ìš°í¸ ì‚­ì œ
            transaction.delete(mailRef);

            // 5. ë¡œì»¬ ë°ì´í„° ë™ê¸°í™”
            playerCurrency = newCurrency;
            playerFountainPens = newPens;
            playerInkwells = newInk;
            playerInventory = newInventory;
            if (rewards.cardName) {
                collectedCardNames.add(rewards.cardName);
                // saveGameToFirebase(); // íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì €ì¥ë˜ë¯€ë¡œ ìƒëµ ê°€ëŠ¥í•˜ë‚˜ ì•ˆì „í•˜ê²Œ í˜¸ì¶œ ê°€ëŠ¥
            }
        });

        alert("ë³´ìƒì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤!");
        updateUI(); 
        loadMailboxList(); 
        saveGame(); // ë¡œì»¬ ë³€ê²½ì‚¬í•­ ìµœì¢… ì €ì¥

    } catch (e) {
        console.error(e);
        alert("ìˆ˜ë ¹ ì‹¤íŒ¨: " + e);
    }
}

// 4. ëª¨ë‘ ë°›ê¸°
async function claimAllMails() {
    const list = document.getElementById('mailbox-list');
    const buttons = list ? list.querySelectorAll('button') : [];
    
    if (buttons.length === 0) return alert("ìˆ˜ë ¹í•  ìš°í¸ì´ ì—†ìŠµë‹ˆë‹¤.");
    if (!confirm(`ì´ ${buttons.length}ê°œì˜ ìš°í¸ì„ ëª¨ë‘ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    const snapshot = await db.collection('users').doc(currentUser.uid).collection('mailbox').get();
    
    let successCount = 0;
    for (const doc of snapshot.docs) {
        try {
            await claimMail(doc.id);
            successCount++;
        } catch(e) {
            console.error("ê°œë³„ ìˆ˜ë ¹ ì‹¤íŒ¨", e);
        }
    }
}

// 5. ìš°í¸í•¨ ì‹¤ì‹œê°„ ê°ì‹œ (ë°°ì§€ìš©)
function startMailListener(uid) {
    db.collection('users').doc(uid).collection('mailbox')
      .onSnapshot(snapshot => {
          const count = snapshot.size;
          const badge = document.getElementById('mail-badge');
          if (badge) {
              if (count > 0) {
                  badge.classList.remove('hidden');
                  badge.textContent = count > 99 ? '99+' : count;
              } else {
                  badge.classList.add('hidden');
              }
          }
          
          // ìš°í¸í•¨ ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ëª©ë¡ë„ ê°±ì‹ 
          const modal = document.getElementById('mailbox-modal');
          if (modal && !modal.classList.contains('hidden')) {
              loadMailboxList(); 
          }
      });
}
window.openMailbox = openMailbox;
    window.claimMail = claimMail;
    window.claimAllMails = claimAllMails;

// ================== ğŸ“© ìš°í¸í•¨ ì‹œìŠ¤í…œ ë ==================



async function checkAndProcessSystemMails(uid) {
    const now = new Date();
    const batch = db.batch();
    const userRef = db.collection('users').doc(uid);
    let newMailCount = 0;

    // 1. ì‹œíŠ¸ì— ìˆëŠ” ëª¨ë“  ë©”ì¼ì„ ìˆœíšŒ
    systemMails.forEach(mail => {
        // (A) ê¸°ê°„ ì²´í¬
        if (now < mail.startDate || now > mail.endDate) return;

        // (B) íƒ€ê²Ÿ ì²´í¬ (ALL ì´ê±°ë‚˜ ë‚´ UIDì—¬ì•¼ í•¨)
        if (mail.target !== 'ALL' && mail.target !== uid) return;

        // (C) ì´ë¯¸ ë°›ì€ ë©”ì¼ì¸ì§€ ì²´í¬ (History ë°°ì—´ í™•ì¸)
        if (playerSystemMailHistory.includes(mail.id)) return;

        // --- ì¡°ê±´ ë§Œì¡±! ë°›ì„ ë©”ì¼ì„ ---
        
        // 2. Firebase ìš°í¸í•¨ì— ì¶”ê°€
        const newMailRef = userRef.collection('mailbox').doc(); // ìë™ ID ìƒì„±
        batch.set(newMailRef, {
            title: mail.title,
            content: mail.content,
            rewards: mail.rewards,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            fromSystemId: mail.id // ì¶”ì ìš© ID
        });

        // 3. ë¡œì»¬ ê¸°ë¡ ë° ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        playerSystemMailHistory.push(mail.id);
        newMailCount++;
    });

    // 4. ë°›ì„ ë©”ì¼ì´ ìˆë‹¤ë©´ DBì— í•œêº¼ë²ˆì— ì €ì¥ (Batch)
    if (newMailCount > 0) {
        // ìœ ì € ì •ë³´ì— 'ìˆ˜ë ¹ ê¸°ë¡(systemMailHistory)' ì—…ë°ì´íŠ¸
        batch.update(userRef, { 
            systemMailHistory: playerSystemMailHistory 
        });

        try {
            await batch.commit();
            console.log(`ğŸ“­ ì‹œìŠ¤í…œ ìš°í¸ ${newMailCount}ê°œê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`);
            
            // ë°°ì§€ ì•Œë¦¼ ê°±ì‹ ì„ ìœ„í•´ ë¦¬ìŠ¤ë„ˆê°€ ì‘ë™í•˜ê² ì§€ë§Œ, ì¦‰ê° ë°˜ì‘ì„ ìœ„í•´ ì•Œë¦¼ ë„ìš°ê¸°
            // (toastNotificationì´ ìˆë‹¤ë©´ í™œìš©)
            const toast = document.getElementById('toast-notification');
            if(toast) {
                toast.textContent = `ğŸ“© ìƒˆë¡œìš´ ìš´ì˜ì ìš°í¸ì´ ${newMailCount}í†µ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            }
        } catch (e) {
            console.error("ì‹œìŠ¤í…œ ìš°í¸ ë™ê¸°í™” ì‹¤íŒ¨:", e);
        }
    }
}
// âœ… [ì‹ ê·œ] 1ë¶„ë§ˆë‹¤ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•´ì„œ ìƒˆ ìš°í¸ì´ ìˆìœ¼ë©´ ë°°ë‹¬í•˜ëŠ” í•¨ìˆ˜
function startPeriodicMailCheck(uid) {
    // ì´ë¯¸ íƒ€ì´ë¨¸ê°€ ëŒê³  ìˆë‹¤ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (window.mailCheckInterval) clearInterval(window.mailCheckInterval);

    console.log("ğŸ“® ìë™ ìš°í¸ ì²´í¬ ì‹œìŠ¤í…œì´ ê°€ë™ë˜ì—ˆìŠµë‹ˆë‹¤. (1ë¶„ ì£¼ê¸°)");

    window.mailCheckInterval = setInterval(async () => {
        if (!uid) return;
        
        try {
            // 1. êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ëª°ë˜ ìƒˆë¡œê³ ì¹¨
            const response = await fetch(GOOGLE_SHEET_URL);
            const data = await response.json();
            
            // ë‚ ì§œ ë³€í™˜ í—¬í¼ (ë‚´ë¶€ìš©)
            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                return new Date(String(dateStr).replace(' ', 'T'));
            };

            // 2. ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            if (data.systemMails) {
                systemMails = data.systemMails.map(row => ({
                    id: row.id,
                    target: row.target,
                    title: row.title,
                    content: row.content,
                    rewards: row.rewards ? JSON.parse(row.rewards) : {},
                    startDate: parseDate(row.startDate),
                    endDate: parseDate(row.endDate)
                }));
            }

            // 3. ë‚´ ìš°í¸í•¨ê³¼ ë¹„êµí•´ì„œ ì•ˆ ë°›ì€ ê±° ë„£ê¸°
            await checkAndProcessSystemMails(uid);
            
        } catch (e) {
            console.warn("ìë™ ìš°í¸ ì²´í¬ ì¤‘ ì˜¤ë¥˜(ë„¤íŠ¸ì›Œí¬ ë“±):", e);
        }
    }, 60 * 1000); // 60ì´ˆ(1ë¶„) ë§ˆë‹¤ ì‹¤í–‰
}
// yumecan.html - <script> ì„¹ì…˜ (loadRaidRankingData í•¨ìˆ˜ ê·¼ì²˜ì— ì¶”ê°€)

// âœ… [ìˆ˜ì •ë¨] ë ˆì´ë“œ ë­í‚¹ í”„ë¦¬ë·° (Top 5, í˜„ì¬ ë³´ìŠ¤ ì‹œì¦Œ í•„í„°ë§)
async function loadRaidRankingPreview() {
    // í˜„ì¬ ì´ë²¤íŠ¸ IDê°€ ì—†ê±°ë‚˜, ë³´ìŠ¤ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¤‘ë‹¨
    if (!CURRENT_EVENT_ID || !raidBossData) return;
    
    const container = document.getElementById('raid-ranking-preview-container');
    if (!container) return;

    container.innerHTML = '<p class="text-center text-gray-500 py-2">ìˆœìœ„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

    try {
        // âœ¨ [í•µì‹¬] í˜„ì¬ ë³´ìŠ¤ ID(lastRaidSpawnId)ì™€ ì¼ì¹˜í•˜ëŠ” ê¸°ë¡ë§Œ ê°€ì ¸ì˜´
        const snapshot = await db.collection('users')
            .where('currentEventId', '==', CURRENT_EVENT_ID)
            .where('lastRaidSpawnId', '==', raidBossData.spawnId) // í•„í„° ì¶”ê°€
            .orderBy('raidCumulativeDamage', 'desc')
            .limit(5) 
            .get();
        
        container.innerHTML = '';

        if (snapshot.empty) {
            container.innerHTML = '<p class="text-center text-gray-500 text-sm py-2">ì•„ì§ ì°¸ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        let rank = 1;
        snapshot.forEach(doc => {
            const data = doc.data();
            const isMe = (currentUser && doc.id === currentUser.uid);
            
            const score = (data.raidCumulativeDamage || 0).toLocaleString();
            
            const div = document.createElement('div');
            
            // ë­í‚¹ë³„ ìŠ¤íƒ€ì¼ ì„¤ì •
            const rankStyle = rank === 1 ? 'border-yellow-400 bg-yellow-900/30' : (isMe ? 'border-blue-500 bg-blue-900/30' : 'border-gray-700 bg-black/30');

            div.className = `flex justify-between items-center p-3 rounded-lg border ${rankStyle}`;
            
            // ë­í¬ ë°°ì§€ ì„¤ì •
            let rankBadge = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : rank));

            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="font-bold text-lg text-yellow-300 w-6 text-center">${rankBadge}</span>
                    <span class="font-bold text-white truncate max-w-[150px]">${data.nickname || 'ìµëª…ì˜ íƒì •'}</span>
                </div>
                <span class="font-bold text-red-300 text-sm">${score} DAM</span>
            `;
            container.appendChild(div);
            rank++;
        });

    } catch (e) {
        console.error("ë ˆì´ë“œ ë­í‚¹ í”„ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:", e);
        
        // ì¸ë±ìŠ¤ ì—ëŸ¬ê°€ ë°œìƒí•´ë„ í”„ë¦¬ë·° ì˜ì—­ì€ ì¡°ìš©íˆ ì‹¤íŒ¨ ë©”ì‹œì§€ë§Œ ë„ì›€
        if (e.message.includes('index')) {
            container.innerHTML = '<p class="text-center text-red-400 text-xs py-2">ì‹œìŠ¤í…œ: ì¸ë±ìŠ¤ ìƒì„± í•„ìš” (F12 í™•ì¸)</p>';
        } else {
            container.innerHTML = '<p class="text-center text-red-400 text-xs py-2">ë¡œë”© ì‹¤íŒ¨</p>';
        }
    }
}

// ================== ğŸ‘‡ ë ˆì´ë“œ ì‹œìŠ¤í…œ ë¡œì§ ì‹œì‘ ğŸ‘‡ ==================


// 1. ì´ë²¤íŠ¸ íƒ­ ì „í™˜ ê¸°ëŠ¥ (ë ˆì´ë“œ íƒ­ í¬í•¨)

// ë ˆì´ë“œ íƒ­ ë²„íŠ¼ í´ë¦­ ì‹œ
eventSubTabRaid.addEventListener('click', () => {
    // íƒ­ UI ì „í™˜
    displayEventView(); // ë‹¤ë¥¸ ë·° ìˆ¨ê¸°ê¸° ìœ„í•œ í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ (ê¸°ì¡´ í•¨ìˆ˜ ì¬í™œìš©)
    switchSubTab(document.getElementById('event-view'), eventSubTabRaid);
    
    // ë ˆì´ë“œ ë·° ë³´ì´ê¸°
    document.getElementById('event-raid-view').classList.remove('hidden');
    
    // ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì‹œì‘
    initRaidListener();
});

// ì´ë²¤íŠ¸ í™ˆ -> ë ˆì´ë“œ ì…ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById('goto-event-raid').addEventListener('click', () => {
    document.getElementById('event-home-view').classList.add('hidden');
    document.getElementById('event-view').classList.remove('hidden');
    
    // ë ˆì´ë“œ íƒ­ í™œì„±í™”
    displayEventView(); // ì´ˆê¸°í™”
    switchSubTab(document.getElementById('event-view'), eventSubTabRaid);
    document.getElementById('event-raid-view').classList.remove('hidden');
    
    initRaidListener();
});

// 2. Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
function initRaidListener() {
    if (raidUnsubscribe) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ íŒ¨ìŠ¤

    // 'system' ì»¬ë ‰ì…˜ì˜ 'raid_boss' ë¬¸ì„œë¥¼ êµ¬ë…
    raidUnsubscribe = db.collection('system').doc('raid_boss')
        .onSnapshot((doc) => {
            if (doc.exists) {
                raidBossData = doc.data();
                updateRaidUI();
            } else {
                console.log("ë³´ìŠ¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
}

// 3. UI ì—…ë°ì´íŠ¸
// yumecan.html - updateRaidUI í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” (7979í–‰ ê·¼ì²˜)
function updateRaidUI() {
    if (!raidBossData) return;
    
    const nameEl = document.getElementById('raid-boss-name');
    const imgEl = document.getElementById('raid-boss-image');
    const hpBar = document.getElementById('raid-boss-hp-bar');
    const hpText = document.getElementById('raid-boss-hp-text');
    // âœ… [ìˆ˜ì •] ë²„íŠ¼ IDë¥¼ raid-start-btnìœ¼ë¡œ ë³€ê²½
    const btn = document.getElementById('raid-start-btn'); 

    nameEl.textContent = `Lv.${raidBossData.level} ${raidBossData.name}`;
    imgEl.src = raidBossData.imageUrl;
    
    // HP í¼ì„¼íŠ¸ ê³„ì‚°
    const percent = Math.max(0, (raidBossData.currentHp / raidBossData.maxHp) * 100);
    hpBar.style.width = `${percent}%`;
    hpText.textContent = `${raidBossData.currentHp.toLocaleString()} / ${raidBossData.maxHp.toLocaleString()}`;

    // ë³´ìŠ¤ ì²˜ì¹˜ ìƒíƒœ ì²˜ë¦¬
    if (btn) { // âœ… [ì•ˆì „ì¥ì¹˜] ë²„íŠ¼ ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
        if (raidBossData.currentHp <= 0) {
            btn.disabled = true;
            btn.textContent = "í† ë²Œ ì™„ë£Œ";
            btn.classList.add('bg-gray-600', 'cursor-not-allowed');
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            imgEl.style.filter = "grayscale(100%) opacity(0.6)";
            nameEl.textContent += " (ê²©íŒŒë¨)";
        } else {
            // ë ˆì´ë“œ íšŸìˆ˜ ì œí•œ ë¡œì§ì€ updateRaidDailyCountUIê°€ ì²˜ë¦¬í•´ì•¼ í•˜ì§€ë§Œ, 
            // ê¸°ë³¸ ìŠ¤íƒ€ì¼ì€ ì—¬ê¸°ì„œ ì„¤ì •í•´ ë‘¡ë‹ˆë‹¤.
            if (!btn.disabled) {
                btn.classList.remove('bg-gray-600', 'cursor-not-allowed');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.textContent = "âš”ï¸ ì „íˆ¬ ê°œì‹œ";
            }
            imgEl.style.filter = "none";
        }
    }
    
    // âœ… [ì¶”ê°€] ë ˆì´ë“œ íšŸìˆ˜ UIë„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    updateRaidDailyCountUI(); 
    loadRaidRankingPreview();
}

// 4. ì „íˆ¬ ì‹œì‘ íŠ¸ë¦¬ê±°
function startRaidBattle() {
// ğŸ”’ ë ˆì´ë“œ ì…ì¥ ì œí•œ
    // âœ… [ìˆ˜ì •] ì œí•œ ì²´í¬ë¥¼ ì—¬ê¸°ì„œ ë¨¼ì € ì‹¤í–‰í•©ë‹ˆë‹¤.
    if (playerRaidDailyCount >= 5) { 
        alert("âš ï¸ ì˜¤ëŠ˜ì˜ ë ˆì´ë“œ ì°¸ì—¬ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\në‚´ì¼ ë‹¤ì‹œ ë„ì „í•´ì£¼ì„¸ìš”!");
        return;
    }
    if (!raidBossData || raidBossData.currentHp <= 0) return alert("ì „íˆ¬ ê°€ëŠ¥í•œ ë³´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
    if (playerDeck.length < 5) return alert("ë±ì— 5ëª…ì˜ íƒì •ì„ ëª¨ë‘ í¸ì„±í•´ì•¼ í•©ë‹ˆë‹¤.");
    
    // ë ˆì´ë“œ ëª¨ë“œë¡œ ì „íˆ¬ ì‹œì‘
    startCombat(null, 'raid');
}
window.startRaidBattle = startRaidBattle;

// âœ¨ [ì‹ ê·œ] ì´ë²¤íŠ¸ ë­í‚¹ ë³´ìƒ ë¶„ë°° í•¨ìˆ˜ (ì¢…ë£Œëœ ì´ë²¤íŠ¸ ì²˜ë¦¬)
async function distributeEventRewards(eventId, eventTitle) {
    console.log(`ğŸ [${eventTitle}] ë­í‚¹ ë³´ìƒ ë¶„ë°° ì‹œì‘...`);
    
    try {
        // 1. í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ì°¸ê°€ì ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸° (ì´ë²¤íŠ¸ í¬ì¸íŠ¸ ìˆœ)
        // (ì£¼ì˜: ì´ë¯¸ ì¢…ë£Œëœ ì´ë²¤íŠ¸ë¼ currentEventIdê°€ ë°”ë€Œì—ˆì„ ìˆ˜ ìˆì§€ë§Œ, 
        //  DBì—ëŠ” ê¸°ë¡ì´ ë‚¨ì•„ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì¿¼ë¦¬í•©ë‹ˆë‹¤.)
        const snapshot = await db.collection('users')
            .where('currentEventId', '==', eventId)
            .orderBy('cumulativeEventPoints', 'desc') // ëˆ„ì  í¬ì¸íŠ¸ ê¸°ì¤€
            .limit(500) 
            .get();

        if (snapshot.empty) {
            console.log("ì°¸ì—¬ìê°€ ì—†ì–´ ë³´ìƒì„ ë¶„ë°°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        const batch = db.batch();
        let count = 0;
        let currentRank = 1; 

        // 2. ìˆœìœ„ë³„ ìš°í¸ ìƒì„±
        snapshot.docs.forEach(doc => {
            const userData = doc.data();
            
            // í¬ì¸íŠ¸ê°€ ì—†ëŠ” ìœ ì € ì œì™¸
            if (!userData.cumulativeEventPoints || userData.cumulativeEventPoints <= 0) return;

            const rank = currentRank++;
            let rewardData = null;

            if (rank === 1) rewardData = EVENT_RANK_REWARDS[1];
            else if (rank === 2) rewardData = EVENT_RANK_REWARDS[2];
            else if (rank === 3) rewardData = EVENT_RANK_REWARDS[3];
            else if (rank <= 10) rewardData = EVENT_RANK_REWARDS.top10;
            else if (rank <= 50) rewardData = EVENT_RANK_REWARDS.top50;
            else rewardData = EVENT_RANK_REWARDS.participation;

            const mailRef = db.collection('users').doc(doc.id).collection('mailbox').doc();
            const scoreStr = userData.cumulativeEventPoints.toLocaleString();

            batch.set(mailRef, {
                title: `[ì´ë²¤íŠ¸ ì¢…ë£Œ] ${eventTitle}`,
                content: `${eventTitle} ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¹ì‹ ì˜ ìµœì¢… ìˆœìœ„ëŠ” ${rank}ìœ„ ì…ë‹ˆë‹¤.\n(ëˆ„ì  í¬ì¸íŠ¸: ${scoreStr} P)`,
                rewards: {
                    currency: rewardData.currency,
                    fountainPens: rewardData.fountainPens
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                fromSystem: true
            });
            count++;
        });

        // 3. ì¼ê´„ ì „ì†¡
        await batch.commit();
        console.log(`âœ… [${eventTitle}] ì´ ${count}ëª…ì—ê²Œ ë­í‚¹ ë³´ìƒ ë°œì†¡ ì™„ë£Œ.`);
        
        // (ìš´ì˜ì/ìµœì´ˆ ì ‘ì†ìì—ê²Œë§Œ ë³´ì´ëŠ” ë©”ì‹œì§€)
        showMessage(`ì§€ë‚œ ì´ë²¤íŠ¸ [${eventTitle}]ì˜ ë³´ìƒ ì •ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, "text-yellow-300", messageArea);

    } catch (e) {
        console.error("ì´ë²¤íŠ¸ ë³´ìƒ ë¶„ë°° ì¤‘ ì˜¤ë¥˜:", e);
        if (e.message.includes('index')) {
            alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜: ì´ë²¤íŠ¸ ë­í‚¹ ì¸ë±ìŠ¤ ìƒì„± í•„ìš” (ì½˜ì†” í™•ì¸)");
        }
    }
}

		// âœ… [ì‹ ê·œ] ìœ ì €ì˜ ëŒ€í‘œ ì •ë³´(ì´ë¯¸ì§€, ì´ë¦„)ë¥¼ ê²°ì •í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
// (í”„ë¡œí•„ ì„¤ì • ì¹´ë“œ ìš°ì„  -> ì—†ìœ¼ë©´ ë©”ì¸ í™ˆ ìºë¦­í„° ì‚¬ìš©)
function getUserRepInfo(userData) {
    let imgUrl = "https://placehold.co/50x50/333/fff?text=?";
    let cardName = "";

    // 1ìˆœìœ„: í”„ë¡œí•„ ë©”ë‰´ì—ì„œ ì„¤ì •í•œ ì¹´ë“œ (repCardId)
    // ì¸ë²¤í† ë¦¬ ì •ë³´ê°€ ìˆì–´ì•¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    if (userData.profile && userData.profile.repCardId && userData.inventory) {
        const profileCard = userData.inventory.find(c => c.id === userData.profile.repCardId);
        if (profileCard) {
            const charData = findCharacter(profileCard.name);
            if (charData) {
                return { 
                    imgUrl: charData.imageUrl, 
                    cardName: `[${charData.rarity}] ${charData.name}` 
                };
            }
        }
    }

    // 2ìˆœìœ„: ë©”ì¸ í™ˆ ìºë¦­í„° (representative)
    if (userData.representative) {
        const charData = findCharacter(userData.representative);
        if (charData) {
            return { 
                imgUrl: charData.imageUrl, 
                cardName: `[${charData.rarity}] ${charData.name}` 
            };
        }
    }

    // ì •ë³´ ì—†ìŒ
    return { imgUrl, cardName };
}

// âœ… [ìˆ˜ì •ë¨] ë ˆì´ë“œ ë³´ìƒ ë¶„ë°° í•¨ìˆ˜ (NaN ì˜¤ë¥˜ ìˆ˜ì • + ì•ˆì „í•œ ë­í‚¹ ê³„ì‚°)
async function distributeRaidRewards(bossName) {
    console.log("ğŸ ë ˆì´ë“œ ë³´ìƒ ë¶„ë°° ì‹œì‘...");
    
    try {
        // 1. í˜„ì¬ ì´ë²¤íŠ¸ì˜ ë ˆì´ë“œ ì°¸ì—¬ì ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸°
        const snapshot = await db.collection('users')
            .where('currentEventId', '==', CURRENT_EVENT_ID)
            .orderBy('raidCumulativeDamage', 'desc')
            .limit(500) 
            .get();

        if (snapshot.empty) {
            console.log("ì°¸ì—¬ìê°€ ì—†ì–´ ë³´ìƒì„ ë¶„ë°°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        const batch = db.batch();
        let count = 0;
        let currentRank = 1; // âœ¨ ìˆœìœ„ë¥¼ ì§ì ‘ ì¹´ìš´íŒ…í•˜ëŠ” ë³€ìˆ˜ ìƒì„±

        // 2. ìˆœìœ„ë³„ ë³´ìƒ ìš°í¸ ìƒì„±
        snapshot.docs.forEach(doc => { // .docsë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©
            const userData = doc.data();
            
            // ë°ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ 0ì¸ ìœ ì €ëŠ” ê±´ë„ˆëœ€
            if (!userData.raidCumulativeDamage || userData.raidCumulativeDamage <= 0) return;

            // âœ¨ index ëŒ€ì‹  ì§ì ‘ ë³€ìˆ˜ ì‚¬ìš© (NaN ë°©ì§€)
            const rank = currentRank++; 
            
            let rewardData = null;

            // ìˆœìœ„ë³„ ë³´ìƒ ê²°ì • (ì„¤ì •ëœ ë³€ìˆ˜ ì‚¬ìš©)
            if (rank === 1) rewardData = RAID_RANK_REWARDS[1];
            else if (rank === 2) rewardData = RAID_RANK_REWARDS[2];
            else if (rank === 3) rewardData = RAID_RANK_REWARDS[3];
            else if (rank <= 5) rewardData = RAID_RANK_REWARDS.top5;
            else rewardData = RAID_RANK_REWARDS.participation;

            // ìš°í¸ ë¬¸ì„œ ìƒì„±
            const mailRef = db.collection('users').doc(doc.id).collection('mailbox').doc();
            
            // ìˆ«ì ì½¤ë§ˆ ì°ê¸° (ì˜ˆ: 3502 -> 3,502)
            const damageStr = (userData.raidCumulativeDamage || 0).toLocaleString();

            batch.set(mailRef, {
                title: `[í† ë²Œ ì„±ê³µ] ${bossName}`,
                content: `${bossName} í† ë²Œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!\në‹¹ì‹ ì˜ ê¸°ì—¬ë„ ìˆœìœ„ëŠ” ${rank}ìœ„ ì…ë‹ˆë‹¤.\n(ëˆ„ì  í”¼í•´ëŸ‰: ${damageStr})`,
                rewards: {
                    currency: rewardData.currency,
                    fountainPens: rewardData.fountainPens
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                fromSystem: true
            });
            count++;
        });

        // 3. ì¼ê´„ ì „ì†¡
        await batch.commit();
        console.log(`âœ… ì´ ${count}ëª…ì—ê²Œ ë ˆì´ë“œ ë³´ìƒ ìš°í¸ ë°œì†¡ ì™„ë£Œ.`);
        
        showMessage(`ë³´ìŠ¤ í† ë²Œ í™•ì¸! ${count}ëª…ì—ê²Œ ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.`, "text-yellow-300", messageArea);

    } catch (e) {
        console.error("ë³´ìƒ ë¶„ë°° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
        
        // âš ï¸ ì—¬ê¸°ì„œ ì¸ë±ìŠ¤ ì—ëŸ¬ì¸ì§€ í™•ì¸í•˜ì—¬ ì•Œë¦¼ì„ ë„ì›Œì¤ë‹ˆë‹¤.
        if (e.message.includes('index')) {
            alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜: Firebase ìƒ‰ì¸(Index) ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.\nê°œë°œì ë„êµ¬(F12) ì½˜ì†”ì˜ ë§í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }
    }
}

// âœ… [ìˆ˜ì •ë¨] ë ˆì´ë“œ ê³µê²© í•¨ìˆ˜ (ìƒˆ ë³´ìŠ¤ë©´ ì ìˆ˜ ë¦¬ì…‹)
async function submitRaidDamage(damage) {
    if (damage <= 0) return;
    if (!currentUser) return alert("ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

    const DAILY_LIMIT = 5;           
    const bossRef = db.collection('system').doc('raid_boss');
    const userRef = db.collection('users').doc(currentUser.uid);
    
    let finalCount = null;
    let calculatedReward = 0;
    const REWARD_PER_100_DAMAGE = 1; 
    const MAX_REWARD = 50;           
    
    let triggerRewardDistribution = false;
    let bossNameForReward = "Unknown Boss";

    try {
        finalCount = await db.runTransaction(async (t) => {
            const bossDoc = await t.get(bossRef);
            const userDoc = await t.get(userRef);
            
            if (!bossDoc.exists) throw new Error("ë³´ìŠ¤ê°€ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.");
            if (!userDoc.exists) throw new Error("ìœ ì € ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

            const bossData = bossDoc.data();
            const userData = userDoc.data();
            const today = new Date().toDateString();

            // 1. ë‚ ì§œ ì²´í¬ (ì¼ì¼ íšŸìˆ˜ ì´ˆê¸°í™”)
            let countBeforeIncrement = userData.raidDailyCount || 0; 
            const lastDate = (userData.raidLastResetDate && userData.raidLastResetDate.toDate)
                ? userData.raidLastResetDate.toDate().toDateString() : '';
            
            if (lastDate !== today) countBeforeIncrement = 0;
            if (countBeforeIncrement >= DAILY_LIMIT) throw new Error("LIMIT_REACHED");
            if (bossData.currentHp <= 0) throw new Error("BOSS_DEAD");

            // 2. âœ¨ [í•µì‹¬] ê¸°ì—¬ë„(ë°ë¯¸ì§€) ì´ˆê¸°í™” ì²´í¬
            // ë‚´ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ì¹œ ë³´ìŠ¤ IDì™€ í˜„ì¬ ë³´ìŠ¤ IDê°€ ë‹¤ë¥´ë©´ -> ìƒˆ ì‹œì¦Œì´ë¯€ë¡œ 0ë¶€í„° ì‹œì‘
            let myCurrentTotalDamage = userData.raidCumulativeDamage || 0;
            const currentBossId = bossData.spawnId || 0; // ë³´ìŠ¤ ê³ ìœ  ID
            const myLastBossId = userData.lastRaidSpawnId || 0; // ë‚´ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ì¹œ ë³´ìŠ¤ ID

            if (currentBossId !== myLastBossId) {
                myCurrentTotalDamage = 0; // ë¦¬ì…‹!
            }

            // 3. ë°ë¯¸ì§€ ê³„ì‚° ë° ì ìš©
            const countAfterIncrement = countBeforeIncrement + 1; 
            const newHp = Math.max(0, bossData.currentHp - damage);
            const newTotalDamage = myCurrentTotalDamage + damage; // ë¦¬ì…‹ëœ ì ìˆ˜ + ì´ë²ˆ ë°ë¯¸ì§€
            
            // 4. ë§‰íƒ€ ì²´í¬
            if (newHp <= 0 && !bossData.isRewardDistributed) {
                triggerRewardDistribution = true;
                bossNameForReward = bossData.name;
                t.update(bossRef, { 
                    currentHp: newHp,
                    isRewardDistributed: true,
                    defeatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                t.update(bossRef, { currentHp: newHp });
            }
            
            // 5. ìœ ì € ì •ë³´ ì—…ë°ì´íŠ¸ (ë°ë¯¸ì§€ ëˆ„ì  + í˜„ì¬ ë³´ìŠ¤ ID ê¸°ë¡)
            t.update(userRef, {
                raidDailyCount: countAfterIncrement, 
                raidLastResetDate: firebase.firestore.FieldValue.serverTimestamp(),
                raidCumulativeDamage: newTotalDamage, // ê°±ì‹ ëœ ë°ë¯¸ì§€
                lastRaidSpawnId: currentBossId        // âœ¨ "ë‚˜ ì´ ë³´ìŠ¤ ë•Œë ¸ìŒ" ë„ì¥ ì°ê¸°
            });

            return countAfterIncrement; 
        });
        
        // --- íŠ¸ëœì­ì…˜ ì„±ê³µ í›„ ---
        if (triggerRewardDistribution) {
            // ë§‰íƒ€ ë³´ìƒ ë¶„ë°° (ì´ì „ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            distributeRaidRewards(bossNameForReward); 
            alert(`ğŸ‰ ê²°ì •íƒ€!! [${bossNameForReward}] ì²˜ì¹˜!\nì ì‹œ í›„ ë³´ìƒ ìš°í¸ì´ ë°œì†¡ë©ë‹ˆë‹¤.`);
            
            // âœ¨ [ì¶”ê°€] ë³´ìŠ¤ê°€ ì£½ì—ˆìœ¼ë‹ˆ ë°”ë¡œ ë‹¤ìŒ ë³´ìŠ¤(ë˜ëŠ” ë¶€í™œ) ì²´í¬ ë¡œì§ ì‹¤í–‰ ê°€ëŠ¥
            // setTimeout(() => checkAndSpawnRaidBoss(), 3000); 
        } else {
            const rewardMsg = calculatedReward > 0 ? `ê¸°ì—¬ ë³´ìƒ: ğŸ’${calculatedReward}` : `(ë³´ìƒ ì—†ìŒ)`;
            alert(`ğŸ‰ ${damage} í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤! (ì˜¤ëŠ˜ ${finalCount}íšŒ)\n${rewardMsg}`);
        }

        playerRaidDailyCount = finalCount;
        updateRaidDailyCountUI();
        
        calculatedReward = Math.min(MAX_REWARD, Math.floor(damage * REWARD_PER_100_DAMAGE)); 
        if (calculatedReward > 0) playerCurrency += calculatedReward;
        
        // í™”ë©´ì— ë³´ì´ëŠ” ëˆ„ì  ë°ë¯¸ì§€ë„ ì¦‰ì‹œ ê°±ì‹  (ë¦¬ì…‹ëœ ë¡œì§ ë°˜ì˜)
        // (íŠ¸ëœì­ì…˜ ê²°ê³¼ë¥¼ ì •í™•íˆ ë°˜ì˜í•˜ë ¤ë©´ DBë¥¼ ë‹¤ì‹œ ì½ëŠ” ê²Œ ì¢‹ì§€ë§Œ, ì—¬ê¸°ì„  ì•½ì‹ìœ¼ë¡œ ë”í•¨)
        // ë¦¬ì…‹ ì—¬ë¶€ë¥¼ ëª¨ë¥´ë¯€ë¡œ UIì—ëŠ” ì¼ë‹¨ ë”í•´ì£¼ê³ , ë‹¤ìŒ ë¡œë”© ë•Œ ì •í™•í•´ì§
        playerRaidDamage += damage; 
        
        updateUI(); 

    } catch (error) {
        if (error.message === "LIMIT_REACHED") return;
        if (error.message === "BOSS_DEAD") {
            alert("ì´ë¯¸ í† ë²Œëœ ë³´ìŠ¤ì…ë‹ˆë‹¤.");
            updateRaidUI();
        } else {
            console.error(error);
            alert(`ì˜¤ë¥˜: ${error.message}`);
        }
    }
}
window.startRaidBattle = startRaidBattle;

// yumecan.html - loadEventRankingData í•¨ìˆ˜ ê·¼ì²˜ì— ì¶”ê°€

// âœ… [ìˆ˜ì •ë¨] ë©”ì¸ ë ˆì´ë“œ ë­í‚¹ ë¡œë“œ (í˜„ì¬ ë³´ìŠ¤ ì‹œì¦Œë§Œ í•„í„°ë§)
async function loadRaidRankingData() {
    const listContainer = document.getElementById('ranking-list');
    
    // ë­í‚¹ ëª¨ë‹¬ì´ ì—†ê±°ë‚˜, ì•„ì§ ë³´ìŠ¤ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¤‘ë‹¨
    if (!listContainer || !raidBossData) return;
    
    listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
    
    try {
        // âœ¨ [í•µì‹¬] í˜„ì¬ ì´ë²¤íŠ¸ + í˜„ì¬ ë³´ìŠ¤ ID(ì‹œì¦Œ) + ë°ë¯¸ì§€ ìˆœ ì •ë ¬
        const snapshot = await db.collection('users')
            .where('currentEventId', '==', CURRENT_EVENT_ID) 
            .where('lastRaidSpawnId', '==', raidBossData.spawnId) // í˜„ì¬ ë³´ìŠ¤ë¥¼ ì¹œ ì‚¬ëŒë§Œ
            .orderBy('raidCumulativeDamage', 'desc')
            .limit(20)
            .get();

        listContainer.innerHTML = '';
        
        if (snapshot.empty) {
            listContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">ì•„ì§ ì´ ë³´ìŠ¤ë¥¼ ê³µê²©í•œ íƒì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        let rank = 1;
        
        snapshot.forEach(doc => {
            const data = doc.data();
            const isMe = (currentUser && doc.id === currentUser.uid);
			const { imgUrl } = getUserRepInfo(data);
            
            // ì ìˆ˜ í¬ë§·íŒ…
            const score = (data.raidCumulativeDamage || 0).toLocaleString();
            
            const div = document.createElement('div');
            
            // ë­í‚¹ë³„ ìŠ¤íƒ€ì¼ ì„¤ì •
            let rankStyle = 'bg-gray-700 border-gray-600';
            let rankBadge = `<span class="font-bold w-6 text-center text-gray-400">${rank}</span>`;
            
            if (rank === 1) {
                rankStyle = 'bg-yellow-900/40 border-yellow-500';
                rankBadge = 'ğŸ¥‡';
            } else if (rank === 2) {
                rankStyle = 'bg-gray-400/20 border-gray-400';
                rankBadge = 'ğŸ¥ˆ';
            } else if (rank === 3) {
                rankStyle = 'bg-orange-900/40 border-orange-500';
                rankBadge = 'ğŸ¥‰';
            }

            // ë‚´ ìˆœìœ„ ê°•ì¡°
            if (isMe) rankStyle += ' ring-2 ring-blue-500';



            // í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ìŠ¤íƒ€ì¼ ë° ì´ë²¤íŠ¸ ì¶”ê°€
            div.className = `flex items-center gap-3 p-2 rounded border ${rankStyle} cursor-pointer hover:bg-white/10 transition-colors relative group`;
    div.onclick = () => openOtherUserProfile({ ...data, uid: doc.id });
    
    div.innerHTML = `
        <div class="text-xl">${rankBadge}</div>
        <img src="${imgUrl}" class="w-10 h-10 rounded object-cover bg-black">
        <div class="flex-grow">
            <p class="text-sm font-bold text-white truncate max-w-[120px]">
                ${data.nickname || 'ìµëª…ì˜ íƒì •'}
            </p>
            ${isMe ? '<span class="text-[10px] bg-blue-600 text-white px-1 rounded">ME</span>' : ''}
        </div>
        <div class="text-right">
            <p class="text-yellow-300 font-bold text-sm">${(data.cumulativeEventPoints || 0).toLocaleString()} P</p>
        </div>
    `;
    listContainer.appendChild(div);
    rank++;
});

    } catch (error) {
        console.error("ë ˆì´ë“œ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:", error);
        
        // âš ï¸ ì¸ë±ìŠ¤ ì—ëŸ¬ ì²˜ë¦¬ (ì½˜ì†” ë§í¬ ì•ˆë‚´)
        if (error.message.includes('index')) {
             listContainer.innerHTML = `
                <div class="text-red-400 text-center text-sm p-2">
                    <p class="font-bold">âš ï¸ ì‹œìŠ¤í…œ ì„¤ì • í•„ìš”</p>
                    <p>ê°œë°œì ì½˜ì†”(F12)ì„ ì—´ì–´ Firestore ì¸ë±ìŠ¤ ìƒì„± ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.</p>
                </div>
            `;
        } else {
             listContainer.innerHTML = '<p class="text-red-400 text-center">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
}

// âœ¨ [ì‹ ê·œ] ì¢…ë£Œëœ ì´ë²¤íŠ¸ í™•ì¸ ë° ë³´ìƒ íŠ¸ë¦¬ê±°
async function checkEndedEvents() {
    if (!allEventInfos || allEventInfos.length === 0) return;

    const now = new Date();
    const statusRef = db.collection('system').doc('event_status');

    try {
        await db.runTransaction(async (t) => {
            const doc = await t.get(statusRef);
            // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ë¡œ ì‹œì‘
            const statusData = doc.exists ? doc.data() : {};
            
            // ëª¨ë“  ì´ë²¤íŠ¸ ëª©ë¡ì„ ìˆœíšŒí•˜ë©° 'ì¢…ë£Œë˜ì—ˆìœ¼ë‚˜ ë³´ìƒì´ ì•ˆ ë‚˜ê°„' ê±´ì„ ì°¾ìŒ
            for (const info of allEventInfos) {
                // 1. ì´ë¯¸ ì¢…ë£Œëœ ì´ë²¤íŠ¸ì¸ê°€?
                if (now > info.endDate) {
                    // 2. ì´ë¯¸ ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆëŠ”ê°€? (statusDataì— ê¸°ë¡ í™•ì¸)
                    if (!statusData[info.id]) {
                        console.log(`ğŸ“¢ [${info.title}] ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ìƒ ë¶„ë°°ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.`);
                        
                        // 3. 'ì§€ê¸‰ ì™„ë£Œ' í”Œë˜ê·¸ë¥¼ ë¨¼ì € ì„¤ì • (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ë½)
                        // ì£¼ì˜: ì—¬ê¸°ì„œëŠ” í”Œë˜ê·¸ë§Œ ì°ê³ , ì‹¤ì œ ë¶„ë°°(distributeEventRewards)ëŠ”
                        // íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì‹¤í–‰í•˜ê±°ë‚˜ ë¹„ë™ê¸°ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
                        t.set(statusRef, { [info.id]: true }, { merge: true });
                        
                        // 4. ë¶„ë°° í•¨ìˆ˜ ì‹¤í–‰ (await ì—†ì´ í˜¸ì¶œí•˜ì—¬ íŠ¸ëœì­ì…˜ ì§€ì—° ë°©ì§€)
                        distributeEventRewards(info.id, info.title);
                    }
                }
            }
        });
    } catch (e) {
        console.error("ì´ë²¤íŠ¸ ì¢…ë£Œ ì²´í¬ ì¤‘ ì˜¤ë¥˜:", e);
    }
}

// yumecan.html - <script> íƒœê·¸ ë‚´ë¶€

/// yumecan.html - <script> íƒœê·¸ ë‚´ë¶€ (ë ˆì´ë“œ ë¡œì§ ë¶€ë¶„)

// âœ¨ [ì‹ ê·œ] ì‹œíŠ¸ ë°ì´í„°ë¥¼ Firebaseì™€ ë¹„êµí•˜ì—¬ ë³´ìŠ¤ê°€ ì—†ìœ¼ë©´ ìŠ¤í°í•©ë‹ˆë‹¤.
// âœ… [ìˆ˜ì •ë¨] ë³´ìŠ¤ ìƒì„±/í™•ì¸ í•¨ìˆ˜ (ê³ ìœ  spawnId ë¶€ì—¬)
async function checkAndSpawnRaidBoss() {
    console.log("---------- [DEBUG: RAID SPAWN START] ----------");

    if (!raidBossDataSheet) return;
    if (!currentUser) return;

    const bossRef = db.collection('system').doc('raid_boss');
    
    try {
        const doc = await bossRef.get();
        
        // 1. ë³´ìŠ¤ê°€ ì•„ì˜ˆ ì—†ê±°ë‚˜, ë ˆë²¨ì´ ë‹¤ë¥´ë©´ ìƒˆë¡œ ìƒì„±
        if (!doc.exists || doc.data().level !== raidBossDataSheet.level) {
             console.log("[DEBUG] ìƒˆë¡œìš´ ë ˆì´ë“œ ë³´ìŠ¤ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.");
             
             const newBossData = {
                ...raidBossDataSheet, 
                currentHp: raidBossDataSheet.maxHp, 
                isDead: false,
                isRewardDistributed: false, // ë³´ìƒ ì´ˆê¸°í™”
                spawnedAt: firebase.firestore.FieldValue.serverTimestamp(),
                spawnId: Date.now() // âœ¨ [í•µì‹¬] ì´ë²ˆ ë³´ìŠ¤ì˜ ê³ ìœ  ì£¼ë¯¼ë²ˆí˜¸ (ìƒì„± ì‹œê°„)
             };
             
             await bossRef.set(newBossData);
             raidBossData = newBossData;
             updateRaidUI();
             return;
        }

        // 2. ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° ë°ì´í„° ë¡œë“œ
        raidBossData = doc.data();
        
        // (ì•ˆì „ì¥ì¹˜) ì˜›ë‚  ë°ì´í„°ë¼ spawnIdê°€ ì—†ìœ¼ë©´ ê°•ì œë¡œ ë„£ì–´ì¤Œ
        if (!raidBossData.spawnId) {
            await bossRef.update({ spawnId: Date.now() });
            raidBossData.spawnId = Date.now();
        }
        
        updateRaidUI();

    } catch (error) {
        console.error("ë³´ìŠ¤ ìŠ¤í° ì²´í¬ ì¤‘ ì˜¤ë¥˜:", error);
    }
}

// âœ… [ìˆ˜ì •ë¨] ê°€ì±  íšë“ ê°€ëŠ¥ ëª©ë¡ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (3ì—´ ê³ ì •)
function openGachaPoolModal(gachaType) {
    const modal = document.getElementById('gacha-pool-modal');
    const titleEl = document.getElementById('pool-modal-title');
    const listContainer = document.getElementById('pool-list-container');
    
    if (!modal || !listContainer) return;
    
    // 1. ì œëª© ì„¤ì •
    const typeName = gachaType === 'normal' ? 'ì¼ë°˜ ì„œê°€' : 'ì´ë²¤íŠ¸ ì„œê°€';
    titleEl.textContent = `[${typeName}] íšë“ ê°€ëŠ¥ ë“±ì¥ì¸ë¬¼`;
    listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">ëª©ë¡ ë¡œë”© ì¤‘...</p>';
    
    // 2. ìºë¦­í„° í•„í„°ë§ (gachaPool ë°ì´í„° ê¸°ì¤€)
    const obtainableCharacters = characters.filter(char => {
        const poolInfo = gachaPool[char.name];
        if (!poolInfo) return false; 
        return gachaType === 'normal' ? poolInfo.normal : poolInfo.event;
    });

    // 3. ë“±ê¸‰ë³„ ê·¸ë£¹í™”
    const grouped = obtainableCharacters.reduce((acc, char) => {
        const rarity = char.rarity || 'N';
        if (!acc[rarity]) acc[rarity] = [];
        acc[rarity].push(char);
        return acc;
    }, {});
    
    // 4. í™”ë©´ ë Œë”ë§ (SSR > SR > R > N ìˆœì„œ)
    const rarityOrder = ['SSR', 'SR', 'R', 'N'];
    listContainer.innerHTML = ''; 

    rarityOrder.forEach(rarity => {
        const charList = grouped[rarity];
        if (charList && charList.length > 0) {
            
            const colorClass = { 
                'SSR': 'text-yellow-400', 
                'SR': 'text-purple-400', 
                'R': 'text-blue-400', 
                'N': 'text-gray-400' 
            }[rarity];
            
            const section = document.createElement('div');
            
            // í”½ì—… í‘œì‹œ
            let pickupBadge = '';
            if (gachaType === 'event') {
                 const pickupCount = charList.filter(c => EVENT_CHARACTER_NAMES.includes(c.name)).length;
                 if (pickupCount > 0) {
                     pickupBadge = `<span class="ml-2 text-red-400 bg-red-900/30 px-2 py-0.5 rounded-full text-sm font-medium">âœ¨ í”½ì—… ëŒ€ìƒ (${pickupCount}ì¢…)</span>`;
                 }
            }

            section.innerHTML = `
                <h4 class="text-xl font-bold ${colorClass} mb-2 flex items-center">
                    ${rarity} (${charList.length}ì¢…)${pickupBadge}
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 border-b border-gray-700 pb-4 mb-4">
                    ${charList.map(char => {
                        return `
                            <div class="bg-gray-700/50 p-2 rounded-lg flex flex-col items-center text-center justify-center gap-1">
                                <img src="${char.cardImageUrl}" class="w-16 h-16 rounded object-cover">
                                <span class="text-xs text-white text-center font-medium">${char.name}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            listContainer.appendChild(section);
        }
    });

    // 5. ëª¨ë‹¬ í‘œì‹œ
    modal.classList.remove('hidden');
}
window.openGachaPoolModal = openGachaPoolModal;

let raidBossData = null;
let raidUnsubscribe = null;

// âœ… [ì‹ ê·œ] í•­ë³µ/ë„ì£¼ ë¡œì§ í•¨ìˆ˜
// âœ… [ìˆ˜ì •ë¨] í•­ë³µ/ë„ì£¼ ë¡œì§ í•¨ìˆ˜ (í™•ì‹¤í•œ ì¢…ë£Œ ì²˜ë¦¬)
function fleeCombat() {
    // ì´ë¯¸ ì „íˆ¬ê°€ ëë‚œ ìƒíƒœë¼ë©´ ë¬´ì‹œ
    if (!isCombatRunning) return;

    if (!window.currentCombatIndices || !window.currentCombatType) {
        console.error("ì „íˆ¬ ì •ë³´ê°€ ìœ ì‹¤ë˜ì—ˆìŠµë‹ˆë‹¤. í™ˆìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
        isCombatRunning = false;
        switchTab('home'); 
        return;
    }

    // 1. ì „íˆ¬ ì§„í–‰ í”Œë˜ê·¸ë¥¼ ë¨¼ì € ë•ë‹ˆë‹¤. (ì´ê²Œ runCombatLoopë¥¼ ë©ˆì¶”ëŠ” ì‹ í˜¸ê°€ ë©ë‹ˆë‹¤)
    isCombatRunning = false; 
    
    // 2. íŒ¨ë°° ì²˜ë¦¬ë¡œ ì „íˆ¬ ì¢…ë£Œ í•¨ìˆ˜ í˜¸ì¶œ
    // (totalDamageDealtëŠ” 0ìœ¼ë¡œ ì²˜ë¦¬)
    endCombat(false, {
        indices: window.currentCombatIndices,
        type: window.currentCombatType
    }, 0); 
}

// ... (ë‹¤ë¥¸ í•¨ìˆ˜ë“¤)

// yumecan.html - updateRaidDailyCountUI í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš” (7894í–‰ ê·¼ì²˜)
// âœ… [ìˆ˜ì •] ë ˆì´ë“œ íšŸìˆ˜ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë²„íŠ¼ì„ í™œì„±í™”/ë¹„í™œì„±í™”í•˜ëŠ” í•¨ìˆ˜
function updateRaidDailyCountUI() {
    const maxCount = 5;
    // playerRaidDailyCountëŠ” loadGameFromFirebaseì—ì„œ ë¡œë“œë˜ê±°ë‚˜ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë¨
    const currentCount = playerRaidDailyCount || 0; 
    const remaining = Math.max(0, maxCount - currentCount);

    const display = document.getElementById("raid-count-display");
    // âœ… [í™•ì¸] HTMLì—ì„œ ë³€ê²½í•œ IDì™€ ì¼ì¹˜ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.
    const btn = document.getElementById("raid-start-btn"); 

    if (display) {
        display.textContent = `ì˜¤ëŠ˜ì˜ ë ˆì´ë“œ: ${currentCount} / ${maxCount}íšŒ`;
    }

    // â­ [í•µì‹¬ ìˆ˜ì •] ë²„íŠ¼ì´ nullì´ ì•„ë‹ ë•Œë§Œ ì ‘ê·¼
    if (btn) {
        if (remaining <= 0) {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-600');
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            btn.textContent = "íšŸìˆ˜ ì œí•œ";
        } else {
            btn.disabled = false;
            // â­ [í•µì‹¬ ìˆ˜ì •] íšŸìˆ˜ ì œí•œì´ í’€ë ¤ë„ ë³´ìŠ¤ê°€ ì£½ì—ˆëŠ”ì§€ ìµœì¢… í™•ì¸ í›„ ìŠ¤íƒ€ì¼ ì ìš©
            if (raidBossData && raidBossData.currentHp > 0) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-600');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.textContent = "âš”ï¸ ì „íˆ¬ ê°œì‹œ";
            }
        }
    }
}

// ... (ë‹¤ë¥¸ í•¨ìˆ˜ë“¤)
// ================== ğŸ‘† ë ˆì´ë“œ ì‹œìŠ¤í…œ ë¡œì§ ë ğŸ‘† ==================
	

    }); // <--- DOMContentLoaded ë‹«ëŠ” ê´„í˜¸ (ì ˆëŒ€ ì§€ìš°ì§€ ë§ˆì„¸ìš”!)
	
    </script>
</body>
</html>










